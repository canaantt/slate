function once(t,n){return function e(){e.hookCalled||(e.hookCalled=!0,t.apply(n,arguments))}}module.exports={hook:function(t,n,e){if(1!==arguments.length||"object"!=typeof t){var r=this.prototype||this,o=r._pres=r._pres||{},s=r._posts=r._posts||{};return o[t]=o[t]||[],s[t]=s[t]||[],r[t]=function(){var o,s=this,u=arguments[arguments.length-1],i=this._pres[t],p=this._posts[t],a=i.length,h=-1,c=r[t].numAsyncPres,f=function(t){return t?l(t):void(--c||y.apply(s,o))},l=function(t){if("function"==typeof u)return u(t);if(e)return e.call(s,t);throw t},g=function(){if(arguments[0]instanceof Error)return l(arguments[0]);var t,n,e=Array.prototype.slice.call(arguments);if(!e.length||null==arguments[0]&&"function"==typeof u||(o=e),++h<a){if(t=i[h],t.isAsync&&t.length<2)throw new Error("Your pre must have next and done arguments -- e.g., function (next, done, ...)");if(t.length<1)throw new Error("Your pre must have a next argument -- e.g., function (next, ...)");return n=(t.isAsync?[once(g),once(f)]:[once(g)]).concat(o),t.apply(s,n)}return c?void 0:y.apply(s,o)},y=function(){var t,e,r,i,c=Array.prototype.slice.call(arguments);return h===a?(i=function(){if(arguments[0]instanceof Error)return l(arguments[0]);var t,n,a=Array.prototype.slice.call(arguments,1);if(a.length&&(o=a),++r<e){if(t=p[r],t.length<1)throw new Error("Your post must have a next argument -- e.g., function (next, ...)");return n=[once(i)].concat(o),t.apply(s,n)}return"function"==typeof u?u.apply(s,arguments):void 0},"function"==typeof u&&(c[c.length-1]=once(i)),e=p.length,r=-1,t=n.apply(s,c),e&&"function"!=typeof u?i():t):void 0};return g.apply(this,arguments)},r[t].numAsyncPres=0,this}for(var u in t)this.hook(u,t[u])},pre:function(t,n,e,r){"boolean"!=typeof arguments[1]&&(r=e,e=n,n=!1);var o=this.prototype||this,s=o._pres=o._pres||{};return this._lazySetupHooks(o,t,r),(e.isAsync=n)&&o[t].numAsyncPres++,(s[t]=s[t]||[]).push(e),this},post:function(t,n,e){2===arguments.length&&(e=n,n=!1);var r=this.prototype||this,o=r._posts=r._posts||{};return this._lazySetupHooks(r,t),(o[t]=o[t]||[]).push(e),this},removePre:function(t,n){var e=this.prototype||this,r=e._pres||e._pres||{};return r[t]?(1===arguments.length?r[t].length=0:r[t]=r[t].filter(function(t){return t!==n}),this):this},removePost:function(t,n){var e=this.prototype||this,r=e._posts||e._posts||{};return r[t]?(1===arguments.length?r[t].length=0:r[t]=r[t].filter(function(t){return t!==n}),this):this},_lazySetupHooks:function(t,n,e){"undefined"==typeof t[n].numAsyncPres&&this.hook(n,t[n],e)}};