"use strict";function toArray(e,t,r){return Array.prototype.slice.call(e,t,r)}function strongUnshift(e,t){var r=toArray(t);return r.unshift(e),r}function Promise(e){this.emitter=new EventEmitter,this.emitted={},this.ended=!1,"function"==typeof e&&(this.ended=!0,this.onResolve(e))}function handler(e,t){function r(){var r=e.emitter.domain;r&&r!==process.domain&&r.enter();try{var i=t.apply(void 0,n.args)}catch(o){return void e.reject(o)}resolve(e,i)}function n(){n.args=arguments,process.nextTick(r)}return n}function resolve(e,t){function r(){f++||resolve.apply(void 0,strongUnshift(e,arguments))}function n(t){f++||e.reject(t)}if(e===t)return void e.reject(new TypeError("promise and x are the same"));var i=toArray(arguments,1),o=typeof t;if("undefined"==o||null==t||"object"!=o&&"function"!=o)return void e.fulfill.apply(e,i);try{var s=t.then}catch(u){return void e.reject(u)}if("function"!=typeof s)return void e.fulfill.apply(e,i);var f=0;try{var l=s.call(t,r,n);return l}catch(u){if(f++)return;e.reject(u)}}var util=require("util"),EventEmitter=require("events").EventEmitter;module.exports=Promise,/*!
 * event names
 */
Promise.SUCCESS="fulfill",Promise.FAILURE="reject",Promise.prototype.on=function(e,t){return this.emitted[e]?t.apply(void 0,this.emitted[e]):this.emitter.on(e,t),this},Promise.prototype.safeEmit=function(e){if(e==Promise.SUCCESS||e==Promise.FAILURE){if(this.emitted[Promise.SUCCESS]||this.emitted[Promise.FAILURE])return this;this.emitted[e]=toArray(arguments,1)}return this.emitter.emit.apply(this.emitter,arguments),this},Promise.prototype.hasRejectListeners=function(){return EventEmitter.listenerCount(this.emitter,Promise.FAILURE)>0},Promise.prototype.fulfill=function(){return this.safeEmit.apply(this,strongUnshift(Promise.SUCCESS,arguments))},Promise.prototype.reject=function(e){if(this.ended&&!this.hasRejectListeners())throw e;return this.safeEmit(Promise.FAILURE,e)},Promise.prototype.resolve=function(e,t){return e?this.reject(e):this.fulfill(t)},Promise.prototype.onFulfill=function(e){if(!e)return this;if("function"!=typeof e)throw new TypeError("fn should be a function");return this.on(Promise.SUCCESS,e)},Promise.prototype.onReject=function(e){if(!e)return this;if("function"!=typeof e)throw new TypeError("fn should be a function");return this.on(Promise.FAILURE,e)},Promise.prototype.onResolve=function(e){if(!e)return this;if("function"!=typeof e)throw new TypeError("fn should be a function");return this.on(Promise.FAILURE,function(t){e.call(this,t)}),this.on(Promise.SUCCESS,function(){e.apply(this,strongUnshift(null,arguments))}),this},Promise.prototype.then=function(e,t){var r=new Promise;return"function"==typeof e?this.onFulfill(handler(r,e)):this.onFulfill(r.fulfill.bind(r)),"function"==typeof t?this.onReject(handler(r,t)):this.onReject(r.reject.bind(r)),r},Promise.prototype.end=Promise.prototype["catch"]=function(e){return e||this.hasRejectListeners()||(e=function(e){throw e}),this.onReject(e),this.ended=!0,this},Promise.trace=function(e,t){e.then(function(){console.log("%s fulfill %j",t,toArray(arguments))},function(){console.log("%s reject %j",t,toArray(arguments))})},Promise.prototype.chain=function(e){var t=this;return t.onFulfill(e.fulfill.bind(e)),t.onReject(e.reject.bind(e)),e},Promise.prototype.all=function(e){var t=new Promise;return this.then(e).then(function(e){var r,n=0,i=[];return e.length||t.resolve(),e.forEach(function(e,o){r||(n++,e.then(function(e){r||(i[o]=e,--n,0==n&&t.fulfill(i))},function(e){r||(r=e,t.reject(e))}))}),t},t.reject.bind(t)),t},Promise.hook=function(e){var t=new Promise,r=new Promise,n=function(){return--i,0==i&&r.fulfill(),r},i=1,o=t;return e.forEach(function(e){o=o.then(function(){var t=new Promise;return i++,e(t.resolve.bind(t),n),t})}),o=o.then(n),t.resolve(),o},Promise.fulfilled=function(){var e=new Promise;return e.fulfill.apply(e,arguments),e},Promise.rejected=function(e){return(new Promise).reject(e)},Promise.deferred=function(){var e=new Promise;return{promise:e,reject:e.reject.bind(e),resolve:e.fulfill.bind(e),callback:e.resolve.bind(e)}};