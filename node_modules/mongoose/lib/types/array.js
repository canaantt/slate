/*!
 * Module dependencies.
 */
function MongooseArray(t,i,e){for(var s=[].concat(t),r=Object.keys(MongooseArray.mixin),n=r.length,a=0;n>a;++a)s[r[a]]=MongooseArray.mixin[r[a]];return s._path=i,s.isMongooseArray=!0,s.validators=[],s._atomics={},s._schema=void 0,e&&e instanceof Document&&(s._parent=e,s._schema=e.schema.path(i)),s}var EmbeddedDocument=require("./embedded"),Document=require("../document"),ObjectId=require("./objectid"),utils=require("../utils"),isMongooseObject=utils.isMongooseObject;MongooseArray.mixin={_atomics:void 0,_parent:void 0,_cast:function(t){var i,e=this._owner,s=!1;if(this._parent&&(e||(e=this._owner=this._parent.ownerDocument?this._parent.ownerDocument():this._parent),s=e.populated(this._path,!0)),s&&null!==t&&void 0!==t){i=s.options.model,(Buffer.isBuffer(t)||t instanceof ObjectId||!utils.isObject(t))&&(t={_id:t});var r=t.schema&&t.schema.discriminatorMapping&&void 0!==t.schema.discriminatorMapping.key;return r||(t=new i(t)),this._schema.caster.cast(t,this._parent,!0)}return this._schema.caster.cast(t,this._parent,!1)},_markModified:function(t,i){var e,s=this._parent;return s&&(e=this._path,arguments.length&&(e=null!=i?e+"."+this.indexOf(t)+"."+i:e+"."+t),s.markModified(e)),this},_registerAtomic:function(t,i){if("$set"===t)return this._atomics={$set:i},this;var e=this._atomics;if("$pop"===t&&!("$pop"in e)){var s=this;this._parent.once("save",function(){s._popped=s._shifted=null})}if(this._atomics.$set||Object.keys(e).length&&!(t in e))return this._atomics={$set:this},this;var r;if("$pullAll"===t||"$pushAll"===t||"$addToSet"===t)e[t]||(e[t]=[]),e[t]=e[t].concat(i);else if("$pullDocs"===t){var n=e.$pull||(e.$pull={});i[0]instanceof EmbeddedDocument?(r=n.$or||(n.$or=[]),Array.prototype.push.apply(r,i.map(function(t){return t.toObject({virtuals:!1})}))):(r=n._id||(n._id={$in:[]}),r.$in=r.$in.concat(i))}else e[t]=i;return this},$__getAtomics:function(){var t=[],i=Object.keys(this._atomics),e=i.length;if(0===e)return t[0]=["$set",this.toObject({depopulate:1,transform:!1})],t;for(;e--;){var s=i[e],r=this._atomics[s];isMongooseObject(r)?r=r.toObject({depopulate:1,transform:!1}):Array.isArray(r)?r=this.toObject.call(r,{depopulate:1,transform:!1}):r.valueOf&&(r=r.valueOf()),"$addToSet"===s&&(r={$each:r}),t.push([s,r])}return t},hasAtomics:function(){return this._atomics&&"Object"===this._atomics.constructor.name?Object.keys(this._atomics).length:0},_mapCast:function(t,i){return this._cast(t,this.length+i)},push:function(){var t=[].map.call(arguments,this._mapCast,this);t=this._schema.applySetters(t,this._parent,void 0,void 0,{skipDocumentArrayCast:!0});var i=[].push.apply(this,t);return this._registerAtomic("$pushAll",t),this._markModified(),i},nonAtomicPush:function(){var t=[].map.call(arguments,this._mapCast,this),i=[].push.apply(this,t);return this._registerAtomic("$set",this),this._markModified(),i},$pop:function(){return this._registerAtomic("$pop",1),this._markModified(),this._popped?void 0:(this._popped=!0,[].pop.call(this))},pop:function(){var t=[].pop.call(this);return this._registerAtomic("$set",this),this._markModified(),t},$shift:function(){return this._registerAtomic("$pop",-1),this._markModified(),this._shifted?void 0:(this._shifted=!0,[].shift.call(this))},shift:function(){var t=[].shift.call(this);return this._registerAtomic("$set",this),this._markModified(),t},pull:function(){for(var t,i=[].map.call(arguments,this._cast,this),e=this._parent.get(this._path),s=e.length;s--;)if(t=e[s],t instanceof Document){var r=i.some(function(i){return t.equals(i)});r&&[].splice.call(e,s,1)}else~e.indexOf.call(i,t)&&[].splice.call(e,s,1);return i[0]instanceof EmbeddedDocument?this._registerAtomic("$pullDocs",i.map(function(t){return t._id||t})):this._registerAtomic("$pullAll",i),this._markModified(),this},splice:function(){var t,i,e;if(arguments.length){for(i=[],e=0;e<arguments.length;++e)i[e]=2>e?arguments[e]:this._cast(arguments[e],arguments[0]+(e-2));t=[].splice.apply(this,i),this._registerAtomic("$set",this),this._markModified()}return t},unshift:function(){var t=[].map.call(arguments,this._cast,this);return t=this._schema.applySetters(t,this._parent),[].unshift.apply(this,t),this._registerAtomic("$set",this),this._markModified(),this.length},sort:function(){var t=[].sort.apply(this,arguments);return this._registerAtomic("$set",this),this._markModified(),t},addToSet:function(){var t=[].map.call(arguments,this._mapCast,this);t=this._schema.applySetters(t,this._parent);var i=[],e="";return t[0]instanceof EmbeddedDocument?e="doc":t[0]instanceof Date&&(e="date"),t.forEach(function(t){var s;switch(e){case"doc":s=this.some(function(i){return i.equals(t)});break;case"date":var r=+t;s=this.some(function(t){return+t===r});break;default:s=~this.indexOf(t)}s||([].push.call(this,t),this._registerAtomic("$addToSet",t),this._markModified(),[].push.call(i,t))},this),i},set:function(t,i){var e=this._cast(i,t);return e=this._schema.caster instanceof EmbeddedDocument?e:this._schema.caster.applySetters(i,this._parent),this[t]=e,this._markModified(t),this},toObject:function(t){return t&&t.depopulate?this.map(function(i){return i instanceof Document?i.toObject(t):i}):this.slice()},inspect:function(){return JSON.stringify(this)},indexOf:function(t){t instanceof ObjectId&&(t=t.toString());for(var i=0,e=this.length;e>i;++i)if(t==this[i])return i;return-1}},MongooseArray.mixin.remove=MongooseArray.mixin.pull,/*!
 * Module exports.
 */
module.exports=exports=MongooseArray;