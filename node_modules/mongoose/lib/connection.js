/*!
 * Module dependencies.
 */
function Connection(t){this.base=t,this.collections={},this.models={},this.config={autoIndex:!0},this.replica=!1,this.hosts=null,this.host=null,this.port=null,this.user=null,this.pass=null,this.name=null,this.options=null,this.otherDbs=[],this._readyState=STATES.disconnected,this._closeCalled=!1,this._hasOpened=!1}var utils=require("./utils"),EventEmitter=require("events").EventEmitter,driver=global.MONGOOSE_DRIVER_PATH||"./drivers/node-mongodb-native",Schema=require("./schema"),Collection=require(driver+"/collection"),STATES=require("./connectionstate"),MongooseError=require("./error"),muri=require("muri"),PromiseProvider=require("./promise_provider"),rgxProtocol=/^(?:.)+:\/\//,authMechanismsWhichDontRequirePassword=["MONGODB-X509"];/*!
 * Inherit from EventEmitter
 */
Connection.prototype.__proto__=EventEmitter.prototype,Object.defineProperty(Connection.prototype,"readyState",{get:function(){return this._readyState},set:function(t){if(!(t in STATES))throw new Error("Invalid connection state: "+t);if(this._readyState!==t){this._readyState=t;for(var e=0;e<this.otherDbs.length;e++)this.otherDbs[e].readyState=t;STATES.connected===t&&(this._hasOpened=!0),this.emit(STATES[t])}}}),Connection.prototype.collections,Connection.prototype.db,Connection.prototype.config,Connection.prototype.open=function(t,e,o,s,i){var n;if("string"==typeof e)switch(arguments.length){case 2:o=27017;break;case 3:switch(typeof o){case"function":i=o,o=27017;break;case"object":s=o,o=27017}break;case 4:"function"==typeof s&&(i=s,s={})}else{switch(typeof e){case"function":i=e,e=void 0;break;case"object":s=e,e=void 0,i=o}rgxProtocol.test(t)||(t="mongodb://"+t);try{n=muri(t)}catch(r){return this.error(r,i),this}e=n.db,t=n.hosts[0].host||n.hosts[0].ipc,o=n.hosts[0].port||27017}if(this.options=this.parseOptions(s,n&&n.options),STATES.disconnected!==this.readyState){var r=new Error("Trying to open unclosed connection.");return r.state=this.readyState,this.error(r,i),this}if(!t)return this.error(new Error("Missing hostname."),i),this;if(!e)return this.error(new Error("Missing database name."),i),this;if(this.optionsProvideAuthenticationData(s))this.user=s.user,this.pass=s.pass;else if(n&&n.auth)this.user=n.auth.user,this.pass=n.auth.pass;else if(/@/.test(t)&&/:/.test(t.split("@")[0])){t=t.split("@");var c=t.shift().split(":");t=t.pop(),this.user=c[0],this.pass=c[1]}else this.user=this.pass=void 0;s&&s.config&&(this.config.autoIndex=s.config.autoIndex!==!1),this.name=e,this.host=t,this.port=o;var h=this,a=PromiseProvider.get(),u=new a.ES6(function(t,e){h._open(!0,function(o){return i&&i(o),o?(e(o),void(i||u.$hasHandler||h.emit("error",o))):void t()})});return u},Connection.prototype.openSet=function(t,e,o,s){switch(rgxProtocol.test(t)||(t="mongodb://"+t),arguments.length){case 3:switch(typeof e){case"string":this.name=e;break;case"object":s=o,o=e,e=null}"function"==typeof o&&(s=o,o={});break;case 2:switch(typeof e){case"string":this.name=e;break;case"function":s=e,e=null;break;case"object":o=e,e=null}}var i;try{i=muri(t)}catch(n){return this.error(n,s),this}if(this.name||(this.name=i.db),this.hosts=i.hosts,this.options=this.parseOptions(o,i&&i.options),this.replica=!0,!this.name)return this.error(new Error("No database name provided for replica set"),s),this;this.optionsProvideAuthenticationData(o)?(this.user=o.user,this.pass=o.pass):i&&i.auth?(this.user=i.auth.user,this.pass=i.auth.pass):this.user=this.pass=void 0,o&&o.config&&(this.config.autoIndex=o.config.autoIndex!==!1);var r=this,c=PromiseProvider.get(),h=new c.ES6(function(t,e){r._open(!0,function(o){return s&&s(o),o?(e(o),void(s||h.$hasHandler||r.emit("error",o))):void t()})});return h},Connection.prototype.error=function(t,e){return e?e(t):void this.emit("error",t)},Connection.prototype._open=function(t,e){this.readyState=STATES.connecting,this._closeCalled=!1;var o=this,s=this.replica?"doOpenSet":"doOpen";this[s](function(s){return s?(o.readyState=STATES.disconnected,void(o._hasOpened?e&&e(s):o.error(s,t&&e))):void o.onOpen(e)})},Connection.prototype.onOpen=function(t){function e(e,s){if(e)return o.readyState=s?STATES.unauthorized:STATES.disconnected,void o.error(e,t);o.readyState=STATES.connected;for(var i in o.collections)utils.object.hasOwnProperty(o.collections,i)&&o.collections[i].onOpen();t&&t(),o.emit("open")}var o=this;this._readyState!==STATES.connected&&this.shouldAuthenticate()?o.db.authenticate(o.user,o.pass,o.options.auth,function(t){e(t,!0)}):e()},Connection.prototype.close=function(t){var e=this,o=PromiseProvider.get();return new o.ES6(function(o,s){e._close(function(e){return t&&t(e),e?void s(e):void o()})})},Connection.prototype._close=function(t){var e=this;switch(this._closeCalled=!0,this.readyState){case 0:t&&t();break;case 1:case 4:this.readyState=STATES.disconnecting,this.doClose(function(o){o?e.error(o,t):(e.onClose(),t&&t())});break;case 2:this.once("open",function(){e.close(t)});break;case 3:if(!t)break;this.once("close",function(){t()})}return this},Connection.prototype.onClose=function(){this.readyState=STATES.disconnected;for(var t in this.collections)utils.object.hasOwnProperty(this.collections,t)&&this.collections[t].onClose();this.emit("close")},Connection.prototype.collection=function(t,e){return t in this.collections||(this.collections[t]=new Collection(t,this,e)),this.collections[t]},Connection.prototype.model=function(t,e,o){if("string"==typeof e&&(o=e,e=!1),utils.isObject(e)&&!e.instanceOfSchema&&(e=new Schema(e)),this.models[t]&&!o){if(e&&e.instanceOfSchema&&e!==this.models[t].schema)throw new MongooseError.OverwriteModelError(t);return this.models[t]}var s,i={cache:!1,connection:this};if(e&&e.instanceOfSchema)return s=this.base.model(t,e,o,i),this.models[t]||(this.models[t]=s),s.init(),s;if(this.models[t]&&o){s=this.models[t],e=s.prototype.schema;var n=s.__subclass(this,e,o);return n}if(s=this.base.models[t],!s)throw new MongooseError.MissingSchemaError(t);return this!==s.prototype.db||o&&o!==s.collection.name?(this.models[t]=s.__subclass(this,e,o),this.models[t]):(this.models[t]||(this.models[t]=s),s)},Connection.prototype.modelNames=function(){return Object.keys(this.models)},Connection.prototype.shouldAuthenticate=function(){return null!==this.user&&void 0!==this.user&&(null!==this.pass||void 0!==this.pass||this.authMechanismDoesNotRequirePassword())},Connection.prototype.authMechanismDoesNotRequirePassword=function(){return this.options&&this.options.auth?authMechanismsWhichDontRequirePassword.indexOf(this.options.auth.authMechanism)>=0:!0},Connection.prototype.optionsProvideAuthenticationData=function(t){return t&&t.user&&(t.pass||this.authMechanismDoesNotRequirePassword())},/*!
 * Module exports.
 */
Connection.STATES=STATES,module.exports=Connection;