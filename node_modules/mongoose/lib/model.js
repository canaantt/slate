/*!
 * Module dependencies.
 */
function Model(e,t,o){Document.call(this,e,t,o)}/*!
 * Determines whether versioning should be skipped for the given path
 *
 * @param {Document} self
 * @param {String} path
 * @return {Boolean} true if versioning should be skipped for the given path
 */
function shouldSkipVersioning(e,t){var o=e.schema.options.skipVersioning;return o?(t=t.replace(/\.\d+\./,"."),o[t]):!1}/*!
 * Apply the operation to the delta (update) clause as
 * well as track versioning for our where clause.
 *
 * @param {Document} self
 * @param {Object} where
 * @param {Object} delta
 * @param {Object} data
 * @param {Mixed} val
 * @param {String} [operation]
 */
function operand(e,t,o,i,n,r){if(r||(r="$set"),o[r]||(o[r]={}),o[r][i.path]=n,e.schema.options.versionKey!==!1&&!shouldSkipVersioning(e,i.path)&&VERSION_ALL!==(VERSION_ALL&e.$__.version)){switch(r){case"$set":case"$unset":case"$pop":case"$pull":case"$pullAll":case"$push":case"$pushAll":case"$addToSet":break;default:return}"$push"===r||"$pushAll"===r||"$addToSet"===r?e.$__.version=VERSION_INC:/^\$p/.test(r)?e.increment():Array.isArray(n)?e.increment():/\.\d+\.|\.\d+$/.test(i.path)&&(e.$__.version=VERSION_WHERE)}}/*!
 * Compiles an update and where clause for a `val` with _atomics.
 *
 * @param {Document} self
 * @param {Object} where
 * @param {Object} delta
 * @param {Object} data
 * @param {Array} value
 */
function handleAtomics(e,t,o,i,n){function r(e){return isMongooseObject(e)?e.toObject({depopulate:1}):e}if(!o.$set||!o.$set[i.path]){if("function"==typeof n.$__getAtomics)return void n.$__getAtomics().forEach(function(n){var r=n[0],s=n[1];operand(e,t,o,i,s,r)});var s,a,l=n._atomics,u=Object.keys(l),c=u.length;if(0===c)return isMongooseObject(n)?n=n.toObject({depopulate:1}):n.valueOf&&(n=n.valueOf()),operand(e,t,o,i,n);for(;c--;)a=u[c],s=l[a],isMongooseObject(s)?s=s.toObject({depopulate:1}):Array.isArray(s)?s=s.map(r):s.valueOf&&(s=s.valueOf()),"$addToSet"===a&&(s={$each:s}),operand(e,t,o,i,s,a)}}/*!
 * Determine if array was populated with some form of filter and is now
 * being updated in a manner which could overwrite data unintentionally.
 *
 * @see https://github.com/Automattic/mongoose/issues/1334
 * @param {Document} doc
 * @param {String} path
 * @return {String|undefined}
 */
function checkDivergentArray(e,t,o){var i=e.populated(t,!0);if(!i&&e.$__.selected){var n=t.split(".")[0];if(e.$__.selected[n+".$"])return n}if(i&&o&&o.isMongooseArray){var r=i.options.match||i.options.options&&hasOwnProperty(i.options.options,"limit")||i.options.options&&i.options.options.skip||i.options.select&&(0===i.options.select._id||/\s?-_id\s?/.test(i.options.select));if(r){var s=o._atomics;if(0===Object.keys(s).length||s.$set||s.$pop)return t}}}function _ensureIndexes(e,t){var o=e.schema.indexes();if(!o.length)return void process.nextTick(function(){t&&t()});var i=function(o){o&&e.schema.options.emitIndexErrors&&e.emit("error",o),e.emit("index",o),t&&t(o)},n=function(t,o,i,n){e.emit("index-single-done",t,o,i,n)},r=function(t,o){e.emit("index-single-start",t,o)},s=function(){var t=o.shift();if(!t)return i();var a=t[0],l=t[1];_handleSafe(l),r(a,l),e.collection.ensureIndex(a,l,tick(function(e,t){return n(e,a,l,t),e?i(e):void s()}))};process.nextTick(function(){s()})}function _handleSafe(e){e.safe&&("boolean"==typeof e.safe&&(e.w=e.safe,delete e.safe),"object"==typeof e.safe&&(e.w=e.safe.w,e.j=e.safe.j,e.wtimeout=e.safe.wtimeout,delete e.safe))}/*!
 * Populate helper
 *
 * @param {Model} model the model to use
 * @param {Document|Array} docs Either a single document or array of documents to populate.
 * @param {Object} paths
 * @param {Function} [cb(err,doc)] Optional callback, executed upon completion. Receives `err` and the `doc(s)`.
 * @return {Function}
 * @api private
 */
function _populate(e,t,o,i,n){function r(e){return e?n(e):void(--s||n(null,t))}var s=o.length;if(0===s)return n(null,t);for(var a,l=s;l--;)a=o[l],populate(e,t,a,r)}function populate(e,t,o,i){function n(e){return void 0!==e}function r(e,t,o,n){return o?i(o):(f=f.concat(n),s(null,f,e,t),void(0===--h&&i()))}function s(t,o,n,r){if(t)return i(t);for(var s,a,l,u=n.options,c=u.options&&u.options.lean,d=o.length,p={},f={},h=0;d>h;h++)if(l=o[h]){if(s=utils.getValue(n.foreignField,l),Array.isArray(s))for(var m=s.length,v=0;m>v;++v)a=String(s[v]),f[a]?Array.isArray(f[a])?(f[a].push(l),p[a].push(h)):(f[a]=[f[a],l],p[a]=[p[a],h]):(f[a]=l,p[a]=h);else a=String(utils.getValue(n.foreignField,l)),f[a]?Array.isArray(f[a])?(f[a].push(l),p[a].push(h)):(f[a]=[f[a],l],p[a]=[p[a],h]):(f[a]=l,p[a]=h);c||(l.$__.wasPopulated=!0)}assignVals({originalModel:e,rawIds:n.ids,localField:n.localField,foreignField:n.foreignField,rawDocs:f,rawOrder:p,docs:n.docs,path:u.path,options:r,justOne:n.justOne,isVirtual:n.isVirtual})}var a;if(Array.isArray(t)||(t=[t]),0===t.length||t.every(utils.isNullOrUndefined))return i();a=getModelsMapForPopulate(e,t,o);var l,u,c,d,p=a.length,f=[],h=p,m=!1;for(l=0;p>l;l++){u=a[l],d=u.options.select,c=u.options.match?utils.object.shallowCopy(u.options.match):{};var v=utils.array.flatten(u.ids,n);if(v=utils.array.unique(v),0===v.length||v.every(utils.isNullOrUndefined))--h;else{m=!0,"_id"===u.foreignField&&c._id||(c[u.foreignField]={$in:v});var y={};y.sort=u.options.options&&u.options.options.sort||void 0,y.excludeId=excludeIdReg.test(d)||d&&0===d._id,y.excludeId&&("string"==typeof d?d=d.replace(excludeIdRegGlobal," "):(d=utils.object.shallowCopy(d),delete d._id)),u.options.options&&u.options.options.limit&&(y.originalLimit=u.options.options.limit,u.options.options.limit=u.options.options.limit*v.length);var _=u.options.populate,g=u.Model.find(c,d,u.options.options);_&&g.populate(_),g.exec(r.bind(this,u,y))}}return m?void 0:i()}/*!
 * Assigns documents returned from a population query back
 * to the original document path.
 */
function assignVals(e){function t(e){return valueFilter(e,n)}assignRawDocsToIdStructure(e.rawIds,e.rawDocs,e.rawOrder,e.options,e.localField,e.foreignField);for(var o=e.docs,i=e.rawIds,n=e.options,r=0;r<o.length;++r)(null!=utils.getValue(e.path,o[r])||e.originalModel.schema.virtuals[e.path])&&(!e.isVirtual||e.justOne||Array.isArray(i[r])||(i[r]=[i[r]]),utils.setValue(e.path,i[r],o[r],t))}/*!
 * Assign `vals` returned by mongo query to the `rawIds`
 * structure returned from utils.getVals() honoring
 * query sort order if specified by user.
 *
 * This can be optimized.
 *
 * Rules:
 *
 *   if the value of the path is not an array, use findOne rules, else find.
 *   for findOne the results are assigned directly to doc path (including null results).
 *   for find, if user specified sort order, results are assigned directly
 *   else documents are put back in original order of array if found in results
 *
 * @param {Array} rawIds
 * @param {Array} vals
 * @param {Boolean} sort
 * @api private
 */
function assignRawDocsToIdStructure(e,t,o,i,n,r,s){for(var a,l,u,c=[],d=i.sort&&e.length>1,p=0;p<e.length;++p)u=e[p],Array.isArray(u)?(assignRawDocsToIdStructure(u,t,o,i,n,r,!0),c.push(u)):null!==u||d?(l=String(u),s?(a=t[l],a?d?c[o[l]]=a:c.push(a):c.push(u)):c[p]=a=t[l]||null):c.push(u);e.length=0,c.length&&c.forEach(function(t,o){t&&(e[o]=t)})}function getModelsMapForPopulate(e,t,o){var i,n,r,s,a,l,u,c,d,p,f=t.length,h={},m=[],v=o.model&&o.model.modelName||o.model,y=utils.clone(o),_=!1;for(r=e._getSchema(o.path),r&&r.caster&&(r=r.caster),!r&&e.discriminators&&(d=e.schema.discriminatorMapping.key),s=r&&r.options&&r.options.refPath,i=0;f>i;i++){if(n=t[i],s)u=utils.getValue(s,n);else if(v)u=[v];else{var g,w=e;!r&&d?(p=utils.getValue(d,n),p&&(w=e.db.model(p),g=w._getSchema(o.path),g&&g.caster&&(g=g.caster))):g=r;var M=w.schema.virtuals[o.path];g&&g.options&&g.options.ref?u=[g.options.ref]:M&&M.options&&M.options.ref?(u=[M&&M.options&&M.options.ref],_=!0):u=[e.modelName]}if(u){Array.isArray(u)||(u=[u]),M=e.schema.virtuals[o.path];var b=M&&M.options?M.options.localField:o.path,$=M&&M.options?M.options.foreignField:"_id",O=M&&M.options&&M.options.justOne;M&&M.options&&M.options.ref&&(_=!0);var A=convertTo_id(utils.getValue(b,n)),E=String(utils.getValue($,n));o._docs[E]=Array.isArray(A)?A.slice():A,n.$__&&n.populated(o.path,o._docs[E],o);for(var N=u.length;N--;)c=u[N],a=y.model&&y.model.modelName?y.model:e.db.model(c),h[c]?(h[c].docs.push(n),h[c].ids.push(A)):(l={model:a},utils.merge(l,o),r&&!d&&(l.model=a),o.model=a,h[c]={Model:a,options:l,docs:[n],ids:[A],localField:b,foreignField:$,justOne:O,isVirtual:_},m.push(h[c]))}}return m}/*!
 * Retrieve the _id of `val` if a Document or Array of Documents.
 *
 * @param {Array|Document|Any} val
 * @return {Array|Document|Any}
 */
function convertTo_id(e){if(e instanceof Model)return e._id;if(Array.isArray(e)){for(var t=0;t<e.length;++t)e[t]instanceof Model&&(e[t]=e[t]._id);return e}return e}/*!
 * 1) Apply backwards compatible find/findOne behavior to sub documents
 *
 *    find logic:
 *      a) filter out non-documents
 *      b) remove _id from sub docs when user specified
 *
 *    findOne
 *      a) if no doc found, set to null
 *      b) remove _id from sub docs when user specified
 *
 * 2) Remove _ids when specified by users query.
 *
 * background:
 * _ids are left in the query even when user excludes them so
 * that population mapping can occur.
 */
function valueFilter(e,t){if(Array.isArray(e)){for(var o=[],i=e.length,n=0;i>n;++n){var r=e[n];if(isDoc(r)&&(maybeRemoveId(r,t),o.push(r),t.originalLimit&&o.length>=t.originalLimit))break}for(;e.length>o.length;)Array.prototype.pop.apply(e,[]);for(n=0;n<o.length;++n)e[n]=o[n];return e}return isDoc(e)?(maybeRemoveId(e,t),e):null}/*!
 * Remove _id from `subdoc` if user specified "lean" query option
 */
function maybeRemoveId(e,t){t.excludeId&&("function"==typeof e.setValue?delete e._doc._id:delete e._id)}/*!
 * Determine if `doc` is a document returned
 * by a populate query.
 */
function isDoc(e){if(null==e)return!1;var t=typeof e;return"string"===t?!1:"number"===t?!1:Buffer.isBuffer(e)?!1:"ObjectID"===e.constructor.name?!1:!0}/*!
 * Register custom query methods for this model
 *
 * @param {Model} model
 * @param {Schema} schema
 */
function applyQueryMethods(e,t){for(var o in t)e.Query.prototype[o]=t[o]}var Document=require("./document"),MongooseError=require("./error"),VersionError=MongooseError.VersionError,DivergentArrayError=MongooseError.DivergentArrayError,Query=require("./query"),Aggregate=require("./aggregate"),Schema=require("./schema"),utils=require("./utils"),hasOwnProperty=utils.object.hasOwnProperty,isMongooseObject=utils.isMongooseObject,EventEmitter=require("events").EventEmitter,util=require("util"),tick=utils.tick,async=require("async"),PromiseProvider=require("./promise_provider"),VERSION_WHERE=1,VERSION_INC=2,VERSION_ALL=VERSION_WHERE|VERSION_INC;/*!
 * Inherits from Document.
 *
 * All Model.prototype features are available on
 * top level (non-sub) documents.
 */
Model.prototype.__proto__=Document.prototype,Model.prototype.db,Model.prototype.collection,Model.prototype.modelName,Model.prototype.baseModelName,Model.prototype.$__handleSave=function(e,t){var o=this;if(!e.safe&&this.schema.options.safe&&(e.safe=this.schema.options.safe),"boolean"==typeof e.safe&&(e.safe=null),this.isNew){var i={};this.schema.options.toObject&&this.schema.options.toObject.retainKeyOrder&&(i.retainKeyOrder=!0),i.depopulate=1,i._skipDepopulateTopLevel=!0,i.transform=!1;var n=this.toObject(i);if(!utils.object.hasOwnProperty(n||{},"_id"))return void setTimeout(function(){t(new Error("document must have an _id before saving"))},0);this.$__version(!0,n),this.collection.insert(n,e.safe,function(e,i){return e?(o.isNew=!0,o.emit("isNew",!0),void t(e)):void t(null,i)}),this.$__reset(),this.isNew=!1,this.emit("isNew",!1),this.$__.inserting=!0}else{this.$__.inserting=!1;var r=this.$__delta();if(!r)return this.$__reset(),void t();if(r instanceof Error)return void t(r);var s=this.$__where(r[0]);if(s instanceof Error)return void t(s);this.collection.update(s,r[1],e.safe,function(e,o){return e?void t(e):void t(null,o)}),this.emit("isNew",!1)}},/*!
 * ignore
 */
Model.prototype.$__save=function(e,t){var o=this;o.$__handleSave(e,function(e,i){if(e)return o.schema.s.hooks.execPost("save:error",o,[o],{error:e},function(e){t(e)});o.$__reset(),o.$__storeShard();var n=0;if(i&&(n=Array.isArray(i)?i.length:i.result&&void 0!==i.result.n?i.result.n:i.result&&void 0!==i.result.nModified?i.result.nModified:i),o.$__.version&&!o.$__.inserting){var r=VERSION_INC===(VERSION_INC&o.$__.version);if(o.$__.version=void 0,0>=n){var s=new VersionError(o);return t(s)}if(r){var a=o.schema.options.versionKey,l=0|o.getValue(a);o.setValue(a,l+1)}}o.emit("save",o,n),t(null,o,n)})},Model.prototype.save=function(e,t){return"function"==typeof e&&(t=e,e=void 0),e||(e={}),t&&(t=this.constructor.$wrapCallback(t)),this.$__save(e,t)},Model.prototype.$__delta=function(){var e=this.$__dirty();if(e.length||VERSION_ALL===this.$__.version){var t={},o={},i=e.length,n=[],r=0;for(t._id=this._doc._id;i>r;++r){var s=e[r],a=s.value,l=checkDivergentArray(this,s.path,a);if(l)n.push(l);else{var u=this.populated(s.path,!0);if(!u&&this.$__.selected){var c=s.path.split("."),d=c[0];if(this.$__.selected[d]&&this.$__.selected[d].$elemMatch){if(!(c.length>1&&0==c[1]&&"undefined"==typeof t[d])){n.push(s.path);continue}t[d]=this.$__.selected[d],c[1]="$",s.path=c.join(".")}}n.length||(void 0===a?operand(this,t,o,s,1,"$unset"):null===a?operand(this,t,o,s,null):a._path&&a._atomics?handleAtomics(this,t,o,s,a):a._path&&Buffer.isBuffer(a)?(a=a.toObject(),operand(this,t,o,s,a)):(a=utils.clone(a,{depopulate:1}),operand(this,t,o,s,a)))}}return n.length?new DivergentArrayError(n):(this.$__.version&&this.$__version(t,o),[t,o])}},Model.prototype.$__version=function(e,t){var o=this.schema.options.versionKey;return e===!0?void(o&&this.setValue(o,t[o]=0)):void(this.isSelected(o)&&(VERSION_WHERE===(VERSION_WHERE&this.$__.version)&&(e[o]=this.getValue(o)),VERSION_INC===(VERSION_INC&this.$__.version)&&(t.$set&&"undefined"!=typeof t.$set[o]||(t.$inc||(t.$inc={}),t.$inc[o]=1))))},Model.prototype.increment=function(){return this.$__.version=VERSION_ALL,this},Model.prototype.$__where=function(e){e||(e={});var t,o;if(e._id||(e._id=this._doc._id),this.$__.shardval){t=Object.keys(this.$__.shardval),o=t.length;for(var i=0;o>i;++i)e[t[i]]=this.$__.shardval[t[i]]}return null==this._doc._id?new Error("No _id found on document!"):e},Model.prototype.remove=function(e,t){if("function"==typeof e&&(t=e,e=void 0),e||(e={}),this.$__.removing)return t&&this.$__.removing.then(function(e){t(null,e)},function(e){t(e)}),this;var o=this,i=PromiseProvider.get();return t&&(t=this.constructor.$wrapCallback(t)),this.$__.removing=new i.ES6(function(i,n){var r=o.$__where();return r instanceof Error?(n(r),void(t&&t(r))):(!e.safe&&o.schema.options.safe&&(e.safe=o.schema.options.safe),void o.collection.remove(r,e,function(e){return e?(n(e),void(t&&t(e))):(o.emit("remove",o),i(o),void(t&&t(null,o)))}))}),this.$__.removing},Model.prototype.model=function(e){return this.db.model(e)},Model.discriminator=function(e,t){function o(t,o){utils.merge(t,o);var r={};r[n]={type:String,"default":e,set:function(){return e}},t.add(r),t.discriminatorMapping={key:n,value:e,isRoot:!1},o.options.collection&&(t.options.collection=o.options.collection);for(var s=t.options.toJSON,a=t.options.toObject,l=t.options._id,u=t.options.id,c=Object.keys(t.options),d=0;d<c.length;++d){var p=c[d];if(!i[p]&&!utils.deepEqual(t.options[p],o.options[p]))throw new Error("Can't customize discriminator option "+p+" (can only modify "+Object.keys(i).join(", ")+")")}t.options=utils.clone(o.options),s&&(t.options.toJSON=s),a&&(t.options.toObject=a),"undefined"!=typeof l&&(t.options._id=l),t.options.id=u,t.callQueue=o.callQueue.concat(t.callQueue.slice(t._defaultMiddleware.length)),t._requiredpaths=void 0}var i={toJSON:!0,toObject:!0,_id:!0,id:!0};if(!t||!t.instanceOfSchema)throw new Error("You must pass a valid discriminator Schema");if(this.schema.discriminatorMapping&&!this.schema.discriminatorMapping.isRoot)throw new Error('Discriminator "'+e+'" can only be a discriminator of the root model');var n=this.schema.options.discriminatorKey;if(t.path(n))throw new Error('Discriminator "'+e+'" cannot have field with name "'+n+'"');if(o(t,this.schema),this.discriminators||(this.discriminators={}),this.schema.discriminatorMapping||(this.schema.discriminatorMapping={key:n,value:null,isRoot:!0}),this.discriminators[e])throw new Error('Discriminator with name "'+e+'" already exists');if(this.db.models[e])throw new MongooseError.OverwriteModelError(e);return this.discriminators[e]=this.db.model(e,t,this.collection.name),this.discriminators[e].prototype.__proto__=this.prototype,Object.defineProperty(this.discriminators[e],"baseModelName",{value:this.modelName,configurable:!0,writable:!1}),applyMethods(this.discriminators[e],t),applyStatics(this.discriminators[e],t),this.discriminators[e]};/*!
 * Give the constructor the ability to emit events.
 */
for(var i in EventEmitter.prototype)Model[i]=EventEmitter.prototype[i];Model.init=function(){(this.schema.options.autoIndex||null===this.schema.options.autoIndex&&this.db.config.autoIndex)&&this.ensureIndexes({__noPromise:!0}),this.schema.emit("init",this)},Model.ensureIndexes=function(e,t){if("function"==typeof e&&(t=e,e=null),e&&e.__noPromise)return void _ensureIndexes(this,t);t&&(t=this.$wrapCallback(t));var o=this,i=PromiseProvider.get();return new i.ES6(function(e,i){_ensureIndexes(o,function(o){o&&(t&&t(o),i(o)),t&&t(),e()})})},Model.schema,/*!
 * Connection instance the model uses.
 *
 * @property db
 * @receiver Model
 * @api public
 */
Model.db,/*!
 * Collection the model uses.
 *
 * @property collection
 * @receiver Model
 * @api public
 */
Model.collection,Model.base,Model.discriminators,Model.remove=function(e,t){"function"==typeof e&&(t=e,e={});var o=new this.Query(e,{},this,this.collection);return t&&(t=this.$wrapCallback(t)),o.remove(t)},Model.find=function(e,t,o,i){"function"==typeof e?(i=e,e={},t=null,o=null):"function"==typeof t?(i=t,t=null,o=null):"function"==typeof o&&(i=o,o=null);var n=new this.Query({},{},this,this.collection);return n.select(t),n.setOptions(o),this.schema.discriminatorMapping&&n.selectedInclusively()&&n.select(this.schema.options.discriminatorKey),i&&(i=this.$wrapCallback(i)),n.find(e,i)},Model.findById=function(e,t,o,i){return"undefined"==typeof e&&(e=null),i&&(i=this.$wrapCallback(i)),this.findOne({_id:e},t,o,i)},Model.findOne=function(e,t,o,i){"function"==typeof o?(i=o,o=null):"function"==typeof t?(i=t,t=null,o=null):"function"==typeof e&&(i=e,e={},t=null,o=null);var n=new this.Query({},{},this,this.collection);return n.select(t),n.setOptions(o),this.schema.discriminatorMapping&&n.selectedInclusively()&&n.select(this.schema.options.discriminatorKey),i&&(i=this.$wrapCallback(i)),n.findOne(e,i)},Model.count=function(e,t){"function"==typeof e&&(t=e,e={});var o=new this.Query({},{},this,this.collection);return t&&(t=this.$wrapCallback(t)),o.count(e,t)},Model.distinct=function(e,t,o){var i=new this.Query({},{},this,this.collection);return"function"==typeof t&&(o=t,t={}),o&&(o=this.$wrapCallback(o)),i.distinct(e,t,o)},Model.where=function(e,t){var o=new this.Query({},{},this,this.collection).find({});return o.where.apply(o,arguments)},Model.$where=function(){var e=new this.Query({},{},this,this.collection).find({});return e.$where.apply(e,arguments)},Model.findOneAndUpdate=function(e,t,o,i){if("function"==typeof o)i=o,o=null;else if(1===arguments.length){if("function"==typeof e){var n="Model.findOneAndUpdate(): First argument must not be a function.\n\n  "+this.modelName+".findOneAndUpdate(conditions, update, options, callback)\n  "+this.modelName+".findOneAndUpdate(conditions, update, options)\n  "+this.modelName+".findOneAndUpdate(conditions, update)\n  "+this.modelName+".findOneAndUpdate(update)\n  "+this.modelName+".findOneAndUpdate()\n";throw new TypeError(n)}t=e,e=void 0}i&&(i=this.$wrapCallback(i));var r;o&&o.fields&&(r=o.fields),t=utils.clone(t,{depopulate:1}),this.schema.options.versionKey&&o&&o.upsert&&(t.$setOnInsert||(t.$setOnInsert={}),t.$setOnInsert[this.schema.options.versionKey]=0);var s=new this.Query({},{},this,this.collection);return s.select(r),s.findOneAndUpdate(e,t,o,i)},Model.findByIdAndUpdate=function(e,t,o,i){if(i&&(i=this.$wrapCallback(i)),1===arguments.length){if("function"==typeof e){var n="Model.findByIdAndUpdate(): First argument must not be a function.\n\n  "+this.modelName+".findByIdAndUpdate(id, callback)\n  "+this.modelName+".findByIdAndUpdate(id)\n  "+this.modelName+".findByIdAndUpdate()\n";throw new TypeError(n)}return this.findOneAndUpdate({_id:e},void 0)}return e instanceof Document&&(e=e._id),this.findOneAndUpdate.call(this,{_id:e},t,o,i)},Model.findOneAndRemove=function(e,t,o){if(1===arguments.length&&"function"==typeof e){var i="Model.findOneAndRemove(): First argument must not be a function.\n\n  "+this.modelName+".findOneAndRemove(conditions, callback)\n  "+this.modelName+".findOneAndRemove(conditions)\n  "+this.modelName+".findOneAndRemove()\n";throw new TypeError(i)}"function"==typeof t&&(o=t,t=void 0),o&&(o=this.$wrapCallback(o));var n;t&&(n=t.select,t.select=void 0);var r=new this.Query({},{},this,this.collection);return r.select(n),r.findOneAndRemove(e,t,o)},Model.findByIdAndRemove=function(e,t,o){if(1===arguments.length&&"function"==typeof e){var i="Model.findByIdAndRemove(): First argument must not be a function.\n\n  "+this.modelName+".findByIdAndRemove(id, callback)\n  "+this.modelName+".findByIdAndRemove(id)\n  "+this.modelName+".findByIdAndRemove()\n";throw new TypeError(i)}return o&&(o=this.$wrapCallback(o)),this.findOneAndRemove({_id:e},t,o)},Model.create=function(e,t){var o,i;if(Array.isArray(e))o=e,i=t;else{var n=arguments[arguments.length-1];"function"==typeof n?(i=n,o=utils.args(arguments,0,arguments.length-1)):o=utils.args(arguments)}var r=PromiseProvider.get(),s=this;i&&(i=this.$wrapCallback(i));var a=new r.ES6(function(t,n){if(0===o.length)return void process.nextTick(function(){i&&i(null),t(null)});var r=[];o.forEach(function(e){r.push(function(t){var o=new s(e),i=function(e,o){return e?t(e):void t(null,o)};o.$__original_save?o.$__original_save({__noPromise:!0},i):o.save({__noPromise:!0},i)})}),async.parallel(r,function(o,r){return o?(i&&i(o),void n(o)):void(e instanceof Array?(t(r),i&&i.call(s,null,r)):(t.apply(a,r),i&&(r.unshift(null),i.apply(s,r))))})});return a},Model.insertMany=function(e,t){var o=this;t&&(t=this.$wrapCallback(t));var i=[];e.forEach(function(e){i.push(function(t){e=new o(e),e.validate({__noPromise:!0},function(o){return o?t(o):void t(null,e)})})}),async.parallel(i,function(e,i){if(e)return void(t&&t(e));var n=i.map(function(e){return e.initializeTimestamps?e.initializeTimestamps().toObject({virtuals:!1}):e.toObject({virtuals:!1})});o.collection.insertMany(n,function(e){if(e)return void(t&&t(e));for(var o=0;o<i.length;++o)i[o].isNew=!1,i[o].emit("isNew",!1);t&&t(null,i)})})},Model.hydrate=function(e){var t=require("./queryhelpers").createModel(this,e);return t.init(e),t},Model.update=function(e,t,o,i){var n=new this.Query({},{},this,this.collection);return i&&(i=this.$wrapCallback(i)),e=e instanceof Document?e.toObject():utils.clone(e,{retainKeyOrder:!0}),o="function"==typeof o?o:utils.clone(o),n.update(e,t,o,i)},Model.mapReduce=function(e,t){var o=this;t&&(t=this.$wrapCallback(t));var i=PromiseProvider.get();return new i.ES6(function(i,n){if(!Model.mapReduce.schema){var r={noId:!0,noVirtualId:!0,strict:!1};Model.mapReduce.schema=new Schema({},r)}if(e.out||(e.out={inline:1}),e.verbose!==!1&&(e.verbose=!0),e.map=String(e.map),e.reduce=String(e.reduce),e.query){var s=new o.Query(e.query);s.cast(o),e.query=s._conditions,s=void 0}o.collection.mapReduce(null,null,e,function(e,r,s){if(e)return t&&t(e),void n(e);if(r.findOne&&r.mapReduce){var a=Model.compile("_mapreduce_"+r.collectionName,Model.mapReduce.schema,r.collectionName,o.db,o.base);return a._mapreduce=!0,t&&t(null,a,s),i(a,s)}t&&t(null,r,s),i(r,s)})})},Model.geoNear=function(e,t,o){"function"==typeof t&&(o=t,t={}),o&&(o=this.$wrapCallback(o));var i=this,n=PromiseProvider.get();if(!e)return new n.ES6(function(e,t){var i=new Error("Must pass a near option to geoNear");t(i),o&&o(i)});var r,s;return new n.ES6(function(n,a){var l=function(e,r){function s(e){return e&&!u?(u=!0,a(e),void(o&&o(e))):void(--l<=0&&(n(r.results,r.stats),o&&o(null,r.results,r.stats)))}if(e)return a(e),void(o&&o(e));if(t.lean)return n(r.results,r.stats),void(o&&o(null,r.results,r.stats));var l=r.results.length;if(0===l)return n(r.results,r.stats),void(o&&o(null,r.results,r.stats));for(var u=!1,c=0;c<r.results.length;c++){var d=r.results[c].obj;r.results[c].obj=new i,r.results[c].obj.init(d,s)}};if(Array.isArray(e)){if(2!==e.length){var u=new Error("If using legacy coordinates, must be an array of size 2 for geoNear");return a(u),void(o&&o(u))}r=e[0],s=e[1],i.collection.geoNear(r,s,t,l)}else{if("Point"!==e.type||!Array.isArray(e.coordinates))return u=new Error("Must pass either a legacy coordinate array or GeoJSON Point to geoNear"),a(u),void(o&&o(u));i.collection.geoNear(e,t,l)}})},Model.aggregate=function e(){var e,t,o=[].slice.call(arguments);return"function"==typeof o[o.length-1]&&(t=o.pop()),e=new Aggregate(1===o.length&&util.isArray(o[0])?o[0]:o),e.model(this),"undefined"==typeof t?e:(t&&(t=this.$wrapCallback(t)),void e.exec(t))},Model.geoSearch=function(e,t,o){"function"==typeof t&&(o=t,t={}),o&&(o=this.$wrapCallback(o));var i=this,n=PromiseProvider.get();return new n.ES6(function(n,r){var s;return void 0!==e&&utils.isObject(e)?t.near?Array.isArray(t.near)||(s=new Error("near option must be an array [x, y]")):s=new Error("Must specify the near option in geoSearch"):s=new Error("Must pass conditions to geoSearch"),s?(o&&o(s),void r(s)):(t.search=e,void i.collection.geoHaystackSearch(t.near[0],t.near[1],t,function(e,s){function a(e){return e&&!u?(o&&o(e),void r(e)):void(--l||u||(o&&o(null,s.results,s.stats),n(s.results,s.stats)))}if(e)return o&&o(e),void r(e);var l=s.results.length;if(t.lean||0===l)return o&&o(null,s.results,s.stats),void n(s.results,s.stats);for(var u=!1,c=0;c<s.results.length;c++){var d=s.results[c];s.results[c]=new i,s.results[c].init(d,{},a)}}))})},Model.populate=function(e,t,o){var i=this;o&&(o=this.$wrapCallback(o));var n=t&&!!t.__noPromise;t=utils.populate(t);var r={};if(!n){var s=PromiseProvider.get();return new s.ES6(function(n,s){_populate(i,e,t,r,function(e,t){e?(o&&o(e),s(e)):(o&&o(null,t),n(t))})})}_populate(this,e,t,r,o)};/*!
 * Populates `docs`
 */
var excludeIdReg=/\s?-_id\s?/,excludeIdRegGlobal=/\s?-_id\s?/g;Model._getSchema=function(e){return this.schema._getSchema(e)},/*!
 * Compiler utility.
 *
 * @param {String} name model name
 * @param {Schema} schema
 * @param {String} collectionName
 * @param {Connection} connection
 * @param {Mongoose} base mongoose instance
 */
Model.compile=function(e,t,o,i,n){function r(e,t,o){return this instanceof r?void Model.call(this,e,t,o):new r(e,t,o)}var s=t.options.versionKey!==!1;if(s&&!t.paths[t.options.versionKey]){var a={};a[t.options.versionKey]=Number,t.add(a)}r.hooks=t.s.hooks.clone(),r.base=n,r.modelName=e,r.__proto__=Model,r.prototype.__proto__=Model.prototype,r.model=Model.prototype.model,r.db=r.prototype.db=i,r.discriminators=r.prototype.discriminators=void 0,r.prototype.$__setSchema(t);var l={bufferCommands:t.options.bufferCommands,capped:t.options.capped};r.prototype.collection=i.collection(o,l),applyMethods(r,t),applyStatics(r,t),r.schema=r.prototype.schema,r.collection=r.prototype.collection,r.Query=function(){Query.apply(this,arguments)},r.Query.prototype=Object.create(Query.prototype),r.Query.base=Query.base,applyQueryMethods(r,t.query);var u={useErrorHandlers:!0};return r.$__insertMany=r.hooks.createWrapper("insertMany",r.insertMany,r,u),r.insertMany=function(e,t){var o=PromiseProvider.get();return new o.ES6(function(o,i){r.$__insertMany(e,function(e,n){return e?(t&&t(e),i(e)):(t&&t(null,n),void o(n))})})},r};/*!
 * Register methods for this model
 *
 * @param {Model} model
 * @param {Schema} schema
 */
var applyMethods=function(e,t){function o(t,o){Object.defineProperty(e.prototype,t,{get:function(){var e={};for(var i in o.methods[t])e[i]=o.methods[t][i].bind(this);return e},configurable:!0})}for(var i in t.methods)"function"==typeof t.methods[i]?e.prototype[i]=t.methods[i]:o(i,t)},applyStatics=function(e,t){for(var o in t.statics)e[o]=t.statics[o]};/*!
 * Subclass this model with `conn`, `schema`, and `collection` settings.
 *
 * @param {Connection} conn
 * @param {Schema} [schema]
 * @param {String} [collection]
 * @return {Model}
 */
Model.__subclass=function(e,t,o){var i=this,n=function l(e,t,o){return this instanceof l?void i.call(this,e,t,o):new l(e,t,o)};n.__proto__=i,n.prototype.__proto__=i.prototype,n.db=n.prototype.db=e;var r=t&&"string"!=typeof t?t:i.prototype.schema,s=r.options||{};o||(o=i.prototype.schema.get("collection")||utils.toCollectionName(i.modelName,s));var a={bufferCommands:r?s.bufferCommands:!0,capped:r&&s.capped};return n.prototype.collection=e.collection(o,a),n.collection=n.prototype.collection,n.init(),n},Model.$wrapCallback=function(e){var t=this;return function(){try{e.apply(null,arguments)}catch(o){t.emit("error",o)}}},/*!
 * Module exports.
 */
module.exports=exports=Model;