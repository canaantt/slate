"use strict";var flatten=require("./common").flatten,modifiedPaths=require("./common").modifiedPaths;module.exports=function(e,t,n,s){for(var i=Object.keys(n||{}),r={},f={},a=i.length,o=!1,c={},l=0;a>l;++l)if("$"===i[l].charAt(0)){modifiedPaths(n[i[l]],"",c);for(var d=flatten(n[i[l]]),u=Object.keys(d),h=u.length,$=0;h>$;++$){var O=u[$].replace(".$.",".0.");O=O.replace(/\.\$$/,".0"),"$set"===i[l]||"$setOnInsert"===i[l]?f[O]=d[u[$]]:"$unset"===i[l]&&(f[O]=void 0),r[O]=!0}o=!0}if(o||(modifiedPaths(n,"",c),f=flatten(n),r=Object.keys(f)),s&&s.upsert){for(u=Object.keys(e._conditions),h=i.length,l=0;h>l;++l){var m=u[l],v=e._conditions[m];if(v&&"object"==typeof v){var y=Object.keys(v),I=y.length,b=!1;for($=0;I>$;++$)if("$"===y[$].charAt(0)){b=!0;break}if(b)continue}r[m]=!0,c[m]=!0}s.setDefaultsOnInsert&&t.eachPath(function(e,t){if("_id"!==e)if(t.$isSingleNested)t.schema.eachPath(function(t,s){if("_id"!==e){var i=s.getDefault(null,!0);c[e+"."+t]||"undefined"==typeof i||(n=n||{},n.$setOnInsert=n.$setOnInsert||{},n.$setOnInsert[e+"."+t]=i,f[e+"."+t]=i)}});else{var s=t.getDefault(null,!0);c[e]||"undefined"==typeof s||(n=n||{},n.$setOnInsert=n.$setOnInsert||{},n.$setOnInsert[e]=s,f[e]=s)}})}return n};