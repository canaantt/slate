/*!
 * Module dependencies.
 */
function Document(t,e,i){this.$__=new InternalCache,this.$__.emitter=new EventEmitter,this.isNew=!0,this.errors=void 0;var r=this.schema;"boolean"==typeof e?(this.$__.strictMode=e,e=void 0):(this.$__.strictMode=r.options&&r.options.strict,this.$__.selected=e);for(var o=r.requiredPaths(!0),n=0;n<o.length;++n)this.$__.activePaths.require(o[n]);if(this.$__.emitter.setMaxListeners(0),this._doc=this.$__buildDoc(t,e,i),t&&(t instanceof Document&&(this.isNew=t.isNew),this.set(t,void 0,!0)),!r.options.strict&&t){var s=this,a=Object.keys(this._doc);a.forEach(function(t){t in r.tree||defineKey(t,null,s)})}this.$__registerHooksFromSchema()}/*!
 * Init helper.
 *
 * @param {Object} self document instance
 * @param {Object} obj raw mongodb doc
 * @param {Object} doc object we are initializing
 * @api private
 */
function init(t,e,i,r){r=r||"";for(var o,n,s,a=Object.keys(e),c=a.length;c--;)if(s=a[c],n=r+s,o=t.schema.path(n),o||!utils.isObject(e[s])||e[s].constructor&&"Object"!==utils.getFunctionName(e[s].constructor)){if(null===e[s])i[s]=null;else if(void 0!==e[s])if(o)try{i[s]=o.cast(e[s],t,!0)}catch(u){t.invalidate(u.path,new ValidatorError({path:u.path,message:u.message,type:"cast",value:u.value}))}else i[s]=e[s];t.isModified(n)||t.$__.activePaths.init(n)}else i[s]||(i[s]={}),init(t,e[s],i[s],n+".")}/*!
 * ignore
 */
function cleanModifiedSubpaths(t,e){for(var i=Object.keys(t.$__.activePaths.states.modify),r=i.length,o=0;r>o;++o)0===i[o].indexOf(e+".")&&delete t.$__.activePaths.states.modify[i[o]]}/*!
 * ignore
 */
function _getPathsToValidate(t){var e=Object.keys(t.$__.activePaths.states.require).filter(function(e){if(!t.isSelected(e)&&!t.isModified(e))return!1;var i=t.schema.path(e);return"function"==typeof i.originalRequiredValue?i.originalRequiredValue.call(t):!0});e=e.concat(Object.keys(t.$__.activePaths.states.init)),e=e.concat(Object.keys(t.$__.activePaths.states.modify)),e=e.concat(Object.keys(t.$__.activePaths.states["default"]));for(var i=0;i<e.length;++i){var r=e[i],o=t.getValue(r);if(o&&o.isMongooseArray&&!Buffer.isBuffer(o)&&!o.isMongooseDocumentArray)for(var n=o.length,s=0;n>s;++s)e.push(r+"."+s)}var a={skipArrays:!0};for(i=0;i<e.length;++i){var c=e[i];if(t.schema.nested[c]){var u=t.getValue(c);isMongooseObject(u)&&(u=u.toObject({virtuals:!1}));var h=flatten(u,"",a),l=Object.keys(h).map(function(t){return c+"."+t});e=e.concat(l)}}return e}/*!
 * Compiles schemas.
 */
function compile(t,e,i,r){for(var o,n,s=Object.keys(t),a=s.length;a--;)n=s[a],o=t[n],defineKey(n,"Object"===utils.getFunctionName(o.constructor)&&Object.keys(o).length&&(!o[r.typeKey]||"type"===r.typeKey&&o.type.type)?o:null,e,i,s,r)}function getOwnPropertyDescriptors(t){var e={};return Object.getOwnPropertyNames(t).forEach(function(i){e[i]=Object.getOwnPropertyDescriptor(t,i),e[i].enumerable=!0}),e}/*!
 * Defines the accessor named prop on the incoming prototype.
 */
function defineKey(t,e,i,r,o,n){var s=(r?r+".":"")+t;r=r||"",e?Object.defineProperty(i,t,{enumerable:!0,configurable:!0,get:function(){var t=this;if(this.$__.getters||(this.$__.getters={}),!this.$__.getters[s]){var i=Object.create(Object.getPrototypeOf(this),getOwnPropertyDescriptors(this));r||(i.$__.scope=this);for(var a=0,c=o.length;c>a;++a)Object.defineProperty(i,o[a],{enumerable:!1,writable:!0,configurable:!0,value:void 0});Object.defineProperty(i,"toObject",{enumerable:!0,configurable:!0,writable:!1,value:function(){return t.get(s)}}),Object.defineProperty(i,"toJSON",{enumerable:!0,configurable:!0,writable:!1,value:function(){return t.get(s)}}),Object.defineProperty(i,"$__isNested",{enumerable:!0,configurable:!0,writable:!1,value:!0}),compile(e,i,s,n),this.$__.getters[s]=i}return this.$__.getters[s]},set:function(t){return t instanceof Document&&(t=t.toObject()),(this.$__.scope||this).set(s,t)}}):Object.defineProperty(i,t,{enumerable:!0,configurable:!0,get:function(){return this.get.call(this.$__.scope||this,s)},set:function(t){return this.set.call(this.$__.scope||this,s,t)}})}/*!
 * Minimizes an object, removing undefined values and empty objects
 *
 * @param {Object} object to minimize
 * @return {Object}
 */
function minimize(t){for(var e,i,r,o=Object.keys(t),n=o.length;n--;)i=o[n],r=t[i],utils.isObject(r)&&(t[i]=minimize(r)),void 0!==t[i]?e=!0:delete t[i];return e?t:void 0}/*!
 * Applies virtuals properties to `json`.
 *
 * @param {Document} self
 * @param {Object} json
 * @param {String} type either `virtuals` or `paths`
 * @return {Object} `json`
 */
function applyGetters(t,e,i,r){for(var o,n=t.schema,s=Object.keys(n[i]),a=s.length;a--;){o=s[a];for(var c,u=o.split("."),h=u.length,l=h-1,p=e,d=0;h>d;++d)c=u[d],d===l?p[c]=clone(t.get(o),r):p=p[c]||(p[c]={})}return e}var EventEmitter=require("events").EventEmitter,MongooseError=require("./error"),MixedSchema=require("./schema/mixed"),Schema=require("./schema"),ObjectExpectedError=require("./error/objectExpected"),StrictModeError=require("./error/strict"),ValidatorError=require("./schematype").ValidatorError,VersionError=require("./error").VersionError,utils=require("./utils"),clone=utils.clone,isMongooseObject=utils.isMongooseObject,inspect=require("util").inspect,ValidationError=MongooseError.ValidationError,InternalCache=require("./internal"),deepEqual=utils.deepEqual,hooks=require("hooks-fixed"),PromiseProvider=require("./promise_provider"),DocumentArray,MongooseArray,Embedded,flatten=require("./services/common").flatten;/*!
 * Document exposes the NodeJS event emitter API, so you can use
 * `on`, `once`, etc.
 */
utils.each(["on","once","emit","listeners","removeListener","setMaxListeners","removeAllListeners","addListener"],function(t){Document.prototype[t]=function(){return this.$__.emitter[t].apply(this.$__.emitter,arguments)}}),Document.prototype.constructor=Document,Document.prototype.schema,Document.prototype.isNew,Document.prototype.id,Document.prototype.errors,Document.prototype.$__buildDoc=function(t,e,i){var r,o,n={},s=null,a=this;if(e&&"Object"===utils.getFunctionName(e.constructor))if(r=Object.keys(e),o=r.length,1===o&&"_id"===r[0])s=!!e[r[o]];else for(;o--;)if("_id"!==r[o]&&(!e[r[o]]||"object"!=typeof e[r[o]])){s=!e[r[o]];break}for(var c=Object.keys(this.schema.paths),u=c.length,h=0;u>h;++h){var l=c[h];if("_id"===l){if(i)continue;if(t&&"_id"in t)continue}for(var p=this.schema.paths[l],d=l.split("."),f=d.length,_=f-1,m="",v=n,y=0,g=!1;f>y;++y){var $,b=d[y];if(m+=b,s===!0){if(m in e)break}else e&&m in e&&(g=!0);if(y===_)if(e&&null!==s)if(s===!0){if(l in e)continue;$=p.getDefault(a,!0),"undefined"!=typeof $&&(v[b]=$,a.$__.activePaths["default"](l))}else g&&($=p.getDefault(a,!0),"undefined"!=typeof $&&(v[b]=$,a.$__.activePaths["default"](l)));else $=p.getDefault(a,!0),"undefined"!=typeof $&&(v[b]=$,a.$__.activePaths["default"](l));else v=v[b]||(v[b]={}),m+="."}}return n},Document.prototype.init=function(t,e,i){if("function"==typeof e&&(i=e,e=null),this.isNew=!1,null!==t._id&&void 0!==t._id&&e&&e.populated&&e.populated.length)for(var r=String(t._id),o=0;o<e.populated.length;++o){var n=e.populated[o];this.populated(n.path,n._docs[r],n)}return init(this,t,this._doc),this.$__storeShard(),this.emit("init",this),i&&i(null),this},Document.prototype.$__storeShard=function(){var t=this.schema.options.shardKey||this.schema.options.shardkey;if(t&&"Object"===utils.getFunctionName(t.constructor))for(var e,i=this.$__.shardval={},r=Object.keys(t),o=r.length,n=0;o>n;++n)e=this.getValue(r[n]),isMongooseObject(e)?i[r[n]]=e.toObject({depopulate:!0}):null===e||void 0===e||!e.valueOf||e.constructor&&"Date"===utils.getFunctionName(e.constructor)?i[r[n]]=e:i[r[n]]=e.valueOf()};/*!
 * Set up middleware support
 */
for(var k in hooks)"pre"===k||"post"===k?Document.prototype["$"+k]=Document["$"+k]=hooks[k]:Document.prototype[k]=Document[k]=hooks[k];Document.prototype.update=function(){var t=utils.args(arguments);return t.unshift({_id:this._id}),this.constructor.update.apply(this.constructor,t)},Document.prototype.set=function(t,e,i,r){i&&"Object"===utils.getFunctionName(i.constructor)&&(r=i,i=void 0);var o,n=r&&r.merge,s=i&&i!==!0,a=i===!0,c=r&&"strict"in r?r.strict:this.$__.strictMode;if(s&&(o=this.$__.adhocPaths||(this.$__.adhocPaths={}),o[t]=Schema.interpretAsType(t,i,this.schema.options)),"string"!=typeof t){if(null!==t&&void 0!==t){var u=e?e+".":"";t instanceof Document&&(t=t.$__isNested?t.toObject():t._doc);var h,l,p=Object.keys(t),d=p.length;if(0===d&&!this.schema.options.minimize)return e&&this.set(e,{}),this;for(;d--;){l=p[d];var f=u+l;if(h=this.schema.pathType(f),null===t[l]||void 0===t[l]||!utils.isObject(t[l])||t[l].constructor&&"Object"!==utils.getFunctionName(t[l].constructor)||"virtual"===h||"real"===h||this.$__path(f)instanceof MixedSchema||this.schema.paths[f]&&this.schema.paths[f].options&&this.schema.paths[f].options.ref)if(c){if(a&&void 0===t[l]&&void 0!==this.get(l))continue;if("real"===h||"virtual"===h)this.schema.paths[f]&&this.schema.paths[f].$isSingleNested&&t[l]instanceof Document&&(t[l]=t[l].toObject({virtuals:!1})),this.set(u+l,t[l],a);else if("nested"===h&&t[l]instanceof Document)this.set(u+l,t[l].toObject({virtuals:!1}),a);else if("throw"===c)throw"nested"===h?new ObjectExpectedError(l,t[l]):new StrictModeError(l)}else void 0!==t[l]&&this.set(u+l,t[l],a);else this.set(t[l],u+l,a)}return this}var _=t;t=e,e=_}var m=this.schema.pathType(t);if("nested"===m&&e)return!utils.isObject(e)||e.constructor&&"Object"!==utils.getFunctionName(e.constructor)?(this.invalidate(t,new MongooseError.CastError("Object",e,t)),this):(n||(this.setValue(t,null),cleanModifiedSubpaths(this,t)),0===Object.keys(e).length?(this.setValue(t,{}),this.markModified(t),cleanModifiedSubpaths(this,t)):this.set(e,t,a),this);var v,y=t.split(".");if("adhocOrUndefined"===m&&c){var g;for(d=0;d<y.length;++d){var $=y.slice(0,d+1).join(".");if(v=this.schema.path($),v instanceof MixedSchema){g=!0;break}}if(!g){if("throw"===c)throw new StrictModeError(t);return this}}else{if("virtual"===m)return v=this.schema.virtualpath(t),v.applySetters(e,this),this;v=this.$__path(t)}var b;if(y.length<=1)b=t;else{for(d=0;d<y.length;++d)if($=y.slice(0,d+1).join("."),this.isDirectModified($)||null===this.get($)){b=$;break}b||(b=t)}var O=a?void 0:this.getValue(t);if(!v)return this.$__set(b,t,a,y,v,e,O),this;var D=!0;try{var E=!1;v.options&&v.options.ref&&e instanceof Document&&v.options.ref===e.constructor.modelName&&(this.ownerDocument?this.ownerDocument().populated(this.$__fullPath(t),e._id,{model:e.constructor}):this.populated(t,e._id,{model:e.constructor}),E=!0);var j;v.options&&Array.isArray(v.options.type)&&v.options.type.length&&v.options.type[0].ref&&Array.isArray(e)&&e.length>0&&e[0]instanceof Document&&e[0].constructor.modelName&&v.options.type[0].ref===e[0].constructor.modelName&&(this.ownerDocument?(j={model:e[0].constructor},this.ownerDocument().populated(this.$__fullPath(t),e.map(function(t){return t._id}),j)):(j={model:e[0].constructor},this.populated(t,e.map(function(t){return t._id}),j)),E=!0),e=v.applySetters(e,this,!1,O),!E&&this.$__.populated&&delete this.$__.populated[t],this.$markValid(t)}catch(k){this.invalidate(t,new MongooseError.CastError(v.instance,e,t,k)),D=!1}return v.$isSingleNested&&cleanModifiedSubpaths(this,t),D&&this.$__set(b,t,a,y,v,e,O),this},Document.prototype.$__shouldModify=function(t,e,i,r,o,n,s){return this.isNew?!0:void 0!==n||this.isSelected(e)?void 0===n&&e in this.$__.activePaths.states["default"]?!1:this.populated(e)&&n instanceof Document&&deepEqual(n._id,s)?!1:deepEqual(n,s||this.get(e))?!i&&null!==n&&void 0!==n&&e in this.$__.activePaths.states["default"]&&deepEqual(n,o.getDefault(this,i))?!0:!1:!0:!0},Document.prototype.$__set=function(t,e,i,r,o,n,s){Embedded=Embedded||require("./types/embedded");var a=this.$__shouldModify(t,e,i,r,o,n,s),c=this;a&&(this.markModified(t,n),MongooseArray||(MongooseArray=require("./types/array")),n&&n.isMongooseArray&&(n._registerAtomic("$set",n),this.$__.activePaths.forEach(function(t){0===t.indexOf(e+".")&&c.$__.activePaths.ignore(t)})));for(var u=this._doc,h=0,l=r.length;l>h;h++){var p=h+1,d=p===l;d?u[r[h]]=n:u=u[r[h]]&&"Object"===utils.getFunctionName(u[r[h]].constructor)?u[r[h]]:u[r[h]]&&u[r[h]]instanceof Embedded?u[r[h]]:u[r[h]]&&u[r[h]].$isSingleNested?u[r[h]]:u[r[h]]&&Array.isArray(u[r[h]])?u[r[h]]:u[r[h]]={}}},Document.prototype.getValue=function(t){return utils.getValue(t,this._doc)},Document.prototype.setValue=function(t,e){return utils.setValue(t,e,this._doc),this},Document.prototype.get=function(t,e){var i;e&&(i=Schema.interpretAsType(t,e,this.schema.options));for(var r=this.$__path(t)||this.schema.virtualpath(t),o=t.split("."),n=this._doc,s=0,a=o.length;a>s;s++)n=null===n||void 0===n?void 0:n[o[s]];return i&&(n=i.cast(n)),r&&!this.populated(t)&&(n=r.applyGetters(n,this)),n},Document.prototype.$__path=function(t){var e=this.$__.adhocPaths,i=e&&e[t];return i?i:this.schema.path(t)},Document.prototype.markModified=function(t){this.$__.activePaths.modify(t)},Document.prototype.unmarkModified=function(t){this.$__.activePaths.init(t)},Document.prototype.modifiedPaths=function(){var t=Object.keys(this.$__.activePaths.states.modify);return t.reduce(function(t,e){var i=e.split(".");return t.concat(i.reduce(function(t,e,r){return t.concat(i.slice(0,r).concat(e).join("."))},[]).filter(function(e){return-1===t.indexOf(e)}))},[])},Document.prototype.isModified=function(t){return t?!!~this.modifiedPaths().indexOf(t):this.$__.activePaths.some("modify")},Document.prototype.$isDefault=function(t){return t in this.$__.activePaths.states["default"]},Document.prototype.isDirectModified=function(t){return t in this.$__.activePaths.states.modify},Document.prototype.isInit=function(t){return t in this.$__.activePaths.states.init},Document.prototype.isSelected=function(t){if(this.$__.selected){if("_id"===t)return 0!==this.$__.selected._id;var e,i=Object.keys(this.$__.selected),r=i.length,o=!1;if(1===r&&"_id"===i[0])return 0===this.$__.selected._id;for(;r--;)if(e=i[r],"_id"!==e){o=!!this.$__.selected[e];break}if(t in this.$__.selected)return o;r=i.length;for(var n=t+".";r--;)if(e=i[r],"_id"!==e){if(0===e.indexOf(n))return o;if(0===n.indexOf(e+"."))return o}return!o}return!0},Document.prototype.validate=function(t,e){"function"==typeof t&&(e=t,t=null),this.$__validate(e)},/*!
 * ignore
 */
Document.prototype.$__validate=function(t){var e=this,i=function(){var t=e.$__.validationError;if(e.$__.validationError=void 0,e.emit("validate",e),t){for(var i in t.errors)!e.__parent&&t.errors[i]instanceof MongooseError.CastError&&e.invalidate(i,t.errors[i]);return t}},r=_getPathsToValidate(this);0===r.length&&process.nextTick(function(){var e=i();return e?void t(e):void t()});var o={},n=0,s=function(){var e=i();return e?void t(e):void t()},a=function(t){o[t]||(o[t]=!0,n++,process.nextTick(function(){var i=e.schema.path(t);if(!i)return--n||s();if(!e.$isValid(t))return void(--n||s());var r=e.getValue(t);i.doValidate(r,function(i){i&&e.invalidate(t,i,void 0,!0),--n||s()},e)}))};r.forEach(a)},Document.prototype.validateSync=function(t){var e=this;"string"==typeof t&&(t=t.split(" "));var i=_getPathsToValidate(this);if(t&&t.length){for(var r=[],o=0;o<i.length;++o)-1!==t.indexOf(i[o])&&r.push(i[o]);i=r}var n={};i.forEach(function(t){if(!n[t]){n[t]=!0;var i=e.schema.path(t);if(i&&e.$isValid(t)){var r=e.getValue(t),o=i.doValidateSync(r,e);o&&e.invalidate(t,o,void 0,!0)}}});var s=e.$__.validationError;if(e.$__.validationError=void 0,e.emit("validate",e),s)for(var a in s.errors)s.errors[a]instanceof MongooseError.CastError&&e.invalidate(a,s.errors[a]);return s},Document.prototype.invalidate=function(t,e,i,r){return this.$__.validationError||(this.$__.validationError=new ValidationError(this)),this.$__.validationError.errors[t]?void 0:(e&&"string"!=typeof e||(e=new ValidatorError({path:t,message:e,type:r||"user defined",value:i})),this.$__.validationError===e?this.$__.validationError:(this.$__.validationError.errors[t]=e,this.$__.validationError))},Document.prototype.$markValid=function(t){this.$__.validationError&&this.$__.validationError.errors[t]&&(delete this.$__.validationError.errors[t],0===Object.keys(this.$__.validationError.errors).length&&(this.$__.validationError=null))},Document.prototype.$isValid=function(t){return!this.$__.validationError||!this.$__.validationError.errors[t]},Document.prototype.$__reset=function(){var t=this;return DocumentArray||(DocumentArray=require("./types/documentarray")),this.$__.activePaths.map("init","modify",function(e){return t.getValue(e)}).filter(function(t){return t&&t instanceof Array&&t.isMongooseDocumentArray&&t.length}).forEach(function(t){for(var e=t.length;e--;){var i=t[e];i&&i.$__reset()}}),this.$__dirty().forEach(function(t){var e=t.value;e&&e._atomics&&(e._atomics={})}),this.$__.activePaths.clear("modify"),this.$__.activePaths.clear("default"),this.$__.validationError=void 0,this.errors=void 0,t=this,this.schema.requiredPaths().forEach(function(e){t.$__.activePaths.require(e)}),this},Document.prototype.$__dirty=function(){var t=this,e=this.$__.activePaths.map("modify",function(e){return{path:e,value:t.getValue(e),schema:t.$__path(e)}});e=e.concat(this.$__.activePaths.map("default",function(e){return"_id"!==e&&t.getValue(e)?{path:e,value:t.getValue(e),schema:t.$__path(e)}:void 0})),e.sort(function(t,e){return t.path<e.path?-1:t.path>e.path?1:0});var i,r,o=[];return e.forEach(function(t){t&&(0!==t.path.indexOf(i)?(i=t.path+".",o.push(t),r=t):r.value&&r.value._atomics&&r.value.hasAtomics()&&(r.value._atomics={},r.value._atomics.$set=r.value))}),r=i=null,o},Document.prototype.$__setSchema=function(t){compile(t.tree,this,void 0,t.options),this.schema=t},Document.prototype.$__getArrayPathsToValidate=function(){return DocumentArray||(DocumentArray=require("./types/documentarray")),this.$__.activePaths.map("init","modify",function(t){return this.getValue(t)}.bind(this)).filter(function(t){return t&&t instanceof Array&&t.isMongooseDocumentArray&&t.length}).reduce(function(t,e){return t.concat(e)},[]).filter(function(t){return t})},Document.prototype.$__getAllSubdocs=function(){function t(e,i){var r=this[i];return r instanceof Embedded&&e.push(r),r&&r.$isSingleNested&&(e=Object.keys(r._doc).reduce(t.bind(r._doc),e),e.push(r)),r&&r.isMongooseDocumentArray?r.forEach(function(i){i&&i._doc&&(i instanceof Embedded&&e.push(i),e=Object.keys(i._doc).reduce(t.bind(i._doc),e))}):r instanceof Document&&r.$__isNested&&(r=r.toObject(),r&&(e=Object.keys(r).reduce(t.bind(r),e))),e}DocumentArray||(DocumentArray=require("./types/documentarray")),Embedded=Embedded||require("./types/embedded");var e=Object.keys(this._doc).reduce(t.bind(this),[]);return e},Document.prototype.$__registerHooksFromSchema=function(){Embedded=Embedded||require("./types/embedded");var t=PromiseProvider.get(),e=this,i=e.schema&&e.schema.callQueue;if(!i.length)return e;var r=i.reduce(function(t,i){if("pre"!==i[0]&&"post"!==i[0]&&"on"!==i[0])return e[i[0]].apply(e,i[1]),t;var r=[].slice.call(i[1]),o="on"===i[0]?"post":r[0];return o in t||(t[o]={post:[],pre:[]}),"post"===i[0]?t[o].post.push(r):"on"===i[0]?t[o].push(r):t[o].pre.push(r),t},{post:[]});return r.post.forEach(function(t){e.on.apply(e,t)}),delete r.post,r.init&&e instanceof Embedded?(r.init.pre&&r.init.pre.forEach(function(t){e.$pre.apply(e,t)}),r.init.post&&r.init.post.forEach(function(t){e.$post.apply(e,t)}),delete r.init):r.set&&(r.set.pre&&r.set.pre.forEach(function(t){e.$pre.apply(e,t)}),r.set.post&&r.set.post.forEach(function(t){e.$post.apply(e,t)}),delete r.set),Object.keys(r).forEach(function(i){var o="$__original_"+i;e[i]&&(e[o]=e[i],e[i]=function(){var i,r,n=[].slice.call(arguments),s=n.pop(),a=(new Error).stack;s&&"function"!=typeof s?n.push(s):i=s;var c=new t.ES6(function(t,i){n.push(function(o){return o?(o instanceof VersionError&&(o.stack=a),e.$__handleReject(o),void i(o)):(r=Array.prototype.slice.call(arguments,1),void t.apply(c,r))}),e[o].apply(e,n)});return i?(e.constructor.$wrapCallback&&(i=e.constructor.$wrapCallback(i)),c.then(function(){process.nextTick(function(){i.apply(null,[null].concat(r))})},function(t){process.nextTick(function(){i(t)})})):c},r[i].pre.forEach(function(t){t[0]=o,e.$pre.apply(e,t)}),r[i].post.forEach(function(t){t[0]=o,e.$post.apply(e,t)}))}),e},Document.prototype.$__handleReject=function(t){this.listeners("error").length?this.emit("error",t):this.constructor.listeners&&this.constructor.listeners("error").length?this.constructor.emit("error",t):this.listeners&&this.listeners("error").length&&this.emit("error",t)},Document.prototype.$toObject=function(t,e){var i={transform:!0,json:e};if(t&&t.depopulate&&!t._skipDepopulateTopLevel&&this.$__.wasPopulated)return clone(this._id,t);t&&t._skipDepopulateTopLevel&&(t._skipDepopulateTopLevel=!1),(!t||"Object"!==utils.getFunctionName(t.constructor)||t&&t._useSchemaOptions)&&(e?(t=this.schema.options.toJSON?clone(this.schema.options.toJSON):{},t.json=!0,t._useSchemaOptions=!0):(t=this.schema.options.toObject?clone(this.schema.options.toObject):{},t.json=!1,t._useSchemaOptions=!0));for(var r in i)void 0===t[r]&&(t[r]=i[r]);"minimize"in t||(t.minimize=this.schema.options.minimize);var o=t.transform,n=clone(this._doc,t)||{};t.getters&&(applyGetters(this,n,"paths",t),t.minimize&&(n=minimize(n)||{})),(t.virtuals||t.getters&&t.virtuals!==!1)&&applyGetters(this,n,"virtuals",t),t.versionKey===!1&&this.schema.options.versionKey&&delete n[this.schema.options.versionKey];var s=t.transform;if(s===!0||this.schema.options.toObject&&s){var a=t.json?this.schema.options.toJSON:this.schema.options.toObject;a&&(s="function"==typeof t.transform?t.transform:a.transform)}else t.transform=o;if("function"==typeof s){var c=s(this,n,t);"undefined"!=typeof c&&(n=c)}return n},Document.prototype.toObject=function(t){return this.$toObject(t)},Document.prototype.toJSON=function(t){return this.$toObject(t,!0)},Document.prototype.inspect=function(t){var e,i=t&&"Object"===utils.getFunctionName(t.constructor);return i&&(e=t,e.minimize=!1,e.retainKeyOrder=!0),this.toObject(e)},Document.prototype.toString=function(){return inspect(this.inspect())},Document.prototype.equals=function(t){if(!t)return!1;var e=this.get("_id"),i=t.get?t.get("_id"):t;return e||i?e&&e.equals?e.equals(i):e===i:deepEqual(this,t)},Document.prototype.populate=function(){if(0===arguments.length)return this;var t,e=this.$__.populate||(this.$__.populate={}),i=utils.args(arguments);if("function"==typeof i[i.length-1]&&(t=i.pop()),i.length)for(var r=utils.populate.apply(null,i),o=0;o<r.length;++o)e[r[o].path]=r[o];if(t){var n=utils.object.vals(e);this.$__.populate=void 0,n.__noPromise=!0,this.constructor.populate(this,n,t)}return this},Document.prototype.execPopulate=function(){var t=PromiseProvider.get(),e=this;return new t.ES6(function(t,i){e.populate(function(e,r){e?i(e):t(r)})})},Document.prototype.populated=function(t,e,i){if(null===e||void 0===e){if(!this.$__.populated)return void 0;var r=this.$__.populated[t];return r?r.value:void 0}return e===!0?this.$__.populated?this.$__.populated[t]:void 0:(this.$__.populated||(this.$__.populated={}),this.$__.populated[t]={value:e,options:i},e)},Document.prototype.depopulate=function(t){var e=this.populated(t);e&&(delete this.$__.populated[t],this.set(t,e))},Document.prototype.$__fullPath=function(t){return t||""},/*!
 * Module exports.
 */
Document.ValidationError=ValidationError,module.exports=exports=Document;