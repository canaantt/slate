/*!
 * Module dependencies.
 */
function QueryCursor(r,e){Readable.call(this,{objectMode:!0}),this.cursor=null,this.query=r;var n=this,o=r.model;o.collection.find(r._conditions,e,function(r,e){return r?n.emit("error",r):(n.cursor=e,void n.emit("cursor",e))})}/*!
 * Get the next doc from the underlying cursor and mongooseify it
 * (populate, etc.)
 */
function _next(r,e){r.cursor?r.cursor.next(function(n,o){if(n)return e(n);if(!o)return e(null,null);var t=r.query._mongooseOptions;if(!t.populate)return t.lean===!0?e(null,o):_create(r,o,null,e);var u=helpers.preparePopulationOptionsMQ(r.query,r.query._mongooseOptions);u.forEach(function(r){delete r.model}),u.__noPromise=!0,r.query.model.populate(o,u,function(n,o){return n?e(n):t.lean===!0?e(null,o):_create(r,o,u,e)})}):r.once("cursor",function(){_next(r,e)})}/*!
 * Convert a raw doc into a full mongoose doc.
 */
function _create(r,e,n,o){var t=helpers.createModel(r.query.model,e,r.query._fields),u=n?{populated:n}:void 0;t.init(e,u,function(r){return r?o(r):void o(null,t)})}var PromiseProvider=require("./promise_provider"),Readable=require("stream").Readable,helpers=require("./queryhelpers"),util=require("util");util.inherits(QueryCursor,Readable),/*!
 * Necessary to satisfy the Readable API
 */
QueryCursor.prototype._read=function(){var r=this;_next(this,function(e,n){return e?r.emit("error",e):n?void r.push(n):(r.push(null),r.cursor.close(function(e){return e?r.emit("error",e):void r.emit("close")}))})},QueryCursor.prototype.close=function(r){var e=PromiseProvider.get(),n=this;return new e.ES6(function(e,o){n.cursor.close(function(t){return t?(r&&r(t),o(t),n.emit("error",t)):(n.emit("close"),e(),void(r&&r()))})})},QueryCursor.prototype.next=function(r){var e=PromiseProvider.get(),n=this;return new e.ES6(function(e,o){_next(n,function(n,t){return n?(r&&r(n),o(n)):(r&&r(null,t),void e(t))})})},QueryCursor.prototype.eachAsync=function(r,e){var n=PromiseProvider.get(),o=this,t=function(e,n){var o=r(e);o&&"function"==typeof o.then?o.then(function(){n(null)},function(r){n(r)}):n(null)},u=function(r){return _next(o,function(e,n){return e?r(e):n?void t(n,function(e){return e?r(e):void u(r)}):r(null)})};return new n.ES6(function(r,n){u(function(o){return o?(e&&e(o),n(o)):(e&&e(null),r())})})},module.exports=QueryCursor;