/*!
 * Module dependencies.
 */
function SchemaType(t,e,i){this.path=t,this.instance=i,this.validators=[],this.setters=[],this.getters=[],this.options=e,this._index=null,this.selected;for(var r in e)if(this[r]&&"function"==typeof this[r]){if("index"===r&&this._index)continue;var n=Array.isArray(e[r])?e[r]:[e[r]];this[r].apply(this,n)}}/*!
 * ignore
 */
function handleSingle(t){return this.castForQuery(t)}/*!
 * ignore
 */
function handleArray(t){var e=this;return Array.isArray(t)?t.map(function(t){return e.castForQuery(t)}):[this.castForQuery(t)]}var utils=require("./utils"),MongooseError=require("./error"),CastError=MongooseError.CastError,ValidatorError=MongooseError.ValidatorError;SchemaType.prototype["default"]=function(t){return 1===arguments.length?void 0===t?void(this.defaultValue=void 0):(this.defaultValue="function"==typeof t?t:this.cast(t),this.defaultValue):(arguments.length>1&&(this.defaultValue=utils.args(arguments)),this.defaultValue)},SchemaType.prototype.index=function(t){return this._index=t,utils.expires(this._index),this},SchemaType.prototype.unique=function(t){return null===this._index||void 0===this._index||"boolean"==typeof this._index?this._index={}:"string"==typeof this._index&&(this._index={type:this._index}),this._index.unique=t,this},SchemaType.prototype.text=function(t){return null===this._index||void 0===this._index||"boolean"==typeof this._index?this._index={}:"string"==typeof this._index&&(this._index={type:this._index}),this._index.text=t,this},SchemaType.prototype.sparse=function(t){return null===this._index||void 0===this._index||"boolean"==typeof this._index?this._index={}:"string"==typeof this._index&&(this._index={type:this._index}),this._index.sparse=t,this},SchemaType.prototype.set=function(t){if("function"!=typeof t)throw new TypeError("A setter must be a function.");return this.setters.push(t),this},SchemaType.prototype.get=function(t){if("function"!=typeof t)throw new TypeError("A getter must be a function.");return this.getters.push(t),this},SchemaType.prototype.validate=function(t,e,i){if("function"==typeof t||t&&"RegExp"===utils.getFunctionName(t.constructor)){var r;return e instanceof Object&&!i?(r=utils.clone(e),r.message||(r.message=r.msg),r.validator=t,r.type=r.type||"user defined"):(e||(e=MongooseError.messages.general["default"]),i||(i="user defined"),r={message:e,type:i,validator:t}),this.validators.push(r),this}var n,s,o;for(n=0,s=arguments.length;s>n;n++){if(o=arguments[n],!o||"Object"!==utils.getFunctionName(o.constructor)){var a="Invalid validator. Received ("+typeof o+") "+o+". See http://mongoosejs.com/docs/api.html#schematype_SchemaType-validate";throw new Error(a)}this.validate(o.validator,o)}return this},SchemaType.prototype.required=function(t,e){if(t===!1)return this.validators=this.validators.filter(function(t){return t.validator!==this.requiredValidator},this),this.isRequired=!1,this;var i=this;this.isRequired=!0,this.requiredValidator=function(e){return"isSelected"in this&&!this.isSelected(i.path)&&!this.isModified(i.path)?!0:"function"==typeof t&&!t.apply(this)||i.checkRequired(e,this)},this.originalRequiredValue=t,"string"==typeof t&&(e=t,t=void 0);var r=e||MongooseError.messages.general.required;return this.validators.unshift({validator:this.requiredValidator,message:r,type:"required"}),this},SchemaType.prototype.getDefault=function(t,e){var i="function"==typeof this.defaultValue?this.defaultValue.call(t):this.defaultValue;if(null!==i&&void 0!==i){var r=this.cast(i,t,e);return r&&r.$isSingleNested&&(r.$parent=t),r}return i},SchemaType.prototype.applySetters=function(t,e,i,r,n){for(var s=t,o=this.setters,a=o.length,u=this.caster;a--;)s=o[a].call(e,s,this);if(Array.isArray(s)&&u&&u.setters){for(var h=[],l=0;l<s.length;l++)h.push(u.applySetters(s[l],e,i,r));s=h}return null===s||void 0===s?s:s=this.cast(s,e,i,r,n)},SchemaType.prototype.applyGetters=function(t,e){var i=t,r=this.getters,n=r.length;if(!n)return i;for(;n--;)i=r[n].call(e,i,this);return i},SchemaType.prototype.select=function(t){return this.selected=!!t,this},SchemaType.prototype.doValidate=function(t,e,i){var r=!1,n=this.path,s=this.validators.length;if(!s)return e(null);var o=function(t,i){r||(void 0===t||t?--s||e(null):(r=new ValidatorError(i),e(r)))},a=this;this.validators.forEach(function(e){if(!r){var s=e.validator,u=utils.clone(e);if(u.path=n,u.value=t,s instanceof RegExp)o(s.test(t),u);else if("function"==typeof s){if(void 0===t&&!a.isRequired)return void o(!0,u);if(2===s.length){var h=s.call(i,t,function(t,e){"boolean"!=typeof h&&(e&&(u.message=e),o(t,u))});"boolean"==typeof h&&o(h,u)}else o(s.call(i,t),u)}}})},SchemaType.prototype.doValidateSync=function(t,e){var i=null,r=this.path,n=this.validators.length;if(!n)return null;var s=function(t,e){i||void 0===t||t||(i=new ValidatorError(e))},o=this;return void 0!==t||o.isRequired?(this.validators.forEach(function(n){if(!i){var o=n.validator,a=utils.clone(n);a.path=r,a.value=t,o instanceof RegExp?s(o.test(t),a):"function"==typeof o&&2!==o.length&&s(o.call(e,t),a)}}),i):null},SchemaType._isRef=function(t,e,i,r){var n=r&&t.options&&t.options.ref;if(!n&&i&&i.$__fullPath){var s=i.$__fullPath(t.path),o=i.ownerDocument?i.ownerDocument():i;n=o.populated(s)}if(n){if(null==e)return!0;if(!Buffer.isBuffer(e)&&"Binary"!==e._bsontype&&utils.isObject(e))return!0}return!1},/*!
 * ignore
 */
SchemaType.prototype.$conditionalHandlers={$all:handleArray,$eq:handleSingle,$in:handleArray,$ne:handleSingle,$nin:handleArray},SchemaType.prototype.castForQuery=function(t,e){var i;if(2===arguments.length){if(i=this.$conditionalHandlers[t],!i)throw new Error("Can't use "+t);return i.call(this,e)}return e=t,this.cast(e)},SchemaType.prototype.checkRequired=function(t){return null!=t},/*!
 * Module exports.
 */
module.exports=exports=SchemaType,exports.CastError=CastError,exports.ValidatorError=ValidatorError;