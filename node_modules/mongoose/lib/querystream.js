/*!
 * Module dependencies.
 */
function QueryStream(t,e){Stream.call(this),this.query=t,this.readable=!0,this.paused=!1,this._cursor=null,this._destroyed=null,this._fields=null,this._buffer=null,this._inline=T_INIT,this._running=!1,this._transform=e&&"function"==typeof e.transform?e.transform:K;var r=this;process.nextTick(function(){r._init()})}function createAndEmit(t,e,r){var i=helpers.createModel(t.query.model,r,t._fields),n=e?{populated:e}:void 0;i.init(r,n,function(e){return e?t.destroy(e):void emit(t,i)})}/*!
 * Emit a data event and manage the trampoline state
 */
function emit(t,e){t.emit("data",t._transform(e)),T_IDLE===t._inline?t._next():t._inline=T_CONT}var Stream=require("stream").Stream,utils=require("./utils"),helpers=require("./queryhelpers"),K=function(t){return t};/*!
 * Inherit from Stream
 */
QueryStream.prototype.__proto__=Stream.prototype,QueryStream.prototype.readable,QueryStream.prototype.paused;var T_INIT=0,T_IDLE=1,T_CONT=2;QueryStream.prototype._init=function(){if(!this._destroyed){var t=this.query,e=t.model,r=t._optionsForExec(e),i=this;try{t.cast(e)}catch(n){return i.destroy(n)}i._fields=utils.clone(t._fields),r.fields=t._castFields(i._fields),e.collection.find(t._conditions,r,function(t,e){return t?i.destroy(t):(i._cursor=e,void i._next())})}},QueryStream.prototype._next=function(){if(this.paused||this._destroyed)return this._running=!1,this._running;if(this._running=!0,this._buffer&&this._buffer.length)for(var t;!this.paused&&!this._destroyed&&(t=this._buffer.shift());)this._onNextObject.apply(this,t);for(;this.__next(););},QueryStream.prototype.__next=function(){if(this.paused||this._destroyed)return this._running=!1,this._running;var t=this;return t._inline=T_INIT,t._cursor.nextObject(function(e,r){t._onNextObject(e,r)}),T_CONT===this._inline?!0:void(this._inline=T_IDLE)},QueryStream.prototype._onNextObject=function(t,e){if(!this._destroyed){if(this.paused)return this._buffer||(this._buffer=[]),this._buffer.push([t,e]),this._running=!1,this._running;if(t)return this.destroy(t);if(!e)return this.emit("end"),this.destroy();var r=this.query._mongooseOptions;if(!r.populate)return r.lean===!0?emit(this,e):createAndEmit(this,null,e);var i=this,n=helpers.preparePopulationOptionsMQ(i.query,i.query._mongooseOptions);n.forEach(function(t){delete t.model}),n.__noPromise=!0,i.query.model.populate(e,n,function(t,e){return t?i.destroy(t):r.lean===!0?emit(i,e):createAndEmit(i,n,e)})}},QueryStream.prototype.pause=function(){this.paused=!0},QueryStream.prototype.resume=function(){return this.paused=!1,this._cursor&&T_INIT!==this._inline?this._running?void 0:this._next():void 0},QueryStream.prototype.destroy=function(t){this._destroyed||(this._destroyed=!0,this._running=!1,this.readable=!1,this._cursor&&this._cursor.close(),t&&this.emit("error",t),this.emit("close"))},/*!
 * Module exports
 */
module.exports=exports=QueryStream;