/*!
 * Module dependencies.
 */
function Schema(e,t){if(!(this instanceof Schema))return new Schema(e,t);this.paths={},this.subpaths={},this.virtuals={},this.singleNestedPaths={},this.nested={},this.inherits={},this.callQueue=[],this._indexes=[],this.methods={},this.statics={},this.tree={},this._requiredpaths=void 0,this.discriminatorMapping=void 0,this._indexedpaths=void 0,this.query={},this.childSchemas=[],this.s={hooks:new Kareem,kareemHooks:IS_KAREEM_HOOK},this.options=this.defaultOptions(t),e&&this.add(e);var s=e&&e._id&&utils.isObject(e._id),i=!this.paths._id&&!this.options.noId&&this.options._id&&!s;i&&(e={_id:{auto:!0}},e._id[this.options.typeKey]=Schema.ObjectId,this.add(e));var r=!this.paths.id&&!this.options.noVirtualId&&this.options.id;r&&this.virtual("id").get(idGetter);for(var n=0;n<this._defaultMiddleware.length;++n){var a=this._defaultMiddleware[n];this[a.kind](a.hook,!!a.isAsync,a.fn)}this.options.timestamps&&this.setupTimestamp(this.options.timestamps)}/*!
 * Returns this documents _id cast to a string.
 */
function idGetter(){return this.$__._id?this.$__._id:(this.$__._id=null==this._id?null:String(this._id),this.$__._id)}/*!
 * ignore
 */
function getPositionalPathType(e,t){var s=t.split(/\.(\d+)\.|\.(\d+)$/).filter(Boolean);if(s.length<2)return e.paths[s[0]];var i=e.path(s[0]),r=!1;if(!i)return i;for(var n,a=s.length-1,o=1;o<s.length;++o){if(r=!1,n=s[o],o===a&&i&&!i.schema&&!/\D/.test(n)){i=i instanceof MongooseTypes.Array?i.caster:void 0;break}if(/\D/.test(n)){if(!i||!i.schema){i=void 0;break}var h=i.schema.pathType(n);r="nested"===h,i=i.schema.path(n)}}return e.subpaths[t]=i,i?"real":r?"nested":"adhocOrUndefined"}/*!
 * ignore
 */
function getPositionalPath(e,t){return getPositionalPathType(e,t),e.subpaths[t]}var readPref=require("./drivers").ReadPreference,EventEmitter=require("events").EventEmitter,VirtualType=require("./virtualtype"),utils=require("./utils"),MongooseTypes,Kareem=require("kareem"),async=require("async"),IS_KAREEM_HOOK={count:!0,find:!0,findOne:!0,findOneAndUpdate:!0,findOneAndRemove:!0,insertMany:!0,update:!0};/*!
 * Inherit from EventEmitter.
 */
Schema.prototype=Object.create(EventEmitter.prototype),Schema.prototype.constructor=Schema,Schema.prototype.instanceOfSchema=!0,Object.defineProperty(Schema.prototype,"_defaultMiddleware",{configurable:!1,enumerable:!1,writable:!1,value:[{kind:"pre",hook:"save",fn:function(e,t){var s=this;if(this.ownerDocument)return e();var i,r=t&&"object"==typeof t&&"validateBeforeSave"in t;i=r?!!t.validateBeforeSave:this.schema.options.validateBeforeSave,i?this.$__original_validate?this.$__original_validate({__noPromise:!0},function(t){return s.schema.s.hooks.execPost("save:error",s,[s],{error:t},function(t){e(t)})}):this.validate({__noPromise:!0},function(t){return s.schema.s.hooks.execPost("save:error",s,[s],{error:t},function(t){e(t)})}):e()}},{kind:"pre",hook:"save",isAsync:!0,fn:function(e,t){var s=this,i=this.$__getAllSubdocs();return!i.length||this.$__preSavingFromParent?(t(),void e()):void async.each(i,function(e,t){e.$__preSavingFromParent=!0,e.save(function(e){t(e)})},function(r){for(var n=0;n<i.length;++n)delete i[n].$__preSavingFromParent;return r?s.schema.s.hooks.execPost("save:error",s,[s],{error:r},function(e){t(e)}):(e(),void t())})}},{kind:"pre",hook:"validate",isAsync:!0,fn:function(e,t){e(),t()}},{kind:"pre",hook:"remove",isAsync:!0,fn:function(e,t){if(this.ownerDocument)return t(),void e();var s=this.$__getAllSubdocs();return!s.length||this.$__preSavingFromParent?(t(),void e()):void async.each(s,function(e,t){e.remove({noop:!0},function(e){t(e)})},function(s){return s?void t(s):(e(),void t())})}}]}),Schema.prototype.paths,Schema.prototype.tree,Schema.prototype.defaultOptions=function(e){return e&&e.safe===!1&&(e.safe={w:0}),e&&e.safe&&0===e.safe.w&&(e.versionKey=!1),e=utils.options({strict:!0,bufferCommands:!0,capped:!1,versionKey:"__v",discriminatorKey:"__t",minimize:!0,autoIndex:null,shardKey:null,read:null,validateBeforeSave:!0,noId:!1,_id:!0,noVirtualId:!1,id:!0,typeKey:"type"},e),e.read&&(e.read=readPref(e.read)),e},Schema.prototype.add=function(e,t){t=t||"";for(var s=Object.keys(e),i=0;i<s.length;++i){var r=s[i];if(null==e[r])throw new TypeError("Invalid value for schema path `"+t+r+"`");if(Array.isArray(e[r])&&1===e[r].length&&null==e[r][0])throw new TypeError("Invalid value for schema Array path `"+t+r+"`");!utils.isObject(e[r])||e[r].constructor&&"Object"!==utils.getFunctionName(e[r].constructor)||e[r][this.options.typeKey]&&("type"!==this.options.typeKey||!e[r].type.type)?this.path(t+r,e[r]):Object.keys(e[r]).length?(this.nested[t+r]=!0,this.add(e[r],t+r+".")):this.path(t+r,e[r])}},Schema.reserved=Object.create(null);var reserved=Schema.reserved;reserved.emit=reserved.on=reserved.once=reserved.listeners=reserved.removeListener=reserved.collection=reserved.db=reserved.errors=reserved.init=reserved.isModified=reserved.isNew=reserved.get=reserved.modelName=reserved.save=reserved.schema=reserved.set=reserved.toObject=reserved.validate=reserved._pres=reserved._posts=1;/*!
 * Document keys to print warnings for
 */
var warnings={};warnings.increment="`increment` should not be used as a schema path name unless you have disabled versioning.",Schema.prototype.path=function(e,t){if(void 0===t)return this.paths[e]?this.paths[e]:this.subpaths[e]?this.subpaths[e]:this.singleNestedPaths[e]?this.singleNestedPaths[e]:/\.\d+\.?.*$/.test(e)?getPositionalPath(this,e):void 0;if(reserved[e])throw new Error("`"+e+"` may not be used as a schema pathname");warnings[e]&&console.log("WARN: "+warnings[e]);var s=e.split(/\./),i=s.pop(),r=this.tree;if(s.forEach(function(t,i){if(r[t]||(r[t]={}),"object"!=typeof r[t]){var n="Cannot set nested path `"+e+"`. Parent path `"+s.slice(0,i).concat([t]).join(".")+"` already set to type "+r[t].name+".";throw new Error(n)}r=r[t]}),r[i]=utils.clone(t),this.paths[e]=Schema.interpretAsType(e,t,this.options),this.paths[e].$isSingleNested){for(var n in this.paths[e].schema.paths)this.singleNestedPaths[e+"."+n]=this.paths[e].schema.paths[n];for(n in this.paths[e].schema.singleNestedPaths)this.singleNestedPaths[e+"."+n]=this.paths[e].schema.singleNestedPaths[n];this.childSchemas.push(this.paths[e].schema)}else this.paths[e].$isMongooseDocumentArray&&this.childSchemas.push(this.paths[e].schema);return this},Schema.interpretAsType=function(e,t,s){if(t.constructor){var i=utils.getFunctionName(t.constructor);if("Object"!==i){var r=t;t={},t[s.typeKey]=r}}var n=!t[s.typeKey]||"type"===s.typeKey&&t.type.type?{}:t[s.typeKey];if("Object"===utils.getFunctionName(n.constructor)||"mixed"===n)return new MongooseTypes.Mixed(e,t);if(Array.isArray(n)||Array===n||"array"===n){var a=Array===n||"array"===n?t.cast:n[0];if(a&&a.instanceOfSchema)return new MongooseTypes.DocumentArray(e,a,t);if(Array.isArray(a))return new MongooseTypes.Array(e,Schema.interpretAsType(e,a,s),t);if("string"==typeof a)a=MongooseTypes[a.charAt(0).toUpperCase()+a.substring(1)];else if(a&&(!a[s.typeKey]||"type"===s.typeKey&&a.type.type)&&"Object"===utils.getFunctionName(a.constructor)&&Object.keys(a).length){var o={minimize:s.minimize};s.typeKey&&(o.typeKey=s.typeKey);var h=new Schema(a,o);return new MongooseTypes.DocumentArray(e,h,t)}return new MongooseTypes.Array(e,a||MongooseTypes.Mixed,t)}if(n&&n.instanceOfSchema)return new MongooseTypes.Embedded(n,e,t);var p;if(p=Buffer.isBuffer(n)?"Buffer":"string"==typeof n?n:n.schemaName||utils.getFunctionName(n),p&&(p=p.charAt(0).toUpperCase()+p.substring(1)),void 0==MongooseTypes[p])throw new TypeError("Undefined type `"+p+"` at `"+e+"`\n  Did you try nesting Schemas? You can only nest using refs or arrays.");return new MongooseTypes[p](e,t)},Schema.prototype.eachPath=function(e){for(var t=Object.keys(this.paths),s=t.length,i=0;s>i;++i)e(t[i],this.paths[t[i]]);return this},Schema.prototype.requiredPaths=function(e){if(this._requiredpaths&&!e)return this._requiredpaths;for(var t=Object.keys(this.paths),s=t.length,i=[];s--;){var r=t[s];this.paths[r].isRequired&&i.push(r)}return this._requiredpaths=i,this._requiredpaths},Schema.prototype.indexedPaths=function(){return this._indexedpaths?this._indexedpaths:(this._indexedpaths=this.indexes(),this._indexedpaths)},Schema.prototype.pathType=function(e){return e in this.paths?"real":e in this.virtuals?"virtual":e in this.nested?"nested":e in this.subpaths?"real":e in this.singleNestedPaths?"real":/\.\d+\.|\.\d+$/.test(e)?getPositionalPathType(this,e):"adhocOrUndefined"},Schema.prototype.hasMixedParent=function(e){var t=e.split(/\./g);e="";for(var s=0;s<t.length;++s)if(e=s>0?e+"."+t[s]:t[s],e in this.paths&&this.paths[e]instanceof MongooseTypes.Mixed)return!0;return!1},Schema.prototype.setupTimestamp=function(e){if(e){var t=e.createdAt||"createdAt",s=e.updatedAt||"updatedAt",i={};i[s]=Date,this.paths[t]||(i[t]=Date),this.add(i),this.pre("save",function(e){var i=new Date,r=this._id&&this._id.auto;!this[t]&&this.isSelected(t)&&(this[t]=r?this._id.getTimestamp():i),(this.isNew||this.isModified())&&(this[s]=this.isNew?this[t]:i),e()});var r=function(){var e=new Date,i={$set:{},$setOnInsert:{}};return i.$set[s]=e,i.$setOnInsert[t]=e,i};this.methods.initializeTimestamps=function(){return this[t]||(this[t]=new Date),this[s]||(this[s]=new Date),this},this.pre("findOneAndUpdate",function(e){this.findOneAndUpdate({},r()),e()}),this.pre("update",function(e){this.update({},r()),e()})}},Schema.prototype.queue=function(e,t){return this.callQueue.push([e,t]),this},Schema.prototype.pre=function(){var e=arguments[0];return IS_KAREEM_HOOK[e]?(this.s.hooks.pre.apply(this.s.hooks,arguments),this):this.queue("pre",arguments)},Schema.prototype.post=function(e,t){return IS_KAREEM_HOOK[e]?(this.s.hooks.post.apply(this.s.hooks,arguments),this):t.length<2?this.queue("on",[arguments[0],function(e){return t.call(e,e)}]):3===t.length?(this.s.hooks.post(e+":error",t),this):this.queue("post",[arguments[0],function(e){var s=this,i=Array.prototype.slice.call(arguments,1);t.call(this,this,function(t){return e.apply(s,[t].concat(i))})}])},Schema.prototype.plugin=function(e,t){return e(this,t),this},Schema.prototype.method=function(e,t){if("string"!=typeof e)for(var s in e)this.methods[s]=e[s];else this.methods[e]=t;return this},Schema.prototype["static"]=function(e,t){if("string"!=typeof e)for(var s in e)this.statics[s]=e[s];else this.statics[e]=t;return this},Schema.prototype.index=function(e,t){return t||(t={}),t.expires&&utils.expires(t),this._indexes.push([e,t]),this},Schema.prototype.set=function(e,t,s){if(1===arguments.length)return this.options[e];switch(e){case"read":this.options[e]=readPref(t,s);break;case"safe":this.options[e]=t===!1?{w:0}:t;break;case"timestamps":this.setupTimestamp(t),this.options[e]=t;break;default:this.options[e]=t}return this},Schema.prototype.get=function(e){return this.options[e]};var indexTypes="2d 2dsphere hashed text".split(" ");Object.defineProperty(Schema,"indexTypes",{get:function(){return indexTypes},set:function(){throw new Error("Cannot overwrite Schema.indexTypes")}}),Schema.prototype.indexes=function(){"use strict";/*!
   * Checks for indexes added to subdocs using Schema.index().
   * These indexes need their paths prefixed properly.
   *
   * schema._indexes = [ [indexObj, options], [indexObj, options] ..]
   */
function e(e,s){var i,r,n,a,o,h,p=e._indexes,u=p.length,c=0;for(c=0;u>c;++c){for(i=p[c][0],a=Object.keys(i),n=a.length,r={},h=0;n>h;++h)o=a[h],r[s+o]=i[o];t.push([r,p[c][1]])}}var t=[],s={},i=function(r,n){if(!s[n]){s[n]=!0,n=n||"";for(var a,o,h,p,u,c,d,l=Object.keys(r.paths),f=0;f<l.length;++f)a=l[f],o=r.paths[a],o instanceof MongooseTypes.DocumentArray||o.$isSingleNested?i(o.schema,a+"."):(h=o._index,h!==!1&&null!==h&&void 0!==h&&(p={},u=utils.isObject(h),c=u?h:{},d="string"==typeof h?h:u?h.type:!1,d&&~Schema.indexTypes.indexOf(d)?p[n+a]=d:c.text?(p[n+a]="text",delete c.text):p[n+a]=1,delete c.type,"background"in c||(c.background=!0),t.push([p,c])));n?e(r,n):(r._indexes.forEach(function(e){"background"in e[1]||(e[1].background=!0)}),t=t.concat(r._indexes))}};return i(this),t},Schema.prototype.virtual=function(e,t){if(t&&t.ref){if(!t.localField)throw new Error("Reference virtuals require `localField` option");if(!t.foreignField)throw new Error("Reference virtuals require `foreignField` option");this.pre("init",function(s,i){e in i&&(this.$$populatedVirtuals||(this.$$populatedVirtuals={}),t.justOne?this.$$populatedVirtuals[e]=Array.isArray(i[e])?i[e][0]:i[e]:this.$$populatedVirtuals[e]=Array.isArray(i[e])?i[e]:null==i[e]?[]:[i[e]],delete i[e]),s()});var s=this.virtual(e);return s.options=t,s.get(function(){return this.$$populatedVirtuals||(this.$$populatedVirtuals={}),e in this.$$populatedVirtuals?this.$$populatedVirtuals[e]:null}).set(function(t){this.$$populatedVirtuals||(this.$$populatedVirtuals={}),this.$$populatedVirtuals[e]=t})}var i=this.virtuals,r=e.split(".");return i[e]=r.reduce(function(s,i,n){return s[i]||(s[i]=n===r.length-1?new VirtualType(t,e):{}),s[i]},this.tree),i[e]},Schema.prototype.virtualpath=function(e){return this.virtuals[e]},Schema.prototype.remove=function(e){"string"==typeof e&&(e=[e]),Array.isArray(e)&&e.forEach(function(e){if(this.path(e)){delete this.paths[e];for(var t=e.split("."),s=t.pop(),i=this.tree,r=0;r<t.length;++r)i=i[t[r]];delete i[s]}},this)},/*!
 * ignore
 */
Schema.prototype._getSchema=function(e){function t(e,s){for(var i,r,n=e.length+1;n--;)if(r=e.slice(0,n).join("."),i=s.path(r)){if(i.caster){if(i.caster instanceof MongooseTypes.Mixed)return i.caster;if(n!==e.length&&i.schema)return"$"===e[n]?t(e.slice(n+1),i.schema):t(e.slice(n),i.schema)}return i}}var s=this,i=s.path(e);return i?i:t(e.split("."),s)},/*!
 * ignore
 */
Schema.prototype._getPathType=function(e){function t(e,s){for(var i,r,n=e.length+1;n--;){if(r=e.slice(0,n).join("."),i=s.path(r))return i.caster?i.caster instanceof MongooseTypes.Mixed?{schema:i,pathType:"mixed"}:n!==e.length&&i.schema?"$"===e[n]?n===e.length-1?{schema:i,pathType:"nested"}:t(e.slice(n+1),i.schema):t(e.slice(n),i.schema):{schema:i,pathType:i.$isSingleNested?"nested":"array"}:{schema:i,pathType:"real"};if(n===e.length&&s.nested[r])return{schema:s,pathType:"nested"}}return{schema:i||s,pathType:"undefined"}}var s=this,i=s.path(e);return i?"real":t(e.split("."),s)},/*!
 * Module exports.
 */
module.exports=exports=Schema,Schema.Types=MongooseTypes=require("./schema/index"),/*!
 * ignore
 */
exports.ObjectId=MongooseTypes.ObjectId;