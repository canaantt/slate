"use strict";var inherits=require("util").inherits,EventEmitter=require("events").EventEmitter,Connection=require("./connection"),Query=require("./commands").Query,Logger=require("./logger"),f=require("util").format,DISCONNECTED="disconnected",CONNECTING="connecting",CONNECTED="connected",DESTROYED="destroyed",_id=0,Pool=function(e){if(EventEmitter.call(this),this.options=e||{},this.size="number"!=typeof e.size||isNaN(e.size)?5:e.size,this.waitMS="number"!=typeof e.waitMS||isNaN(e.waitMS)?1e3:e.waitMS,this.host=e.host,this.port=e.port,this.messageHandler=e.messageHandler,!e.bson)throw new Error("must pass in valid bson parser");this.availableConnections=[],this.inUseConnections=[],this.newConnections=[],this.connectingConnections=[],this.state=DISCONNECTED,this.index=0,this.dead=!1,this.logger=Logger("Pool",e),this.id=_id++,this.tag=e.tag,this.queue=[],this.executing=!1,this.unreference=!1};inherits(Pool,EventEmitter);var removeConnection=function(e,n){n.destroy();var t=function(e){for(var t=0;t<e.length;t++)if(e[t]===n)return e.splice(t,1),!0};t(e.availableConnections)||t(e.inUseConnections)||t(e.newConnections)||t(e.connectingConnections)},errorHandler=function(e){return function(n,t){e.logger.isDebug()&&e.logger.debug(f("pool [%s] errored out [%s] with connection [%s]",this.dead,JSON.stringify(n),JSON.stringify(t))),t.destroy(),removeConnection(e,t),e.listeners("error").length>0&&e.emit("error",n,t)}},timeoutHandler=function(e){return function(n,t){e.logger.isDebug()&&e.logger.debug(f("pool [%s] timed out [%s] with connection [%s]",this.dead,JSON.stringify(n),JSON.stringify(t))),t.destroy(),removeConnection(e,t),e.emit("timeout",n,t)}},closeHandler=function(e){return function(n,t){e.logger.isDebug()&&e.logger.debug(f("pool [%s] closed [%s] with connection [%s]",this.dead,JSON.stringify(n),JSON.stringify(t))),t.destroy(),removeConnection(e,t),e.emit("close",n,t)}},parseErrorHandler=function(e){return function(n,t){e.logger.isDebug()&&e.logger.debug(f("pool [%s] errored out [%s] with connection [%s]",this.dead,JSON.stringify(n),JSON.stringify(t))),t.destroy(),removeConnection(e,t),e.emit("parseError",n,t)}};Pool.prototype.unref=function(){this.unreference=!0,this.getAll().forEach(function(e){e.unref()})},Pool.prototype.destroy=function(){this.state=DESTROYED,this.dead=!0;var e=this.getAll();e.forEach(function(e){["close","message","error","timeout","parseError","connect"].forEach(function(n){e.removeAllListeners(n)}),e.destroy()}),this.availableConnections=[],this.connectingConnections=[],this.inUseConnections=[],this.newConnections=[]},Pool.prototype.connect=function(e){var n=this;this.state=CONNECTING,this.dead=!1,n.options.messageHandler=n.messageHandler;var t=new Connection(n.options);["close","error","timeout","parseError","connect"].forEach(function(e){t.removeAllListeners(e)}),t.once("close",closeHandler(n)),t.once("error",errorHandler(n)),t.once("timeout",timeoutHandler(n)),t.once("parseError",parseErrorHandler(n)),t.on("connect",function(e){return"DESTROYED"==n.state?e.destroy():(n.availableConnections.push(e),void n.emit("connect",n))}),t.connect(e)};var _createConnection=function(e){e.options.messageHandler=e.messageHandler;var n=new Connection(e.options);e.connectingConnections.push(n);var t=function(e){return function(n){e.destroy()}},o=["close","message","error","timeout","parseError","connect"],i=function(n){return function(){if("DESTROYED"==e.state){var t=e.connectingConnections.indexOf(n);return-1!=t&&e.connectingConnections.splice(t,1),n.destroy()}o.forEach(function(e){n.removeAllListeners(e)}),n.once("close",closeHandler(e)),n.once("error",errorHandler(e)),n.once("timeout",timeoutHandler(e)),n.once("parseError",parseErrorHandler(e));var t=e.connectingConnections.indexOf(n);-1!=t&&e.connectingConnections.splice(t,1),e.newConnections.push(n),e.emit("connection",n),_execute(e)()}};n.once("close",t(n)),n.once("error",t(n)),n.once("timeout",t(n)),n.once("parseError",t(n)),n.once("connect",i(n)),n.connect()},_execute=function(e){return function(){if("DESTROYED"!=e.state&&!e.executing){e.executing=!0;var n=e.availableConnections.length+e.connectingConnections.length+e.inUseConnections.length+e.newConnections.length;if(0==e.availableConnections.length&&0==e.connectingConnections.length&&n<e.size&&e.queue.length>0)return _createConnection(e),void(e.executing=!1);for(e.availableConnections.length>e.queue.length?e.queue.length:e.availableConnections.length;;){if(0==e.availableConnections.length)break;if(0==e.queue.length)break;var t=e.availableConnections.pop();if(t.isConnected()){var o=e.queue.shift();o.cb&&(o.cb.connection=t);var i=o.buffer;if(e.inUseConnections.push(t),Array.isArray(i))for(var r=0;r<i.length;r++)t.write(i[r]);else t.write(i);o.immediateRelease&&e.availableConnections.push(t)}}e.executing=!1}}};Pool.prototype.write=function(e,n,t){var o={buffer:e,cb:n};t&&t.immediateRelease&&(o.immediateRelease=!0),this.queue.push(o),_execute(this)()},Pool.prototype.connectionAvailable=function(e){var n=this.newConnections.indexOf(e);-1!=n&&this.newConnections.splice(n,1),n=this.inUseConnections.indexOf(e),-1!=n&&this.inUseConnections.splice(n,1),-1==this.availableConnections.indexOf(e)&&this.availableConnections.push(e),_execute(this)()},Pool.prototype.get=function(e){e=e||{},this.index=this.index+1;var n=this.availableConnections.slice(0);return 1==n.length?n[0]:(this.index=this.index%n.length,n[this.index])},Pool.prototype.getAll=function(){return this.availableConnections.concat(this.inUseConnections).concat(this.connectingConnections).concat(this.newConnections)},Pool.prototype.isConnected=function(){for(var e=0;e<this.availableConnections.length;e++)if(this.availableConnections[e].isConnected())return!0;for(var e=0;e<this.inUseConnections.length;e++)if(this.inUseConnections[e].isConnected())return!0;for(var e=0;e<this.newConnections.length;e++)if(this.newConnections[e].isConnected())return!0;return this.state==CONNECTED},Pool.prototype.isDestroyed=function(){return this.state==DESTROYED},module.exports=Pool;