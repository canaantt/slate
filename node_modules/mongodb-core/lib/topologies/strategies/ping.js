"use strict";var Logger=require("../../connection/logger"),EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,f=require("util").format,Ping=function(e){EventEmitter.call(this),this.s={pings:{},options:e||{},logger:Logger("Ping",e),pingInterval:e.pingInterval||1e4,acceptableLatency:e.acceptableLatency||15,debug:"boolean"==typeof e.debug?e.debug:!1,index:0,lastPing:null},this.s.logger.isDebug()&&this.s.logger.debug(f("ping strategy interval [%s], acceptableLatency [%s]",this.s.pingInterval,this.s.acceptableLatency)),this.s.debug&&Object.defineProperty(this,"data",{enumerable:!0,get:function(){return this.s.pings}})};inherits(Ping,EventEmitter);var filterByTags=function(e,t){if(null==e.tags)return t;for(var n=[],r=e.tags,i=0;i<t.length;i++){var s=t[i].lastIsMaster().tags||{},a=!0;for(var g in r)s[g]!=r[g]&&(a=!1);a&&n.push(t[i])}return n};Ping.prototype.pickServer=function(e,t){var n=this,r=[];e.primary&&r.push(e.primary);for(var i=0;i<e.secondaries.length;i++)r.push(e.secondaries[i]);r=filterByTags(t,r);for(var s=[],i=0;i<r.length;i++)s.push({name:r[i].name,time:n.s.pings[r[i].name]||0});s.sort(function(e,t){return e.time>t.time});var a=s.length>0?s[0].time:0;return s=s.filter(function(e){return e.time<=a+n.s.acceptableLatency}),0==s.length&&e.primary?(n.s.logger.isInfo()&&n.s.logger.info(f("picked primary server [%s]",e.primary.name)),e.primary):0==s.length?null:(n.s.logger.isInfo()&&n.s.logger.info(f("picked server [%s] with ping latency [%s]",s[0].name,s[0].time)),n.s.index=n.s.index+1,n.s.index=n.s.index%s.length,e.get(s[n.s.index].name))},Ping.prototype.startOperation=function(e,t,n){},Ping.prototype.endOperation=function(e,t,n,r){},Ping.prototype.ha=function(e,t,n){var r=this,i=t.getAll(),s=i.length;if(0==i.length)return n(null,null);if(null!=r.s.lastPing){var a=(new Date).getTime()-r.s.lastPing.getTime();if(a<r.s.pingInterval)return n(null,null)}for(var g=function(t){var i=new Date;t.command("system.$cmd",{ismaster:1},function(a,g){s-=1;var o=(new Date).getTime()-i.getTime();r.s.pings[t.name]=o,r.s.logger.isDebug()&&r.s.logger.debug(f("ha latency for server [%s] is [%s] ms",t.name,o)),0==s&&(e.emit("ping",a,g?g.result:null),r.s.lastPing=new Date,n(null,null))})};i.length>0;)g(i.shift())};var removeServer=function(e,t){delete e.s.pings[t.name]};Ping.prototype.close=function(e){removeServer(this,e)},Ping.prototype.error=function(e){removeServer(this,e)},Ping.prototype.timeout=function(e){removeServer(this,e)},Ping.prototype.connect=function(e,t){var n=this,r=new Date;e.command("system.$cmd",{ismaster:1},function(i,s){var a=(new Date).getTime()-r.getTime();n.s.pings[e.name]=a,n.s.logger.isDebug()&&n.s.logger.debug(f("connect latency for server [%s] is [%s] ms",e.name,a)),n.s.lastPing=new Date,t(null,null)})},module.exports=Ping;