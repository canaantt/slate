"use strict";function emitSDAMEvent(e,r,o){e.listeners(r).length>0&&e.emit(r,o)}var inherits=require("util").inherits,f=require("util").format,bindToCurrentDomain=require("../connection/utils").bindToCurrentDomain,EventEmitter=require("events").EventEmitter,Pool=require("../connection/pool"),b=require("bson"),crypto=require("crypto"),Query=require("../connection/commands").Query,MongoError=require("../error"),ReadPreference=require("./read_preference"),BasicCursor=require("../cursor"),CommandResult=require("./command_result"),getSingleProperty=require("../connection/utils").getSingleProperty,getProperty=require("../connection/utils").getProperty,debugOptions=require("../connection/utils").debugOptions,BSON=require("bson")["native"]().BSON,PreTwoSixWireProtocolSupport=require("../wireprotocol/2_4_support"),TwoSixWireProtocolSupport=require("../wireprotocol/2_6_support"),ThreeTwoWireProtocolSupport=require("../wireprotocol/3_2_support"),Session=require("./session"),Logger=require("../connection/logger"),MongoCR=require("../auth/mongocr"),X509=require("../auth/x509"),Plain=require("../auth/plain"),GSSAPI=require("../auth/gssapi"),SSPI=require("../auth/sspi"),ScramSHA1=require("../auth/scram"),bsonTypes=[b.Long,b.ObjectID,b.Binary,b.Code,b.DBRef,b.Symbol,b.Double,b.Timestamp,b.MaxKey,b.MinKey],bsonInstance=null,serverId=0,callbackId=0,Callbacks=function(){this.callbacks={},this.id=callbackId++,this.type="server"},cloneOptions=function(e){var r={};for(var o in e)r[o]=e[o];return r};Callbacks.prototype.flush=function(e){for(var r in this.callbacks)if(!isNaN(parseInt(r,10))){var o=this.callbacks[r];delete this.callbacks[r],o(e,null)}},Callbacks.prototype.flushConnection=function(e,r){for(var o in this.callbacks)if(!isNaN(parseInt(o,10))){var t=this.callbacks[o];t.connection&&t.connection.id===r.id?(delete this.callbacks[o],t(e,null)):!t.connection&&t.monitoring&&(delete this.callbacks[o],t(e,null))}},Callbacks.prototype.callback=function(e){return this.callbacks[e]},Callbacks.prototype.emit=function(e,r,o){var t=this.callbacks[e];delete this.callbacks[e],t(r,o)},Callbacks.prototype.raw=function(e){return null==this.callbacks[e]?!1:1==this.callbacks[e].raw?!0:!1},Callbacks.prototype.documentsReturnedIn=function(e){return null==this.callbacks[e]?!1:"string"==typeof this.callbacks[e].documentsReturnedIn?this.callbacks[e].documentsReturnedIn:null},Callbacks.prototype.unregister=function(e){delete this.callbacks[e]},Callbacks.prototype.register=function(e,r){this.callbacks[e]=bindToCurrentDomain(r)};var DISCONNECTED="disconnected",CONNECTING="connecting",CONNECTED="connected",DESTROYED="destroyed",supportsServer=function(e){return e.ismaster&&"number"==typeof e.ismaster.minWireVersion},createWireProtocolHandler=function(e){return e&&e.maxWireVersion>=4?new ThreeTwoWireProtocolSupport(new TwoSixWireProtocolSupport):e&&e.maxWireVersion>=2?new TwoSixWireProtocolSupport:new PreTwoSixWireProtocolSupport},errorHandler=function(e,r){return function(o,t){if(r.state!=DISCONNECTED&&r.state!=DESTROYED&&(e.s.callbacks&&e.s.callbacks.flushConnection(new MongoError(f("server %s received an error %s",e.name,JSON.stringify(o))),t),r.emitError&&e.listeners("error").length>0&&e.emit("error",o,e),0==r.pool.getAll().length)){if(r.state=DISCONNECTED,null!=r.readPreferenceStrategies&&notifyStrategies(e,e.s,"error",[e]),r.logger.isInfo()&&r.logger.info(f("server %s errored out with %s",e.name,JSON.stringify(o))),r.callbacks&&r.callbacks.flushConnection(new MongoError(f("server %s received an error %s",e.name,JSON.stringify(o))),t),e.destroy(),r.emitError&&e.listeners("error").length>0&&e.emit("error",o,e),r.reconnect)return setTimeout(function(){reconnectServer(e,r)},r.reconnectInterval);e.destroy()}}},reconnectErrorHandler=function(e,r){return function(o,t){r.state!=DESTROYED&&(e.s.callbacks&&e.s.callbacks.flushConnection(new MongoError(f("server %s received an error %s",e.name,JSON.stringify(o))),t),r.emitError&&e.listeners("error").length>0&&e.emit("error",o,e),0==r.pool.getAll().length&&(0==r.currentReconnectRetry?(e.state=DESTROYED,e.destroy(),e.listeners("error").length>0&&e.emit("error",new MongoError(f("failed to connect to %s:%s after %s retries",r.options.host,r.options.port,r.reconnectTries)),e)):(e.listeners("error").length>0&&e.emit("error",new MongoError(f("failed to connect to %s:%s, %s connection attempts left ",r.options.host,r.options.port,r.currentReconnectRetry)),e),setTimeout(function(){reconnectServer(e,r)},r.reconnectInterval))))}},reconnectServer=function(e,r){if(r.state!=DESTROYED){if(e&&r&&r.callbacks&&r.callbacks.flush(new MongoError(f("server %s received a broken socket pipe error",e.name))),0==r.currentReconnectRetry)return e.destroy(!0,!0);r.currentReconnectRetry=r.currentReconnectRetry-1,r.state=CONNECTING,r.pool&&r.pool.destroy(),r.pool=new Pool(r.options),r.pool.once("connect",function(){r.currentReconnectRetry=r.reconnectTries;var o=["error","close","timeout","parseError","serverOpening","serverDescriptionChanged","serverHeartbeatStarted","serverHeartbeatSucceeded","serverHearbeatFailed","serverClosed"];o.forEach(function(e){r.pool.removeAllListeners(e)}),r.state=CONNECTED,r.pool.once("error",e.s.inTopology?errorHandler(e,r):reconnectErrorHandler(e,r)),r.pool.on("close",closeHandler(e,r)),r.pool.on("timeout",timeoutHandler(e,r)),r.pool.on("parseError",fatalErrorHandler(e,r));var t=Object.keys(r.authProviders);if(0==t.length)return e.emit("reconnect",e);for(var n=r.pool.getAll(),s=t.length,i=0;i<t.length;i++)r.authProviders[t[i]].reauthenticate(e,n,function(o,t){return s-=1,0==s?r.ismaster?e.emit("reconnect",e):connectHandler(e,r)():void 0})}),r.pool.once("error",e.s.inTopology?errorHandler(e,r):reconnectErrorHandler(e,r)),r.pool.once("close",errorHandler(e,r)),r.pool.once("timeout",errorHandler(e,r)),r.pool.once("parseError",errorHandler(e,r)),r.pool.connect()}},messageHandler=function(e,r){return function(o,t){try{var n=r.callbacks.callback(o.responseTo),s={raw:r.callbacks.raw(o.responseTo),promoteLongs:n&&"boolean"==typeof n.promoteLongs?n.promoteLongs:!0,documentsReturnedIn:r.callbacks.documentsReturnedIn(o.responseTo)};o.parse(s),(n&&!n.noRelease||!n)&&e.s.pool.connectionAvailable(t),r.logger.isDebug()&&r.logger.debug(f("message [%s] received from %s",o.raw.toString("hex"),e.name)),r.callbacks.emit(o.responseTo,null,o)}catch(i){r.callbacks.flushConnection(new MongoError(i),t),e.destroy()}}},fatalErrorHandler=function(e,r){return function(o,t){if(r.state!=DISCONNECTED&&r.state!=DESTROYED&&(e.s.callbacks&&e.s.callbacks.flushConnection(new MongoError(f("server %s received an error %s",e.name,JSON.stringify(o))),t),0==r.pool.getAll().length)){if(r.state=DISCONNECTED,null!=r.readPreferenceStrategies&&notifyStrategies(e,e.s,"error",[e]),r.logger.isInfo()&&r.logger.info(f("server %s errored out with %s",e.name,JSON.stringify(o))),r.callbacks&&r.callbacks.flushConnection(new MongoError(f("server %s received an error %s",e.name,JSON.stringify(o))),t),e.listeners("error").length>0&&e.emit("error",o,e),r.reconnect)return setTimeout(function(){reconnectServer(e,r)},r.reconnectInterval);e.destroy()}}},timeoutHandler=function(e,r){return function(o,t){if(r.state!=DISCONNECTED&&r.state!=DESTROYED&&(e.s.callbacks&&e.s.callbacks.flushConnection(new MongoError(f("server %s timed out",e.name)),t),0==r.pool.getAll().length)){if(r.state=DISCONNECTED,null!=r.readPreferenceStrategies&&notifyStrategies(e,e.s,"timeout",[e]),r.logger.isInfo()&&r.logger.info(f("server %s timed out",e.name)),r.callbacks&&r.callbacks.flushConnection(new MongoError(f("server %s timed out",e.name)),t),e.emit("timeout",o,e),r.reconnect)return setTimeout(function(){reconnectServer(e,r)},r.reconnectInterval);e.destroy()}}},closeHandler=function(e,r){return function(o,t){if(r.state!=DISCONNECTED&&r.state!=DESTROYED&&(e.s.callbacks&&e.s.callbacks.flushConnection(new MongoError(f("server %s timed out",e.name)),t),0==r.pool.getAll().length)){if(r.state=DISCONNECTED,null!=r.readPreferenceStrategies&&notifyStrategies(e,e.s,"close",[e]),r.logger.isInfo()&&r.logger.info(f("server %s closed",e.name)),r.callbacks&&r.callbacks.flushConnection(new MongoError(f("server %s sockets closed",e.name)),t),e.listeners("serverClosed").length>0&&e.emit("serverClosed",{topologyId:-1!=e.s.topologyId?e.s.topologyId:e.s.id,address:e.name}),e.listeners("topologyClosed").length>0&&!e.s.inTopology&&e.emit("topologyClosed",{topologyId:e.s.id}),e.emit("close",o,e),r.reconnect)return setTimeout(function(){reconnectServer(e,r)},r.reconnectInterval);e.destroy()}}},connectHandler=function(e,r){var o=function(o,t){if(o&&o.arbiterOnly)return t(null,null);var n=Object.keys(r.authProviders);if(0==n.length)return t(null,null);for(var s=r.pool.getAll(),i=n.length,a=0;a<n.length;a++)r.authProviders[n[a]].reauthenticate(e,s,function(e,r){return i-=1,0==i?t(null,null):void 0})};return function(){r.monitoring&&(e.s.inquireServerStateTimeout=setTimeout(inquireServerState(e),r.haInterval));var t=(new Date).getTime();e.command("admin.$cmd",{ismaster:!0},function(n,s){return n?(r.state=DISCONNECTED,e.listeners("serverClosed").length>0&&e.emit("serverClosed",{topologyId:-1!=e.s.topologyId?e.s.topologyId:e.s.id,address:e.name}),e.s.inTopology||e.emit("topologyOpening",{topologyId:e.s.id}),e.emit("close",n,e)):void o(s.result,function(){return emitServerDescriptionChanged(e,{address:e.name,arbiters:[],hosts:[],passives:[],type:e.s.inTopology?getTopologyType(e):"Standalone"}),emitTopologyDescriptionChanged(e,{topologyType:"Single",servers:[{address:e.name,arbiters:[],hosts:[],passives:[],type:"Standalone"}]}),r.isMasterLatencyMS=(new Date).getTime()-t,n||(r.ismaster=s.result),e.emit("ismaster",s.result,e),r.wireProtocolHandler=createWireProtocolHandler(r.ismaster),r.options.wireProtocolHandler=r.wireProtocolHandler,r.logger.isInfo()&&r.logger.info(f("server %s connected with ismaster [%s]",e.name,JSON.stringify(s.result))),supportsServer(r)||null!=r.wireProtocolHandler?(r.ismaster&&r.ismaster.me&&(r.serverDetails.name=r.ismaster.me),null==r.readPreferenceStrategies?(r.state=CONNECTED,e.emit("connect",e)):void notifyStrategies(e,e.s,"connect",[e],function(o,t){return r.state=CONNECTED,e.emit("connect",e)})):(r.state=DISCONNECTED,e.emit("error",new MongoError("non supported server version"),e))})})}},slaveOk=function(e){return e?e.slaveOk():!1},notifyStrategies=function(e,r,o,t,n){if("function"==typeof n){var s=Object.keys(r.readPreferenceStrategies).length;if(0==s)return n(null,null);for(var i in r.readPreferenceStrategies)if(r.readPreferenceStrategies[i][o]){var a=r.readPreferenceStrategies[i],l=t.slice(0);l.push(function(e,r){s-=1,0==s&&n(null,null)}),a[o].apply(a,l)}}else for(var i in r.readPreferenceStrategies)if(r.readPreferenceStrategies[i][o]){var a=r.readPreferenceStrategies[i];a[o].apply(a,t)}},debugFields=["reconnect","reconnectTries","reconnectInterval","emitError","cursorFactory","host","port","size","keepAlive","keepAliveInitialDelay","noDelay","connectionTimeout","checkServerIdentity","socketTimeout","singleBufferSerializtion","ssl","ca","cert","key","rejectUnauthorized","promoteLongs"],Server=function(e){EventEmitter.call(this),null==bsonInstance&&(bsonInstance=new BSON(bsonTypes));var r=e.reconnectTries||30;this.s={options:e,callbacks:new Callbacks,logger:Logger("Server",e),state:DISCONNECTED,reconnect:"boolean"==typeof e.reconnect?e.reconnect:!0,reconnectTries:r,reconnectInterval:e.reconnectInterval||1e3,emitError:"boolean"==typeof e.emitError?e.emitError:!1,currentReconnectRetry:r,ismaster:null,readPreferenceStrategies:e.readPreferenceStrategies,authProviders:e.authProviders||{},id:serverId++,topologyId:e.topologyId||-1,tag:e.tag,disconnectHandler:e.disconnectHandler,monitoring:"boolean"==typeof e.monitoring?e.monitoring:!1,haInterval:e.haInterval||1e4,wireProtocolHandler:e.wireProtocolHandler||new PreTwoSixWireProtocolSupport,Cursor:e.cursorFactory||BasicCursor,bsonInstance:bsonInstance,inquireServerStateTimeout:null,bson:e.bson?e.bson:bsonInstance,pool:null,isMasterLatencyMS:0,inTopology:"boolean"==typeof e.inTopology?e.inTopology:!1,serverDetails:{host:e.host,port:e.port,name:e.port?f("%s:%s",e.host,e.port):e.host},serverDescription:null,topologyDescription:null};var o=crypto.createHash("sha1");o.update(f("%s:%s",this.host,this.port)),this.hashedName=o.digest("hex");var t=this.s;e.bson=t.bson,getProperty(this,"name","name",t.serverDetails,{}),getProperty(this,"bson","bson",t.options,{}),getProperty(this,"wireProtocolHandler","wireProtocolHandler",t.options,{}),getSingleProperty(this,"id",t.id),e.authProviders||(this.addAuthProvider("mongocr",new MongoCR),this.addAuthProvider("x509",new X509),this.addAuthProvider("plain",new Plain),this.addAuthProvider("gssapi",new GSSAPI),this.addAuthProvider("sspi",new SSPI),this.addAuthProvider("scram-sha-1",new ScramSHA1))};inherits(Server,EventEmitter);var getPreviousDescription=function(e){return e.s.serverDescription||(e.s.serverDescription={address:e.name,arbiters:[],hosts:[],passives:[],type:"Unknown"}),e.s.serverDescription},emitServerDescriptionChanged=function(e,r){e.listeners("serverDescriptionChanged").length>0&&(e.emit("serverDescriptionChanged",{topologyId:-1!=e.s.topologyId?e.s.topologyId:e.s.id,address:e.name,previousDescription:getPreviousDescription(e),newDescription:r}),e.s.serverDescription=r)},getPreviousTopologyDescription=function(e){return e.s.topologyDescription||(e.s.topologyDescription={topologyType:"Unknown",servers:[{address:e.name,arbiters:[],hosts:[],passives:[],type:"Unknown"}]}),e.s.topologyDescription},emitTopologyDescriptionChanged=function(e,r){e.listeners("topologyDescriptionChanged").length>0&&(e.emit("topologyDescriptionChanged",{topologyId:-1!=e.s.topologyId?e.s.topologyId:e.s.id,address:e.name,previousDescription:getPreviousTopologyDescription(e),newDescription:r}),e.s.serverDescription=r)};Server.prototype.getDescription=function(){var e=this.s.ismaster||{},r={type:getTopologyType(this),address:this.name};return e.hosts&&(r.hosts=e.hosts),e.arbiters&&(r.arbiters=e.arbiters),e.passives&&(r.passives=e.passives),e.setName&&(r.setName=e.setName),r},Server.prototype.setBSONParserType=function(e){var r=null;if("c++"==e)r=require("bson")["native"]().BSON;else{if("js"!=e)throw new MongoError(f("% parser not supported",e));r=require("bson").pure().BSON}this.s.options.bson=new r(bsonTypes)},Server.prototype.lastIsMaster=function(){return this.s.ismaster},Server.prototype.isMasterLatencyMS=function(){return this.s.isMasterLatencyMS},Server.prototype.connect=function(e){var r=this;e=e||{},"boolean"==typeof e.promoteLongs&&(r.s.options.promoteLongs=e.promoteLongs),r.s.pool&&r.s.pool.destroy(),r.s.state=CONNECTING,r.s.options.messageHandler=messageHandler(r,r.s),r.s.pool=new Pool(r.s.options),r.s.pool.on("timeout",timeoutHandler(r,r.s)),r.s.pool.on("close",closeHandler(r,r.s)),r.s.pool.once("error",r.s.inTopology?errorHandler(r,r.s):reconnectErrorHandler(r,r.s)),r.s.pool.once("connect",connectHandler(r,r.s)),r.s.pool.on("parseError",fatalErrorHandler(r,r.s)),r.s.inTopology||this.emit("topologyOpening",{topologyId:this.s.id}),r.emit("serverOpening",{topologyId:-1!=r.s.topologyId?r.s.topologyId:r.s.id,address:r.name}),r.s.pool.on("connection",function(e){var o=Object.keys(r.s.authProviders);if(0==o.length)return r.s.pool.connectionAvailable(e);for(var t=[e],n=o.length,s=0;s<o.length;s++)r.s.authProviders[o[s]].reauthenticate(r,t,function(o,t){return n-=1,0==n?r.s.pool.connectionAvailable(e):void 0})}),r.s.pool.connect()};var getTopologyType=function(e,r){return r||(r=e.s.ismaster),r?r.ismaster&&!r.hosts?"Standalone":r.ismaster&&"isdbgrid"==r.msg?"Mongos":r.ismaster?"RSPrimary":r.secondary?"RSSecondary":r.arbiterOnly?"RSArbiter":"Unknown":"Unknown"},changedIsMaster=function(e,r,o){var t=getTopologyType(e,r),n=getTopologyType(e,o);return n!=t?!0:!1},inquireServerState=function(e){return function(){if(e.s.state!=DESTROYED){var r=(new Date).getTime();emitSDAMEvent(e,"serverHeartbeatStarted",{connectionId:e.name}),e.command("admin.$cmd",{ismaster:!0},{monitoring:!0},function(o,t){if(o)emitSDAMEvent(e,"serverHearbeatFailed",{durationMS:n,failure:o,connectionId:e.name});else{e.emit("ismaster",t,e);var n=(new Date).getTime()-r;emitSDAMEvent(e,"serverHeartbeatSucceeded",{durationMS:n,reply:t.result,connectionId:e.name}),changedIsMaster(e,e.s.ismaster,t.result)&&emitServerDescriptionChanged(e,{address:e.name,arbiters:[],hosts:[],passives:[],type:e.s.inTopology?getTopologyType(e):"Standalone"}),e.s.ismaster=t.result,e.s.isMasterLatencyMS=n}e.s.inquireServerStateTimeout=setTimeout(inquireServerState(e),e.s.haInterval)})}}};Server.prototype.unref=function(){this.s.pool.unref()},Server.prototype.destroy=function(e,r){var o=this;o.s.logger.isDebug()&&o.s.logger.debug(f("destroy called on server %s",o.name)),o.s.state!=DESTROYED&&(this.s.inquireServerStateTimeout&&clearTimeout(this.s.inquireServerStateTimeout),e&&o.listeners("close").length>0&&o.emit("close",null,o),o.listeners("serverClosed").length>0&&o.emit("serverClosed",{topologyId:-1!=o.s.topologyId?o.s.topologyId:o.s.id,address:o.name}),o.listeners("topologyClosed").length>0&&!o.s.inTopology&&o.emit("topologyClosed",{topologyId:o.s.id}),r&&o.emit("destroy",o),o.s.state=DESTROYED,o.s.pool&&o.s.pool.destroy(),o.s.callbacks&&o.s.callbacks.flush(new MongoError(f("server %s sockets closed",o.name))))},Server.prototype.isConnected=function(){var e=this;return e.s.pool?e.s.pool.isConnected():!1},Server.prototype.isDestroyed=function(){return this.s.state==DESTROYED};var executeSingleOperation=function(e,r,o,t,n,s,i){var a=new Query(e.s.bson,r,o,t);a.slaveOk=slaveOk(n.readPreference),null!=e.s.readPreferenceStrategies&&notifyStrategies(e,e.s,"startOperation",[e,a,new Date]);var l="boolean"==typeof n.raw?n.raw:!1,c="boolean"==typeof n.promoteLongs?n.promoteLongs:!0,u="boolean"==typeof n.monitoring?n.monitoring:!1;if(s)for(var p=e.s.pool.getAll(),d=p.length,g=null,f=0;f<p.length;f++){var m=function(r){return function(o,t){if(o&&(g=o),d-=1,0==d){if(notifyStrategies(e,e.s,"endOperation",[e,g,t,new Date]),g)return i(MongoError.create(g));t.hashedName=r.hashedName;try{i(null,new CommandResult(n.fullResult?t:t.documents[0],p))}catch(o){process.nextTick(function(){throw o})}}}};try{a.incRequestId(),p[f].write(a.toBin())}catch(v){if(d-=1,0==d)return i(MongoError.create(v))}l&&(m.raw=!0),m.promoteLongs=c,m.monitoring=u,m.connection=p[f],e.s.callbacks.register(a.requestId,m(p[f]))}else{var m=function(r,o){if(notifyStrategies(e,e.s,"endOperation",[e,r,o,new Date]),r)return i(r);if(o.documents[0].$err||o.documents[0].errmsg||o.documents[0].err||o.documents[0].code)return i(MongoError.create(o.documents[0]));o.hashedName=o.connection.hashedName;try{i(null,new CommandResult(n.fullResult?o:o.documents[0],o.connection))}catch(r){process.nextTick(function(){throw r})}};try{m.monitoring=u,n.connection?(m.connection=n.connection,m.noRelease=!0,n.connection.write(a.toBin())):e.s.pool.write(a.toBin(),m,n)}catch(v){return i(MongoError.create(v))}l&&(m.raw=!0),m.promoteLongs=c,e.s.callbacks.register(a.requestId,m)}};Server.prototype.command=function(e,r,o,t){"function"==typeof o&&(t=o,o={});var n=this;if(this.s.state==DESTROYED)return t(new MongoError(f("topology was destroyed")));if(o=o||{},o.readPreference&&!(o.readPreference instanceof ReadPreference))throw new Error("readPreference must be an instance of ReadPreference");if(n.s.logger.isDebug()&&n.s.logger.debug(f("executing command [%s] against %s",JSON.stringify({ns:e,cmd:r,options:debugOptions(debugFields,o)}),n.name)),!n.isConnected()&&null!=n.s.disconnectHandler)return t=bindToCurrentDomain(t),n.s.disconnectHandler.add("command",e,r,o,t);if(!n.s.pool.isConnected())return t(new MongoError(f("no connection available to server %s",n.name)));var s="boolean"==typeof o.onAll?o.onAll:!1,i="boolean"==typeof o.checkKeys?o.checkKeys:!1,a="boolean"==typeof o.serializeFunctions?o.serializeFunctions:!1,l="boolean"==typeof o.ignoreUndefined?o.ignoreUndefined:!1,c=("boolean"==typeof o.raw?o.raw:!1,{numberToSkip:0,numberToReturn:-1,checkKeys:i});a&&(c.serializeFunctions=a),l&&(c.ignoreUndefined=l),executeSingleOperation(n,e,r,c,o,s,t)},Server.prototype.insert=function(e,r,o,t){"function"==typeof o&&(t=o,o={});var n=this;return this.s.state==DESTROYED?t(new MongoError(f("topology was destroyed"))):n.isConnected()||null==n.s.disconnectHandler?(r=Array.isArray(r)?r:[r],n.s.wireProtocolHandler.insert(n,n.s.ismaster,e,n.s.bson,n.s.pool,n.s.callbacks,r,o,t)):(t=bindToCurrentDomain(t),n.s.disconnectHandler.add("insert",e,r,o,t))},Server.prototype.update=function(e,r,o,t){"function"==typeof o&&(t=o,o={});var n=this;return this.s.state==DESTROYED?t(new MongoError(f("topology was destroyed"))):n.isConnected()||null==n.s.disconnectHandler?(r=Array.isArray(r)?r:[r],n.s.wireProtocolHandler.update(n,n.s.ismaster,e,n.s.bson,n.s.pool,n.s.callbacks,r,o,t)):(t=bindToCurrentDomain(t),n.s.disconnectHandler.add("update",e,r,o,t))},Server.prototype.remove=function(e,r,o,t){"function"==typeof o&&(t=o,o={});var n=this;return this.s.state==DESTROYED?t(new MongoError(f("topology was destroyed"))):n.isConnected()||null==n.s.disconnectHandler?(r=Array.isArray(r)?r:[r],n.s.wireProtocolHandler.remove(n,n.s.ismaster,e,n.s.bson,n.s.pool,n.s.callbacks,r,o,t)):(t=bindToCurrentDomain(t),n.s.disconnectHandler.add("remove",e,r,o,t))},Server.prototype.auth=function(e,r){var o=this,t=Array.prototype.slice.call(arguments,2),n=t.pop();if(null==o.s.authProviders[e]&&"default"!=e)throw new MongoError(f("auth provider %s does not exist",e));"default"==e&&o.s.ismaster&&o.s.ismaster.maxWireVersion>=3?e="scram-sha-1":"default"==e&&(e="mongocr");var s=o.s.pool.getAll(),i=[o,s,r].concat(t.slice(0)).concat([function(e,r){return e?n(e):r?void n(null,new Session({},o)):n(new MongoError("could not authenticate"))}]);o.s.authProviders[e].auth.apply(o.s.authProviders[e],i)},Server.prototype.addReadPreferenceStrategy=function(e,r){var o=this;null==o.s.readPreferenceStrategies&&(o.s.readPreferenceStrategies={}),o.s.readPreferenceStrategies[e]=r},Server.prototype.addAuthProvider=function(e,r){var o=this;o.s.authProviders[e]=r},Server.prototype.equals=function(e){return"string"==typeof e?e==this.name:e&&e.name?e.name==this.name:!1},Server.prototype.connections=function(){return this.s.pool.getAll()},Server.prototype.getServer=function(e){return this},Server.prototype.getServerFrom=function(e){return this},Server.prototype.getConnection=function(e){return this.s.pool.get()},Server.prototype.getCallbacks=function(){return this.s.callbacks},Server.prototype.parserType=function(){var e=this.s;return-1!=e.options.bson.serialize.toString().indexOf("[native code]")?"c++":"js"},Server.prototype.cursor=function(e,r,o){var t=this.s;o=o||{};var n=o.cursorFactory||t.Cursor;return new n(t.bson,e,r,o,this,t.options)},module.exports=Server;