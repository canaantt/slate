"use strict";var Insert=require("./commands").Insert,Update=require("./commands").Update,Remove=require("./commands").Remove,Query=require("../connection/commands").Query,copy=require("../connection/utils").copy,KillCursor=require("../connection/commands").KillCursor,GetMore=require("../connection/commands").GetMore,Query=require("../connection/commands").Query,ReadPreference=require("../topologies/read_preference"),f=require("util").format,CommandResult=require("../topologies/command_result"),MongoError=require("../error"),Long=require("bson").Long,getReadPreference=require("./shared").getReadPreference,WireProtocol=function(){},executeWrite=function(e,r,o,n,t,i,a){if(0==t.length)throw new MongoError("insert must contain at least one document");"function"==typeof i&&(a=i,i={});var c=n.split("."),s=c.shift(),u="boolean"==typeof i.ordered?i.ordered:!0,l=i.writeConcern||{},d={};d[r]=c.join("."),d[o]=t,d.ordered=u,l&&Object.keys(l).length>0&&(d.writeConcern=l);var m={};"insert"==r&&(m.checkKeys=!0),i.serializeFunctions&&(m.serializeFunctions=i.serializeFunctions),i.ignoreUndefined&&(m.ignoreUndefined=i.ignoreUndefined),e.command(f("%s.$cmd",s),d,m,a)};WireProtocol.prototype.insert=function(e,r,o,n,t,i,a,c,s){executeWrite(e,"insert","documents",o,a,c,s)},WireProtocol.prototype.update=function(e,r,o,n,t,i,a,c,s){executeWrite(e,"update","updates",o,a,c,s)},WireProtocol.prototype.remove=function(e,r,o,n,t,i,a,c,s){executeWrite(e,"delete","deletes",o,a,c,s)},WireProtocol.prototype.killCursor=function(e,r,o,n,t,i){var a=new KillCursor(e,[o]);n&&n.isConnected()&&n.write(a.toBin(),i,{immediateRelease:!0}),o=Long.ZERO,i&&i(null,null)},WireProtocol.prototype.getMore=function(e,r,o,n,t,i,a,c,s){var u=new GetMore(e,r,o.cursorId,{numberToReturn:n}),l=function(e,r){if(e)return s(e);if(0!=(1&r.responseFlags))return s(new MongoError("cursor killed or timed out"),null);var n="number"==typeof r.cursorId?Long.fromNumber(r.cursorId):r.cursorId;o.documents=r.documents,o.cursorId=n,s(null,null,r.connection)};t&&(l.raw=t),"boolean"==typeof o.promoteLongs&&(l.promoteLongs=o.promoteLongs),a.register(u.requestId,l),i.write(u.toBin(),l)},WireProtocol.prototype.command=function(e,r,o,n,t,i){if(o.find)return setupClassicFind(e,r,o,n,t,i);if(null==n.cursorId){if(o)return setupCommand(e,r,o,n,t,i);throw new MongoError(f("command %s does not return a cursor",JSON.stringify(o)))}};var setupClassicFind=function(e,r,o,n,t,i){i=i||{};var a=getReadPreference(o,i);n.batchSize=o.batchSize||n.batchSize;var c=0;c=0==n.limit?n.batchSize:n.limit<0||n.limit<n.batchSize||n.limit>0&&0==n.batchSize?n.limit:n.batchSize;var s=n.skip||0,u={},l=!1;if("mongos"==t.type&&a&&(u.$readPreference=a.toJSON(),l=!0),o.sort&&(u.orderby=o.sort,l=!0),o.hint&&(u.$hint=o.hint,l=!0),o.snapshot&&(u.$snapshot=o.snapshot,l=!0),o.returnKey&&(u.$returnKey=o.returnKey,l=!0),o.maxScan&&(u.$maxScan=o.maxScan,l=!0),o.min&&(u.$min=o.min,l=!0),o.max&&(u.$max=o.max,l=!0),o.showDiskLoc&&(u.$showDiskLoc=o.showDiskLoc,l=!0),o.comment&&(u.$comment=o.comment,l=!0),o.maxTimeMS&&(u.$maxTimeMS=o.maxTimeMS,l=!0),o.explain&&(c=-Math.abs(o.limit||0),l=!0,u.$explain=!0),l?u.$query=o.query:u=o.query,o.readConcern&&"local"!=o.readConcern.level)throw new MongoError(f("server find command does not support a readConcern level of %s",o.readConcern.level));o.readConcern&&(o=copy(o),delete o.readConcern);var d="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,m="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1,p=new Query(e,r,u,{numberToSkip:s,numberToReturn:c,checkKeys:!1,returnFieldSelector:o.fields,serializeFunctions:d,ignoreUndefined:m});return p.slaveOk=a.slaveOk(),"boolean"==typeof o.tailable&&(p.tailable=o.tailable),"boolean"==typeof o.oplogReplay&&(p.oplogReplay=o.oplogReplay),"boolean"==typeof o.noCursorTimeout&&(p.noCursorTimeout=o.noCursorTimeout),"boolean"==typeof o.awaitData&&(p.awaitData=o.awaitData),"boolean"==typeof o.partial&&(p.partial=o.partial),p},setupCommand=function(e,r,o,n,t,i){i=i||{};var a=getReadPreference(o,i),c={};for(var s in o)c[s]=o[s];var u=r.split(/\./),l="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,d="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;if(o.readConcern&&"local"!=o.readConcern.level)throw new MongoError(f("server %s command does not support a readConcern level of %s",JSON.stringify(o),o.readConcern.level));o.readConcern&&delete o.readConcern,"mongos"==t.type&&a&&"primary"!=a.preference&&(c={$query:c,$readPreference:a.toJSON()});var m=new Query(e,f("%s.$cmd",u.shift()),c,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,serializeFunctions:l,ignoreUndefined:d});return m.slaveOk=a.slaveOk(),m},bindToCurrentDomain=function(e){var r=process.domain;return null==r||null==e?e:r.bind(e)};module.exports=WireProtocol;