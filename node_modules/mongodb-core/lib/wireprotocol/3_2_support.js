"use strict";var Insert=require("./commands").Insert,Update=require("./commands").Update,Remove=require("./commands").Remove,Query=require("../connection/commands").Query,copy=require("../connection/utils").copy,KillCursor=require("../connection/commands").KillCursor,GetMore=require("../connection/commands").GetMore,Query=require("../connection/commands").Query,ReadPreference=require("../topologies/read_preference"),f=require("util").format,CommandResult=require("../topologies/command_result"),MongoError=require("../error"),Long=require("bson").Long,getReadPreference=require("./shared").getReadPreference,WireProtocol=function(e){this.legacyWireProtocol=e},executeWrite=function(e,r,o,n,t,i,a){if(0==t.length)throw new MongoError("insert must contain at least one document");"function"==typeof i&&(a=i,i={});var u=n.split("."),s=u.shift(),c="boolean"==typeof i.ordered?i.ordered:!0,l=i.writeConcern,m={};m[r]=u.join("."),m[o]=t,m.ordered=c,l&&Object.keys(l).length>0&&(m.writeConcern=l),"boolean"==typeof i.bypassDocumentValidation&&(m.bypassDocumentValidation=i.bypassDocumentValidation);var d={};"insert"==r&&(d.checkKeys=!0),i.serializeFunctions&&(d.serializeFunctions=i.serializeFunctions),i.ignoreUndefined&&(d.ignoreUndefined=i.ignoreUndefined),e.command(f("%s.$cmd",s),m,d,a)};WireProtocol.prototype.insert=function(e,r,o,n,t,i,a,u,s){executeWrite(e,"insert","documents",o,a,u,s)},WireProtocol.prototype.update=function(e,r,o,n,t,i,a,u,s){executeWrite(e,"update","updates",o,a,u,s)},WireProtocol.prototype.remove=function(e,r,o,n,t,i,a,u,s){executeWrite(e,"delete","deletes",o,a,u,s)},WireProtocol.prototype.killCursor=function(e,r,o,n,t,i){var a=r.split(/\./),u=f("%s.$cmd",a.shift()),s={killCursors:a.join("."),cursors:[o]},c=new Query(e,u,s,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,returnFieldSelector:null});c.slaveOk=!0,n&&n.isConnected()&&n.write(c.toBin(),i);var l=function(e,r){if(e){if("function"!=typeof i)return;return i(e)}if(0!=(1&r.responseFlags)){if("function"!=typeof i)return;return i(new MongoError("cursor killed or timed out"),null)}if(!Array.isArray(r.documents)||0==r.documents.length){if("function"!=typeof i)return;return i(new MongoError(f("invalid killCursors result returned for cursor id %s",cursorState.cursorId)))}"function"==typeof i&&i(null,r.documents[0])};t.register(c.requestId,l)},WireProtocol.prototype.getMore=function(e,r,o,n,t,i,a,u,s){u=u||{};var c=r.split(/\./),l=f("%s.$cmd",c.shift()),m=("number"==typeof o.cmd.maxTimeMS?o.cmd.maxTimeMS:3e3,{getMore:o.cursorId,collection:c.join("."),batchSize:Math.abs(n)});o.cmd.tailable&&"number"==typeof o.cmd.maxAwaitTimeMS&&(m.maxTimeMS=o.cmd.maxAwaitTimeMS);var d=new Query(e,l,m,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,returnFieldSelector:null});d.slaveOk=!0;var p=function(e,r){if(e)return s(e);if(0!=(1&r.responseFlags))return s(new MongoError("cursor killed or timed out"),null);if(t)return o.documents=r.documents,o.cursorId=r.cursorId,s(null,r.documents);if(0==r.documents[0].ok)return s(MongoError.create(r.documents[0]));var n="number"==typeof r.documents[0].cursor.id?Long.fromNumber(r.documents[0].cursor.id):r.documents[0].cursor.id;o.documents=r.documents[0].cursor.nextBatch,o.cursorId=n,s(null,r.documents[0],r.connection)};t&&(p.raw=t),p.documentsReturnedIn="nextBatch","boolean"==typeof o.promoteLongs&&(p.promoteLongs=o.promoteLongs),a.register(d.requestId,p),i.write(d.toBin(),p)},WireProtocol.prototype.command=function(e,r,o,n,t,i){if(o.find){var a=executeFindCommand(e,r,o,n,t,i);return o.virtual=!1,a.documentsReturnedIn="firstBatch",a}if(null==n.cursorId){if(o)return setupCommand(e,r,o,n,t,i);throw new MongoError(f("command %s does not return a cursor",JSON.stringify(o)))}};var executeFindCommand=function(e,r,o,n,t,i){i=i||{};var a=getReadPreference(o,i);n.batchSize=o.batchSize||n.batchSize;var u=r.split(/\./),s=f("%s.$cmd",u.shift()),c={find:u.join(".")};o.query&&(o.query.$query?c.filter=o.query.$query:c.filter=o.query);var l=o.sort;if(Array.isArray(l)){var m={};if(l.length>0&&!Array.isArray(l[0])){var d=l[1];"asc"==d?d=1:"desc"==d&&(d=-1),m[l[0]]=d}else for(var p=0;p<l.length;p++){var d=l[p][1];"asc"==d?d=1:"desc"==d&&(d=-1),m[l[p][0]]=d}l=m}o.sort&&(c.sort=l),o.fields&&(c.projection=o.fields),o.hint&&(c.hint=o.hint),o.skip&&(c.skip=o.skip),o.limit&&(c.limit=o.limit),"number"==typeof o.batchSize&&(c.batchSize=Math.abs(o.batchSize)),o.limit<0&&(c.limit=Math.abs(o.limit),c.singleBatch=!0),o.comment&&(c.comment=o.comment),o.maxScan&&(c.maxScan=o.maxScan),o.maxTimeMS&&(c.maxTimeMS=o.maxTimeMS),o.min&&(c.min=o.min),o.max&&(c.max=o.max),o.returnKey&&(c.returnKey=o.returnKey),o.showDiskLoc&&(c.showRecordId=o.showDiskLoc),o.snapshot&&(c.snapshot=o.snapshot),o.tailable&&(c.tailable=o.tailable),o.oplogReplay&&(c.oplogReplay=o.oplogReplay),o.noCursorTimeout&&(c.noCursorTimeout=o.noCursorTimeout),o.awaitData&&(c.awaitData=o.awaitData),o.awaitdata&&(c.awaitData=o.awaitdata),o.partial&&(c.partial=o.partial),o.explain&&(c={explain:c}),o.readConcern&&(c.readConcern=o.readConcern);var y="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,g="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;"mongos"==t.type&&a&&"primary"!=a.preference&&(c={$query:c,$readPreference:a.toJSON()});var h=new Query(e,s,c,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,returnFieldSelector:null,serializeFunctions:y,ignoreUndefined:g});return h.slaveOk=a.slaveOk(),h},setupCommand=function(e,r,o,n,t,i){i=i||{};var a=getReadPreference(o,i),u={};for(var s in o)u[s]=o[s];var c=r.split(/\./),l="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,m="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;"mongos"==t.type&&a&&"primary"!=a.preference&&(u={$query:u,$readPreference:a.toJSON()});var d=new Query(e,f("%s.$cmd",c.shift()),u,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,serializeFunctions:l,ignoreUndefined:m});return d.slaveOk=a.slaveOk(),d},bindToCurrentDomain=function(e){var r=process.domain;return null==r||null==e?e:r.bind(e)};module.exports=WireProtocol;