"use strict";var Insert=require("./commands").Insert,Update=require("./commands").Update,Remove=require("./commands").Remove,Query=require("../connection/commands").Query,copy=require("../connection/utils").copy,KillCursor=require("../connection/commands").KillCursor,GetMore=require("../connection/commands").GetMore,Query=require("../connection/commands").Query,ReadPreference=require("../topologies/read_preference"),f=require("util").format,CommandResult=require("../topologies/command_result"),MongoError=require("../error"),Long=require("bson").Long,getReadPreference=require("./shared").getReadPreference,writeConcernFields=["w","wtimeout","j","fsync"],WireProtocol=function(){};WireProtocol.prototype.insert=function(e,r,n,o,t,i,a,s,u){s=s||{};var c="boolean"==typeof s.ordered?s.ordered:!0;"boolean"==typeof s.legacy?s.legacy:!1;if(a=Array.isArray(a)?a:[a],a.length>1e3)return u(new MongoError("exceeded maximum write batch size of 1000"));var l=s.writeConcern||{w:1};return c&&0!=l.w?executeOrdered("insert",Insert,r,n,o,t,i,a,s,u):executeUnordered("insert",Insert,r,n,o,t,i,a,s,u)},WireProtocol.prototype.update=function(e,r,n,o,t,i,a,s,u){s=s||{};var c="boolean"==typeof s.ordered?s.ordered:!0;a=Array.isArray(a)?a:[a];var l=s.writeConcern||{w:1};return c&&0!=l.w?executeOrdered("update",Update,r,n,o,t,i,a,s,u):executeUnordered("update",Update,r,n,o,t,i,a,s,u)},WireProtocol.prototype.remove=function(e,r,n,o,t,i,a,s,u){s=s||{};var c="boolean"==typeof s.ordered?s.ordered:!0;a=Array.isArray(a)?a:[a];var l=s.writeConcern||{w:1};return c&&0!=l.w?executeOrdered("remove",Remove,r,n,o,t,i,a,s,u):executeUnordered("remove",Remove,r,n,o,t,i,a,s,u)},WireProtocol.prototype.killCursor=function(e,r,n,o,t,i){var a=new KillCursor(e,[n]);o&&o.isConnected()&&o.write(a.toBin(),i,{immediateRelease:!0}),n=Long.ZERO,i&&i(null,null)},WireProtocol.prototype.getMore=function(e,r,n,o,t,i,a,s,u){var c=new GetMore(e,r,n.cursorId,{numberToReturn:o}),l=function(e,r){if(e)return u(e);if(0!=(1&r.responseFlags))return u(new MongoError("cursor killed or timed out"),null);var o="number"==typeof r.cursorId?Long.fromNumber(r.cursorId):r.cursorId;n.documents=r.documents,n.cursorId=o,u(null,null,r.connection)};t&&(l.raw=t),"boolean"==typeof n.promoteLongs&&(l.promoteLongs=n.promoteLongs),a.register(c.requestId,l),i.write(c.toBin(),l)},WireProtocol.prototype.command=function(e,r,n,o,t,i){if(n.find)return setupClassicFind(e,r,n,o,t,i);if(null==o.cursorId){if(n)return setupCommand(e,r,n,o,t,i);throw new MongoError(f("command %s does not return a cursor",JSON.stringify(n)))}};var setupClassicFind=function(e,r,n,o,t,i){i=i||{};var a=getReadPreference(n,i);o.batchSize=n.batchSize||o.batchSize;var s=0;s=0==o.limit?o.batchSize:o.limit<0||o.limit<o.batchSize||o.limit>0&&0==o.batchSize?o.limit:o.batchSize;var u=o.skip||0,c={},l=!1;if("mongos"==t.type&&a&&(c.$readPreference=a.toJSON(),l=!0),n.sort&&(c.orderby=n.sort,l=!0),n.hint&&(c.$hint=n.hint,l=!0),n.snapshot&&(c.$snapshot=n.snapshot,l=!0),n.returnKey&&(c.$returnKey=n.returnKey,l=!0),n.maxScan&&(c.$maxScan=n.maxScan,l=!0),n.min&&(c.$min=n.min,l=!0),n.max&&(c.$max=n.max,l=!0),n.showDiskLoc&&(c.$showDiskLoc=n.showDiskLoc,l=!0),n.comment&&(c.$comment=n.comment,l=!0),n.maxTimeMS&&(c.$maxTimeMS=n.maxTimeMS,l=!0),n.explain&&(s=-Math.abs(n.limit||0),l=!0,c.$explain=!0),l?c.$query=n.query:c=n.query,n.readConcern&&"local"!=n.readConcern.level)throw new MongoError(f("server find command does not support a readConcern level of %s",n.readConcern.level));n.readConcern&&(n=copy(n),delete n.readConcern);var d="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,m="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1,p=new Query(e,r,c,{numberToSkip:u,numberToReturn:s,checkKeys:!1,returnFieldSelector:n.fields,serializeFunctions:d,ignoreUndefined:m});return p.slaveOk=a.slaveOk(),"boolean"==typeof n.tailable&&(p.tailable=n.tailable),"boolean"==typeof n.oplogReplay&&(p.oplogReplay=n.oplogReplay),"boolean"==typeof n.noCursorTimeout&&(p.noCursorTimeout=n.noCursorTimeout),"boolean"==typeof n.awaitData&&(p.awaitData=n.awaitData),"boolean"==typeof n.partial&&(p.partial=n.partial),p},setupCommand=function(e,r,n,o,t,i){i=i||{};var a=getReadPreference(n,i),s={};for(var u in n)s[u]=n[u];var c=r.split(/\./);if(n.readConcern&&"local"!=n.readConcern.level)throw new MongoError(f("server %s command does not support a readConcern level of %s",JSON.stringify(n),n.readConcern.level));n.readConcern&&delete n.readConcern;var l="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,d="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;"mongos"==t.type&&a&&"primary"!=a.preference&&(s={$query:s,$readPreference:a.toJSON()});var m=new Query(e,f("%s.$cmd",c.shift()),s,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,serializeFunctions:l,ignoreUndefined:d});return m.slaveOk=a.slaveOk(),m},bindToCurrentDomain=function(e){var r=process.domain;return null==r||null==e?e:r.bind(e)},hasWriteConcern=function(e){return e.w||e.wtimeout||1==e.j||1==e.fsync||0==Object.keys(e).length?!0:!1},cloneWriteConcern=function(e){var r={};return null!=e.w&&(r.w=e.w),null!=e.wtimeout&&(r.wtimeout=e.wtimeout),null!=e.j&&(r.j=e.j),null!=e.fsync&&(r.fsync=e.fsync),r},aggregateWriteOperationResults=function(e,r,n,o){for(var t={ok:1,n:0},i=0;i<n.length;i++){var a=n[i],s=r[i];!a.upserted&&0!=a.updatedExisting||null!=t.upserted||(t.upserted=[]),a.upserted&&t.upserted.push({index:i,_id:a.upserted}),0==a.updatedExisting&&1==a.n&&null==a.upserted&&t.upserted.push({index:i,_id:s.q._id}),1==a.ok&&"insert"==e&&null==a.err&&(t.n=t.n+1),null!=a&&0==a.ok||a.err||a.errmsg?(0==a.ok&&(t.ok=0),t.code=a.code,t.errmsg=a.errmsg||a.err||a.errMsg,11e3==a.code||11001==a.code||12582==a.code||16544==a.code||16538==a.code||16542==a.code||14==a.code||13511==a.code?(null==t.writeErrors&&(t.writeErrors=[]),t.writeErrors.push({index:i,code:a.code,errmsg:a.errmsg||a.err||a.errMsg})):t.writeConcernError={code:a.code,errmsg:a.errmsg||a.err||a.errMsg}):"number"==typeof a.n?t.n+=a.n:t.n+=1,null!=a&&a.lastOp&&(t.lastOp=a.lastOp)}return new CommandResult(t,o)},executeOrdered=function(e,r,n,o,t,i,a,s,u,c){var l=s.slice(0);c=bindToCurrentDomain(c);var d=[],m=function(l,p){if(0==l.length)return process.nextTick(function(){p(null,aggregateWriteOperationResults(e,s,d,null))});var g=l.shift(),y=new r(Query.getRequestId(),n,t,o,[g],u),w=u.writeConcern||{w:1},v=cloneWriteConcern(w),C=o.split(".").shift();try{var h=[y.toBin()];if(hasWriteConcern(v)){for(var b={getlasterror:1},R=0;R<writeConcernFields.length;R++)null!=v[writeConcernFields[R]]&&(b[writeConcernFields[R]]=v[writeConcernFields[R]]);var x=new Query(t,f("%s.$cmd",C),b,{numberToReturn:-1});h.push(x.toBin());var k=function(r,n){if(r)return c(r);var o=n.documents[0];return d.push(o),0==o.ok||o.err||o.errmsg?c(null,aggregateWriteOperationResults(e,s,d,n.connection)):void m(l,c)};a.register(x.requestId,k),i.write(h,k)}else i.write(h,c,{immediateRelease:!0})}catch(q){"string"==typeof q&&(q=new MongoError(q)),d.push({ok:1,errmsg:q.message,code:14}),process.nextTick(function(){c(null,aggregateWriteOperationResults(e,s,d,null))})}};m(l,c)},executeUnordered=function(e,r,n,o,t,i,a,s,u,c){c=bindToCurrentDomain(c);for(var l,d=s.length,m=[],p=u.writeConcern||{w:1},g=cloneWriteConcern(p),y=0;y<s.length;y++){var w=new r(Query.getRequestId(),n,t,o,[s[y]],u),v=o.split(".").shift();try{var C=[w.toBin()];if(hasWriteConcern(g)){for(var h={getlasterror:1},b=0;b<writeConcernFields.length;b++)null!=g[writeConcernFields[b]]&&(h[writeConcernFields[b]]=g[writeConcernFields[b]]);var R=new Query(t,f("%s.$cmd",v),h,{numberToReturn:-1});C.push(R.toBin());var x=function(r){return function(n,o){n&&(l=n),d-=1,n||(m[r]=o.documents[0]),0==d&&process.nextTick(function(){return l?c(l):void c(null,aggregateWriteOperationResults(e,s,m,o.connection))})}};a.register(R.requestId,x(y)),i.write(C,x(y))}else i.write(C,c,{immediateRelease:!0})}catch(k){"string"==typeof k&&(k=new MongoError(k)),d-=1,m[y]={ok:1,errmsg:k.message,code:14},0==d&&c(null,aggregateWriteOperationResults(e,s,m,null))}}g&&0==g.w&&c&&c(null,null)};module.exports=WireProtocol;