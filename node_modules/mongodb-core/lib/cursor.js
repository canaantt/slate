"use strict";var Long=require("bson").Long,Logger=require("./connection/logger"),MongoError=require("./error"),f=require("util").format,Cursor=function(r,t,o,e,s,n){e=e||{};this.pool=null,this.server=null,this.disconnectHandler=e.disconnectHandler,this.bson=r,this.ns=t,this.cmd=o,this.options=e,this.topology=s,this.cursorState={cursorId:null,cmd:o,documents:e.documents||[],cursorIndex:0,dead:!1,killed:!1,init:!1,notified:!1,limit:e.limit||o.limit||0,skip:e.skip||o.skip||0,batchSize:e.batchSize||o.batchSize||1e3,currentLimit:0,transforms:e.transforms},"boolean"==typeof n.promoteLongs&&(this.cursorState.promoteLongs=n.promoteLongs),this.callbacks=null,this.logger=Logger("Cursor",e),"number"==typeof o?(this.cursorState.cursorId=Long.fromNumber(o),this.cursorState.lastCursorId=this.cursorState.cursorId):o instanceof Long&&(this.cursorState.cursorId=o,this.cursorState.lastCursorId=o)};Cursor.prototype.setCursorBatchSize=function(r){this.cursorState.batchSize=r},Cursor.prototype.cursorBatchSize=function(){return this.cursorState.batchSize},Cursor.prototype.setCursorLimit=function(r){this.cursorState.limit=r},Cursor.prototype.cursorLimit=function(){return this.cursorState.limit},Cursor.prototype.setCursorSkip=function(r){this.cursorState.skip=r},Cursor.prototype.cursorSkip=function(){return this.cursorState.skip};var handleCallback=function(r,t,o){try{r(t,o)}catch(t){process.nextTick(function(){throw t})}};Cursor.prototype._find=function(r){var t=this;t.logger.isDebug()&&t.logger.debug(f("issue initial query [%s] with flags [%s]",JSON.stringify(t.cmd),JSON.stringify(t.query)));var o=function(o,e){if(o)return r(o);if(e.queryFailure)return r(MongoError.create(e.documents[0]),null);if(t.connection=e.connection,Array.isArray(e.documents)&&1==e.documents.length&&(!t.cmd.find||t.cmd.find&&0==t.cmd.virtual)&&("string"!=e.documents[0].cursor||e.documents[0].$err||e.documents[0].errmsg||Array.isArray(e.documents[0].result))){if(e.documents[0].$err||e.documents[0].errmsg)return r(MongoError.create(e.documents[0]),null);if(null!=e.documents[0].cursor&&"string"!=typeof e.documents[0].cursor){var s=e.documents[0].cursor.id;return e.documents[0].cursor.ns&&(t.ns=e.documents[0].cursor.ns),t.cursorState.cursorId="number"==typeof s?Long.fromNumber(s):s,t.cursorState.lastCursorId=t.cursorState.cursorId,Array.isArray(e.documents[0].cursor.firstBatch)&&(t.cursorState.documents=e.documents[0].cursor.firstBatch),r(null,null)}if(Array.isArray(e.documents[0].result))return t.cursorState.documents=e.documents[0].result,t.cursorState.cursorId=Long.ZERO,r(null,null)}t.cursorState.cursorId=e.cursorId,t.cursorState.documents=e.documents,t.cursorState.lastCursorId=e.cursorId,t.cursorState.transforms&&"function"==typeof t.cursorState.transforms.query&&(t.cursorState.documents=t.cursorState.transforms.query(e)),r(null,null)};(t.options.raw||t.cmd.raw)&&(o.raw=t.options.raw||t.cmd.raw),"string"==typeof t.query.documentsReturnedIn&&(o.documentsReturnedIn=t.query.documentsReturnedIn),"boolean"==typeof t.cursorState.promoteLongs&&(o.promoteLongs=t.cursorState.promoteLongs),t.callbacks.register(t.query.requestId,o),t.pool.write(t.query.toBin(),o)},Cursor.prototype._getmore=function(r){this.logger.isDebug()&&this.logger.debug(f("schedule getMore call for query [%s]",JSON.stringify(this.query)));var t=this.options.raw||this.cmd.raw,o=this.cursorState.batchSize;this.cursorState.limit>0&&this.cursorState.currentLimit+o>this.cursorState.limit&&(o=this.cursorState.limit-this.cursorState.currentLimit);var e=this.pool;if(this.connection&&this.connection.isConnected()){var s=this.topology.getServerFrom(this.connection);s&&s.s.pool&&(e=s.s.pool)}this.server.wireProtocolHandler.getMore(this.bson,this.ns,this.cursorState,o,t,e,this.callbacks,this.options,r)},Cursor.prototype._killcursor=function(r){if(this.cursorState.dead=!0,this.cursorState.killed=!0,this.cursorState.documents=[],null==this.cursorState.cursorId||this.cursorState.cursorId.isZero()||0==this.cursorState.init)return void(r&&r(null,null));var t=this.pool;if(this.connection&&this.connection.isConnected()){var o=this.topology.getServerFrom(this.connection);o&&o.s.pool&&(t=o.s.pool)}this.server.wireProtocolHandler.killCursor(this.bson,this.ns,this.cursorState.cursorId,t,this.callbacks,r)},Cursor.prototype.clone=function(){return this.topology.cursor(this.ns,this.cmd,this.options)},Cursor.prototype.isDead=function(){return 1==this.cursorState.dead},Cursor.prototype.isKilled=function(){return 1==this.cursorState.killed},Cursor.prototype.isNotified=function(){return 1==this.cursorState.notified},Cursor.prototype.bufferedCount=function(){return this.cursorState.documents.length-this.cursorState.cursorIndex},Cursor.prototype.readBufferedDocuments=function(r){var t=this.cursorState.documents.length-this.cursorState.cursorIndex,o=t>r?r:t,e=this.cursorState.documents.slice(this.cursorState.cursorIndex,this.cursorState.cursorIndex+o);if(this.cursorState.transforms&&"function"==typeof this.cursorState.transforms.doc)for(var s=0;s<e.length;s++)e[s]=this.cursorState.transforms.doc(e[s]);return this.cursorState.limit>0&&this.cursorState.currentLimit+e.length>this.cursorState.limit&&(e=e.slice(0,this.cursorState.limit-this.cursorState.currentLimit),this.kill()),this.cursorState.currentLimit=this.cursorState.currentLimit+e.length,this.cursorState.cursorIndex=this.cursorState.cursorIndex+e.length,e},Cursor.prototype.kill=function(r){this._killcursor(r)},Cursor.prototype.rewind=function(){this.cursorState.init&&(this.cursorState.dead||this.kill(),this.cursorState.currentLimit=0,this.cursorState.init=!1,this.cursorState.dead=!1,this.cursorState.killed=!1,this.cursorState.notified=!1,this.cursorState.documents=[],this.cursorState.cursorId=null,this.cursorState.cursorIndex=0)};var isConnectionDead=function(r,t){return r.pool&&!r.pool.isConnected()?(r.cursorState.notified=!0,r.cursorState.killed=!0,r.cursorState.documents=[],r.cursorState.cursorIndex=0,t(MongoError.create(f("connection to host %s:%s was destroyed",r.pool.host,r.pool.port))),!0):!1},isCursorDeadButNotkilled=function(r,t){return r.cursorState.dead&&!r.cursorState.killed?(r.cursorState.notified=!0,r.cursorState.killed=!0,r.cursorState.documents=[],r.cursorState.cursorIndex=0,handleCallback(t,null,null),!0):!1},isCursorDeadAndKilled=function(r,t){return r.cursorState.dead&&r.cursorState.killed?(handleCallback(t,MongoError.create("cursor is dead")),!0):!1},isCursorKilled=function(r,t){return r.cursorState.killed?(r.cursorState.notified=!0,r.cursorState.documents=[],r.cursorState.cursorIndex=0,handleCallback(t,null,null),!0):!1},setCursorDeadAndNotified=function(r,t){r.cursorState.dead=!0,r.cursorState.notified=!0,r.cursorState.documents=[],r.cursorState.cursorIndex=0,handleCallback(t,null,null)},setCursorNotified=function(r,t){r.cursorState.notified=!0,r.cursorState.documents=[],r.cursorState.cursorIndex=0,handleCallback(t,null,null)},push=Array.prototype.push,nextFunction=function(r,t){if(r.cursorState.notified)return t(new Error("cursor is exhausted"));if(!isCursorKilled(r,t)&&!isCursorDeadButNotkilled(r,t)&&!isCursorDeadAndKilled(r,t)){if(!r.cursorState.init){if(!r.topology.isConnected(r.options)&&null!=r.disconnectHandler)return r.disconnectHandler.addObjectAndMethod("cursor",r,"next",[t],t);try{r.server=r.topology.getServer(r.options),r.pool=r.server.s.pool,r.callbacks=r.server.getCallbacks()}catch(o){return null!=r.disconnectHandler?r.disconnectHandler.addObjectAndMethod("cursor",r,"next",[t],t):t(o)}r.cursorState.init=!0;try{r.query=r.server.wireProtocolHandler.command(r.bson,r.ns,r.cmd,r.cursorState,r.topology,r.options)}catch(o){return t(o)}}if(null==r.cursorState.cursorId){if(isConnectionDead(r,t))return;if(r.topology.isDestroyed())return t(new MongoError(f("connection destroyed, not possible to instantiate cursor")));r._find(function(o,e){return o?handleCallback(t,o,null):0==r.cursorState.documents.length&&r.cursorState.cursorId&&r.cursorState.cursorId.isZero()&&!r.cmd.tailable&&!r.cmd.awaitData?setCursorNotified(r,t):void nextFunction(r,t)})}else{if(r.cursorState.limit>0&&r.cursorState.currentLimit>=r.cursorState.limit)return r.kill(),setCursorDeadAndNotified(r,t);if(r.cursorState.cursorIndex!=r.cursorState.documents.length||Long.ZERO.equals(r.cursorState.cursorId)){if(r.cursorState.documents.length==r.cursorState.cursorIndex&&r.cmd.tailable&&Long.ZERO.equals(r.cursorState.cursorId))return handleCallback(t,MongoError.create({message:"No more documents in tailed cursor",tailable:r.cmd.tailable,awaitData:r.cmd.awaitData}));if(r.cursorState.documents.length==r.cursorState.cursorIndex&&Long.ZERO.equals(r.cursorState.cursorId))setCursorDeadAndNotified(r,t);else{if(r.cursorState.limit>0&&r.cursorState.currentLimit>=r.cursorState.limit)return r.kill(),setCursorDeadAndNotified(r,t);r.cursorState.currentLimit+=1;var e=r.cursorState.documents[r.cursorState.cursorIndex++];if(e.$err)return r.kill(),setCursorDeadAndNotified(r,function(){handleCallback(t,new MongoError(e.$err))});r.cursorState.transforms&&"function"==typeof r.cursorState.transforms.doc&&(e=r.cursorState.transforms.doc(e)),handleCallback(t,null,e)}}else{if(r.cursorState.documents=[],r.cursorState.cursorIndex=0,r.topology.isDestroyed())return t(new MongoError(f("connection destroyed, not possible to instantiate cursor")));if(isConnectionDead(r,t))return;r._getmore(function(o,e,s){return o&&43!=o.code?handleCallback(t,o):o&&43==o.code||0==r.cursorState.documents.length&&Long.ZERO.equals(r.cursorState.cursorId)&&!r.cmd.tailable?(r.cursorState.dead=!0,setCursorDeadAndNotified(r,t)):(r.connection=s,0==r.cursorState.documents.length&&r.cmd.tailable&&Long.ZERO.equals(r.cursorState.cursorId)?handleCallback(t,MongoError.create({message:"No more documents in tailed cursor",tailable:r.cmd.tailable,awaitData:r.cmd.awaitData})):0==r.cursorState.documents.length&&r.cmd.tailable&&!Long.ZERO.equals(r.cursorState.cursorId)?nextFunction(r,t):r.cursorState.limit>0&&r.cursorState.currentLimit>=r.cursorState.limit?setCursorDeadAndNotified(r,t):void nextFunction(r,t))})}}}};Cursor.prototype.next=function(r){nextFunction(this,r)},module.exports=Cursor;