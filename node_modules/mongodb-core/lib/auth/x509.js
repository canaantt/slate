"use strict";var f=require("util").format,crypto=require("crypto"),MongoError=require("../error"),AuthSession=function(t,r,e){this.db=t,this.username=r,this.password=e};AuthSession.prototype.equal=function(t){return t.db==this.db&&t.username==this.username&&t.password==this.password};var X509=function(){this.authStore=[]};X509.prototype.auth=function(t,r,e,n,u,o){var s=this,i=r.length;if(0==i)return o(null,null);for(var a=0,l=!1,h=null;r.length>0;){var c=function(r){var c={authenticate:1,mechanism:"MONGODB-X509",user:n};t.command("$external.$cmd",c,{connection:r},function(t,r){i-=1,t?h=t:r.result.$err?h=r.result:r.result.errmsg?h=r.result:(l=!0,a+=1),0==i&&a>0?(addAuthSession(s.authStore,new AuthSession(e,n,u)),o(null,!0)):0==i&&(null==h&&(h=new MongoError(f("failed to authenticate using mongocr"))),o(h,!1))})},d=function(t){process.nextTick(function(){c(t)})};d(r.shift())}};var addAuthSession=function(t,r){for(var e=!1,n=0;n<t.length;n++)if(t[n].equal(r)){e=!0;break}e||t.push(r)};X509.prototype.reauthenticate=function(t,r,e){var n=this.authStore.slice(0),u=n.length;if(0==u)return e(null,null);for(var o=0;o<n.length;o++)this.auth(t,r,n[o].db,n[o].username,n[o].password,function(t,r){t&&(t=t),u-=1,0==u&&e(t,null)})},module.exports=X509;