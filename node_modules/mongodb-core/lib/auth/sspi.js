"use strict";var f=require("util").format,crypto=require("crypto"),require_optional=require("require_optional"),MongoError=require("../error"),AuthSession=function(n,r,t,o){this.db=n,this.username=r,this.password=t,this.options=o};AuthSession.prototype.equal=function(n){return n.db==this.db&&n.username==this.username&&n.password==this.password};var Kerberos=null,MongoAuthProcess=null;try{Kerberos=require_optional("kerberos").Kerberos,MongoAuthProcess=require_optional("kerberos").processes.MongoAuthProcess}catch(err){}var SSPI=function(){this.authStore=[]};SSPI.prototype.auth=function(n,r,t,o,e,i,u){var a=this;if(null==Kerberos)return u(new Error("Kerberos library is not installed"));var s=i.gssapiServiceName||"mongodb",l=r.length;if(0==l)return u(null,null);for(var c=0,d=!1,h=null;r.length>0;){var p=function(r){SSIPAuthenticate(o,e,s,n,r,i,function(n,r){l-=1,n?h=n:r&&"object"==typeof r&&r.result.$err?h=r.result:r&&"object"==typeof r&&r.result.errmsg?h=r.result:(d=!0,c+=1),0==l&&c>0?(addAuthSession(a.authStore,new AuthSession(t,o,e,i)),u(null,!0)):0==l&&(null==h&&(h=new MongoError(f("failed to authenticate using mongocr"))),u(h,!1))})},v=function(n){process.nextTick(function(){p(n)})};v(r.shift())}};var SSIPAuthenticate=function(n,r,t,o,e,i,u){var a={saslStart:1,mechanism:"GSSAPI",payload:"",autoAuthorize:1},s=new MongoAuthProcess(e.host,e.port,t,i);o.command("$external.$cmd",a,{connection:e},function(t,i){if(t)return u(t,!1);var a=i.result;s.init(n,r,function(n){return n?u(n):void s.transition(a.payload,function(n,r){if(n)return u(n);var t={saslContinue:1,conversationId:a.conversationId,payload:r};o.command("$external.$cmd",t,{connection:e},function(n,r){if(n)return u(n,!1);var t=r.result;s.transition(t.payload,function(n,r){if(n)return u(n);var i={saslContinue:1,conversationId:t.conversationId,payload:r};o.command("$external.$cmd",i,{connection:e},function(n,r){if(n)return u(n,!1);var t=r.result;s.transition(t.payload,function(n,r){var i={saslContinue:1,conversationId:t.conversationId,payload:r};o.command("$external.$cmd",i,{connection:e},function(n,r){if(n)return u(n,!1);var t=r.result;return t.done?u(null,!0):void u(new Error("Authentication failed"),!1)})})})})})})})})},addAuthSession=function(n,r){for(var t=!1,o=0;o<n.length;o++)if(n[o].equal(r)){t=!0;break}t||n.push(r)};SSPI.prototype.reauthenticate=function(n,r,t){var o=this.authStore.slice(0),e=o.length;if(0==e)return t(null,null);for(var i=0;i<o.length;i++)this.auth(n,r,o[i].db,o[i].username,o[i].password,o[i].options,function(n,r){n&&(n=n),e-=1,0==e&&t(n,null)})},module.exports=SSPI;