"use strict";var f=require("util").format,crypto=require("crypto"),require_optional=require("require_optional"),MongoError=require("../error"),AuthSession=function(n,r,o,t){this.db=n,this.username=r,this.password=o,this.options=t};AuthSession.prototype.equal=function(n){return n.db==this.db&&n.username==this.username&&n.password==this.password};var Kerberos=null,MongoAuthProcess=null;try{Kerberos=require_optional("kerberos").Kerberos,MongoAuthProcess=require_optional("kerberos").processes.MongoAuthProcess}catch(err){}var GSSAPI=function(){this.authStore=[]};GSSAPI.prototype.auth=function(n,r,o,t,e,i,u){var s=this;if(null==Kerberos)return u(new Error("Kerberos library is not installed"));var a=i.gssapiServiceName||"mongodb",l=r.length;if(0==l)return u(null,null);for(var c=0,S=!1,d=null;r.length>0;){var h=function(r){GSSAPIInitialize(o,t,e,o,a,n,r,i,function(n,r){l-=1,n?d=n:r.result.$err?d=r.result:r.result.errmsg?d=r.result:(S=!0,c+=1),0==l&&c>0?(addAuthSession(s.authStore,new AuthSession(o,t,e,i)),u(null,!0)):0==l&&(null==d&&(d=new MongoError(f("failed to authenticate using mongocr"))),u(d,!1))})},p=function(n){process.nextTick(function(){h(n)})};p(r.shift())}};var GSSAPIInitialize=function(n,r,o,t,e,i,u,s,a){var l=new MongoAuthProcess(u.host,u.port,e,s);l.init(r,o,function(e,s){return e?a(e,!1):void l.transition("",function(e,s){return e?a(e,!1):void MongoDBGSSAPIFirstStep(l,s,n,r,o,t,i,u,a)})})},MongoDBGSSAPIFirstStep=function(n,r,o,t,e,i,u,s,a){var l={saslStart:1,mechanism:"GSSAPI",payload:r,autoAuthorize:1};u.command("$external.$cmd",l,{connection:s},function(r,l){if(r)return a(r,!1);var c=l.result;n.transition(l.result.payload,function(r,l){return r?a(r,!1):void MongoDBGSSAPISecondStep(n,l,c,o,t,e,i,u,s,a)})})},MongoDBGSSAPISecondStep=function(n,r,o,t,e,i,u,s,a,l){var c={saslContinue:1,conversationId:o.conversationId,payload:r};s.command("$external.$cmd",c,{connection:a},function(r,o){if(r)return l(r,!1);var c=o.result;n.transition(c.payload,function(r,o){return r?l(r,!1):void MongoDBGSSAPIThirdStep(n,o,c,t,e,i,u,s,a,l)})})},MongoDBGSSAPIThirdStep=function(n,r,o,t,e,i,u,s,a,l){var c={saslContinue:1,conversationId:o.conversationId,payload:r};s.command("$external.$cmd",c,{connection:a},function(r,o){return r?l(r,!1):void n.transition(null,function(n,r){return n?l(n,null):void l(null,o)})})},addAuthSession=function(n,r){for(var o=!1,t=0;t<n.length;t++)if(n[t].equal(r)){o=!0;break}o||n.push(r)};GSSAPI.prototype.reauthenticate=function(n,r,o){var t=this.authStore.slice(0),e=t.length;if(0==e)return o(null,null);for(var i=0;i<t.length;i++)this.auth(n,r,t[i].db,t[i].username,t[i].password,t[i].options,function(n,r){n&&(n=n),e-=1,0==e&&o(n,null)})},module.exports=GSSAPI;