"use strict";var f=require("util").format,crypto=require("crypto"),MongoError=require("../error"),AuthSession=function(t,n,e){this.db=t,this.username=n,this.password=e};AuthSession.prototype.equal=function(t){return t.db==this.db&&t.username==this.username&&t.password==this.password};var MongoCR=function(){this.authStore=[]},addAuthSession=function(t,n){for(var e=!1,r=0;r<t.length;r++)if(t[r].equal(n)){e=!0;break}e||t.push(n)};MongoCR.prototype.auth=function(t,n,e,r,o,u){var s=this,i=n.length;if(0==i)return u(null,null);for(var a=0,l=!1,c=null;n.length>0;){var h=function(n){t.command(f("%s.$cmd",e),{getnonce:1},{connection:n},function(h,d){var p=null,g=null;if(null==h){p=d.result.nonce;var m=crypto.createHash("md5");m.update(r+":mongo:"+o,"utf8");var v=m.digest("hex");m=crypto.createHash("md5"),m.update(p+r+v,"utf8"),g=m.digest("hex")}t.command(f("%s.$cmd",e),{authenticate:1,user:r,nonce:p,key:g},{connection:n},function(t,n){i-=1,t?c=t:n.result.$err?c=n.result:n.result.errmsg?c=n.result:(l=!0,a+=1),0==i&&a>0?(addAuthSession(s.authStore,new AuthSession(e,r,o)),u(null,!0)):0==i&&(null==c&&(c=new MongoError(f("failed to authenticate using mongocr"))),u(c,!1))})})},d=function(t){process.nextTick(function(){h(t)})};d(n.shift())}},MongoCR.prototype.reauthenticate=function(t,n,e){var r=this.authStore.slice(0),o=r.length;if(0==o)return e(null,null);for(var u=0;u<r.length;u++)this.auth(t,n,r[u].db,r[u].username,r[u].password,function(t,n){t&&(t=t),o-=1,0==o&&e(t,null)})},module.exports=MongoCR;