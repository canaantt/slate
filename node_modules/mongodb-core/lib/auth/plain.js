"use strict";var f=require("util").format,crypto=require("crypto"),Binary=require("bson").Binary,MongoError=require("../error"),AuthSession=function(t,r,n){this.db=t,this.username=r,this.password=n};AuthSession.prototype.equal=function(t){return t.db==this.db&&t.username==this.username&&t.password==this.password};var Plain=function(){this.authStore=[]};Plain.prototype.auth=function(t,r,n,e,o,u){var i=this,s=r.length;if(0==s)return u(null,null);for(var a=0,l=!1,h=null;r.length>0;){var c=function(r){var c=new Binary(f("\x00%s\x00%s",e,o)),d={saslStart:1,mechanism:"PLAIN",payload:c,autoAuthorize:1};t.command("$external.$cmd",d,{connection:r},function(t,r){s-=1,t?h=t:r.result.$err?h=r.result:r.result.errmsg?h=r.result:(l=!0,a+=1),0==s&&a>0?(addAuthSession(i.authStore,new AuthSession(n,e,o)),u(null,!0)):0==s&&(null==h&&(h=new MongoError(f("failed to authenticate using mongocr"))),u(h,!1))})},d=function(t){process.nextTick(function(){c(t)})};d(r.shift())}};var addAuthSession=function(t,r){for(var n=!1,e=0;e<t.length;e++)if(t[e].equal(r)){n=!0;break}n||t.push(r)};Plain.prototype.reauthenticate=function(t,r,n){var e=this.authStore.slice(0),o=e.length;if(0==o)return n(null,null);for(var u=0;u<e.length;u++)this.auth(t,r,e[u].db,e[u].username,e[u].password,function(t,r){t&&(t=t),o-=1,0==o&&n(t,null)})},module.exports=Plain;