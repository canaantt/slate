"use strict";var f=require("util").format,crypto=require("crypto"),Binary=require("bson").Binary,MongoError=require("../error"),AuthSession=function(e,r,t){this.db=e,this.username=r,this.password=t};AuthSession.prototype.equal=function(e){return e.db==this.db&&e.username==this.username&&e.password==this.password};var id=0,ScramSHA1=function(){this.authStore=[],this.id=id++},parsePayload=function(e){for(var r={},t=e.split(","),n=0;n<t.length;n++){var a=t[n].split("=");r[a[0]]=a[1]}return r},passwordDigest=function(e,r){if("string"!=typeof e)throw new MongoError("username must be a string");if("string"!=typeof r)throw new MongoError("password must be a string");if(0==r.length)throw new MongoError("password cannot be empty");var t=crypto.createHash("md5");return t.update(e+":mongo:"+r,"utf8"),t.digest("hex")},xor=function(e,r){Buffer.isBuffer(e)||(e=new Buffer(e)),Buffer.isBuffer(r)||(r=new Buffer(r));var t=[];if(e.length>r.length)for(var n=0;n<r.length;n++)t.push(e[n]^r[n]);else for(var n=0;n<e.length;n++)t.push(e[n]^r[n]);return new Buffer(t)},hi=function(e,r,t){var n=function(r){var t=crypto.createHmac("sha1",e);return t.update(r),new Buffer(t.digest("base64"),"base64")};r=Buffer.concat([r,new Buffer("\x00\x00\x00")]);for(var a=n(r),s=a,o=0;t-1>o;o++)s=n(s),a=xor(a,s);return a};ScramSHA1.prototype.auth=function(e,r,t,n,a,s){var o=this,u=r.length;if(0==u)return s(null,null);for(var i=0,c=!1,l=null,d=function(r){n=n.replace("=","=3D").replace(",","=2C");var d=crypto.randomBytes(24).toString("base64"),h=f("n=%s,r=%s",n,d),p={saslStart:1,mechanism:"SCRAM-SHA-1",payload:new Binary(f("n,,%s",h)),autoAuthorize:1},w=function(e,r){return e?(i-=1,l=e,!1):r.result.$err?(l=r.result,!1):r.result.errmsg?(l=r.result,!1):(c=!0,i+=1,!0)},g=function(e,r){return 0==e&&r>0?(addAuthSession(o.authStore,new AuthSession(t,n,a)),s(null,!0)):0==e?(null==l&&(l=new MongoError(f("failed to authenticate using scram"))),s(l,!1)):void 0},m=function(e,r){w(e,r),u-=1,g(u,i)};e.command(f("%s.$cmd",t),p,{connection:r},function(c,d){if(0!=w(c,d)){var p=parsePayload(d.result.payload.value()),g=parseInt(p.i,10),v=p.s,y=p.r,B=f("c=biws,r=%s",y),b=passwordDigest(n,a),S=hi(b,new Buffer(v,"base64"),g),A=crypto.createHmac("sha1",S);A.update(new Buffer("Client Key"));var H=new Buffer(A.digest("base64"),"base64"),x=crypto.createHash("sha1");x.update(H);var M=new Buffer(x.digest("base64"),"base64"),q=[h,d.result.payload.value().toString("base64"),B].join(","),A=crypto.createHmac("sha1",M);A.update(new Buffer(q));var E=new Buffer(A.digest("base64"),"base64"),C=f("p=%s",new Buffer(xor(H,E)).toString("base64")),I=[B,C].join(","),A=crypto.createHmac("sha1",S);A.update(new Buffer("Server Key"));var $=new Buffer(A.digest("base64"),"base64"),A=crypto.createHmac("sha1",$);A.update(new Buffer(q));var D=(new Buffer(A.digest("base64"),"base64"),{saslContinue:1,conversationId:d.result.conversationId,payload:new Binary(new Buffer(I))});e.command(f("%s.$cmd",t),D,{connection:r},function(n,a){if(a&&0==a.result.done){var s={saslContinue:1,conversationId:a.result.conversationId,payload:new Buffer(0)};e.command(f("%s.$cmd",t),s,{connection:r},function(e,r){m(e,r)})}else m(n,a)})}else{if(u-=1,0==u&&i>0)return addAuthSession(o.authStore,new AuthSession(t,n,a)),s(null,!0);if(0==u)return null==l&&(l=new MongoError(f("failed to authenticate using scram"))),s(l,!1)}})},h=function(e){process.nextTick(function(){d(e)})};r.length>0;)h(r.shift())};var addAuthSession=function(e,r){for(var t=!1,n=0;n<e.length;n++)if(e[n].equal(r)){t=!0;break}t||e.push(r)};ScramSHA1.prototype.reauthenticate=function(e,r,t){var n=this.authStore.slice(0),a=n.length;if(0==a)return t(null,null);for(var s=0;s<n.length;s++)this.auth(e,r,n[s].db,n[s].username,n[s].password,function(e,r){e&&(e=e),a-=1,0==a&&t(e,null)})},module.exports=ScramSHA1;