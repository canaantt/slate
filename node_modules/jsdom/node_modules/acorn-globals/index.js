"use strict";function isScope(e){return"FunctionExpression"===e.type||"FunctionDeclaration"===e.type||"ArrowFunctionExpression"===e.type||"Program"===e.type}function isBlockScope(e){return"BlockStatement"===e.type||isScope(e)}function declaresArguments(e){return"FunctionExpression"===e.type||"FunctionDeclaration"===e.type}function declaresThis(e){return"FunctionExpression"===e.type||"FunctionDeclaration"===e.type}function reallyParse(e){try{return acorn.parse(e,{ecmaVersion:6,allowReturnOutsideFunction:!0,allowImportExportEverywhere:!0,allowHashBang:!0})}catch(n){return acorn.parse(e,{ecmaVersion:5,allowReturnOutsideFunction:!0,allowImportExportEverywhere:!0,allowHashBang:!0})}}function findGlobals(e){function n(e,n){var r=e.name;if("undefined"!==r){for(var t=0;t<n.length;t++){if("arguments"===r&&declaresArguments(n[t]))return;if(n[t].locals&&r in n[t].locals)return}n[n.length-2]&&"TryStatement"===n[n.length-2].type&&n[n.length-2].handler&&e===n[n.length-2].handler.param||(e.parents=n,a.push(e))}}var r,a=[];if(r="string"==typeof e?reallyParse(e):e,!r||"object"!=typeof r||"Program"!==r.type)throw new TypeError("Source must be either a string of JavaScript or an acorn AST");var t=function(e){var n=e;n.locals=n.locals||{},e.params.forEach(function(e){o(e,n)}),e.id&&(n.locals[e.id.name]=!0)},o=function(e,n){switch(e.type){case"Identifier":n.locals[e.name]=!0;break;case"ObjectPattern":e.properties.forEach(function(e){o(e.value,n)});break;case"ArrayPattern":e.elements.forEach(function(e){e&&o(e,n)});break;case"RestElement":o(e.argument,n);break;case"AssignmentPattern":o(e.left,n);break;default:throw new Error("Unrecognized pattern type: "+e.type)}},l=function(e,n){r.locals=r.locals||{},r.locals[e.local.name]=!0};walk.ancestor(r,{VariableDeclaration:function(e,n){for(var r=null,a=n.length-1;a>=0&&null===r;a--)("var"===e.kind?isScope(n[a]):isBlockScope(n[a]))&&(r=n[a]);r.locals=r.locals||{},e.declarations.forEach(function(e){o(e.id,r)})},FunctionDeclaration:function(e,n){for(var r=null,a=n.length-2;a>=0&&null===r;a--)isScope(n[a])&&(r=n[a]);r.locals=r.locals||{},r.locals[e.id.name]=!0,t(e)},Function:t,ClassDeclaration:function(e,n){for(var r=null,a=n.length-2;a>=0&&null===r;a--)isScope(n[a])&&(r=n[a]);r.locals=r.locals||{},r.locals[e.id.name]=!0},TryStatement:function(e){null!==e.handler&&(e.handler.body.locals=e.handler.body.locals||{},e.handler.body.locals[e.handler.param.name]=!0)},ImportDefaultSpecifier:l,ImportSpecifier:l,ImportNamespaceSpecifier:l}),walk.ancestor(r,{VariablePattern:n,Identifier:n,ThisExpression:function(e,n){for(var r=0;r<n.length;r++)if(declaresThis(n[r]))return;e.parents=n,a.push(e)}});var c={};return a.forEach(function(e){c[e.name]=c[e.name]||[],c[e.name].push(e)}),Object.keys(c).sort().map(function(e){return{name:e,nodes:c[e]}})}var acorn=require("acorn"),walk=require("acorn/dist/walk");module.exports=findGlobals,module.exports.parse=reallyParse;