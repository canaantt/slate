"use strict";function setEndLocation(t,e,n){var o=t.__location;if(o&&(o.startTag||(o.startTag={start:o.start,end:o.end}),e.location)){var a=n.getTagName(t),i=e.type===Tokenizer.END_TAG_TOKEN&&a===e.tagName;i&&(o.endTag={start:e.location.start,end:e.location.end}),o.end=e.location.end}}function patchOpenElementsStack(t,e){var n=e.treeAdapter;t.pop=function(){setEndLocation(this.current,e.currentToken,n),OpenElementStack.prototype.pop.call(this)},t.popAllUpToHtmlElement=function(){for(var t=this.stackTop;t>0;t--)setEndLocation(this.items[t],e.currentToken,n);OpenElementStack.prototype.popAllUpToHtmlElement.call(this)},t.remove=function(t){setEndLocation(t,e.currentToken,n),OpenElementStack.prototype.remove.call(this,t)}}var OpenElementStack=require("./open_element_stack"),Tokenizer=require("../tokenization/tokenizer"),HTML=require("../common/html"),$=HTML.TAG_NAMES;exports.assign=function(t){var e=Object.getPrototypeOf(t),n=t.treeAdapter;t._reset=function(n,o,a){e._reset.call(this,n,o,a),this.attachableElementLocation=null,this.lastFosterParentingLocation=null,this.currentToken=null,patchOpenElementsStack(this.openElements,t)},t._processTokenInForeignContent=function(t){this.currentToken=t,e._processTokenInForeignContent.call(this,t)},t._processToken=function(t){if(this.currentToken=t,e._processToken.call(this,t),t.type===Tokenizer.END_TAG_TOKEN&&(t.tagName===$.HTML||t.tagName===$.BODY&&this.openElements.hasInScope($.BODY)))for(var o=this.openElements.stackTop;o>=0;o--){var a=this.openElements.items[o];if(this.treeAdapter.getTagName(a)===t.tagName){setEndLocation(a,t,n);break}}},t._setDocumentType=function(t){e._setDocumentType.call(this,t);for(var n=this.treeAdapter.getChildNodes(this.document),o=n.length,a=0;o>a;a++){var i=n[a];if(this.treeAdapter.isDocumentTypeNode(i)){i.__location=t.location;break}}},t._attachElementToTree=function(t){t.__location=this.attachableElementLocation||null,this.attachableElementLocation=null,e._attachElementToTree.call(this,t)},t._appendElement=function(t,n){this.attachableElementLocation=t.location,e._appendElement.call(this,t,n)},t._insertElement=function(t,n){this.attachableElementLocation=t.location,e._insertElement.call(this,t,n)},t._insertTemplate=function(t){this.attachableElementLocation=t.location,e._insertTemplate.call(this,t);var n=this.treeAdapter.getChildNodes(this.openElements.current)[0];n.__location=null},t._insertFakeRootElement=function(){e._insertFakeRootElement.call(this),this.openElements.current.__location=null},t._appendCommentNode=function(t,n){e._appendCommentNode.call(this,t,n);var o=this.treeAdapter.getChildNodes(n),a=o[o.length-1];a.__location=t.location},t._findFosterParentingLocation=function(){return this.lastFosterParentingLocation=e._findFosterParentingLocation.call(this),this.lastFosterParentingLocation},t._insertCharacters=function(t){e._insertCharacters.call(this,t);var n=this._shouldFosterParentOnInsertion(),o=this.lastFosterParentingLocation,a=n&&o.parent||this.openElements.currentTmplContent||this.openElements.current,i=this.treeAdapter.getChildNodes(a),l=n&&o.beforeElement?i.indexOf(o.beforeElement)-1:i.length-1,r=i[l];r.__location?r.__location.end=t.location.end:r.__location=t.location}};