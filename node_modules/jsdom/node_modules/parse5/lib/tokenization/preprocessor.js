"use strict";function isReservedCodePoint(t){return t>=55296&&57343>=t||t>1114111}function isSurrogatePair(t,s){return t>=55296&&56319>=t&&s>=56320&&57343>=s}function getSurrogatePairCodePoint(t,s){return 1024*(t-55296)+9216+s}var UNICODE=require("../common/unicode"),$=UNICODE.CODE_POINTS,Preprocessor=module.exports=function(t){this.write(t),this.pos=this.html.charCodeAt(0)===$.BOM?0:-1,this.gapStack=[],this.lastGapPos=-1,this.skipNextNewLine=!1};Preprocessor.prototype.write=function(t){this.html?this.html=this.html.substring(0,this.pos+1)+t+this.html.substring(this.pos+1,this.html.length):this.html=t,this.lastCharPos=this.html.length-1},Preprocessor.prototype.advanceAndPeekCodePoint=function(){if(this.pos++,this.pos>this.lastCharPos)return $.EOF;var t=this.html.charCodeAt(this.pos);return this.skipNextNewLine&&t===$.LINE_FEED?(this.skipNextNewLine=!1,this._addGap(),this.advanceAndPeekCodePoint()):t===$.CARRIAGE_RETURN?(this.skipNextNewLine=!0,$.LINE_FEED):(this.skipNextNewLine=!1,t>=55296?this._processHighRangeCodePoint(t):t)},Preprocessor.prototype._processHighRangeCodePoint=function(t){if(this.pos!==this.lastCharPos){var s=this.html.charCodeAt(this.pos+1);isSurrogatePair(t,s)&&(this.pos++,t=getSurrogatePairCodePoint(t,s),this._addGap())}return isReservedCodePoint(t)&&(t=$.REPLACEMENT_CHARACTER),t},Preprocessor.prototype._addGap=function(){this.gapStack.push(this.lastGapPos),this.lastGapPos=this.pos},Preprocessor.prototype.retreat=function(){this.pos===this.lastGapPos&&(this.lastGapPos=this.gapStack.pop(),this.pos--),this.pos--};