/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */
if("function"!=typeof define)var define=require("amdefine")(module,require);define(function(e,r,n){function t(e){var r=e;"string"==typeof e&&(r=JSON.parse(e.replace(/^\)\]\}'/,"")));var n=o.getArg(r,"version"),t=o.getArg(r,"sources"),i=o.getArg(r,"names",[]),a=o.getArg(r,"sourceRoot",null),u=o.getArg(r,"sourcesContent",null),l=o.getArg(r,"mappings"),g=o.getArg(r,"file",null);if(n!=this._version)throw new Error("Unsupported version: "+n);t=t.map(o.normalize),this._names=s.fromArray(i,!0),this._sources=s.fromArray(t,!0),this.sourceRoot=a,this.sourcesContent=u,this._mappings=l,this.file=g}var o=e("./util"),i=e("./binary-search"),s=e("./array-set").ArraySet,a=e("./base64-vlq"),u=e("./source-map-consumer").SourceMapConsumer;t.prototype=Object.create(u.prototype),t.prototype.consumer=u,t.fromSourceMap=function(e){var r=Object.create(t.prototype);return r._names=s.fromArray(e._names.toArray(),!0),r._sources=s.fromArray(e._sources.toArray(),!0),r.sourceRoot=e._sourceRoot,r.sourcesContent=e._generateSourcesContent(r._sources.toArray(),r.sourceRoot),r.file=e._file,r.__generatedMappings=e._mappings.toArray().slice(),r.__originalMappings=e._mappings.toArray().slice().sort(o.compareByOriginalPositions),r},t.prototype._version=3,Object.defineProperty(t.prototype,"sources",{get:function(){return this._sources.toArray().map(function(e){return null!=this.sourceRoot?o.join(this.sourceRoot,e):e},this)}}),t.prototype._parseMappings=function(e,r){for(var n,t=1,i=0,s=0,u=0,l=0,g=0,p=e,c={};p.length>0;)if(";"===p.charAt(0))t++,p=p.slice(1),i=0;else if(","===p.charAt(0))p=p.slice(1);else{if(n={},n.generatedLine=t,a.decode(p,c),n.generatedColumn=i+c.value,i=n.generatedColumn,p=c.rest,p.length>0&&!this._nextCharIsMappingSeparator(p)){if(a.decode(p,c),n.source=this._sources.at(l+c.value),l+=c.value,p=c.rest,0===p.length||this._nextCharIsMappingSeparator(p))throw new Error("Found a source, but no line and column");if(a.decode(p,c),n.originalLine=s+c.value,s=n.originalLine,n.originalLine+=1,p=c.rest,0===p.length||this._nextCharIsMappingSeparator(p))throw new Error("Found a source and line, but no column");a.decode(p,c),n.originalColumn=u+c.value,u=n.originalColumn,p=c.rest,p.length>0&&!this._nextCharIsMappingSeparator(p)&&(a.decode(p,c),n.name=this._names.at(g+c.value),g+=c.value,p=c.rest)}this.__generatedMappings.push(n),"number"==typeof n.originalLine&&this.__originalMappings.push(n)}this.__generatedMappings.sort(o.compareByGeneratedPositions),this.__originalMappings.sort(o.compareByOriginalPositions)},t.prototype._findMapping=function(e,r,n,t,o){if(e[n]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[n]);if(e[t]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[t]);return i.search(e,r,o)},t.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var n=this._generatedMappings[e+1];if(r.generatedLine===n.generatedLine){r.lastGeneratedColumn=n.generatedColumn-1;continue}}r.lastGeneratedColumn=1/0}},t.prototype.originalPositionFor=function(e){var r={generatedLine:o.getArg(e,"line"),generatedColumn:o.getArg(e,"column")},n=this._findMapping(r,this._generatedMappings,"generatedLine","generatedColumn",o.compareByGeneratedPositions);if(n>=0){var t=this._generatedMappings[n];if(t.generatedLine===r.generatedLine){var i=o.getArg(t,"source",null);return null!=i&&null!=this.sourceRoot&&(i=o.join(this.sourceRoot,i)),{source:i,line:o.getArg(t,"originalLine",null),column:o.getArg(t,"originalColumn",null),name:o.getArg(t,"name",null)}}}return{source:null,line:null,column:null,name:null}},t.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;if(null!=this.sourceRoot&&(e=o.relative(this.sourceRoot,e)),this._sources.has(e))return this.sourcesContent[this._sources.indexOf(e)];var n;if(null!=this.sourceRoot&&(n=o.urlParse(this.sourceRoot))){var t=e.replace(/^file:\/\//,"");if("file"==n.scheme&&this._sources.has(t))return this.sourcesContent[this._sources.indexOf(t)];if((!n.path||"/"==n.path)&&this._sources.has("/"+e))return this.sourcesContent[this._sources.indexOf("/"+e)]}if(r)return null;throw new Error('"'+e+'" is not in the SourceMap.')},t.prototype.generatedPositionFor=function(e){var r={source:o.getArg(e,"source"),originalLine:o.getArg(e,"line"),originalColumn:o.getArg(e,"column")};null!=this.sourceRoot&&(r.source=o.relative(this.sourceRoot,r.source));var n=this._findMapping(r,this._originalMappings,"originalLine","originalColumn",o.compareByOriginalPositions);if(n>=0){var t=this._originalMappings[n];return{line:o.getArg(t,"generatedLine",null),column:o.getArg(t,"generatedColumn",null),lastColumn:o.getArg(t,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}},r.BasicSourceMapConsumer=t});