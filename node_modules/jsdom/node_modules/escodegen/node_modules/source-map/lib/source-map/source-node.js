/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */
if("function"!=typeof define)var define=require("amdefine")(module,require);define(function(n,e,t){function r(n,e,t,r,o){this.children=[],this.sourceContents={},this.line=null==n?null:n,this.column=null==e?null:e,this.source=null==t?null:t,this.name=null==o?null:o,this[s]=!0,null!=r&&this.add(r)}var o=n("./source-map-generator").SourceMapGenerator,i=n("./util"),l=/(\r?\n)/,u=10,s="$$$isSourceNode$$$";r.fromStringWithSourceMap=function(n,e,t){function o(n,e){if(null===n||void 0===n.source)u.add(e);else{var o=t?i.join(t,n.source):n.source;u.add(new r(n.originalLine,n.originalColumn,o,e,n.name))}}var u=new r,s=n.split(l),c=function(){var n=s.shift(),e=s.shift()||"";return n+e},a=1,h=0,d=null;return e.eachMapping(function(n){if(null!==d){if(!(a<n.generatedLine)){var e=s[0],t=e.substr(0,n.generatedColumn-h);return s[0]=e.substr(n.generatedColumn-h),h=n.generatedColumn,o(d,t),void(d=n)}var t="";o(d,c()),a++,h=0}for(;a<n.generatedLine;)u.add(c()),a++;if(h<n.generatedColumn){var e=s[0];u.add(e.substr(0,n.generatedColumn)),s[0]=e.substr(n.generatedColumn),h=n.generatedColumn}d=n},this),s.length>0&&(d&&o(d,c()),u.add(s.join(""))),e.sources.forEach(function(n){var r=e.sourceContentFor(n);null!=r&&(null!=t&&(n=i.join(t,n)),u.setSourceContent(n,r))}),u},r.prototype.add=function(n){if(Array.isArray(n))n.forEach(function(n){this.add(n)},this);else{if(!n[s]&&"string"!=typeof n)throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+n);n&&this.children.push(n)}return this},r.prototype.prepend=function(n){if(Array.isArray(n))for(var e=n.length-1;e>=0;e--)this.prepend(n[e]);else{if(!n[s]&&"string"!=typeof n)throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+n);this.children.unshift(n)}return this},r.prototype.walk=function(n){for(var e,t=0,r=this.children.length;r>t;t++)e=this.children[t],e[s]?e.walk(n):""!==e&&n(e,{source:this.source,line:this.line,column:this.column,name:this.name})},r.prototype.join=function(n){var e,t,r=this.children.length;if(r>0){for(e=[],t=0;r-1>t;t++)e.push(this.children[t]),e.push(n);e.push(this.children[t]),this.children=e}return this},r.prototype.replaceRight=function(n,e){var t=this.children[this.children.length-1];return t[s]?t.replaceRight(n,e):"string"==typeof t?this.children[this.children.length-1]=t.replace(n,e):this.children.push("".replace(n,e)),this},r.prototype.setSourceContent=function(n,e){this.sourceContents[i.toSetString(n)]=e},r.prototype.walkSourceContents=function(n){for(var e=0,t=this.children.length;t>e;e++)this.children[e][s]&&this.children[e].walkSourceContents(n);for(var r=Object.keys(this.sourceContents),e=0,t=r.length;t>e;e++)n(i.fromSetString(r[e]),this.sourceContents[r[e]])},r.prototype.toString=function(){var n="";return this.walk(function(e){n+=e}),n},r.prototype.toStringWithSourceMap=function(n){var e={code:"",line:1,column:0},t=new o(n),r=!1,i=null,l=null,s=null,c=null;return this.walk(function(n,o){e.code+=n,null!==o.source&&null!==o.line&&null!==o.column?((i!==o.source||l!==o.line||s!==o.column||c!==o.name)&&t.addMapping({source:o.source,original:{line:o.line,column:o.column},generated:{line:e.line,column:e.column},name:o.name}),i=o.source,l=o.line,s=o.column,c=o.name,r=!0):r&&(t.addMapping({generated:{line:e.line,column:e.column}}),i=null,r=!1);for(var a=0,h=n.length;h>a;a++)n.charCodeAt(a)===u?(e.line++,e.column=0,a+1===h?(i=null,r=!1):r&&t.addMapping({source:o.source,original:{line:o.line,column:o.column},generated:{line:e.line,column:e.column},name:o.name})):e.column++}),this.walkSourceContents(function(n,e){t.setSourceContent(n,e)}),{code:e.code,map:t}},e.SourceNode=r});