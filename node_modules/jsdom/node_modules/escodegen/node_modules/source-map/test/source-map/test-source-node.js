/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */
if("function"!=typeof define)var define=require("amdefine")(module,require);define(function(e,n,o){function l(e){return function(n,o){["\n","\r\n"].forEach(e.bind(null,n,o))}}var a=e("../../lib/source-map/source-map-generator").SourceMapGenerator,t=e("../../lib/source-map/source-map-consumer").SourceMapConsumer,u=e("../../lib/source-map/source-node").SourceNode;n["test .add()"]=function(e,n){var o=new u(null,null,null);o.add("function noop() {}"),o.add(new u(null,null,null)),o.add(["function foo() {",new u(null,null,null,"return 10;"),"}"]),e["throws"](function(){o.add({})}),e["throws"](function(){o.add(function(){})})},n["test .prepend()"]=function(e,n){var o=new u(null,null,null);o.prepend("function noop() {}"),e.equal(o.children[0],"function noop() {}"),e.equal(o.children.length,1),o.prepend(new u(null,null,null)),e.equal(o.children[0],""),e.equal(o.children[1],"function noop() {}"),e.equal(o.children.length,2),o.prepend(["function foo() {",new u(null,null,null,"return 10;"),"}"]),e.equal(o.children[0],"function foo() {"),e.equal(o.children[1],"return 10;"),e.equal(o.children[2],"}"),e.equal(o.children[3],""),e.equal(o.children[4],"function noop() {}"),e.equal(o.children.length,5),e["throws"](function(){o.prepend({})}),e["throws"](function(){o.prepend(function(){})})},n["test .toString()"]=function(e,n){e.equal(new u(null,null,null,["function foo() {",new u(null,null,null,"return 10;"),"}"]).toString(),"function foo() {return 10;}")},n["test .join()"]=function(e,n){e.equal(new u(null,null,null,["a","b","c","d"]).join(", ").toString(),"a, b, c, d")},n["test .walk()"]=function(e,n){var o=new u(null,null,null,["(function () {\n","  ",new u(1,0,"a.js",["someCall()"]),";\n","  ",new u(2,0,"b.js",["if (foo) bar()"]),";\n","}());"]),l=[{str:"(function () {\n",source:null,line:null,column:null},{str:"  ",source:null,line:null,column:null},{str:"someCall()",source:"a.js",line:1,column:0},{str:";\n",source:null,line:null,column:null},{str:"  ",source:null,line:null,column:null},{str:"if (foo) bar()",source:"b.js",line:2,column:0},{str:";\n",source:null,line:null,column:null},{str:"}());",source:null,line:null,column:null}],a=0;o.walk(function(n,o){e.equal(l[a].str,n),e.equal(l[a].source,o.source),e.equal(l[a].line,o.line),e.equal(l[a].column,o.column),a++})},n["test .replaceRight"]=function(e,n){var o;o=new u(null,null,null,"hello world"),o.replaceRight(/world/,"universe"),e.equal(o.toString(),"hello universe"),o=new u(null,null,null,[new u(null,null,null,"hey sexy mama, "),new u(null,null,null,"want to kill all humans?")]),o.replaceRight(/kill all humans/,"watch Futurama"),e.equal(o.toString(),"hey sexy mama, want to watch Futurama?")},n["test .toStringWithSourceMap()"]=l(function(e,n,o){var l=new u(null,null,null,["(function () {"+o,"  ",new u(1,0,"a.js","someCall","originalCall"),new u(1,8,"a.js","()"),";"+o,"  ",new u(2,0,"b.js",["if (foo) bar()"]),";"+o,"}());"]),i=l.toStringWithSourceMap({file:"foo.js"});e.equal(i.code,["(function () {","  someCall();","  if (foo) bar();","}());"].join(o));var r=i.map,c=l.toStringWithSourceMap().map;e.ok(r instanceof a,"map instanceof SourceMapGenerator"),e.ok(c instanceof a,"mapWithoutOptions instanceof SourceMapGenerator"),e.ok(!("file"in c)),c._file="foo.js",n.assertEqualMaps(e,r.toJSON(),c.toJSON()),r=new t(r.toString());var s;s=r.originalPositionFor({line:1,column:4}),e.equal(s.source,null),e.equal(s.line,null),e.equal(s.column,null),s=r.originalPositionFor({line:2,column:2}),e.equal(s.source,"a.js"),e.equal(s.line,1),e.equal(s.column,0),e.equal(s.name,"originalCall"),s=r.originalPositionFor({line:3,column:2}),e.equal(s.source,"b.js"),e.equal(s.line,2),e.equal(s.column,0),s=r.originalPositionFor({line:3,column:16}),e.equal(s.source,null),e.equal(s.line,null),e.equal(s.column,null),s=r.originalPositionFor({line:4,column:2}),e.equal(s.source,null),e.equal(s.line,null),e.equal(s.column,null)}),n["test .fromStringWithSourceMap()"]=l(function(e,n,o){var l=n.testGeneratedCode.replace(/\n/g,o),i=u.fromStringWithSourceMap(l,new t(n.testMap)),r=i.toStringWithSourceMap({file:"min.js"}),c=r.map,s=r.code;e.equal(s,l),e.ok(c instanceof a,"map instanceof SourceMapGenerator"),c=c.toJSON(),e.equal(c.version,n.testMap.version),e.equal(c.file,n.testMap.file),e.equal(c.mappings,n.testMap.mappings)}),n["test .fromStringWithSourceMap() empty map"]=l(function(e,n,o){var l=u.fromStringWithSourceMap(n.testGeneratedCode.replace(/\n/g,o),new t(n.emptyMap)),i=l.toStringWithSourceMap({file:"min.js"}),r=i.map,c=i.code;e.equal(c,n.testGeneratedCode.replace(/\n/g,o)),e.ok(r instanceof a,"map instanceof SourceMapGenerator"),r=r.toJSON(),e.equal(r.version,n.emptyMap.version),e.equal(r.file,n.emptyMap.file),e.equal(r.mappings.length,n.emptyMap.mappings.length),e.equal(r.mappings,n.emptyMap.mappings)}),n["test .fromStringWithSourceMap() complex version"]=l(function(e,n,o){var l=new u(null,null,null,["(function() {"+o,"  var Test = {};"+o,"  ",new u(1,0,"a.js","Test.A = { value: 1234 };"+o),"  ",new u(2,0,"a.js","Test.A.x = 'xyz';"),o,"}());"+o,"/* Generated Source */"]);l=l.toStringWithSourceMap({file:"foo.js"});var i=u.fromStringWithSourceMap(l.code,new t(l.map.toString())),r=i.toStringWithSourceMap({file:"foo.js"}),c=r.map,s=r.code;e.equal(s,l.code),e.ok(c instanceof a,"map instanceof SourceMapGenerator"),c=c.toJSON();var f=l.map.toJSON();n.assertEqualMaps(e,c,f)}),n["test .fromStringWithSourceMap() third argument"]=function(e,n){var o=new u(1,0,"foo.coffee","foo(coffee);\n");o.setSourceContent("foo.coffee","foo coffee"),o.add(new u(2,0,"/bar.coffee","bar(coffee);\n")),o.add(new u(3,0,"http://www.example.com/baz.coffee","baz(coffee);")),o=o.toStringWithSourceMap({file:"foo.js",sourceRoot:".."});var l=new u(1,0,"foo.js","foo(js);"),a=function(n,a){var i=new u;i.add(u.fromStringWithSourceMap(o.code,new t(o.map.toString()),n)),i.add(l);var r=0;i.walk(function(n,o){e.equal(o.source,a[r]),r++}),i.walkSourceContents(function(n,o){e.equal(n,a[0]),e.equal(o,"foo coffee")})};a("../coffee/maps",["../coffee/foo.coffee","/bar.coffee","http://www.example.com/baz.coffee","foo.js"]),a(void 0,["../foo.coffee","/bar.coffee","http://www.example.com/baz.coffee","foo.js"]),a("",["../foo.coffee","/bar.coffee","http://www.example.com/baz.coffee","foo.js"]),a(".",["../foo.coffee","/bar.coffee","http://www.example.com/baz.coffee","foo.js"]),a("./",["../foo.coffee","/bar.coffee","http://www.example.com/baz.coffee","foo.js"])},n["test .toStringWithSourceMap() merging duplicate mappings"]=l(function(e,n,o){var l=new u(null,null,null,[new u(1,0,"a.js","(function"),new u(1,0,"a.js","() {"+o),"  ",new u(1,0,"a.js","var Test = "),new u(1,0,"b.js","{};"+o),new u(2,0,"b.js","Test"),new u(2,0,"b.js",".A","A"),new u(2,20,"b.js"," = { value: ","A"),"1234",new u(2,40,"b.js"," };"+o,"A"),"}());"+o,"/* Generated Source */"]);l=l.toStringWithSourceMap({file:"foo.js"}),e.equal(l.code,["(function() {","  var Test = {};","Test.A = { value: 1234 };","}());","/* Generated Source */"].join(o));var t=new a({file:"foo.js"});t.addMapping({generated:{line:1,column:0},source:"a.js",original:{line:1,column:0}}),t.addMapping({generated:{line:2,column:2},source:"a.js",original:{line:1,column:0}}),t.addMapping({generated:{line:2,column:13},source:"b.js",original:{line:1,column:0}}),t.addMapping({generated:{line:3,column:0},source:"b.js",original:{line:2,column:0}}),t.addMapping({generated:{line:3,column:4},source:"b.js",name:"A",original:{line:2,column:0}}),t.addMapping({generated:{line:3,column:6},source:"b.js",name:"A",original:{line:2,column:20}}),t.addMapping({generated:{line:3,column:18}}),t.addMapping({generated:{line:3,column:22},source:"b.js",name:"A",original:{line:2,column:40}});var i=l.map.toJSON();t=t.toJSON(),n.assertEqualMaps(e,i,t)}),n["test .toStringWithSourceMap() multi-line SourceNodes"]=l(function(e,n,o){var l=new u(null,null,null,[new u(1,0,"a.js","(function() {"+o+"var nextLine = 1;"+o+"anotherLine();"+o),new u(2,2,"b.js","Test.call(this, 123);"+o),new u(2,2,"b.js","this['stuff'] = 'v';"+o),new u(2,2,"b.js","anotherLine();"+o),"/*"+o+"Generated"+o+"Source"+o+"*/"+o,new u(3,4,"c.js","anotherLine();"+o),"/*"+o+"Generated"+o+"Source"+o+"*/"]);l=l.toStringWithSourceMap({file:"foo.js"}),e.equal(l.code,["(function() {","var nextLine = 1;","anotherLine();","Test.call(this, 123);","this['stuff'] = 'v';","anotherLine();","/*","Generated","Source","*/","anotherLine();","/*","Generated","Source","*/"].join(o));var t=new a({file:"foo.js"});t.addMapping({generated:{line:1,column:0},source:"a.js",original:{line:1,column:0}}),t.addMapping({generated:{line:2,column:0},source:"a.js",original:{line:1,column:0}}),t.addMapping({generated:{line:3,column:0},source:"a.js",original:{line:1,column:0}}),t.addMapping({generated:{line:4,column:0},source:"b.js",original:{line:2,column:2}}),t.addMapping({generated:{line:5,column:0},source:"b.js",original:{line:2,column:2}}),t.addMapping({generated:{line:6,column:0},source:"b.js",original:{line:2,column:2}}),t.addMapping({generated:{line:11,column:0},source:"c.js",original:{line:3,column:4}});var i=l.map.toJSON();t=t.toJSON(),n.assertEqualMaps(e,i,t)}),n["test .toStringWithSourceMap() with empty string"]=function(e,n){var o=new u(1,0,"empty.js",""),l=o.toStringWithSourceMap();e.equal(l.code,"")},n["test .toStringWithSourceMap() with consecutive newlines"]=l(function(e,n,o){var l=new u(null,null,null,["/***/"+o+o,new u(1,0,"a.js","'use strict';"+o),new u(2,0,"a.js","a();")]);l=l.toStringWithSourceMap({file:"foo.js"}),e.equal(l.code,["/***/","","'use strict';","a();"].join(o));var t=new a({file:"foo.js"});t.addMapping({generated:{line:3,column:0},source:"a.js",original:{line:1,column:0}}),t.addMapping({generated:{line:4,column:0},source:"a.js",original:{line:2,column:0}});var i=l.map.toJSON();t=t.toJSON(),n.assertEqualMaps(e,i,t)}),n["test setSourceContent with toStringWithSourceMap"]=function(e,n){var o=new u(1,1,"a.js","a");o.setSourceContent("a.js","someContent");var l=new u(null,null,null,["(function () {\n","  ",o,"  ",new u(1,1,"b.js","b"),"}());"]);l.setSourceContent("b.js","otherContent");var i=l.toStringWithSourceMap({file:"foo.js"}).map;e.ok(i instanceof a,"map instanceof SourceMapGenerator"),i=new t(i.toString()),e.equal(i.sources.length,2),e.equal(i.sources[0],"a.js"),e.equal(i.sources[1],"b.js"),e.equal(i.sourcesContent.length,2),e.equal(i.sourcesContent[0],"someContent"),e.equal(i.sourcesContent[1],"otherContent")},n["test walkSourceContents"]=function(e,n){var o=new u(1,1,"a.js","a");o.setSourceContent("a.js","someContent");var l=new u(null,null,null,["(function () {\n","  ",o,"  ",new u(1,1,"b.js","b"),"}());"]);l.setSourceContent("b.js","otherContent");var a=[];l.walkSourceContents(function(e,n){a.push([e,n])}),e.equal(a.length,2),e.equal(a[0][0],"a.js"),e.equal(a[0][1],"someContent"),e.equal(a[1][0],"b.js"),e.equal(a[1][1],"otherContent")}});