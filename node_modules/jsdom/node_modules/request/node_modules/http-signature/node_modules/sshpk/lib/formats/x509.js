// Copyright 2016 Joyent, Inc.
function readMPInt(e,r){return assert.strictEqual(e.peek(),asn1.Ber.Integer,r+" is not an Integer"),utils.mpNormalize(e.readString(asn1.Ber.Integer,!0))}function verify(e,r){var t=e.signatures.x509;assert.object(t,"x509 signature");var a=t.algo.split("-");if(a[0]!==r.type)return!1;var s=t.cache;if(void 0===s){var n=new asn1.BerWriter;writeTBSCert(e,n),s=n.buffer}var i=r.createVerify(a[1]);return i.write(s),i.verify(t.signature)}function Local(e){return asn1.Ber.Context|asn1.Ber.Constructor|e}function Context(e){return asn1.Ber.Context|e}function read(e,r){"string"==typeof e&&(e=new Buffer(e,"binary")),assert.buffer(e,"buf");var t=new asn1.BerReader(e);if(t.readSequence(),Math.abs(t.length-t.remain)>1)throw new Error("DER sequence does not contain whole byte stream");var a=t.offset;t.readSequence();var s=t.offset+t.length,n=s;if(t.peek()===Local(0)){t.readSequence(Local(0));var i=t.readInt();assert.ok(3>=i,"only x.509 versions up to v3 supported")}var u={};u.signatures={};var o=u.signatures.x509={};o.extras={},u.serial=readMPInt(t,"serial"),t.readSequence();var c=t.offset+t.length,f=t.readOID(),l=SIGN_ALGS[f];if(void 0===l)throw new Error("unknown signature algorithm "+f);if(t._offset=c,u.issuer=Identity.parseAsn1(t),t.readSequence(),u.validFrom=readDate(t),u.validUntil=readDate(t),u.subjects=[Identity.parseAsn1(t)],t.readSequence(),c=t.offset+t.length,u.subjectKey=pkcs8.readPkcs8(void 0,"public",t),t._offset=c,t.peek()===Local(1)&&(t.readSequence(Local(1)),o.extras.issuerUniqueID=e.slice(t.offset,t.offset+t.length),t._offset+=t.length),t.peek()===Local(2)&&(t.readSequence(Local(2)),o.extras.subjectUniqueID=e.slice(t.offset,t.offset+t.length),t._offset+=t.length),t.peek()===Local(3)){t.readSequence(Local(3));var d=t.offset+t.length;for(t.readSequence();t.offset<d;)readExtension(u,e,t);assert.strictEqual(t.offset,d)}assert.strictEqual(t.offset,s),t.readSequence(),c=t.offset+t.length;var S=t.readOID(),g=SIGN_ALGS[S];if(void 0===g)throw new Error("unknown signature algorithm "+S);t._offset=c;var h=t.readString(asn1.Ber.BitString,!0);0===h[0]&&(h=h.slice(1));var T=g.split("-");return o.signature=Signature.parse(h,T[0],"asn1"),o.signature.hashAlgorithm=T[1],o.algo=g,o.cache=e.slice(a,n),new Certificate(u)}function readDate(e){if(e.peek()===asn1.Ber.UTCTime)return utcTimeToDate(e.readString(asn1.Ber.UTCTime));if(e.peek()===asn1.Ber.GeneralizedTime)return gTimeToDate(e.readString(asn1.Ber.GeneralizedTime));throw new Error("Unsupported date format")}function readExtension(e,r,t){t.readSequence();var a,s=t.offset+t.length,n=t.readOID(),i=e.signatures.x509;i.extras.exts=[];var u;switch(t.peek()===asn1.Ber.Boolean&&(u=t.readBoolean()),n){case EXTS.altName:t.readSequence(asn1.Ber.OctetString),t.readSequence();for(var o=t.offset+t.length;t.offset<o;)switch(t.peek()){case ALTNAME.OtherName:case ALTNAME.EDIPartyName:t.readSequence(),t._offset+=t.length;break;case ALTNAME.OID:t.readOID(ALTNAME.OID);break;case ALTNAME.RFC822Name:var c=t.readString(ALTNAME.RFC822Name);a=Identity.forEmail(c),e.subjects[0].equals(a)||e.subjects.push(a);break;case ALTNAME.DirectoryName:t.readSequence(ALTNAME.DirectoryName),a=Identity.parseAsn1(t),e.subjects[0].equals(a)||e.subjects.push(a);break;case ALTNAME.DNSName:var f=t.readString(ALTNAME.DNSName);a=Identity.forHost(f),e.subjects[0].equals(a)||e.subjects.push(a);break;default:t.readString(t.peek())}i.extras.exts.push({oid:n,critical:u});break;default:i.extras.exts.push({oid:n,critical:u,data:t.readString(asn1.Ber.OctetString,!0)})}t._offset=s}function utcTimeToDate(e){var r=e.match(UTCTIME_RE);assert.ok(r,"timestamps must be in UTC");var t=new Date,a=t.getUTCFullYear(),s=100*Math.floor(a/100),n=parseInt(r[1],10);return n+=50>a%100&&n>=60?s-1:s,t.setUTCFullYear(n,parseInt(r[2],10)-1,parseInt(r[3],10)),t.setUTCHours(parseInt(r[4],10),parseInt(r[5],10)),r[6]&&r[6].length>0&&t.setUTCSeconds(parseInt(r[6],10)),t}function gTimeToDate(e){var r=e.match(GTIME_RE);assert.ok(r);var t=new Date;return t.setUTCFullYear(parseInt(r[1],10),parseInt(r[2],10)-1,parseInt(r[3],10)),t.setUTCHours(parseInt(r[4],10),parseInt(r[5],10)),r[6]&&r[6].length>0&&t.setUTCSeconds(parseInt(r[6],10)),t}function zeroPad(e){for(var r=""+e;r.length<2;)r="0"+r;return r}function dateToUTCTime(e){var r="";return r+=zeroPad(e.getUTCFullYear()%100),r+=zeroPad(e.getUTCMonth()+1),r+=zeroPad(e.getUTCDate()),r+=zeroPad(e.getUTCHours()),r+=zeroPad(e.getUTCMinutes()),r+=zeroPad(e.getUTCSeconds()),r+="Z"}function sign(e,r){void 0===e.signatures.x509&&(e.signatures.x509={});var t=e.signatures.x509;if(t.algo=r.type+"-"+r.defaultHashAlgorithm(),void 0===SIGN_ALGS[t.algo])return!1;var a=new asn1.BerWriter;writeTBSCert(e,a);var s=a.buffer;t.cache=s;var n=r.createSign();return n.write(s),e.signatures.x509.signature=n.sign(),!0}function write(e,r){var t=e.signatures.x509;assert.object(t,"x509 signature");var a=new asn1.BerWriter;a.startSequence(),t.cache?(a._ensure(t.cache.length),t.cache.copy(a._buf,a._offset),a._offset+=t.cache.length):writeTBSCert(e,a),a.startSequence(),a.writeOID(SIGN_ALGS[t.algo]),t.algo.match(/^rsa-/)&&a.writeNull(),a.endSequence();var s=t.signature.toBuffer("asn1"),n=new Buffer(s.length+1);return n[0]=0,s.copy(n,1),a.writeBuffer(n,asn1.Ber.BitString),a.endSequence(),a.buffer}function writeTBSCert(e,r){var t=e.signatures.x509;assert.object(t,"x509 signature"),r.startSequence(),r.startSequence(Local(0)),r.writeInt(2),r.endSequence(),r.writeBuffer(utils.mpNormalize(e.serial),asn1.Ber.Integer),r.startSequence(),r.writeOID(SIGN_ALGS[t.algo]),r.endSequence(),e.issuer.toAsn1(r),r.startSequence(),r.writeString(dateToUTCTime(e.validFrom),asn1.Ber.UTCTime),r.writeString(dateToUTCTime(e.validUntil),asn1.Ber.UTCTime),r.endSequence();var a=e.subjects[0],s=e.subjects.slice(1);if(a.toAsn1(r),pkcs8.writePkcs8(r,e.subjectKey),t.extras&&t.extras.issuerUniqueID&&r.writeBuffer(t.extras.issuerUniqueID,Local(1)),t.extras&&t.extras.subjectUniqueID&&r.writeBuffer(t.extras.subjectUniqueID,Local(2)),s.length>0||"host"===a.type||t.extras&&t.extras.exts){r.startSequence(Local(3)),r.startSequence();var n=[{oid:EXTS.altName}];t.extras&&t.extras.exts&&(n=t.extras.exts);for(var i=0;i<n.length;++i){if(r.startSequence(),r.writeOID(n[i].oid),void 0!==n[i].critical&&r.writeBoolean(n[i].critical),n[i].oid===EXTS.altName){r.startSequence(asn1.Ber.OctetString),r.startSequence(),"host"===a.type&&r.writeString(a.hostname,Context(2));for(var u=0;u<s.length;++u)"host"===s[u].type?r.writeString(s[u].hostname,ALTNAME.DNSName):"email"===s[u].type?r.writeString(s[u].email,ALTNAME.RFC822Name):(r.startSequence(ALTNAME.DirectoryName),s[u].toAsn1(r),r.endSequence());r.endSequence(),r.endSequence()}else r.writeBuffer(n[i].data,asn1.Ber.OctetString);r.endSequence()}r.endSequence(),r.endSequence()}r.endSequence()}module.exports={read:read,verify:verify,sign:sign,write:write};var assert=require("assert-plus"),asn1=require("asn1"),algs=require("../algs"),utils=require("../utils"),Key=require("../key"),PrivateKey=require("../private-key"),pem=require("./pem"),Identity=require("../identity"),Signature=require("../signature"),Certificate=require("../certificate"),pkcs8=require("./pkcs8"),SIGN_ALGS={"rsa-md5":"1.2.840.113549.1.1.4","rsa-sha1":"1.2.840.113549.1.1.5","rsa-sha256":"1.2.840.113549.1.1.11","rsa-sha384":"1.2.840.113549.1.1.12","rsa-sha512":"1.2.840.113549.1.1.13","dsa-sha1":"1.2.840.10040.4.3","dsa-sha256":"2.16.840.1.101.3.4.3.2","ecdsa-sha1":"1.2.840.10045.4.1","ecdsa-sha256":"1.2.840.10045.4.3.2","ecdsa-sha384":"1.2.840.10045.4.3.3","ecdsa-sha512":"1.2.840.10045.4.3.4"};Object.keys(SIGN_ALGS).forEach(function(e){SIGN_ALGS[SIGN_ALGS[e]]=e}),SIGN_ALGS["1.3.14.3.2.3"]="rsa-md5",SIGN_ALGS["1.3.14.3.2.29"]="rsa-sha1";var EXTS={issuerKeyId:"2.5.29.35",altName:"2.5.29.17"},ALTNAME={OtherName:Local(0),RFC822Name:Context(1),DNSName:Context(2),X400Address:Local(3),DirectoryName:Local(4),EDIPartyName:Local(5),URI:Context(6),IPAddress:Context(7),OID:Context(8)},UTCTIME_RE=/^([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/,GTIME_RE=/^([0-9]{4})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})?Z$/;