// Copyright 2016 Joyent, Inc.
function Identity(t){var e=this;if(assert.object(t,"options"),assert.arrayOfObject(t.components,"options.components"),this.components=t.components,this.componentLookup={},this.components.forEach(function(t){t.name&&!t.oid&&(t.oid=oids[t.name]),t.oid&&!t.name&&(t.name=unoids[t.oid]),void 0===e.componentLookup[t.name]&&(e.componentLookup[t.name]=[]),e.componentLookup[t.name].push(t)}),this.componentLookup.cn&&this.componentLookup.cn.length>0&&(this.cn=this.componentLookup.cn[0].value),assert.optionalString(t.type,"options.type"),void 0===t.type)1===this.components.length&&this.componentLookup.cn&&1===this.componentLookup.cn.length&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)?(this.type="host",this.hostname=this.componentLookup.cn[0].value):this.componentLookup.dc&&this.components.length===this.componentLookup.dc.length?(this.type="host",this.hostname=this.componentLookup.dc.map(function(t){return t.value}).join(".")):this.componentLookup.uid&&this.components.length===this.componentLookup.uid.length?(this.type="user",this.uid=this.componentLookup.uid[0].value):this.componentLookup.cn&&1===this.componentLookup.cn.length&&this.componentLookup.cn[0].value.match(DNS_NAME_RE)?(this.type="host",this.hostname=this.componentLookup.cn[0].value):this.componentLookup.uid&&1===this.componentLookup.uid.length?(this.type="user",this.uid=this.componentLookup.uid[0].value):this.componentLookup.mail&&1===this.componentLookup.mail.length?(this.type="email",this.email=this.componentLookup.mail[0].value):this.componentLookup.cn&&1===this.componentLookup.cn.length?(this.type="user",this.uid=this.componentLookup.cn[0].value):this.type="unknown";else if(this.type=t.type,"host"===this.type)this.hostname=t.hostname;else if("user"===this.type)this.uid=t.uid;else{if("email"!==this.type)throw new Error("Unknown type "+this.type);this.email=t.email}}function globMatch(t,e){if("**"===t||"**"===e)return!0;var n=t.split("."),o=e.split(".");if(n.length!==o.length)return!1;for(var i=0;i<n.length;++i)if("*"!==n[i]&&"*"!==o[i]&&n[i]!==o[i])return!1;return!0}module.exports=Identity;var assert=require("assert-plus"),algs=require("./algs"),crypto=require("crypto"),Fingerprint=require("./fingerprint"),Signature=require("./signature"),errs=require("./errors"),util=require("util"),utils=require("./utils"),asn1=require("asn1"),DNS_NAME_RE=/^([*]|[a-z0-9][a-z0-9\-]{0,62})(?:\.([*]|[a-z0-9][a-z0-9\-]{0,62}))*$/i,oids={};oids.cn="2.5.4.3",oids.o="2.5.4.10",oids.ou="2.5.4.11",oids.l="2.5.4.7",oids.s="2.5.4.8",oids.c="2.5.4.6",oids.sn="2.5.4.4",oids.dc="0.9.2342.19200300.100.1.25",oids.uid="0.9.2342.19200300.100.1.1",oids.mail="0.9.2342.19200300.100.1.3";var unoids={};Object.keys(oids).forEach(function(t){unoids[oids[t]]=t}),Identity.prototype.toString=function(){return this.components.map(function(t){return t.name.toUpperCase()+"="+t.value}).join(", ")},Identity.prototype.toAsn1=function(t,e){t.startSequence(e),this.components.forEach(function(e){t.startSequence(asn1.Ber.Constructor|asn1.Ber.Set),t.startSequence(),t.writeOID(e.oid),t.writeString(e.value,asn1.Ber.PrintableString),t.endSequence(),t.endSequence()}),t.endSequence()},Identity.prototype.equals=function(t){if(!Identity.isIdentity(t,[1,0]))return!1;if(t.components.length!==this.components.length)return!1;for(var e=0;e<this.components.length;++e){if(this.components[e].oid!==t.components[e].oid)return!1;if(!globMatch(this.components[e].value,t.components[e].value))return!1}return!0},Identity.forHost=function(t){return assert.string(t,"hostname"),new Identity({type:"host",hostname:t,components:[{name:"cn",value:t}]})},Identity.forUser=function(t){return assert.string(t,"uid"),new Identity({type:"user",uid:t,components:[{name:"uid",value:t}]})},Identity.forEmail=function(t){return assert.string(t,"email"),new Identity({type:"email",email:t,components:[{name:"mail",value:t}]})},Identity.parseDN=function(t){assert.string(t,"dn");var e=t.split(","),n=e.map(function(t){t=t.trim();var e=t.indexOf("="),n=t.slice(0,e).toLowerCase(),o=t.slice(e+1);return{name:n,value:o}});return new Identity({components:n})},Identity.parseAsn1=function(t,e){var n=[];t.readSequence(e);for(var o=t.offset+t.length;t.offset<o;){t.readSequence(asn1.Ber.Constructor|asn1.Ber.Set);var i=t.offset+t.length;t.readSequence();var s,r=t.readOID(),u=t.peek();switch(u){case asn1.Ber.PrintableString:case asn1.Ber.IA5String:case asn1.Ber.OctetString:case asn1.Ber.T61String:s=t.readString(u);break;case asn1.Ber.Utf8String:s=t.readString(u,!0),s=s.toString("utf8");break;case asn1.Ber.CharacterString:case asn1.Ber.BMPString:s=t.readString(u,!0),s=s.toString("utf16le");break;default:throw new Error("Unknown asn1 type "+u)}n.push({oid:r,value:s}),t._offset=i}return t._offset=o,new Identity({components:n})},Identity.isIdentity=function(t,e){return utils.isCompatible(t,Identity,e)},Identity.prototype._sshpkApiVersion=[1,0],Identity._oldVersionDetect=function(t){return[1,0]};