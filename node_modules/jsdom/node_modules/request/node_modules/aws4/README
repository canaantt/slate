<h2 id="aws4">aws4</h2>

<p><a href="http://travis-ci.org/mhart/aws4"><img alt="Build Status" src="https://secure.travis-ci.org/mhart/aws4.png?branch=master" /></a></p>

<p>A small utility to sign vanilla node.js http(s) request options using Amazon&rsquo;s
<a href="http://docs.amazonwebservices.com/general/latest/gr/signature-version-4.html">AWS Signature Version 4</a>.</p>

<p>Can also be used <a href="./browser">in the browser</a>.</p>

<p>This signature is supported by nearly all Amazon services, including
<a href="http://docs.aws.amazon.com/AmazonS3/latest/API/">S3</a>,
<a href="http://docs.aws.amazon.com/AWSEC2/latest/APIReference/">EC2</a>,
<a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/API.html">DynamoDB</a>,
<a href="http://docs.aws.amazon.com/kinesis/latest/APIReference/">Kinesis</a>,
<a href="http://docs.aws.amazon.com/lambda/latest/dg/API_Reference.html">Lambda</a>,
<a href="http://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/">SQS</a>,
<a href="http://docs.aws.amazon.com/sns/latest/api/">SNS</a>,
<a href="http://docs.aws.amazon.com/IAM/latest/APIReference/">IAM</a>,
<a href="http://docs.aws.amazon.com/STS/latest/APIReference/">STS</a>,
<a href="http://docs.aws.amazon.com/AmazonRDS/latest/APIReference/">RDS</a>,
<a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/">CloudWatch</a>,
<a href="http://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/">CloudWatch Logs</a>,
<a href="http://docs.aws.amazon.com/codedeploy/latest/APIReference/">CodeDeploy</a>,
<a href="http://docs.aws.amazon.com/AmazonCloudFront/latest/APIReference/">CloudFront</a>,
<a href="http://docs.aws.amazon.com/awscloudtrail/latest/APIReference/">CloudTrail</a>,
<a href="http://docs.aws.amazon.com/AmazonElastiCache/latest/APIReference/">ElastiCache</a>,
<a href="http://docs.aws.amazon.com/ElasticMapReduce/latest/API/">EMR</a>,
<a href="http://docs.aws.amazon.com/amazonglacier/latest/dev/amazon-glacier-api.html">Glacier</a>,
<a href="http://docs.aws.amazon.com/cloudsearch/latest/developerguide/APIReq.html">CloudSearch</a>,
<a href="http://docs.aws.amazon.com/ElasticLoadBalancing/latest/APIReference/">Elastic Load Balancing</a>,
<a href="http://docs.aws.amazon.com/elastictranscoder/latest/developerguide/api-reference.html">Elastic Transcoder</a>,
<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/">CloudFormation</a>,
<a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/api/">Elastic Beanstalk</a>,
<a href="http://docs.aws.amazon.com/storagegateway/latest/userguide/AWSStorageGatewayAPI.html">Storage Gateway</a>,
<a href="http://docs.aws.amazon.com/datapipeline/latest/APIReference/">Data Pipeline</a>,
<a href="http://docs.aws.amazon.com/directconnect/latest/APIReference/">Direct Connect</a>,
<a href="http://docs.aws.amazon.com/redshift/latest/APIReference/">Redshift</a>,
<a href="http://docs.aws.amazon.com/opsworks/latest/APIReference/">OpsWorks</a>,
<a href="http://docs.aws.amazon.com/ses/latest/APIReference/">SES</a>,
<a href="http://docs.aws.amazon.com/amazonswf/latest/apireference/">SWF</a>,
<a href="http://docs.aws.amazon.com/AutoScaling/latest/APIReference/">AutoScaling</a>,
<a href="http://docs.aws.amazon.com/mobileanalytics/latest/ug/server-reference.html">Mobile Analytics</a>,
<a href="http://docs.aws.amazon.com/cognitoidentity/latest/APIReference/">Cognito Identity</a>,
<a href="http://docs.aws.amazon.com/cognitosync/latest/APIReference/">Cognito Sync</a>,
<a href="http://docs.aws.amazon.com/AmazonECS/latest/APIReference/">Container Service</a>,
<a href="http://docs.aws.amazon.com/appstream/latest/developerguide/appstream-api-rest.html">AppStream</a>,
<a href="http://docs.aws.amazon.com/kms/latest/APIReference/">Key Management Service</a>,
<a href="http://docs.aws.amazon.com/config/latest/APIReference/">Config</a>,
<a href="http://docs.aws.amazon.com/cloudhsm/latest/dg/api-ref.html">CloudHSM</a>,
<a href="http://docs.aws.amazon.com/Route53/latest/APIReference/requests-rest.html">Route53</a> and
<a href="http://docs.aws.amazon.com/Route53/latest/APIReference/requests-rpc.html">Route53 Domains</a>.</p>

<p>Indeed, the only AWS services that <em>don&rsquo;t</em> support v4 as of 2014-12-30 are
<a href="http://docs.aws.amazon.com/AWSImportExport/latest/DG/api-reference.html">Import/Export</a> and
<a href="http://docs.aws.amazon.com/AmazonSimpleDB/latest/DeveloperGuide/SDB_API.html">SimpleDB</a>
(they only support <a href="https://github.com/mhart/aws2">AWS Signature Version 2</a>).</p>

<p>It also provides defaults for a number of core AWS headers and
request parameters, making it very easy to query AWS services, or
build out a fully-featured AWS library.</p>

<h2 id="example">Example</h2>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">http</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">),</span>
    <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'https'</span><span class="p">),</span>
    <span class="nx">aws4</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'aws4'</span><span class="p">)</span>

<span class="c1">// given an options object you could pass to http.request</span>
<span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span><span class="na">host</span><span class="p">:</span> <span class="s1">'sqs.us-east-1.amazonaws.com'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListQueues'</span><span class="p">}</span>

<span class="c1">// alternatively (as aws4 can infer the host):</span>
<span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span><span class="na">service</span><span class="p">:</span> <span class="s1">'sqs'</span><span class="p">,</span> <span class="na">region</span><span class="p">:</span> <span class="s1">'us-east-1'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListQueues'</span><span class="p">}</span>

<span class="c1">// alternatively (as us-east-1 is default):</span>
<span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span><span class="na">service</span><span class="p">:</span> <span class="s1">'sqs'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListQueues'</span><span class="p">}</span>

<span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="c1">// assumes AWS credentials are available in process.env</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
<span class="cm">/*
{
  host: 'sqs.us-east-1.amazonaws.com',
  path: '/?Action=ListQueues',
  headers: {
    Host: 'sqs.us-east-1.amazonaws.com',
    'X-Amz-Date': '20121226T061030Z',
    Authorization: 'AWS4-HMAC-SHA256 Credential=ABCDEF/20121226/us-east-1/sqs/aws4_request, ...'
  }
}
*/</span>

<span class="c1">// we can now use this to query AWS using the standard node.js http API</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span> <span class="p">}).</span><span class="nx">end</span><span class="p">()</span>
<span class="cm">/*
&lt;?xml version="1.0"?&gt;
&lt;ListQueuesResponse xmlns="http://queue.amazonaws.com/doc/2012-11-05/"&gt;
...
*/</span>
</code></pre>

<h2 id="more-options">More options</h2>
<pre class="highlight javascript"><code><span class="c1">// you can also pass AWS credentials in explicitly (otherwise taken from process.env)</span>
<span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="p">{</span><span class="na">accessKeyId</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">secretAccessKey</span><span class="p">:</span> <span class="s1">''</span><span class="p">})</span>

<span class="c1">// can also add the signature to query strings</span>
<span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'s3'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/my-bucket?X-Amz-Expires=12345'</span><span class="p">,</span> <span class="na">signQuery</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>

<span class="c1">// create a utility function to pipe to stdout (with https this time)</span>
<span class="kd">function</span> <span class="nx">request</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span> <span class="nx">https</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span> <span class="p">}).</span><span class="nx">end</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="s1">''</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// aws4 can infer the HTTP method if a body is passed in</span>
<span class="c1">// method will be POST and Content-Type: 'application/x-www-form-urlencoded; charset=utf-8'</span>
<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'iam'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'Action=ListGroups&amp;Version=2010-05-08'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListGroupsResponse xmlns="https://iam.amazonaws.com/doc/2010-05-08/"&gt;
...
*/</span>

<span class="c1">// can specify any custom option or header as per usual</span>
<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span>
  <span class="na">service</span><span class="p">:</span> <span class="s1">'dynamodb'</span><span class="p">,</span>
  <span class="na">region</span><span class="p">:</span> <span class="s1">'ap-southeast-2'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
  <span class="na">path</span><span class="p">:</span> <span class="s1">'/'</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.0'</span><span class="p">,</span>
    <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'DynamoDB_20120810.ListTables'</span>
  <span class="p">},</span>
  <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span>
<span class="p">}))</span>
<span class="cm">/*
{"TableNames":[]}
...
*/</span>

<span class="c1">// works with all other services that support Signature Version 4</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'s3'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/'</span><span class="p">,</span> <span class="na">signQuery</span><span class="p">:</span> <span class="kc">true</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListAllMyBucketsResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'ec2'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=DescribeRegions&amp;Version=2014-06-15'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DescribeRegionsResponse xmlns="http://ec2.amazonaws.com/doc/2014-06-15/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'sns'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListTopics&amp;Version=2010-03-31'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListTopicsResponse xmlns="http://sns.amazonaws.com/doc/2010-03-31/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'sts'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=GetSessionToken&amp;Version=2011-06-15'</span><span class="p">}))</span>
<span class="cm">/*
&lt;GetSessionTokenResponse xmlns="https://sts.amazonaws.com/doc/2011-06-15/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'cloudsearch'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListDomainNames&amp;Version=2013-01-01'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListDomainNamesResponse xmlns="http://cloudsearch.amazonaws.com/doc/2013-01-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'ses'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListIdentities&amp;Version=2010-12-01'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListIdentitiesResponse xmlns="http://ses.amazonaws.com/doc/2010-12-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'autoscaling'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=DescribeAutoScalingInstances&amp;Version=2011-01-01'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DescribeAutoScalingInstancesResponse xmlns="http://autoscaling.amazonaws.com/doc/2011-01-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'elasticloadbalancing'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=DescribeLoadBalancers&amp;Version=2012-06-01'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DescribeLoadBalancersResponse xmlns="http://elasticloadbalancing.amazonaws.com/doc/2012-06-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'cloudformation'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListStacks&amp;Version=2010-05-15'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListStacksResponse xmlns="http://cloudformation.amazonaws.com/doc/2010-05-15/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'elasticbeanstalk'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListAvailableSolutionStacks&amp;Version=2010-12-01'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListAvailableSolutionStacksResponse xmlns="http://elasticbeanstalk.amazonaws.com/docs/2010-12-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'rds'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=DescribeDBInstances&amp;Version=2012-09-17'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DescribeDBInstancesResponse xmlns="http://rds.amazonaws.com/doc/2012-09-17/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'monitoring'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListMetrics&amp;Version=2010-08-01'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListMetricsResponse xmlns="http://monitoring.amazonaws.com/doc/2010-08-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'redshift'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=DescribeClusters&amp;Version=2012-12-01'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DescribeClustersResponse xmlns="http://redshift.amazonaws.com/doc/2012-12-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'cloudfront'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/2014-05-31/distribution'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DistributionList xmlns="http://cloudfront.amazonaws.com/doc/2014-05-31/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'elasticache'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=DescribeCacheClusters&amp;Version=2014-07-15'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DescribeCacheClustersResponse xmlns="http://elasticache.amazonaws.com/doc/2014-07-15/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'elasticmapreduce'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=DescribeJobFlows&amp;Version=2009-03-31'</span><span class="p">}))</span>
<span class="cm">/*
&lt;DescribeJobFlowsResponse xmlns="http://elasticmapreduce.amazonaws.com/doc/2009-03-31"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'route53'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/2013-04-01/hostedzone'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListHostedZonesResponse xmlns="https://route53.amazonaws.com/doc/2013-04-01/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'appstream'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/applications'</span><span class="p">}))</span>
<span class="cm">/*
{"_links":{"curie":[{"href":"http://docs.aws.amazon.com/appstream/latest/...
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'cognito-sync'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/identitypools'</span><span class="p">}))</span>
<span class="cm">/*
{"Count":0,"IdentityPoolUsages":[],"MaxResults":16,"NextToken":null}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'elastictranscoder'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/2012-09-25/pipelines'</span><span class="p">}))</span>
<span class="cm">/*
{"NextPageToken":null,"Pipelines":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'lambda'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/2014-11-13/functions/'</span><span class="p">}))</span>
<span class="cm">/*
{"Functions":[],"NextMarker":null}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'ecs'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/?Action=ListClusters&amp;Version=2014-11-13'</span><span class="p">}))</span>
<span class="cm">/*
&lt;ListClustersResponse xmlns="http://ecs.amazonaws.com/doc/2014-11-13/"&gt;
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'glacier'</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'/-/vaults'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span><span class="s1">'X-Amz-Glacier-Version'</span><span class="p">:</span> <span class="s1">'2012-06-01'</span><span class="p">}}))</span>
<span class="cm">/*
{"Marker":null,"VaultList":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'storagegateway'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'StorageGateway_20120630.ListGateways'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"Gateways":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'datapipeline'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'DataPipeline.ListPipelines'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"hasMoreResults":false,"pipelineIdList":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'opsworks'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'OpsWorks_20130218.DescribeStacks'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"Stacks":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'route53domains'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'Route53Domains_v20140515.ListDomains'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"Domains":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'kinesis'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'Kinesis_20131202.ListStreams'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"HasMoreStreams":false,"StreamNames":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'cloudtrail'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'CloudTrail_20131101.DescribeTrails'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"trailList":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'logs'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'Logs_20140328.DescribeLogGroups'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"logGroups":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'codedeploy'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'CodeDeploy_20141006.ListApplications'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"applications":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'directconnect'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'OvertureService.DescribeConnections'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"connections":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'kms'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'TrentService.ListKeys'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"Keys":[],"Truncated":false}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'config'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'StarlingDoveService.DescribeDeliveryChannels'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"DeliveryChannels":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span><span class="na">service</span><span class="p">:</span> <span class="s1">'cloudhsm'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="s1">'{}'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
  <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'CloudHsmFrontendService.ListAvailableZones'</span>
<span class="p">}}))</span>
<span class="cm">/*
{"AZList":["us-east-1a","us-east-1b","us-east-1c"]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span>
  <span class="na">service</span><span class="p">:</span> <span class="s1">'swf'</span><span class="p">,</span>
  <span class="na">body</span><span class="p">:</span> <span class="s1">'{"registrationStatus":"REGISTERED"}'</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.0'</span><span class="p">,</span>
    <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'SimpleWorkflowService.ListDomains'</span>
  <span class="p">}</span>
<span class="p">}))</span>
<span class="cm">/*
{"domainInfos":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span>
  <span class="na">service</span><span class="p">:</span> <span class="s1">'cognito-identity'</span><span class="p">,</span>
  <span class="na">body</span><span class="p">:</span> <span class="s1">'{"MaxResults": 1}'</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-amz-json-1.1'</span><span class="p">,</span>
    <span class="s1">'X-Amz-Target'</span><span class="p">:</span> <span class="s1">'AWSCognitoIdentityService.ListIdentityPools'</span>
  <span class="p">}</span>
<span class="p">}))</span>
<span class="cm">/*
{"IdentityPools":[]}
...
*/</span>

<span class="nx">request</span><span class="p">(</span><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span>
  <span class="na">service</span><span class="p">:</span> <span class="s1">'mobileanalytics'</span><span class="p">,</span>
  <span class="na">path</span><span class="p">:</span> <span class="s1">'/2014-06-05/events'</span><span class="p">,</span>
  <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="na">events</span><span class="p">:[{</span>
    <span class="na">eventType</span><span class="p">:</span> <span class="s1">'a'</span><span class="p">,</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
    <span class="na">session</span><span class="p">:</span> <span class="p">{},</span>
  <span class="p">}]}),</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">,</span>
    <span class="s1">'X-Amz-Client-Context'</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
      <span class="na">client</span><span class="p">:</span> <span class="p">{</span><span class="na">client_id</span><span class="p">:</span> <span class="s1">'a'</span><span class="p">,</span> <span class="na">app_title</span><span class="p">:</span> <span class="s1">'a'</span><span class="p">},</span>
      <span class="na">custom</span><span class="p">:</span> <span class="p">{},</span>
      <span class="na">env</span><span class="p">:</span> <span class="p">{</span><span class="na">platform</span><span class="p">:</span> <span class="s1">'a'</span><span class="p">},</span>
      <span class="na">services</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}),</span>
  <span class="p">}</span>
<span class="p">}))</span>
<span class="cm">/*
(HTTP 202, empty response)
*/</span>
</code></pre>

<h2 id="api">API</h2>

<h3 id="aws4-sign-requestoptions-credentials">aws4.sign(requestOptions, [credentials])</h3>

<p>This calculates and populates the <code class="prettyprint">Authorization</code> header of
<code class="prettyprint">requestOptions</code>, and any other necessary AWS headers and/or request
options. Returns <code class="prettyprint">requestOptions</code> as a convenience for chaining.</p>

<p><code class="prettyprint">requestOptions</code> is an object holding the same options that the node.js
<a href="http://nodejs.org/docs/latest/api/http.html#http_http_request_options_callback">http.request</a>
function takes.</p>

<p>The following properties of <code class="prettyprint">requestOptions</code> are used in the signing or
populated if they don&rsquo;t already exist:</p>

<ul>
<li><code class="prettyprint">hostname</code> or <code class="prettyprint">host</code> (will be determined from <code class="prettyprint">service</code> and <code class="prettyprint">region</code> if not given)</li>
<li><code class="prettyprint">method</code> (will use <code class="prettyprint">&#39;GET&#39;</code> if not given or <code class="prettyprint">&#39;POST&#39;</code> if there is a <code class="prettyprint">body</code>)</li>
<li><code class="prettyprint">path</code> (will use <code class="prettyprint">&#39;/&#39;</code> if not given)</li>
<li><code class="prettyprint">body</code> (will use <code class="prettyprint">&#39;&#39;</code> if not given)</li>
<li><code class="prettyprint">service</code> (will be calculated from <code class="prettyprint">hostname</code> or <code class="prettyprint">host</code> if not given)</li>
<li><code class="prettyprint">region</code> (will be calculated from <code class="prettyprint">hostname</code> or <code class="prettyprint">host</code> or use <code class="prettyprint">&#39;us-east-1&#39;</code> if not given)</li>
<li><code class="prettyprint">headers[&#39;Host&#39;]</code> (will use <code class="prettyprint">hostname</code> or <code class="prettyprint">host</code> or be calculated if not given)</li>
<li><code class="prettyprint">headers[&#39;Content-Type&#39;]</code> (will use <code class="prettyprint">&#39;application/x-www-form-urlencoded; charset=utf-8&#39;</code>
if not given and there is a <code class="prettyprint">body</code>)</li>
<li><code class="prettyprint">headers[&#39;Date&#39;]</code> (used to calculate the signature date if given, otherwise <code class="prettyprint">new Date</code> is used)</li>
</ul>

<p>Your AWS credentials (which can be found in your
<a href="https://portal.aws.amazon.com/gp/aws/securityCredentials">AWS console</a>)
can be specified in one of two ways:</p>

<ul>
<li>As the second argument, like this:</li>
</ul>
<pre class="highlight javascript"><code><span class="nx">aws4</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">requestOptions</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">secretAccessKey</span><span class="p">:</span> <span class="s2">"&lt;your-secret-access-key&gt;"</span><span class="p">,</span>
  <span class="na">accessKeyId</span><span class="p">:</span> <span class="s2">"&lt;your-access-key-id&gt;"</span><span class="p">,</span>
  <span class="na">sessionToken</span><span class="p">:</span> <span class="s2">"&lt;your-session-token&gt;"</span>
<span class="p">})</span>
</code></pre>

<ul>
<li>From <code class="prettyprint">process.env</code>, such as this:</li>
</ul>
<pre class="highlight plaintext"><code>export AWS_SECRET_ACCESS_KEY="&lt;your-secret-access-key&gt;"
export AWS_ACCESS_KEY_ID="&lt;your-access-key-id&gt;"
export AWS_SESSION_TOKEN="&lt;your-session-token&gt;"
</code></pre>

<p>(will also use <code class="prettyprint">AWS_ACCESS_KEY</code> and <code class="prettyprint">AWS_SECRET_KEY</code> if available)</p>

<p>The <code class="prettyprint">sessionToken</code> property and <code class="prettyprint">AWS_SESSION_TOKEN</code> environment variable are optional for signing
with <a href="http://docs.aws.amazon.com/STS/latest/UsingSTS/using-temp-creds.html">IAM STS temporary credentials</a>.</p>

<h2 id="installation">Installation</h2>

<p>With <a href="http://npmjs.org/">npm</a> do:</p>
<pre class="highlight plaintext"><code>npm install aws4
</code></pre>

<p>Can also be used <a href="./browser">in the browser</a>.</p>

<h2 id="thanks">Thanks</h2>

<p>Thanks to <a href="https://github.com/jed">@jed</a> for his
<a href="https://github.com/jed/dynamo-client">dynamo-client</a> lib where I first
committed and subsequently extracted this code.</p>

<p>Also thanks to the
<a href="https://github.com/aws/aws-sdk-js">official node.js AWS SDK</a> for giving
me a start on implementing the v4 signature.</p>
