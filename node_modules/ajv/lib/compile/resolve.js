"use strict";function resolve(e,r,t){var i=this._refs[t];if("string"==typeof i){if(!this._refs[i])return resolve.call(this,e,r,i);i=this._refs[i]}if(i=i||this._schemas[t],i instanceof SchemaObject)return inlineRef(i.schema,this._opts.inlineRefs)?i.schema:i.validate||this._compile(i);var s,a,o,l=resolveSchema.call(this,r,t);return l&&(s=l.schema,r=l.root,o=l.baseId),s instanceof SchemaObject?a=s.validate||e.call(this,s.schema,r,void 0,o):s&&(a=inlineRef(s,this._opts.inlineRefs)?s:e.call(this,s,r,void 0,o)),a}function resolveSchema(e,r){var t=url.parse(r,!1,!0),i=_getFullPath(t),s=getFullPath(e.schema.id);if(i!==s){var a=normalizeId(i),o=this._refs[a];if("string"==typeof o)return resolveRecursive.call(this,e,o,t);if(o instanceof SchemaObject)o.validate||this._compile(o),e=o;else{if(o=this._schemas[a],!(o instanceof SchemaObject))return;if(o.validate||this._compile(o),a==normalizeId(r))return{schema:o,root:e,baseId:s};e=o}if(!e.schema)return;s=getFullPath(e.schema.id)}return getJsonPointer.call(this,t,s,e.schema,e)}function resolveRecursive(e,r,t){var i=resolveSchema.call(this,e,r);if(i){var s=i.schema,a=i.baseId;return e=i.root,s.id&&(a=resolveUrl(a,s.id)),getJsonPointer.call(this,t,a,s,e)}}function getJsonPointer(e,r,t,i){if(e.hash=e.hash||"","#/"==e.hash.slice(0,2)){for(var s=e.hash.split("/"),a=1;a<s.length;a++){var o=s[a];if(o){if(o=util.unescapeFragment(o),t=t[o],!t)break;if(t.id&&!PREVENT_SCOPE_CHANGE[o]&&(r=resolveUrl(r,t.id)),t.$ref){var l=resolveUrl(r,t.$ref),n=resolveSchema.call(this,i,l);n&&(t=n.schema,i=n.root,r=n.baseId)}}}return t&&t!=i.schema?{schema:t,root:i,baseId:r}:void 0}}function inlineRef(e,r){return r===!1?!1:void 0===r||r===!0?checkNoRef(e):r?countKeys(e)<=r:void 0}function checkNoRef(e){var r;if(Array.isArray(e)){for(var t=0;t<e.length;t++)if(r=e[t],"object"==typeof r&&!checkNoRef(r))return!1}else for(var i in e){if("$ref"==i)return!1;if(r=e[i],"object"==typeof r&&!checkNoRef(r))return!1}return!0}function countKeys(e){var r,t=0;if(Array.isArray(e)){for(var i=0;i<e.length;i++)if(r=e[i],"object"==typeof r&&(t+=countKeys(r)),t==1/0)return 1/0}else for(var s in e){if("$ref"==s)return 1/0;if(SIMPLE_INLINED[s])t++;else if(r=e[s],"object"==typeof r&&(t+=countKeys(r)+1),t==1/0)return 1/0}return t}function getFullPath(e,r){r!==!1&&(e=normalizeId(e));var t=url.parse(e,!1,!0);return _getFullPath(t)}function _getFullPath(e){var r=e.protocol||"//"==e.href.slice(0,2)?"//":"";return(e.protocol||"")+r+(e.host||"")+(e.path||"")+"#"}function normalizeId(e){return e?e.replace(TRAILING_SLASH_HASH,""):""}function resolveUrl(e,r){return r=normalizeId(r),url.resolve(e,r)}function resolveIds(e){function r(e,t,s){if(Array.isArray(e))for(var a=0;a<e.length;a++)r.call(this,e[a],t+"/"+a,s);else if(e&&"object"==typeof e){if("string"==typeof e.id){var o=s=s?url.resolve(s,e.id):e.id;o=normalizeId(o);var l=this._refs[o];if("string"==typeof l&&(l=this._refs[l]),l&&l.schema){if(!equal(e,l.schema))throw new Error('id "'+o+'" resolves to more than one schema')}else if(o!=normalizeId(t))if("#"==o[0]){if(i[o]&&!equal(e,i[o]))throw new Error('id "'+o+'" resolves to more than one schema');i[o]=e}else this._refs[o]=t}for(var n in e)r.call(this,e[n],t+"/"+util.escapeFragment(n),s)}}var t=normalizeId(e.id),i={};return r.call(this,e,getFullPath(t,!1),t),i}var url=require("url"),equal=require("./equal"),util=require("./util"),SchemaObject=require("./schema_obj");module.exports=resolve,resolve.normalizeId=normalizeId,resolve.fullPath=getFullPath,resolve.url=resolveUrl,resolve.ids=resolveIds,resolve.inlineRef=inlineRef,resolve.schema=resolveSchema;var PREVENT_SCOPE_CHANGE=util.toHash(["properties","patternProperties","enum","dependencies","definitions"]),SIMPLE_INLINED=util.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]),TRAILING_SLASH_HASH=/#\/?$/;