"use strict";function compile(schema,root,localRefs,baseId){function callValidate(){var e=compilation.validate,a=e.apply(null,arguments);return callValidate.errors=e.errors,a}function localCompile(_schema,_root,localRefs,baseId){var isRoot=!_root||_root&&_root.schema==_schema;if(_root.schema!=root.schema)return compile.call(self,_schema,_root,localRefs,baseId);var $async=_schema.$async===!0;$async&&!opts.transpile&&async.setup(opts);var sourceCode=validateGenerator({isTop:!0,schema:_schema,isRoot:isRoot,baseId:baseId,root:_root,schemaPath:"",errSchemaPath:"#",errorPath:'""',RULES:RULES,validate:validateGenerator,util:util,resolve:resolve,resolveRef:resolveRef,usePattern:usePattern,useDefault:useDefault,useCustomRule:useCustomRule,opts:opts,formats:formats,self:self});sourceCode=vars(refVal,refValCode)+vars(patterns,patternCode)+vars(defaults,defaultCode)+vars(customRules,customRuleCode)+sourceCode,opts.beautify&&(beautify?sourceCode=beautify(sourceCode,opts.beautify):console.error('"npm install js-beautify" to use beautify option'));var validate,validateCode,transpile=opts._transpileFunc;try{validateCode=$async&&transpile?transpile(sourceCode):sourceCode,eval(validateCode),refVal[0]=validate}catch(e){throw console.error("Error compiling schema, function code:",validateCode),e}return validate.schema=_schema,validate.errors=null,validate.refs=refs,validate.refVal=refVal,validate.root=isRoot?validate:_root,$async&&(validate.$async=!0),validate.sourceCode=sourceCode,validate}function resolveRef(e,a,r){a=resolve.url(e,a);var t,o,l=refs[a];if(void 0!==l)return t=refVal[l],o="refVal["+l+"]",resolvedRef(t,o);if(!r&&root.refs){var s=root.refs[a];if(void 0!==s)return t=root.refVal[s],o=addLocalRef(a,t),resolvedRef(t,o)}o=addLocalRef(a);var i=resolve.call(self,localCompile,root,a);if(!i){var n=localRefs&&localRefs[a];n&&(i=resolve.inlineRef(n,opts.inlineRefs)?n:compile.call(self,n,root,localRefs,e))}return i?(replaceLocalRef(a,i),resolvedRef(i,o)):void 0}function addLocalRef(e,a){var r=refVal.length;return refVal[r]=a,refs[e]=r,"refVal"+r}function replaceLocalRef(e,a){var r=refs[e];refVal[r]=a}function resolvedRef(e,a){return"object"==typeof e?{code:a,schema:e,inline:!0}:{code:a,$async:e&&e.$async}}function usePattern(e){var a=patternsHash[e];return void 0===a&&(a=patternsHash[e]=patterns.length,patterns[a]=e),"pattern"+a}function useDefault(e){switch(typeof e){case"boolean":case"number":return""+e;case"string":return util.toQuotedString(e);case"object":if(null===e)return"null";var a=stableStringify(e),r=defaultsHash[a];return void 0===r&&(r=defaultsHash[a]=defaults.length,defaults[r]=e),"default"+r}}function useCustomRule(e,a,r,t){var o=e.definition.validateSchema;if(o&&self._opts.validateSchema!==!1){var l=o(a);if(!l){var s="keyword schema is invalid: "+self.errorsText(o.errors);if("log"!=self._opts.validateSchema)throw new Error(s);console.error(s)}}var i,n=e.definition.compile,c=e.definition.inline,u=e.definition.macro;n?i=n.call(self,a,r):u?(i=u.call(self,a,r),opts.validateSchema!==!1&&self.validateSchema(i,!0)):i=c?c.call(self,t,e.keyword,a,r):e.definition.validate;var f=customRules.length;return customRules[f]=i,{code:"customRule"+f,validate:i}}var self=this,opts=this._opts,refVal=[void 0],refs={},patterns=[],patternsHash={},defaults=[],defaultsHash={},customRules=[];root=root||{schema:schema,refVal:refVal,refs:refs};var c=checkCompiling.call(this,schema,root,baseId),compilation=this._compilations[c.index];if(c.compiling)return compilation.callValidate=callValidate;var formats=this._formats,RULES=this.RULES;try{var v=localCompile(schema,root,localRefs,baseId);compilation.validate=v;var cv=compilation.callValidate;return cv&&(cv.schema=v.schema,cv.errors=null,cv.refs=v.refs,cv.refVal=v.refVal,cv.root=v.root,cv.$async=v.$async,cv.sourceCode=v.sourceCode),v}finally{endCompiling.call(this,schema,root,baseId)}}function checkCompiling(e,a,r){var t=compIndex.call(this,e,a,r);return t>=0?{index:t,compiling:!0}:(t=this._compilations.length,this._compilations[t]={schema:e,root:a,baseId:r},{index:t,compiling:!1})}function endCompiling(e,a,r){var t=compIndex.call(this,e,a,r);t>=0&&this._compilations.splice(t,1)}function compIndex(e,a,r){for(var t=0;t<this._compilations.length;t++){var o=this._compilations[t];if(o.schema==e&&o.root==a&&o.baseId==r)return t}return-1}function patternCode(e,a){return"var pattern"+e+" = new RegExp("+util.toQuotedString(a[e])+");"}function defaultCode(e){return"var default"+e+" = defaults["+e+"];"}function refValCode(e,a){return a[e]?"var refVal"+e+" = refVal["+e+"];":""}function customRuleCode(e){return"var customRule"+e+" = customRules["+e+"];"}function vars(e,a){if(!e.length)return"";for(var r="",t=0;t<e.length;t++)r+=a(t,e);return r}var resolve=require("./resolve"),util=require("./util"),stableStringify=require("json-stable-stringify"),async=require("../async"),beautify=function(){try{return require("js-beautify").js_beautify}catch(e){}}(),validateGenerator=require("../dotjs/validate");module.exports=compile;var co=require("co"),ucs2length=util.ucs2length,equal=require("./equal"),ValidationError=require("./validation_error");