<p><a href="http://promisesaplus.com/">
    <img src="http://promisesaplus.com/assets/logo-small.png" alt="Promises/A+ logo"
         title="Promises/A+ 1.1 compliant" align="right" />
</a>
<a href="https://travis-ci.org/petkaantonov/bluebird"><img alt="Build Status" src="https://travis-ci.org/petkaantonov/bluebird.svg?branch=master" /></a>
<a href="http://petkaantonov.github.io/bluebird/coverage/debug/index.html"><img alt="coverage-98%" src="http://img.shields.io/badge/coverage-98%-brightgreen.svg?style=flat" /></a></p>

<p><strong>Got a question?</strong> Join us on <a href="http://stackoverflow.com/questions/tagged/bluebird">stackoverflow</a>, the <a href="https://groups.google.com/forum/#!forum/bluebird-js">mailing list</a> or chat on <a href="https://webchat.freenode.net/?channels=#promises">IRC</a></p>

<h1 id="introduction">Introduction</h1>

<p>Bluebird is a fully featured <a href="#what-are-promises-and-why-should-i-use-them">promise</a> library with focus on innovative features and performance</p>

<h1 id="topics">Topics</h1>

<ul>
<li><a href="#features">Features</a></li>
<li><a href="#quick-start">Quick start</a></li>
<li><a href="API.md">API Reference and examples</a></li>
<li><a href="#support">Support</a></li>
<li><a href="#what-are-promises-and-why-should-i-use-them">What are promises and why should I use them?</a></li>
<li><a href="#questions-and-issues">Questions and issues</a></li>
<li><a href="#error-handling">Error handling</a></li>
<li><a href="#development">Development</a>

<ul>
<li><a href="#testing">Testing</a></li>
<li><a href="#benchmarks">Benchmarking</a></li>
<li><a href="#custom-builds">Custom builds</a></li>
<li><a href="#for-library-authors">For library authors</a></li>
</ul></li>
<li><a href="#what-is-the-sync-build">What is the sync build?</a></li>
<li><a href="#license">License</a></li>
<li><a href="https://github.com/petkaantonov/bluebird/wiki/Snippets">Snippets for common problems</a></li>
<li><a href="https://github.com/petkaantonov/bluebird/wiki/Promise-anti-patterns">Promise anti-patterns</a></li>
<li><a href="changelog.md">Changelog</a></li>
<li><a href="#optimization-guide">Optimization guide</a></li>
</ul>

<h1 id="features">Features</h1>

<p><img src="http://petkaantonov.github.io/bluebird/logo.png" alt="bluebird logo" align="right" /></p>

<ul>
<li><a href="http://promisesaplus.com">Promises A+</a></li>
<li><a href="API.md#synchronous-inspection">Synchronous inspection</a></li>
<li><a href="API.md#collections">Concurrency coordination</a></li>
<li><a href="API.md#promisification">Promisification on steroids</a></li>
<li><a href="API.md#resource-management">Resource management through a parallel of python <code class="prettyprint">with</code>/C# <code class="prettyprint">using</code></a></li>
<li><a href="API.md#cancellation">Cancellation and timeouts</a></li>
<li><a href="API.md#generators">Parallel for C# <code class="prettyprint">async</code> and <code class="prettyprint">await</code></a></li>
<li>Mind blowing utilities such as

<ul>
<li><a href="API.md#binddynamic-thisarg---promise"><code class="prettyprint">.bind()</code></a></li>
<li><a href="API.md#callstring-propertyname--dynamic-arg---promise"><code class="prettyprint">.call()</code></a></li>
<li><a href="API.md#promisejoinpromisethenablevalue-promises-function-handler---promise"><code class="prettyprint">Promise.join()</code></a></li>
<li><a href="API.md#core">And</a> <a href="API.md#timers">much</a> <a href="API.md#utility">more</a>!</li>
</ul></li>
<li><a href="#error-handling">Practical debugging solutions and sane defaults</a></li>
<li><a href="benchmark/">Sick performance</a></li>
</ul>

<p><hr></p>

<h1 id="quick-start">Quick start</h1>

<h2 id="node-js">Node.js</h2>

<p>npm install bluebird</p>

<p>Then:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
</code></pre>

<h2 id="browsers">Browsers</h2>

<p>There are many ways to use bluebird in browsers:</p>

<ul>
<li>Direct downloads

<ul>
<li>Full build <a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.js">bluebird.js</a></li>
<li>Full build minified <a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.min.js">bluebird.min.js</a></li>
<li>Core build <a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.core.js">bluebird.core.js</a></li>
<li>Core build minified <a href="https://cdn.jsdelivr.net/bluebird/latest/bluebird.core.min.js">bluebird.core.min.js</a></li>
</ul></li>
<li>You may use browserify on the main export</li>
<li>You may use the <a href="http://bower.io">bower</a> package.</li>
</ul>

<p>When using script tags the global variables <code class="prettyprint">Promise</code> and <code class="prettyprint">P</code> (alias for <code class="prettyprint">Promise</code>) become available.</p>

<p>A <a href="#custom-builds">minimal bluebird browser build</a> is &asymp;38.92KB minified*, 11.65KB gzipped and has no external dependencies.</p>

<p>*Google Closure Compiler using Simple.</p>

<h4 id="browser-support">Browser support</h4>

<p>Browsers that <a href="http://en.wikipedia.org/wiki/Ecmascript#Implementations">implement ECMA-262, edition 3</a> and later are supported.</p>

<p><a href="https://saucelabs.com/u/petka_antonov"><img alt="Selenium Test Status" src="https://saucelabs.com/browser-matrix/petka_antonov.svg" /></a></p>

<p><strong>Note</strong> that in ECMA-262, edition 3 (IE7, IE8 etc.) it is not possible to use methods that have keyword names like <code class="prettyprint">.catch</code> and <code class="prettyprint">.finally</code>. The <a href="API.md">API documentation</a> always lists a compatible alternative name that you can use if you need to support these browsers. For example <code class="prettyprint">.catch</code> is replaced with <code class="prettyprint">.caught</code> and <code class="prettyprint">.finally</code> with <code class="prettyprint">.lastly</code>.</p>

<p>Also, <a href="API.md#promiselongstacktraces---void">long stack trace</a> support is only available in Chrome, Firefox and Internet Explorer 10+.</p>

<p>After quick start, see <a href="API.md">API Reference and examples</a></p>

<p><hr></p>

<h1 id="support">Support</h1>

<ul>
<li>Mailing list: <a href="https://groups.google.com/forum/#!forum/bluebird-js">bluebird-js@googlegroups.com</a></li>
<li>IRC: #promises @freenode</li>
<li>StackOverflow: <a href="http://stackoverflow.com/questions/tagged/bluebird">bluebird tag</a></li>
<li>Bugs and feature requests: <a href="https://github.com/petkaantonov/bluebird/issues?state=open">github issue tracker</a></li>
</ul>

<p><hr></p>

<h1 id="what-are-promises-and-why-should-i-use-them">What are promises and why should I use them?</h1>

<p>You should use promises to turn this:</p>
<pre class="highlight javascript"><code><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"file.json"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"unable to read file"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">success</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"invalid json in file"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Into this:</p>
<pre class="highlight javascript"><code><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">"file.json"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">success</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">SyntaxError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"invalid json in file"</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"unable to read file"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p><em>If you are wondering &ldquo;there is no <code class="prettyprint">readFileAsync</code> method on <code class="prettyprint">fs</code> that returns a promise&rdquo;, see <a href="API.md#promisification">promisification</a></em></p>

<p>Actually you might notice the latter has a lot in common with code that would do the same using synchronous I/O:</p>
<pre class="highlight javascript"><code><span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">"file.json"</span><span class="p">));</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">success</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//Syntax actually not supported in JS but drives the point</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">SyntaxError</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"invalid json in file"</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">catch</span><span class="p">(</span><span class="nb">Error</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"unable to read file"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>And that is the point - being able to have something that is a lot like <code class="prettyprint">return</code> and <code class="prettyprint">throw</code> in synchronous code.</p>

<p>You can also use promises to improve code that was written with callback helpers:</p>
<pre class="highlight javascript"><code><span class="c1">//Copyright Plato http://stackoverflow.com/a/19385911/995876</span>
<span class="c1">//CC BY-SA 2.5</span>
<span class="nx">mapSeries</span><span class="p">(</span><span class="nx">URLs</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">needle</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">ret</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'All Needle requests successful'</span><span class="p">);</span>
        <span class="c1">// results is a 1 to 1 mapping in order of URLs &gt; needle.body</span>
        <span class="nx">processAndSaveAllInDB</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'All Needle requests saved'</span><span class="p">);</span>
            <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>Is more pleasing to the eye when done with promises:</p>
<pre class="highlight javascript"><code><span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">needle</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">URLs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">URL</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">current</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">needle</span><span class="p">.</span><span class="nx">getAsync</span><span class="p">(</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">current</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">responseAndBody</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">responseAndBody</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">processAndSaveAllInDB</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'All Needle requests saved'</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p>Also promises don&rsquo;t just give you correspondences for synchronous features but can also be used as limited event emitters or callback aggregators.</p>

<p>More reading:</p>

<ul>
<li><a href="https://promise-nuggets.github.io/">Promise nuggets</a></li>
<li><a href="http://spion.github.io/posts/why-i-am-switching-to-promises.html">Why I am switching to promises</a></li>
<li><a href="http://domenic.me/2012/10/14/youre-missing-the-point-of-promises/#toc_1">What is the the point of promises</a></li>
<li><a href="https://github.com/petkaantonov/bluebird/wiki/Snippets">Snippets for common problems</a></li>
<li><a href="https://github.com/petkaantonov/bluebird/wiki/Promise-anti-patterns">Promise anti-patterns</a></li>
</ul>

<h1 id="questions-and-issues">Questions and issues</h1>

<p>The <a href="https://github.com/petkaantonov/bluebird/issues">github issue tracker</a> is <strong><em>only</em></strong> for bug reports and feature requests. Anything else, such as questions for help in using the library, should be posted in <a href="http://stackoverflow.com/questions/tagged/bluebird">StackOverflow</a> under tags <code class="prettyprint">promise</code> and <code class="prettyprint">bluebird</code>.</p>

<h1 id="error-handling">Error handling</h1>

<p>This is a problem every promise library needs to handle in some way. Unhandled rejections/exceptions don&rsquo;t really have a good agreed-on asynchronous correspondence. The problem is that it is impossible to predict the future and know if a rejected promise will eventually be handled.</p>

<p>There are two common pragmatic attempts at solving the problem that promise libraries do.</p>

<p>The more popular one is to have the user explicitly communicate that they are done and any unhandled rejections should be thrown, like so:</p>
<pre class="highlight javascript"><code><span class="nx">download</span><span class="p">().</span><span class="nx">then</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(...).</span><span class="nx">done</span><span class="p">();</span>
</code></pre>

<p>For handling this problem, in my opinion, this is completely unacceptable and pointless. The user must remember to explicitly call <code class="prettyprint">.done</code> and that cannot be justified when the problem is forgetting to create an error handler in the first place.</p>

<p>The second approach, which is what bluebird by default takes, is to call a registered handler if a rejection is unhandled by the start of a second turn. The default handler is to write the stack trace to <code class="prettyprint">stderr</code> or <code class="prettyprint">console.error</code> in browsers. This is close to what happens with synchronous code - your code doesn&rsquo;t work as expected and you open console and see a stack trace. Nice.</p>

<p>Of course this is not perfect, if your code for some reason needs to swoop in and attach error handler to some promise after the promise has been hanging around a while then you will see annoying messages. In that case you can use the <code class="prettyprint">.done()</code> method to signal that any hanging exceptions should be thrown.</p>

<p>If you want to override the default handler for these possibly unhandled rejections, you can pass yours like so:</p>
<pre class="highlight javascript"><code><span class="nx">Promise</span><span class="p">.</span><span class="nx">onPossiblyUnhandledRejection</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
    <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
<span class="p">});</span>
</code></pre>

<p>If you want to also enable long stack traces, call:</p>
<pre class="highlight javascript"><code><span class="nx">Promise</span><span class="p">.</span><span class="nx">longStackTraces</span><span class="p">();</span>
</code></pre>

<p>right after the library is loaded.</p>

<p>In node.js use the environment flag <code class="prettyprint">BLUEBIRD_DEBUG</code>:</p>
<pre class="highlight plaintext"><code>BLUEBIRD_DEBUG=1 node server.js
</code></pre>

<p>to enable long stack traces in all instances of bluebird.</p>

<p>Long stack traces cannot be disabled after being enabled, and cannot be enabled after promises have already been created. Long stack traces imply a substantial performance penalty, even after using every trick to optimize them.</p>

<p>Long stack traces are enabled by default in the debug build.</p>

<h4 id="expected-and-unexpected-errors">Expected and unexpected errors</h4>

<p>A practical problem with Promises/A+ is that it models Javascript <code class="prettyprint">try-catch</code> too closely for its own good. Therefore by default promises inherit <code class="prettyprint">try-catch</code> warts such as the inability to specify the error types that the catch block is eligible for. It is an anti-pattern in every other language to use catch-all handlers because they swallow exceptions that you might not know about.</p>

<p>Now, Javascript does have a perfectly fine and working way of creating error type hierarchies. It is still quite awkward to use them with the built-in <code class="prettyprint">try-catch</code> however:</p>
<pre class="highlight javascript"><code><span class="k">try</span> <span class="p">{</span>
    <span class="c1">//code</span>
<span class="p">}</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">WhatIWantError</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//handle</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Without such checking, unexpected errors would be silently swallowed. However, with promises, bluebird brings the future (hopefully) here now and extends the <code class="prettyprint">.catch</code> to <a href="API.md#catchfunction-errorclass-function-handler---promise">accept potential error type eligibility</a>.</p>

<p>For instance here it is expected that some evil or incompetent entity will try to crash our server from <code class="prettyprint">SyntaxError</code> by providing syntactically invalid JSON:</p>
<pre class="highlight javascript"><code><span class="nx">getJSONFromSomewhere</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"it was valid json: "</span><span class="p">,</span> <span class="nx">object</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">SyntaxError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"don't be evil"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p>Here any kind of unexpected error will be automatically reported on <code class="prettyprint">stderr</code> along with a stack trace because we only register a handler for the expected <code class="prettyprint">SyntaxError</code>.</p>

<p>Ok, so, that&rsquo;s pretty neat. But actually not many libraries define error types and it is in fact a complete ghetto out there with ad hoc strings being attached as some arbitrary property name like <code class="prettyprint">.name</code>, <code class="prettyprint">.type</code>, <code class="prettyprint">.code</code>, not having any property at all or even throwing strings as errors and so on. So how can we still listen for expected errors?</p>

<p>Bluebird defines a special error type <code class="prettyprint">OperationalError</code> (you can get a reference from <code class="prettyprint">Promise.OperationalError</code>). This type of error is given as rejection reason by promisified methods when
their underlying library gives an untyped, but expected error. Primitives such as strings, and error objects that are directly created like <code class="prettyprint">new Error(&quot;database didn&#39;t respond&quot;)</code> are considered untyped.</p>

<p>Example of such library is the node core library <code class="prettyprint">fs</code>. So if we promisify it, we can catch just the errors we want pretty easily and have programmer errors be redirected to unhandled rejection handler so that we notice them:</p>
<pre class="highlight javascript"><code><span class="c1">//Read more about promisification in the API Reference:</span>
<span class="c1">//API.md</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisifyAll</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">));</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFileAsync</span><span class="p">(</span><span class="s2">"myfile.json"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Successful json"</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">SyntaxError</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"file contains invalid json"</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">Promise</span><span class="p">.</span><span class="nx">OperationalError</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"unable to read file, because: "</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p>The last <code class="prettyprint">catch</code> handler is only invoked when the <code class="prettyprint">fs</code> module explicitly used the <code class="prettyprint">err</code> argument convention of async callbacks to inform of an expected error. The <code class="prettyprint">OperationalError</code> instance will contain the original error in its <code class="prettyprint">.cause</code> property but it does have a direct copy of the <code class="prettyprint">.message</code> and <code class="prettyprint">.stack</code> too. In this code any unexpected error - be it in our code or the <code class="prettyprint">fs</code> module - would not be caught by these handlers and therefore not swallowed.</p>

<p>Since a <code class="prettyprint">catch</code> handler typed to <code class="prettyprint">Promise.OperationalError</code> is expected to be used very often, it has a neat shorthand:</p>
<pre class="highlight javascript"><code><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"unable to read file, because: "</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>

<p>See <a href="API.md#error-rejectedhandler----promise">API documentation for <code class="prettyprint">.error()</code></a></p>

<p>Finally, Bluebird also supports predicate-based filters. If you pass a
predicate function instead of an error type, the predicate will receive
the error as an argument. The return result will be used to determine whether
the error handler should be called.</p>

<p>Predicates should allow for very fine grained control over caught errors:
pattern matching, error typesets with set operations and many other techniques
can be implemented on top of them.</p>

<p>Example of using a predicate-based filter:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">"request"</span><span class="p">));</span>

<span class="kd">function</span> <span class="nx">clientError</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">request</span><span class="p">(</span><span class="s2">"http://www.google.com"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">clientError</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
   <span class="c1">//A client error like 400 Bad Request happened</span>
<span class="p">});</span>
</code></pre>

<p><strong>Danger:</strong> The JavaScript language allows throwing primitive values like strings. Throwing primitives can lead to worse or no stack traces. Primitives <a href="http://www.devthought.com/2011/12/22/a-string-is-not-an-error/">are not exceptions</a>. You should consider always throwing Error objects when handling exceptions.</p>

<p><hr></p>

<h4 id="how-do-long-stack-traces-differ-from-e-g-q">How do long stack traces differ from e.g. Q?</h4>

<p>Bluebird attempts to have more elaborate traces. Consider:</p>
<pre class="highlight javascript"><code><span class="nb">Error</span><span class="p">.</span><span class="nx">stackTraceLimit</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
<span class="nx">Q</span><span class="p">.</span><span class="nx">longStackSupport</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">Q</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">outer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Q</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">inner</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Q</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">evenMoreInner</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">d</span><span class="p">();</span>
        <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">catcher</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre>

<p>You will see</p>

<p>ReferenceError: a is not defined
        at evenMoreInner (<anonymous>:7:13)
    From previous event:
        at inner (<anonymous>:6:20)</p>

<p>Compare to:</p>
<pre class="highlight javascript"><code><span class="nb">Error</span><span class="p">.</span><span class="nx">stackTraceLimit</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">longStackTraces</span><span class="p">();</span>
<span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">outer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">inner</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">evenMoreInner</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">d</span><span class="p">();</span>
        <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">catcher</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre>

<p>ReferenceError: a is not defined
        at evenMoreInner (<anonymous>:7:13)
    From previous event:
        at inner (<anonymous>:6:36)
    From previous event:
        at outer (<anonymous>:5:32)
    From previous event:
        at <anonymous>:4:21
        at Object.InjectedScript._evaluateOn (<anonymous>:572:39)
        at Object.InjectedScript._evaluateAndWrap (<anonymous>:531:52)
        at Object.InjectedScript.evaluate (<anonymous>:450:21)</p>

<p>A better and more practical example of the differences can be seen in gorgikosev&rsquo;s <a href="https://github.com/spion/async-compare#debuggability">debuggability competition</a>.</p>

<p><hr></p>

<h1 id="development">Development</h1>

<p>For development tasks such as running benchmarks or testing, you need to clone the repository and install dev-dependencies.</p>

<p>Install <a href="http://nodejs.org/">node</a> and <a href="https://npmjs.org/">npm</a></p>

<p>git clone git@github.com:petkaantonov/bluebird.git
    cd bluebird
    npm install</p>

<h2 id="testing">Testing</h2>

<p>To run all tests, run</p>

<p>node tools/test</p>

<p>If you need to run generator tests run the <code class="prettyprint">tool/test.js</code> script with <code class="prettyprint">--harmony</code> argument and node 0.11+:</p>

<p>node-dev &ndash;harmony tools/test</p>

<p>You may specify an individual test file to run with the <code class="prettyprint">--run</code> script flag:</p>

<p>node tools/test &ndash;run=cancel.js</p>

<p>This enables output from the test and may give a better idea where the test is failing. The parameter to <code class="prettyprint">--run</code> can be any file name located in <code class="prettyprint">test/mocha</code> folder.</p>

<h4 id="testing-in-browsers">Testing in browsers</h4>

<p>To run the test in a browser instead of node, pass the flag <code class="prettyprint">--browser</code> to the test tool</p>

<p>node tools/test &ndash;run=cancel.js &ndash;browser</p>

<p>This will automatically create a server (default port 9999) and open it in your default browser once the tests have been compiled.</p>

<p>Keep the test tab active because some tests are timing-sensitive and will fail if the browser is throttling timeouts. Chrome will do this for example when the tab is not active.</p>

<h4 id="supported-options-by-the-test-tool">Supported options by the test tool</h4>

<p>The value of boolean flags is determined by presence, if you want to pass false value for a boolean flag, use the <code class="prettyprint">no-</code>-prefix e.g. <code class="prettyprint">--no-browser</code>.</p>

<ul>
<li><code class="prettyprint">--run=String</code> - Which tests to run (or compile when testing in browser). Default <code class="prettyprint">&quot;all&quot;</code>. Can also be a glob string (relative to ./test/mocha folder).</li>
<li><code class="prettyprint">--cover=String</code>. Create code coverage using the String as istanbul reporter. Coverage is created in the ./coverage folder. No coverage is created by default, default reporter is <code class="prettyprint">&quot;html&quot;</code> (use <code class="prettyprint">--cover</code> to use default reporter).</li>
<li><code class="prettyprint">--browser</code> - Whether to compile tests for browsers. Default <code class="prettyprint">false</code>.</li>
<li><code class="prettyprint">--port=Number</code> - Port where local server is hosted when testing in browser. Default <code class="prettyprint">9999</code></li>
<li><code class="prettyprint">--execute-browser-tests</code> - Whether to execute the compiled tests for browser when using <code class="prettyprint">--browser</code>. Default <code class="prettyprint">true</code>.</li>
<li><code class="prettyprint">--open-browser</code> - Whether to open the default browser when executing browser tests. Default <code class="prettyprint">true</code>.</li>
<li><code class="prettyprint">--fake-timers</code> - Whether to use fake timers (<code class="prettyprint">setTimeout</code> etc) when running tests in node. Default <code class="prettyprint">true</code>.</li>
<li><code class="prettyprint">--js-hint</code> - Whether to run JSHint on source files. Default <code class="prettyprint">true</code>.</li>
<li><code class="prettyprint">--saucelabs</code> - Whether to create a tunnel to sauce labs and run tests in their VMs instead of your browser when compiling tests for browser. Default <code class="prettyprint">false</code>.</li>
</ul>

<h2 id="benchmarks">Benchmarks</h2>

<p>To run a benchmark, run the given command for a benchmark while on the project root. Requires bash (on windows the mingw32 that comes with git works fine too).</p>

<p>Node 0.11.2+ is required to run the generator examples.</p>

<h3 id="1-doxbee-sequential">1. DoxBee sequential</h3>

<p>Currently the most relevant benchmark is @gorkikosev&rsquo;s benchmark in the article <a href="http://spion.github.io/posts/analysis-generators-and-other-async-patterns-node.html">Analysis of generators and other async patterns in node</a>. The benchmark emulates a situation where n amount of users are making a request in parallel to execute some mixed async/sync action. The benchmark has been modified to include a warm-up phase to minimize any JITing during timed sections.</p>

<p>Command: <code class="prettyprint">bench doxbee</code></p>

<h3 id="2-made-up-parallel">2. Made-up parallel</h3>

<p>This made-up scenario runs 15 shimmed queries in parallel.</p>

<p>Command: <code class="prettyprint">bench parallel</code></p>

<h2 id="custom-builds">Custom builds</h2>

<p>Custom builds for browsers are supported through a command-line utility.</p>

<table>
    <caption>The following features can be disabled</caption>
    <thead>
        <tr>
            <th>Feature(s)</th>
            <th>Command line identifier</th>
        </tr>
    </thead>
    <tbody>

        <tr><td><a href="API.md#any---promise"><code>.any</code></a> and <a href="API.md#promiseanyarraydynamicpromise-values---promise"><code>Promise.any</code></a></td><td><code>any</code></td></tr>
        <tr><td><a href="API.md#race---promise"><code>.race</code></a> and <a href="API.md#promiseracearraypromise-promises---promise"><code>Promise.race</code></a></td><td><code>race</code></td></tr>
        <tr><td><a href="API.md#callstring-propertyname--dynamic-arg---promise"><code>.call</code></a> and <a href="API.md#getstring-propertyname---promise"><code>.get</code></a></td><td><code>call_get</code></td></tr>
        <tr><td><a href="API.md#filterfunction-filterer---promise"><code>.filter</code></a> and <a href="API.md#promisefilterarraydynamicpromise-values-function-filterer---promise"><code>Promise.filter</code></a></td><td><code>filter</code></td></tr>
        <tr><td><a href="API.md#mapfunction-mapper---promise"><code>.map</code></a> and <a href="API.md#promisemaparraydynamicpromise-values-function-mapper---promise"><code>Promise.map</code></a></td><td><code>map</code></td></tr>
        <tr><td><a href="API.md#reducefunction-reducer--dynamic-initialvalue---promise"><code>.reduce</code></a> and <a href="API.md#promisereducearraydynamicpromise-values-function-reducer--dynamic-initialvalue---promise"><code>Promise.reduce</code></a></td><td><code>reduce</code></td></tr>
        <tr><td><a href="API.md#props---promise"><code>.props</code></a> and <a href="API.md#promisepropsobjectpromise-object---promise"><code>Promise.props</code></a></td><td><code>props</code></td></tr>
        <tr><td><a href="API.md#settle---promise"><code>.settle</code></a> and <a href="API.md#promisesettlearraydynamicpromise-values---promise"><code>Promise.settle</code></a></td><td><code>settle</code></td></tr>
        <tr><td><a href="API.md#someint-count---promise"><code>.some</code></a> and <a href="API.md#promisesomearraydynamicpromise-values-int-count---promise"><code>Promise.some</code></a></td><td><code>some</code></td></tr>
        <tr><td><a href="API.md#nodeifyfunction-callback---promise"><code>.nodeify</code></a></td><td><code>nodeify</code></td></tr>
        <tr><td><a href="API.md#promisecoroutinegeneratorfunction-generatorfunction---function"><code>Promise.coroutine</code></a> and <a href="API.md#promisespawngeneratorfunction-generatorfunction---promise"><code>Promise.spawn</code></a></td><td><code>generators</code></td></tr>
        <tr><td><a href="API.md#progression">Progression</a></td><td><code>progress</code></td></tr>
        <tr><td><a href="API.md#promisification">Promisification</a></td><td><code>promisify</code></td></tr>
        <tr><td><a href="API.md#cancellation">Cancellation</a></td><td><code>cancel</code></td></tr>
        <tr><td><a href="API.md#timers">Timers</a></td><td><code>timers</code></td></tr>
        <tr><td><a href="API.md#resource-management">Resource management</a></td><td><code>using</code></td></tr>

    </tbody>
</table>

<p>Make sure you have cloned the repo somewhere and did <code class="prettyprint">npm install</code> successfully.</p>

<p>After that you can run:</p>

<p>node tools/build &ndash;features=&ldquo;core&rdquo;</p>

<p>The above builds the most minimal build you can get. You can add more features separated by spaces from the above list:</p>

<p>node tools/build &ndash;features=&ldquo;core filter map reduce&rdquo;</p>

<p>The custom build file will be found from <code class="prettyprint">/js/browser/bluebird.js</code>. It will have a comment that lists the disabled and enabled features.</p>

<p>Note that the build leaves the <code class="prettyprint">/js/main</code> etc folders with same features so if you use the folder for node.js at the same time, don&rsquo;t forget to build
a full version afterwards (after having taken a copy of the bluebird.js somewhere):</p>

<p>node tools/build &ndash;debug &ndash;main &ndash;zalgo &ndash;browser &ndash;minify</p>

<h4 id="supported-options-by-the-build-tool">Supported options by the build tool</h4>

<p>The value of boolean flags is determined by presence, if you want to pass false value for a boolean flag, use the <code class="prettyprint">no-</code>-prefix e.g. <code class="prettyprint">--no-debug</code>.</p>

<ul>
<li><code class="prettyprint">--main</code> - Whether to build the main build. The main build is placed at <code class="prettyprint">js/main</code> directory. Default <code class="prettyprint">false</code>.</li>
<li><code class="prettyprint">--debug</code> - Whether to build the debug build. The debug build is placed at <code class="prettyprint">js/debug</code> directory. Default <code class="prettyprint">false</code>.</li>
<li><code class="prettyprint">--zalgo</code> - Whether to build the zalgo build. The zalgo build is placed at <code class="prettyprint">js/zalgo</code> directory. Default <code class="prettyprint">false</code>.</li>
<li><code class="prettyprint">--browser</code> - Whether to compile the browser build. The browser build file is placed at <code class="prettyprint">js/browser/bluebird.js</code> Default <code class="prettyprint">false</code>.</li>
<li><code class="prettyprint">--minify</code> - Whether to minify the compiled browser build. The minified browser build file is placed at <code class="prettyprint">js/browser/bluebird.min.js</code> Default <code class="prettyprint">true</code>.</li>
<li><code class="prettyprint">--features=String</code> - See <a href="#custom-builds">custom builds</a></li>
</ul>

<p><hr></p>

<h2 id="for-library-authors">For library authors</h2>

<p>Building a library that depends on bluebird? You should know about a few features.</p>

<p>If your library needs to do something obtrusive like adding or modifying methods on the <code class="prettyprint">Promise</code> prototype, uses long stack traces or uses a custom unhandled rejection handler then&hellip; that&rsquo;s totally ok as long as you don&rsquo;t use <code class="prettyprint">require(&quot;bluebird&quot;)</code>. Instead you should create a file
that creates an isolated copy. For example, creating a file called <code class="prettyprint">bluebird-extended.js</code> that contains:</p>
<pre class="highlight javascript"><code>                <span class="c1">//NOTE the function call right after</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"bluebird/js/main/promise"</span><span class="p">)();</span>
</code></pre>

<p>Your library can then use <code class="prettyprint">var Promise = require(&quot;bluebird-extended&quot;);</code> and do whatever it wants with it. Then if the application or other library uses their own bluebird promises they will all play well together because of Promises/A+ thenable assimilation magic.</p>

<p>You should also know about <a href="API.md#nodeifyfunction-callback---promise"><code class="prettyprint">.nodeify()</code></a> which makes it easy to provide a dual callback/promise API.</p>

<p><hr></p>

<h2 id="what-is-the-sync-build">What is the sync build?</h2>

<p>You may now use sync build by:</p>

<p>var Promise = require(&ldquo;bluebird/zalgo&rdquo;);</p>

<p>The sync build is provided to see how forced asynchronity affects benchmarks. It should not be used in real code due to the implied hazards.</p>

<p>The normal async build gives Promises/A+ guarantees about asynchronous resolution of promises. Some people think this affects performance or just plain love their code having a possibility
of stack overflow errors and non-deterministic behavior.</p>

<p>The sync build skips the async call trampoline completely, e.g code like:</p>

<p>async.invoke( this.fn, this, val );</p>

<p>Appears as this in the sync build:</p>

<p>this.fn(val);</p>

<p>This should pressure the CPU slightly less and thus the sync build should perform better. Indeed it does, but only marginally. The biggest performance boosts are from writing efficient Javascript, not from compromising determinism.</p>

<p>Note that while some benchmarks are waiting for the next event tick, the CPU is actually not in use during that time. So the resulting benchmark result is not completely accurate because on node.js you only care about how much the CPU is taxed. Any time spent on CPU is time the whole process (or server) is paralyzed. And it is not graceful like it would be with threads.</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span> <span class="c1">//ES6 Map or DataStructures/Map or whatever...</span>
<span class="kd">function</span> <span class="nx">getResult</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">resolver</span> <span class="o">=</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">pending</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">resolver</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
                <span class="nx">resolver</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>



<span class="c1">//The result of console.log is truly random without async guarantees</span>
<span class="kd">function</span> <span class="nx">guessWhatItPrints</span><span class="p">(</span> <span class="nx">url</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="nx">getResult</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<h1 id="optimization-guide">Optimization guide</h1>

<p>Articles about optimization will be periodically posted in <a href="https://github.com/petkaantonov/bluebird/wiki">the wiki section</a>, polishing edits are welcome.</p>

<p>A single cohesive guide compiled from the articles will probably be done eventually.</p>

<h1 id="license">License</h1>

<p>The MIT License (MIT)</p>

<p>Copyright &copy; 2014 Petka Antonov</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &ldquo;Software&rdquo;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED &ldquo;AS IS&rdquo;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>
