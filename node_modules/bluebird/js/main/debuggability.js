"use strict";module.exports=function(e,t){var n,i,o=e._getDomain,s=require("./async.js"),r=require("./errors.js").Warning,a=require("./util.js"),d=a.canAttachTrace,c=a.isNode&&(!!process.env.BLUEBIRD_DEBUG||"development"===process.env.NODE_ENV);return a.isNode&&0==process.env.BLUEBIRD_DEBUG&&(c=!1),c&&s.disableTrampolineIfNecessary(),e.prototype._ignoreRejections=function(){this._unsetRejectionIsUnhandled(),this._bitField=16777216|this._bitField},e.prototype._ensurePossibleRejectionHandled=function(){0===(16777216&this._bitField)&&(this._setRejectionIsUnhandled(),s.invokeLater(this._notifyUnhandledRejection,this,void 0))},e.prototype._notifyUnhandledRejectionIsHandled=function(){t.fireRejectionEvent("rejectionHandled",n,void 0,this)},e.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var e=this._getCarriedStackTrace()||this._settledValue;this._setUnhandledRejectionIsNotified(),t.fireRejectionEvent("unhandledRejection",i,e,this)}},e.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=524288|this._bitField},e.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=-524289&this._bitField},e.prototype._isUnhandledRejectionNotified=function(){return(524288&this._bitField)>0},e.prototype._setRejectionIsUnhandled=function(){this._bitField=2097152|this._bitField},e.prototype._unsetRejectionIsUnhandled=function(){this._bitField=-2097153&this._bitField,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},e.prototype._isRejectionUnhandled=function(){return(2097152&this._bitField)>0},e.prototype._setCarriedStackTrace=function(e){this._bitField=1048576|this._bitField,this._fulfillmentHandler0=e},e.prototype._isCarryingStackTrace=function(){return(1048576&this._bitField)>0},e.prototype._getCarriedStackTrace=function(){return this._isCarryingStackTrace()?this._fulfillmentHandler0:void 0},e.prototype._captureStackTrace=function(){return c&&(this._trace=new t(this._peekContext())),this},e.prototype._attachExtraTrace=function(e,n){if(c&&d(e)){var i=this._trace;if(void 0!==i&&n&&(i=i._parent),void 0!==i)i.attachExtraTrace(e);else if(!e.__stackCleaned__){var o=t.parseStackAndMessage(e);a.notEnumerableProp(e,"stack",o.message+"\n"+o.stack.join("\n")),a.notEnumerableProp(e,"__stackCleaned__",!0)}}},e.prototype._warn=function(e){var n=new r(e),i=this._peekContext();if(i)i.attachExtraTrace(n);else{var o=t.parseStackAndMessage(n);n.stack=o.message+"\n"+o.stack.join("\n")}t.formatAndLogError(n,"")},e.onPossiblyUnhandledRejection=function(e){var t=o();i="function"==typeof e?null===t?e:t.bind(e):void 0},e.onUnhandledRejectionHandled=function(e){var t=o();n="function"==typeof e?null===t?e:t.bind(e):void 0},e.longStackTraces=function(){if(s.haveItemsQueued()&&c===!1)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/DT1qyG\n");c=t.isSupported(),c&&s.disableTrampolineIfNecessary()},e.hasLongStackTraces=function(){return c&&t.isSupported()},t.isSupported()||(e.longStackTraces=function(){},c=!1),function(){return c}};