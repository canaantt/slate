"use strict";module.exports=function(){function t(e){this._parent=e;var r=this._length=1+(void 0===e?0:e._length);y(this,t),r>32&&this.uncycle()}function e(t,e){for(var r=0;r<e.length-1;++r)e[r].push("From previous event:"),e[r]=e[r].join("\n");return r<e.length&&(e[r]=e[r].join("\n")),t+"\n"+e.join("\n")}function r(t){for(var e=0;e<t.length;++e)(0===t[e].length||e+1<t.length&&t[e][0]===t[e+1][0])&&(t.splice(e,1),e--)}function n(t){for(var e=t[0],r=1;r<t.length;++r){for(var n=t[r],o=e.length-1,a=e[o],i=-1,c=n.length-1;c>=0;--c)if(n[c]===a){i=c;break}for(var c=i;c>=0;--c){var s=n[c];if(e[o]!==s)break;e.pop(),o--}e=n}}function o(t){for(var e=[],r=0;r<t.length;++r){var n=t[r],o=p.test(n)||"    (No stack trace)"===n,a=o&&g(n);o&&!a&&(h&&" "!==n.charAt(0)&&(n="    "+n),e.push(n))}return e}function a(t){for(var e=t.stack.replace(/\s+$/g,"").split("\n"),r=0;r<e.length;++r){var n=e[r];if("    (No stack trace)"===n||p.test(n))break}return r>0&&(e=e.slice(r)),e}function i(t){var e;if("function"==typeof t)e="[function "+(t.name||"anonymous")+"]";else{e=t.toString();var r=/\[object [a-zA-Z0-9$_]+\]/;if(r.test(e))try{var n=JSON.stringify(t);e=n}catch(o){}0===e.length&&(e="(empty array)")}return"(<"+c(e)+">, no stack trace)"}function c(t){var e=41;return t.length<e?t:t.substr(0,e-3)+"..."}function s(t){var e=t.match(m);return e?{fileName:e[1],line:parseInt(e[2],10)}:void 0}var f,u=require("./async.js"),l=require("./util.js"),v=/[\\\/]bluebird[\\\/]js[\\\/](main|debug|zalgo|instrumented)/,p=null,d=null,h=!1;l.inherits(t,Error),t.prototype.uncycle=function(){var t=this._length;if(!(2>t)){for(var e=[],r={},n=0,o=this;void 0!==o;++n)e.push(o),o=o._parent;t=this._length=n;for(var n=t-1;n>=0;--n){var a=e[n].stack;void 0===r[a]&&(r[a]=n)}for(var n=0;t>n;++n){var i=e[n].stack,c=r[i];if(void 0!==c&&c!==n){c>0&&(e[c-1]._parent=void 0,e[c-1]._length=1),e[n]._parent=void 0,e[n]._length=1;var s=n>0?e[n-1]:this;t-1>c?(s._parent=e[c+1],s._parent.uncycle(),s._length=s._parent._length+1):(s._parent=void 0,s._length=1);for(var f=s._length+1,u=n-2;u>=0;--u)e[u]._length=f,f++;return}}}},t.prototype.parent=function(){return this._parent},t.prototype.hasParent=function(){return void 0!==this._parent},t.prototype.attachExtraTrace=function(a){if(!a.__stackCleaned__){this.uncycle();for(var i=t.parseStackAndMessage(a),c=i.message,s=[i.stack],f=this;void 0!==f;)s.push(o(f.stack.split("\n"))),f=f._parent;n(s),r(s),l.notEnumerableProp(a,"stack",e(c,s)),l.notEnumerableProp(a,"__stackCleaned__",!0)}},t.parseStackAndMessage=function(t){var e=t.stack,r=t.toString();return e="string"==typeof e&&e.length>0?a(t):["    (No stack trace)"],{message:r,stack:o(e)}},t.formatAndLogError=function(t,e){if("undefined"!=typeof console){var r;if("object"==typeof t||"function"==typeof t){var n=t.stack;r=e+d(n,t)}else r=e+String(t);"function"==typeof f?f(r):("function"==typeof console.log||"object"==typeof console.log)&&console.log(r)}},t.unhandledRejection=function(e){t.formatAndLogError(e,"^--- With additional stack trace: ")},t.isSupported=function(){return"function"==typeof y},t.fireRejectionEvent=function(e,r,n,o){var a=!1;try{"function"==typeof r&&(a=!0,"rejectionHandled"===e?r(o):r(n,o))}catch(i){u.throwLater(i)}var c=!1;try{c=E(e,n,o)}catch(i){c=!0,u.throwLater(i)}var s=!1;if(k)try{s=k(e.toLowerCase(),{reason:n,promise:o})}catch(i){s=!0,u.throwLater(i)}c||a||s||"unhandledRejection"!==e||t.formatAndLogError(n,"Unhandled rejection ")};var g=function(){return!1},m=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;t.setBounds=function(e,r){if(t.isSupported()){for(var n,o,a=e.stack.split("\n"),i=r.stack.split("\n"),c=-1,f=-1,u=0;u<a.length;++u){var l=s(a[u]);if(l){n=l.fileName,c=l.line;break}}for(var u=0;u<i.length;++u){var l=s(i[u]);if(l){o=l.fileName,f=l.line;break}}0>c||0>f||!n||!o||n!==o||c>=f||(g=function(t){if(v.test(t))return!0;var e=s(t);return e&&e.fileName===n&&c<=e.line&&e.line<=f?!0:!1})}};var k,y=function(){var t=/^\s*at\s*/,e=function(t,e){return"string"==typeof t?t:void 0!==e.name&&void 0!==e.message?e.toString():i(e)};if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){Error.stackTraceLimit=Error.stackTraceLimit+6,p=t,d=e;var r=Error.captureStackTrace;return g=function(t){return v.test(t)},function(t,e){Error.stackTraceLimit=Error.stackTraceLimit+6,r(t,e),Error.stackTraceLimit=Error.stackTraceLimit-6}}var n=new Error;if("string"==typeof n.stack&&n.stack.split("\n")[0].indexOf("stackDetection@")>=0)return p=/@/,d=e,h=!0,function(t){t.stack=(new Error).stack};var o;try{throw new Error}catch(a){o="stack"in a}return"stack"in n||!o||"number"!=typeof Error.stackTraceLimit?(d=function(t,e){return"string"==typeof t?t:"object"!=typeof e&&"function"!=typeof e||void 0===e.name||void 0===e.message?i(e):e.toString()},null):(p=t,d=e,function(t){Error.stackTraceLimit=Error.stackTraceLimit+6;try{throw new Error}catch(e){t.stack=e.stack}Error.stackTraceLimit=Error.stackTraceLimit-6})}([]),E=function(){if(l.isNode)return function(t,e,r){return"rejectionHandled"===t?process.emit(t,r):process.emit(t,e,r)};var t=!1,e=!0;try{var r=new self.CustomEvent("test");t=r instanceof CustomEvent}catch(n){}if(!t)try{var o=document.createEvent("CustomEvent");o.initCustomEvent("testingtheevent",!1,!0,{}),self.dispatchEvent(o)}catch(n){e=!1}e&&(k=function(e,r){var n;return t?n=new self.CustomEvent(e,{detail:r,bubbles:!1,cancelable:!0}):self.dispatchEvent&&(n=document.createEvent("CustomEvent"),n.initCustomEvent(e,!1,!0,r)),n?!self.dispatchEvent(n):!1});var a={};return a.unhandledRejection="onunhandledRejection".toLowerCase(),a.rejectionHandled="onrejectionHandled".toLowerCase(),function(t,e,r){var n=a[t],o=self[n];return o?("rejectionHandled"===t?o.call(self,r):o.call(self,e,r),!0):!1}}();return"undefined"!=typeof console&&"undefined"!=typeof console.warn&&(f=function(t){console.warn(t)},l.isNode&&process.stderr.isTTY?f=function(t){process.stderr.write("[31m"+t+"[39m\n")}:l.isNode||"string"!=typeof(new Error).stack||(f=function(t){console.warn("%c"+t,"color: red")})),t};