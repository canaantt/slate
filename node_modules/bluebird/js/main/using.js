"use strict";module.exports=function(t,e,i,r){function s(e){for(var i=e.length,r=0;i>r;++r){var s=e[r];if(s.isRejected())return t.reject(s.error());e[r]=s._settledValue}return e}function n(t){setTimeout(function(){throw t},0)}function o(t){var e=i(t);return e!==t&&"function"==typeof t._isDisposable&&"function"==typeof t._getDisposer&&t._isDisposable()&&e._setDisposable(t._getDisposer()),e}function u(e,r){function s(){if(u>=p)return l.resolve();var a=o(e[u++]);if(a instanceof t&&a._isDisposable()){try{a=i(a._getDisposer().tryDispose(r),e.promise)}catch(f){return n(f)}if(a instanceof t)return a._then(s,n,null,null,null)}s()}var u=0,p=e.length,l=t.defer();return s(),l.promise}function p(t){var e=new d;return e._settledValue=t,e._bitField=268435456,u(this,e).thenReturn(t)}function l(t){var e=new d;return e._settledValue=t,e._bitField=134217728,u(this,e).thenThrow(t)}function a(t,e,i){this._data=t,this._promise=e,this._context=i}function f(t,e,i){this.constructor$(t,e,i)}function c(t){return a.isDisposer(t)?(this.resources[this.index]._setDisposable(t),t.promise()):t}var h=require("./errors.js").TypeError,_=require("./util.js").inherits,d=t.PromiseInspection;a.prototype.data=function(){return this._data},a.prototype.promise=function(){return this._promise},a.prototype.resource=function(){return this.promise().isFulfilled()?this.promise().value():null},a.prototype.tryDispose=function(t){var e=this.resource(),i=this._context;void 0!==i&&i._pushContext();var r=null!==e?this.doDispose(e,t):null;return void 0!==i&&i._popContext(),this._promise._unsetDisposable(),this._data=null,r},a.isDisposer=function(t){return null!=t&&"function"==typeof t.resource&&"function"==typeof t.tryDispose},_(f,a),f.prototype.doDispose=function(t,e){var i=this.data();return i.call(t,t,e)},t.using=function(){var r=arguments.length;if(2>r)return e("you must pass at least 2 arguments to Promise.using");var n=arguments[r-1];if("function"!=typeof n)return e("fn must be a function\n\n    See http://goo.gl/916lJJ\n");var o,u=!0;2===r&&Array.isArray(arguments[0])?(o=arguments[0],r=o.length,u=!1):(o=arguments,r--);for(var f=new Array(r),h=0;r>h;++h){var _=o[h];if(a.isDisposer(_)){var d=_;_=_.promise(),_._setDisposable(d)}else{var v=i(_);v instanceof t&&(_=v._then(c,null,null,{resources:f,index:h},void 0))}f[h]=_}var y=t.settle(f).then(s).then(function(t){y._pushContext();var e;try{e=u?n.apply(void 0,t):n.call(void 0,t)}finally{y._popContext()}return e})._then(p,l,void 0,f,void 0);return f.promise=y,y},t.prototype._setDisposable=function(t){this._bitField=262144|this._bitField,this._disposer=t},t.prototype._isDisposable=function(){return(262144&this._bitField)>0},t.prototype._getDisposer=function(){return this._disposer},t.prototype._unsetDisposable=function(){this._bitField=-262145&this._bitField,this._disposer=void 0},t.prototype.disposer=function(t){if("function"==typeof t)return new f(t,this,r());throw new h}};