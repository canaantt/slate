"use strict";module.exports=function(t,i,e,r,n){function s(t,i,e,r){this.constructor$(t),this._promise._captureStackTrace();var s=l();this._callback=null===s?i:s.bind(i),this._preservedValues=r===n?new Array(this.length()):null,this._limit=e,this._inFlight=0,this._queue=e>=1?[]:c,h.invoke(o,this,void 0)}function o(){this._init$(void 0,-2)}function u(t,i,e,r){var n="object"==typeof e&&null!==e?e.concurrency:0;return n="number"==typeof n&&isFinite(n)&&n>=1?n:0,new s(t,i,n,r)}var l=t._getDomain,h=require("./async.js"),_=require("./util.js"),a=_.tryCatch,p=_.errorObj,f={},c=[];_.inherits(s,i),s.prototype._init=function(){},s.prototype._promiseFulfilled=function(i,e){var n=this._values,s=this.length(),o=this._preservedValues,u=this._limit;if(n[e]===f){if(n[e]=i,u>=1&&(this._inFlight--,this._drainQueue(),this._isResolved()))return}else{if(u>=1&&this._inFlight>=u)return n[e]=i,void this._queue.push(e);null!==o&&(o[e]=i);var l=this._callback,h=this._promise._boundValue();this._promise._pushContext();var _=a(l).call(h,i,e,s);if(this._promise._popContext(),_===p)return this._reject(_.e);var c=r(_,this._promise);if(c instanceof t){if(c=c._target(),c._isPending())return u>=1&&this._inFlight++,n[e]=f,c._proxyPromiseArray(this,e);if(!c._isFulfilled())return this._reject(c._reason());_=c._value()}n[e]=_}var v=++this._totalResolved;v>=s&&(null!==o?this._filter(n,o):this._resolve(n))},s.prototype._drainQueue=function(){for(var t=this._queue,i=this._limit,e=this._values;t.length>0&&this._inFlight<i;){if(this._isResolved())return;var r=t.pop();this._promiseFulfilled(e[r],r)}},s.prototype._filter=function(t,i){for(var e=i.length,r=new Array(e),n=0,s=0;e>s;++s)t[s]&&(r[n++]=i[s]);r.length=n,this._resolve(r)},s.prototype.preservedValues=function(){return this._preservedValues},t.prototype.map=function(t,i){return"function"!=typeof t?e("fn must be a function\n\n    See http://goo.gl/916lJJ\n"):u(this,t,i,null).promise()},t.map=function(t,i,r,n){return"function"!=typeof i?e("fn must be a function\n\n    See http://goo.gl/916lJJ\n"):u(t,i,r,n).promise()}};