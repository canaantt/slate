"use strict";module.exports=function(r,e){function n(r){return!k.test(r)}function t(r){try{return r.__isPromisified__===!0}catch(e){return!1}}function a(r,e,n){var a=p.getDataPropertyOrDefault(r,e+n,y);return a?t(a):!1}function o(r,e,n){for(var t=0;t<r.length;t+=2){var a=r[t];if(n.test(a))for(var o=a.replace(n,""),i=0;i<r.length;i+=2)if(r[i]===o)throw new b("Cannot promisify an API that has normal methods with '%s'-suffix\n\n    See http://goo.gl/iWrZbw\n".replace("%s",e))}}function i(r,e,n,i){for(var c=p.inheritedDataKeys(r),s=[],u=0;u<c.length;++u){var f=c[u],l=r[f],h=i===w?!0:w(f,l,r);"function"!=typeof l||t(l)||a(r,f,e)||!i(f,l,r,h)||s.push(f,l)}return o(s,e,n),s}function c(n,t,a,o){function i(){var a=t;t===l&&(a=this);var o=new r(e);o._captureStackTrace();var i="string"==typeof s&&this!==c?this[s]:n,u=h(o);try{i.apply(a,m(arguments,u))}catch(f){o._rejectCallback(g(f),!0,!0)}return o}var c=function(){return this}(),s=n;return"string"==typeof s&&(n=o),p.notEnumerableProp(i,"__isPromisified__",!0),i}function s(r,e,n,t){for(var a=new RegExp(P(e)+"$"),o=i(r,e,a,n),c=0,s=o.length;s>c;c+=2){var u=o[c],f=o[c+1],h=u+e;if(t===F)r[h]=F(u,l,u,f,e);else{var m=t(f,function(){return F(u,l,u,f,e)});p.notEnumerableProp(m,"__isPromisified__",!0),r[h]=m}}return p.toFastProperties(r),r}function u(r,e){return F(r,e,void 0,r)}var f,l={},p=require("./util.js"),h=require("./promise_resolver.js")._nodebackForPromise,m=p.withAppended,g=p.maybeWrapAsError,v=p.canEvaluate,b=require("./errors").TypeError,d="Async",y={__isPromisified__:!0},_=["arity","length","name","arguments","caller","callee","prototype","__isPromisified__"],k=new RegExp("^(?:"+_.join("|")+")$"),w=function(r){return p.isIdentifier(r)&&"_"!==r.charAt(0)&&"constructor"!==r},P=function(r){return r.replace(/([$])/,"\\$")},C=function(r){for(var e=[r],n=Math.max(0,r-1-3),t=r-1;t>=n;--t)e.push(t);for(var t=r+1;3>=t;++t)e.push(t);return e},E=function(r){return p.filledRange(r,"_arg","")},A=function(r){return p.filledRange(Math.max(r,3),"_arg","")},j=function(r){return"number"==typeof r.length?Math.max(Math.min(r.length,1024),0):0};f=function(n,t,a,o){function i(r){var e,n=E(r).join(", "),a=r>0?", ":"";return e=f?"ret = callback.call(this, {{args}}, nodeback); break;\n":void 0===t?"ret = callback({{args}}, nodeback); break;\n":"ret = callback.call(receiver, {{args}}, nodeback); break;\n",e.replace("{{args}}",n).replace(", ",a)}function c(){for(var r="",e=0;e<u.length;++e)r+="case "+u[e]+":"+i(u[e]);return r+="                                                             \n        default:                                                             \n            var args = new Array(len + 1);                                   \n            var i = 0;                                                       \n            for (var i = 0; i < len; ++i) {                                  \n               args[i] = arguments[i];                                       \n            }                                                                \n            args[i] = nodeback;                                              \n            [CodeForCall]                                                    \n            break;                                                           \n        ".replace("[CodeForCall]",f?"ret = callback.apply(this, args);\n":"ret = callback.apply(receiver, args);\n")}var s=Math.max(0,j(o)-1),u=C(s),f="string"==typeof n||t===l,v="string"==typeof n?"this != null ? this['"+n+"'] : fn":"fn";return new Function("Promise","fn","receiver","withAppended","maybeWrapAsError","nodebackForPromise","tryCatch","errorObj","notEnumerableProp","INTERNAL","'use strict';                            \n        var ret = function (Parameters) {                                    \n            'use strict';                                                    \n            var len = arguments.length;                                      \n            var promise = new Promise(INTERNAL);                             \n            promise._captureStackTrace();                                    \n            var nodeback = nodebackForPromise(promise);                      \n            var ret;                                                         \n            var callback = tryCatch([GetFunctionCode]);                      \n            switch(len) {                                                    \n                [CodeForSwitchCase]                                          \n            }                                                                \n            if (ret === errorObj) {                                          \n                promise._rejectCallback(maybeWrapAsError(ret.e), true, true);\n            }                                                                \n            return promise;                                                  \n        };                                                                   \n        notEnumerableProp(ret, '__isPromisified__', true);                   \n        return ret;                                                          \n        ".replace("Parameters",A(s)).replace("[CodeForSwitchCase]",c()).replace("[GetFunctionCode]",v))(r,o,t,m,g,h,p.tryCatch,p.errorObj,p.notEnumerableProp,e)};var F=v?f:c;r.promisify=function(r,e){if("function"!=typeof r)throw new b("fn must be a function\n\n    See http://goo.gl/916lJJ\n");if(t(r))return r;var a=u(r,arguments.length<2?l:e);return p.copyDescriptors(r,a,n),a},r.promisifyAll=function(r,e){if("function"!=typeof r&&"object"!=typeof r)throw new b("the target of promisifyAll must be an object or a function\n\n    See http://goo.gl/9ITlV0\n");e=Object(e);var n=e.suffix;"string"!=typeof n&&(n=d);var t=e.filter;"function"!=typeof t&&(t=w);var a=e.promisifier;if("function"!=typeof a&&(a=F),!p.isIdentifier(n))throw new RangeError("suffix must be a valid identifier\n\n    See http://goo.gl/8FZo5V\n");for(var o=p.inheritedDataKeys(r),i=0;i<o.length;++i){var c=r[o[i]];"constructor"!==o[i]&&p.isClass(c)&&(s(c.prototype,n,t,a),s(c,n,t,a))}return s(r,n,t,a)}};