var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,AggregationCursor=require("./aggregation_cursor"),CommandCursor=require("./command_cursor"),OrderedBulkOperation=require("./bulk/ordered").OrderedBulkOperation,UnorderedBulkOperation=require("./bulk/unordered").UnorderedBulkOperation,GridStore=require("./gridfs/grid_store"),Server=require("./server"),ReplSet=require("./replset"),Mongos=require("./mongos"),Cursor=require("./cursor"),Collection=require("./collection"),Db=require("./db"),Admin=require("./admin"),basicOperationIdGenerator={operationId:1,next:function(){return this.operationId++}},basicTimestampGenerator={current:function(){return(new Date).getTime()},duration:function(e,r){return r-e}},senstiveCommands=["authenticate","saslStart","saslContinue","getnonce","createUser","updateUser","copydbgetnonce","copydbsaslstart","copydb"],Instrumentation=function(e,r,t){r=r||{};var o=r.operationIdGenerator||basicOperationIdGenerator,n=r.timestampGenerator||basicTimestampGenerator;EventEmitter.call(this),this.overloads=[];var i=function(e){for(var r=[],t=[GridStore,OrderedBulkOperation,UnorderedBulkOperation,CommandCursor,AggregationCursor,Cursor,Collection,Db],o=0;o<t.length;o++)t[o].define&&r.push(t[o].define.generate());e(null,r)};"function"==typeof t&&i(t);var a=this,s=["command","insert","update","remove"],u=e.Server.prototype;s.forEach(function(r){var t=u[r];a.overloads.push({proto:u,name:r,func:t}),u[r]=function(){var i=e.Query.nextRequestId(),s=Array.prototype.slice.call(arguments,0),u=s[0],c=s[1],d=s[2]||{},l=Object.keys(c),m=l[0],p=u.split(".")[0];if("insert"==r){m="insert";var f=u.split(".");f.shift(),f=f.join("."),c={insert:f,documents:c},d.writeConcern&&Object.keys(d.writeConcern).length>0&&(c.writeConcern=d.writeConcern),c.ordered=void 0!=d.ordered?d.ordered:!0}else if("update"==r){m="update";var f=u.split(".");f.shift(),f=f.join("."),c={update:f,updates:c},d.writeConcern&&Object.keys(d.writeConcern).length>0&&(c.writeConcern=d.writeConcern),c.ordered=void 0!=d.ordered?d.ordered:!0}else if("remove"==r){m="delete";var f=u.split(".");f.shift(),f=f.join("."),c={"delete":f,deletes:c},d.writeConcern&&Object.keys(d.writeConcern).length>0&&(c.writeConcern=d.writeConcern),c.ordered=void 0!=d.ordered?d.ordered:!0}var h=s.pop(),v=h.operationId||o.next(),C=this.s.pool.get(),y={command:c,databaseName:p,commandName:m,requestId:i,operationId:v,connectionId:C};senstiveCommands.indexOf(m.toLowerCase())&&(y.commandObj={},y.commandObj[m]=!0),a.emit("started",y);var I=n.current();s.push(function(e,r){var t=n.current(),o={duration:n.duration(I,t),commandName:m,requestId:i,operationId:v,connectionId:C};e||r&&r.result&&0==r.result.ok?(o.failure=e||r.result.writeErrors||r.result,senstiveCommands.indexOf(m.toLowerCase())&&(o.failure={}),a.emit("failed",o)):c&&c.writeConcern&&0==c.writeConcern.w?(o.reply={ok:1},a.emit("succeeded",o)):(o.reply=r&&r.result?r.result:r,-1!=senstiveCommands.indexOf(m.toLowerCase())&&(o.reply={}),a.emit("succeeded",o)),h(e,r)}),t.apply(this,s)}});var s=["execute"],c=[require("./bulk/ordered").Bulk.prototype,require("./bulk/unordered").Bulk.prototype];c.forEach(function(e){s.forEach(function(r){var t=e[r];a.overloads.push({proto:e,name:r,func:t}),e[r]=function(){var e=Array.prototype.slice.call(arguments,0);this.operationId=o.next();var r=e.pop();return"function"!=typeof r?t.apply(this,e):(e.push(function(e,t){r(e,t)}),void t.apply(this,e))}})});var s=["_find","_getmore","_killcursor"],c=[require("./cursor").prototype,require("./command_cursor").prototype,require("./aggregation_cursor").prototype],d={_find:"find",_getmore:"getMore",_killcursor:"killCursors",_explain:"explain"};c.forEach(function(r){s.forEach(function(t){var i=r[t];a.overloads.push({proto:r,name:t,func:i}),r[t]=function(){var r=this,s=e.Query.nextRequestId(),u=o.next(),c=this.ns.split("."),l=c[0];c.shift();var m=c.join("."),p=this.query,f=this.s.cmd;"_find"==t&&(r.operationId=u),"_getmore"==t?(p={getMore:this.cursorState.cursorId,collection:m,batchSize:f.batchSize},f.maxTimeMS&&(p.maxTimeMS=f.maxTimeMS)):"_killcursors"==t?p={killCursors:m,cursors:[this.cursorState.cursorId]}:f.find?(p={find:m,filter:f.query},f.sort&&(p.sort=f.sort),f.fields&&(p.projection=f.fields),f.limit&&f.limit<0?(p.limit=Math.abs(f.limit),p.singleBatch=!0):f.limit&&(p.limit=Math.abs(f.limit)),f.skip&&(p.skip=f.skip),f.hint&&(p.hint=f.hint),f.batchSize&&(p.batchSize=f.batchSize),"boolean"==typeof f.returnKey&&(p.returnKey=f.returnKey),f.comment&&(p.comment=f.comment),f.min&&(p.min=f.min),f.max&&(p.max=f.max),f.maxScan&&(p.maxScan=f.maxScan),f.maxTimeMS&&(p.maxTimeMS=f.maxTimeMS),"boolean"==typeof f.awaitData&&(p.awaitData=f.awaitData),"boolean"==typeof f.snapshot&&(p.snapshot=f.snapshot),"boolean"==typeof f.tailable&&(p.tailable=f.tailable),"boolean"==typeof f.oplogReplay&&(p.oplogReplay=f.oplogReplay),"boolean"==typeof f.noCursorTimeout&&(p.noCursorTimeout=f.noCursorTimeout),"boolean"==typeof f.partial&&(p.partial=f.partial),"boolean"==typeof f.showDiskLoc&&(p.showRecordId=f.showDiskLoc),f.readConcern&&(p.readConcern=f.readConcern),f.explain&&(p.explain=f.explain),f.exhaust&&(p.exhaust=f.exhaust),f.explain&&(p={explain:p,verbosity:"allPlansExecution"},f.readConcern&&(p.readConcern=f.readConcern),t="_explain")):p=f;var h=null;this.connection&&(h=this.connection),!h&&this.server&&this.server.getConnection&&(h=this.server.getConnection());var v="_find"==t?Object.keys(p)[0]:d[t],p={command:p,databaseName:l,commandName:v,requestId:s,operationId:this.operationId,connectionId:h},C=Array.prototype.slice.call(arguments,0),y=C.pop();if("function"!=typeof y&&"killCursors"!=p.commandName){C.push(y);var I=i.apply(this,C);return new r.s.promiseLibrary(function(e,t){var o=n.current();a.emit("started",p),I.then(function(e){var t={duration:n.duration(o,n.current()),commandName:v,requestId:s,operationId:r.operationId,connectionId:r.server.getConnection(),reply:r.cursorState.documents};a.emit("succeeded",t)})["catch"](function(e){var i={duration:n.duration(o,n.current()),commandName:v,requestId:s,operationId:u,connectionId:r.server.getConnection(),failure:e};a.emit("failed",i),t(e)})})}var g=n.current();if(a.emit("started",p),"killCursors"==p.commandName&&this.server.lastIsMaster()&&this.server.lastIsMaster().maxWireVersion<4){var p={duration:n.duration(g,n.current()),commandName:v,requestId:s,operationId:r.operationId,connectionId:r.server.getConnection(),reply:[{ok:1}]};return a.emit("succeeded",p)}C.push(function(e,t){if(e){var o={duration:n.duration(g,n.current()),commandName:v,requestId:s,operationId:u,connectionId:r.server.getConnection(),failure:e};a.emit("failed",o)}else{"getmore"==v.toLowerCase()&&null==t?t={cursor:{id:r.cursorState.cursorId,ns:r.ns,nextBatch:r.cursorState.documents},ok:1}:"find"==v.toLowerCase()&&null==t?t={cursor:{id:r.cursorState.cursorId,ns:r.ns,firstBatch:r.cursorState.documents},ok:1}:"killcursors"==v.toLowerCase()&&null==t&&(t={cursorsUnknown:[r.cursorState.lastCursorId],ok:1});var o={duration:n.duration(g,n.current()),commandName:v,requestId:s,operationId:r.operationId,connectionId:r.server.getConnection(),reply:t&&t.result?t.result:t};a.emit("succeeded",o)}y&&y(e,t)}),i.apply(this,C)}})})};inherits(Instrumentation,EventEmitter),Instrumentation.prototype.uninstrument=function(){for(var e=0;e<this.overloads.length;e++){var r=this.overloads[e];r.proto[r.name]=r.func}this.removeAllListeners("started"),this.removeAllListeners("succeeded"),this.removeAllListeners("failed")},module.exports=Instrumentation;