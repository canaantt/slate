"use strict";var ReadPreference=require("./read_preference"),parser=require("url"),f=require("util").format;module.exports=function(e,r){r=r||{};var t="",a="",s="",n="admin",o=parser.parse(e,!0);if("mongodb:"!=o.protocol)throw new Error("invalid schema, expected mongodb");if((null==o.hostname||""==o.hostname)&&-1==e.indexOf(".sock"))throw new Error("no hostname or hostnames provided in connection string");if("0"==o.port)throw new Error("invalid port (zero) with hostname");if(!isNaN(parseInt(o.port,10))&&parseInt(o.port,10)>65535)throw new Error("invalid port (larger than 65535) with hostname");if(o.path&&o.path.length>0&&"/"!=o.path[0]&&-1==e.indexOf(".sock"))throw new Error("missing delimiting slash between hosts and options");if(o.query)for(var i in o.query){if(-1!=i.indexOf("::"))throw new Error("double colon in host identifier");if(""==o.query[i])throw new Error("query parameter "+i+" is an incomplete value pair")}if(o.auth){var c=o.auth.split(":");if(-1!=e.indexOf(o.auth)&&c.length>2)throw new Error("Username with password containing an unescaped colon");if(-1!=e.indexOf(o.auth)&&-1!=o.auth.indexOf("@"))throw new Error("Username containing an unescaped at-sign")}for(var p=e.split("?").shift(),l=p.split(","),u=[],d=0;d<l.length;d++){var h=l[d];-1!=h.indexOf("mongodb")?-1!=h.indexOf("@")?u.push(h.split("@").pop()):u.push(h.substr("mongodb://".length)):-1!=h.indexOf("/")?u.push(h.split("/").shift()):-1==h.indexOf("/")&&u.push(h.trim())}for(var d=0;d<u.length;d++){var m=parser.parse(f("mongodb://%s",u[d].trim()));if(m.path&&-1!=m.path.indexOf(":"))throw new Error("double colon in host identifier")}if(-1!=e.indexOf("?")?(s=e.substr(e.indexOf("?")+1),t=e.substring("mongodb://".length,e.indexOf("?"))):t=e.substring("mongodb://".length),-1!=t.indexOf("@")&&(a=t.split("@")[0],t=t.split("@")[1]),-1!=t.indexOf(".sock")){if(-1!=t.indexOf(".sock/")){if(n=t.split(".sock/")[1],-1!=n.indexOf("/")){if(2==n.split("/").length&&0==n.split("/")[1].length)throw new Error("Illegal trailing backslash after database name");throw new Error("More than 1 database name in URL")}t=t.split("/",t.indexOf(".sock")+".sock".length)}}else if(-1!=t.indexOf("/")){if(t.split("/").length>2){if(0==t.split("/")[2].length)throw new Error("Illegal trailing backslash after database name");throw new Error("More than 1 database name in URL")}n=t.split("/")[1],t=t.split("/")[0]}var w={},k=a||"",b=k.split(":",2);b[0]=decodeURIComponent(b[0]),b[1]&&(b[1]=decodeURIComponent(b[1])),2==b.length&&(w.auth={user:b[0],password:b[1]});var g,O,S,E={socketOptions:{}},I={read_preference_tags:[]},v={socketOptions:{}},M={socketOptions:{}};if(w.server_options=E,w.db_options=I,w.rs_options=v,w.mongos_options=M,e.match(/\.sock/)){var _=e.substring(e.indexOf("mongodb://")+"mongodb://".length,e.lastIndexOf(".sock")+".sock".length);-1!=_.indexOf("@")&&(_=_.split("@")[1]),S=[{domain_socket:_}]}else{g=t;var x={};S=g.split(",").map(function(e){var r,t,a;if(a=/\[([^\]]+)\](?:\:(.+))?/.exec(e))r=a[1],t=parseInt(a[2],10)||27017;else{var s=e.split(":",2);r=s[0]||"localhost",t=null!=s[1]?parseInt(s[1],10):27017,-1!=r.indexOf("?")&&(r=r.split(/\?/)[0])}return x[r+"_"+t]?null:(x[r+"_"+t]=1,{host:r,port:t})}).filter(function(e){return null!=e})}if(w.dbName=n||"admin",O=(s||"").split(/[&;]/),O.forEach(function(e){if(e){var r=e.split("="),t=r[0],a=r[1];switch(t){case"slaveOk":case"slave_ok":E.slave_ok="true"==a,I.slaveOk="true"==a;break;case"maxPoolSize":case"poolSize":E.poolSize=parseInt(a,10),v.poolSize=parseInt(a,10);break;case"appname":w.appname=decodeURIComponent(a);case"autoReconnect":case"auto_reconnect":E.auto_reconnect="true"==a;break;case"minPoolSize":throw new Error("minPoolSize not supported");case"maxIdleTimeMS":throw new Error("maxIdleTimeMS not supported");case"waitQueueMultiple":throw new Error("waitQueueMultiple not supported");case"waitQueueTimeoutMS":throw new Error("waitQueueTimeoutMS not supported");case"uuidRepresentation":throw new Error("uuidRepresentation not supported");case"ssl":if("prefer"==a){E.ssl=a,v.ssl=a,M.ssl=a;break}E.ssl="true"==a,v.ssl="true"==a,M.ssl="true"==a;break;case"sslValidate":E.sslValidate="true"==a,v.sslValidate="true"==a,M.sslValidate="true"==a;break;case"replicaSet":case"rs_name":v.rs_name=a;break;case"reconnectWait":v.reconnectWait=parseInt(a,10);break;case"retries":v.retries=parseInt(a,10);break;case"readSecondary":case"read_secondary":v.read_secondary="true"==a;break;case"fsync":I.fsync="true"==a;break;case"journal":I.j="true"==a;break;case"safe":I.safe="true"==a;break;case"nativeParser":case"native_parser":I.native_parser="true"==a;break;case"readConcernLevel":I.readConcern={level:a};break;case"connectTimeoutMS":E.socketOptions.connectTimeoutMS=parseInt(a,10),v.socketOptions.connectTimeoutMS=parseInt(a,10),M.socketOptions.connectTimeoutMS=parseInt(a,10);break;case"socketTimeoutMS":E.socketOptions.socketTimeoutMS=parseInt(a,10),v.socketOptions.socketTimeoutMS=parseInt(a,10),M.socketOptions.socketTimeoutMS=parseInt(a,10);break;case"w":I.w=parseInt(a,10),isNaN(I.w)&&(I.w=a);break;case"authSource":I.authSource=a;break;case"gssapiServiceName":I.gssapiServiceName=a;break;case"authMechanism":if("GSSAPI"==a)if(null==w.auth){var s=decodeURIComponent(k);if(-1==s.indexOf("@"))throw new Error("GSSAPI requires a provided principal");w.auth={user:s,password:null}}else w.auth.user=decodeURIComponent(w.auth.user);else"MONGODB-X509"==a&&(w.auth={user:decodeURIComponent(k)});if("GSSAPI"!=a&&"MONGODB-X509"!=a&&"MONGODB-CR"!=a&&"DEFAULT"!=a&&"SCRAM-SHA-1"!=a&&"PLAIN"!=a)throw new Error("only DEFAULT, GSSAPI, PLAIN, MONGODB-X509, SCRAM-SHA-1 or MONGODB-CR is supported by authMechanism");I.authMechanism=a;break;case"authMechanismProperties":var n=a.split(","),o={};n.forEach(function(e){var r=e.split(":");o[r[0]]=r[1]}),I.authMechanismProperties=o,"string"==typeof o.SERVICE_NAME&&(I.gssapiServiceName=o.SERVICE_NAME),"string"==typeof o.SERVICE_REALM&&(I.gssapiServiceRealm=o.SERVICE_REALM),"string"==typeof o.CANONICALIZE_HOST_NAME&&(I.gssapiCanonicalizeHostName="true"==o.CANONICALIZE_HOST_NAME?!0:!1);break;case"wtimeoutMS":I.wtimeout=parseInt(a,10);break;case"readPreference":if(!ReadPreference.isValid(a))throw new Error("readPreference must be either primary/primaryPreferred/secondary/secondaryPreferred/nearest");I.readPreference=a;break;case"maxStalenessMS":I.maxStalenessMS=parseInt(a,10);break;case"readPreferenceTags":a=decodeURIComponent(a);var i={};if(null==a||""==a){I.read_preference_tags.push(i);break}for(var c=a.split(/\,/),p=0;p<c.length;p++){var l=c[p].trim().split(/\:/);i[l[0]]=l[1]}I.read_preference_tags.push(i)}}}),0===I.read_preference_tags.length&&(I.read_preference_tags=null),!(-1!=I.w&&0!=I.w||1!=I.journal&&1!=I.fsync&&1!=I.safe))throw new Error("w set to -1 or 0 cannot be combined with safe/w/journal/fsync");return I.readPreference||(I.readPreference="primary"),w.servers=S,w};