"use strict";var inherits=require("util").inherits,f=require("util").format,formattedOrderClause=require("./utils").formattedOrderClause,handleCallback=require("./utils").handleCallback,ReadPreference=require("./read_preference"),MongoError=require("mongodb-core").MongoError,Readable=require("stream").Readable||require("readable-stream").Readable,Define=require("./metadata"),CoreCursor=require("mongodb-core").Cursor,Map=require("mongodb-core").BSON.Map,Query=require("mongodb-core").Query,CoreReadPreference=require("mongodb-core").ReadPreference,flags=["tailable","oplogReplay","noCursorTimeout","awaitData","exhaust","partial"],fields=["numberOfRetries","tailableRetryInterval"],push=Array.prototype.push,Cursor=function(r,e,s,t,o,i){CoreCursor.apply(this,Array.prototype.slice.call(arguments,0));var n=this,a=Cursor.INIT,u={},c=t.numberOfRetries||5,l=t.tailableRetryInterval||500,d=c,h=t.promiseLibrary;h||(h="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),Readable.call(this,{objectMode:!0}),this.s={numberOfRetries:c,tailableRetryInterval:l,currentNumberOfRetries:d,state:a,streamOptions:u,bson:r,ns:e,cmd:s,options:t,topology:o,topologyOptions:i,promiseLibrary:h,currentDoc:null},1==n.s.options.noCursorTimeout&&n.addCursorFlag("noCursorTimeout",!0),this.sortValue=n.s.cmd.sort};inherits(Cursor,Readable),CoreCursor.prototype._next=CoreCursor.prototype.next;for(var name in CoreCursor.prototype)Cursor.prototype[name]=CoreCursor.prototype[name];var define=Cursor.define=new Define("Cursor",Cursor,!0);Cursor.prototype.hasNext=function(r){var e=this;return"function"==typeof r?e.s.currentDoc?r(null,!0):nextObject(e,function(s,t){return t?(e.s.currentDoc=t,void r(null,!0)):r(null,!1)}):new this.s.promiseLibrary(function(r,s){e.s.currentDoc?r(!0):nextObject(e,function(t,o){return e.s.state==Cursor.CLOSED||e.isDead()?r(!1):t?s(t):o?(e.s.currentDoc=o,void r(!0)):r(!1)})})},define.classMethod("hasNext",{callback:!0,promise:!0}),Cursor.prototype.next=function(r){var e=this;if("function"==typeof r){if(e.s.currentDoc){var s=e.s.currentDoc;return e.s.currentDoc=null,r(null,s)}return nextObject(e,r)}return new this.s.promiseLibrary(function(r,s){if(e.s.currentDoc){var t=e.s.currentDoc;return e.s.currentDoc=null,r(t)}nextObject(e,function(e,t){return e?s(e):void r(t)})})},define.classMethod("next",{callback:!0,promise:!0}),Cursor.prototype.filter=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.query=r,this},define.classMethod("filter",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.maxScan=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.maxScan=r,this},define.classMethod("maxScan",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.hint=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.hint=r,this},define.classMethod("hint",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.min=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.min=r,this},define.classMethod("min",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.max=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.max=r,this},define.classMethod("max",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.returnKey=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.returnKey=r,this},define.classMethod("returnKey",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.showRecordId=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.showDiskLoc=r,this},define.classMethod("showRecordId",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.snapshot=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.snapshot=r,this},define.classMethod("snapshot",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.setCursorOption=function(r,e){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});if(-1==fields.indexOf(r))throw MongoError.create({message:f("option %s not a supported option %s",r,fields),driver:!0});return this.s[r]=e,"numberOfRetries"==r&&(this.s.currentNumberOfRetries=e),this},define.classMethod("setCursorOption",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.addCursorFlag=function(r,e){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});if(-1==flags.indexOf(r))throw MongoError.create({message:f("flag %s not a supported flag %s",r,flags),driver:!0});if("boolean"!=typeof e)throw MongoError.create({message:f("flag %s must be a boolean value",r),driver:!0});return this.s.cmd[r]=e,this},define.classMethod("addCursorFlag",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.addQueryModifier=function(r,e){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});if("$"!=r[0])throw MongoError.create({message:f("%s is not a valid query modifier"),driver:!0});var s=r.substr(1);return this.s.cmd[s]=e,"orderby"==s&&(this.s.cmd.sort=this.s.cmd[s]),this},define.classMethod("addQueryModifier",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.comment=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.comment=r,this},define.classMethod("comment",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.maxAwaitTimeMS=function(r){if("number"!=typeof r)throw MongoError.create({message:"maxAwaitTimeMS must be a number",driver:!0});if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.maxAwaitTimeMS=r,this},define.classMethod("maxAwaitTimeMS",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.maxTimeMS=function(r){if("number"!=typeof r)throw MongoError.create({message:"maxTimeMS must be a number",driver:!0});if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.maxTimeMS=r,this},define.classMethod("maxTimeMS",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.maxTimeMs=Cursor.prototype.maxTimeMS,define.classMethod("maxTimeMs",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.project=function(r){if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});return this.s.cmd.fields=r,this},define.classMethod("project",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.sort=function(r,e){if(this.s.options.tailable)throw MongoError.create({message:"Tailable cursor doesn't support sorting",driver:!0});if(this.s.state==Cursor.CLOSED||this.s.state==Cursor.OPEN||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});var s=r;return Array.isArray(s)&&Array.isArray(s[0])&&(s=new Map(s.map(function(r){var e=[r[0],null];if("asc"==r[1])e[1]=1;else if("desc"==r[1])e[1]=-1;else{if(1!=r[1]&&-1!=r[1])throw new MongoError("Illegal sort clause, must be of the form [['field1', '(ascending|descending)'], ['field2', '(ascending|descending)']]");e[1]=r[1]}return e}))),null!=e&&(s=[[r,e]]),this.s.cmd.sort=s,this.sortValue=s,this},define.classMethod("sort",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.batchSize=function(r){if(this.s.options.tailable)throw MongoError.create({message:"Tailable cursor doesn't support batchSize",driver:!0});if(this.s.state==Cursor.CLOSED||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});if("number"!=typeof r)throw MongoError.create({message:"batchSize requires an integer",driver:!0});return this.s.cmd.batchSize=r,this.setCursorBatchSize(r),this},define.classMethod("batchSize",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.limit=function(r){if(this.s.options.tailable)throw MongoError.create({message:"Tailable cursor doesn't support limit",driver:!0});if(this.s.state==Cursor.OPEN||this.s.state==Cursor.CLOSED||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});if("number"!=typeof r)throw MongoError.create({message:"limit requires an integer",driver:!0});return this.s.cmd.limit=r,this.setCursorLimit(r),this},define.classMethod("limit",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.skip=function(r){if(this.s.options.tailable)throw MongoError.create({message:"Tailable cursor doesn't support skip",driver:!0});if(this.s.state==Cursor.OPEN||this.s.state==Cursor.CLOSED||this.isDead())throw MongoError.create({message:"Cursor is closed",driver:!0});if("number"!=typeof r)throw MongoError.create({message:"skip requires an integer",driver:!0});return this.s.cmd.skip=r,this.setCursorSkip(r),this},define.classMethod("skip",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.nextObject=Cursor.prototype.next;var nextObject=function(r,e){if(r.s.state==Cursor.CLOSED||r.isDead&&r.isDead())return handleCallback(e,MongoError.create({message:"Cursor is closed",driver:!0}));if(r.s.state==Cursor.INIT&&r.s.cmd.sort)try{r.s.cmd.sort=formattedOrderClause(r.s.cmd.sort)}catch(s){return handleCallback(e,s)}r._next(function(s,t){return r.s.state=Cursor.OPEN,s?handleCallback(e,s):void handleCallback(e,null,t)})};define.classMethod("nextObject",{callback:!0,promise:!0});var loop=function(r,e){return 0!=r.bufferedCount()?(r._next(e),loop):void 0};Cursor.prototype.next=Cursor.prototype.nextObject,define.classMethod("next",{callback:!0,promise:!0}),Cursor.prototype.each=function(r){this.rewind(),this.s.state=Cursor.INIT,_each(this,r)},define.classMethod("each",{callback:!0,promise:!1});var _each=function(r,e){if(!e)throw MongoError.create({message:"callback is mandatory",driver:!0});if(!r.isNotified()){if(r.s.state==Cursor.CLOSED||r.isDead())return handleCallback(e,MongoError.create({message:"Cursor is closed",driver:!0}));r.s.state==Cursor.INIT&&(r.s.state=Cursor.OPEN);var s=null;if(r.bufferedCount()>0){for(;s=loop(r,e);)s(r,e);_each(r,e)}else r.next(function(s,t){return s?handleCallback(e,s):null==t?(r.s.state=Cursor.CLOSED,handleCallback(e,null,null)):void(0!=handleCallback(e,null,t)&&_each(r,e))})}};Cursor.prototype.forEach=function(r,e){this.each(function(s,t){if(s)return e(s),!1;if(null!=t)return r(t),!0;if(null==t&&e){var o=e;return e=null,o(null),!1}})},define.classMethod("forEach",{callback:!0,promise:!1}),Cursor.prototype.setReadPreference=function(r){if(this.s.state!=Cursor.INIT)throw MongoError.create({message:"cannot change cursor readPreference after cursor has been accessed",driver:!0});return r instanceof ReadPreference?this.s.options.readPreference=new CoreReadPreference(r.mode,r.tags):"string"==typeof r?this.s.options.readPreference=new CoreReadPreference(r):r instanceof CoreReadPreference&&(this.s.options.readPreference=r),this},define.classMethod("setReadPreference",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.toArray=function(r){var e=this;if(e.s.options.tailable)throw MongoError.create({message:"Tailable cursor cannot be converted to array",driver:!0});return"function"==typeof r?toArray(e,r):new this.s.promiseLibrary(function(r,s){toArray(e,function(e,t){return e?s(e):void r(t)})})};var toArray=function(r,e){var s=[];r.rewind(),r.s.state=Cursor.INIT;var t=function(){r._next(function(o,i){if(o)return handleCallback(e,o);if(null==i)return r.s.state=Cursor.CLOSED,handleCallback(e,null,s);if(s.push(i),r.bufferedCount()>0){var n=r.readBufferedDocuments(r.bufferedCount());r.s.transforms&&"function"==typeof r.s.transforms.doc&&(n=n.map(r.s.transforms.doc)),push.apply(s,n)}t()})};t()};define.classMethod("toArray",{callback:!0,promise:!0}),Cursor.prototype.count=function(r,e,s){var t=this;if(null==t.s.cmd.query)throw MongoError.create({message:"count can only be used with find command",driver:!0});return"function"==typeof e&&(s=e,e={}),e=e||{},"function"==typeof s?count(t,r,e,s):new this.s.promiseLibrary(function(s,o){count(t,r,e,function(r,e){return r?o(r):void s(e)})})};var count=function(r,e,s,t){"function"==typeof e&&(t=e,e=!0),e&&("number"==typeof r.cursorSkip()&&(s.skip=r.cursorSkip()),"number"==typeof r.cursorLimit()&&(s.limit=r.cursorLimit()));var o=r.s.ns.indexOf("."),i={count:r.s.ns.substr(o+1),query:r.s.cmd.query};"number"==typeof s.maxTimeMS?i.maxTimeMS=s.maxTimeMS:r.s.cmd&&"number"==typeof r.s.cmd.maxTimeMS&&(i.maxTimeMS=r.s.cmd.maxTimeMS),s.skip&&(i.skip=s.skip),s.limit&&(i.limit=s.limit),r.s.options.hint&&(i.hint=r.s.options.hint),r.topology.command(f("%s.$cmd",r.s.ns.substr(0,o)),i,function(r,e){t(r,e?e.result.n:null)})};define.classMethod("count",{callback:!0,promise:!0}),Cursor.prototype.close=function(r){return this.s.state=Cursor.CLOSED,this.kill(),this.emit("close"),"function"==typeof r?handleCallback(r,null,this):new this.s.promiseLibrary(function(r,e){r()})},define.classMethod("close",{callback:!0,promise:!0}),Cursor.prototype.map=function(r){return this.cursorState.transforms={doc:r},this},define.classMethod("map",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.isClosed=function(){return this.isDead()},define.classMethod("isClosed",{callback:!1,promise:!1,returns:[Boolean]}),Cursor.prototype.destroy=function(r){r&&this.emit("error",r),this.pause(),this.close()},define.classMethod("destroy",{callback:!1,promise:!1}),Cursor.prototype.stream=function(r){return this.s.streamOptions=r||{},this},define.classMethod("stream",{callback:!1,promise:!1,returns:[Cursor]}),Cursor.prototype.explain=function(r){var e=this;return this.s.cmd.explain=!0,this.s.cmd.readConcern&&delete this.s.cmd.readConcern,"function"==typeof r?this._next(r):new this.s.promiseLibrary(function(r,s){e._next(function(e,t){return e?s(e):void r(t)})})},define.classMethod("explain",{callback:!0,promise:!0}),Cursor.prototype._read=function(r){var e=this;return e.s.state==Cursor.CLOSED||e.isDead()?e.push(null):void e.nextObject(function(r,s){return r?(e.listeners("error")&&e.listeners("error").length>0&&e.emit("error",r),e.isDead()||e.close(),e.emit("end"),e.emit("finish")):"function"==typeof e.s.streamOptions.transform&&null!=s?e.push(e.s.streamOptions.transform(s)):e.cursorState.transforms&&"function"==typeof e.cursorState.transforms.doc&&null!=s?e.push(e.cursorState.transforms.doc(s)):void e.push(s)})},Object.defineProperty(Cursor.prototype,"readPreference",{enumerable:!0,get:function(){return this&&this.s?this.s.options.readPreference:null}}),Object.defineProperty(Cursor.prototype,"namespace",{enumerable:!0,get:function(){if(!this||!this.s)return null;var r=this.s.ns||"",e=r.indexOf(".");return 0>e?{database:this.s.ns,collection:""}:{database:r.substr(0,e),collection:r.substr(e+1)}}}),Cursor.INIT=0,Cursor.OPEN=1,Cursor.CLOSED=2,Cursor.GET_MORE=3,module.exports=Cursor;