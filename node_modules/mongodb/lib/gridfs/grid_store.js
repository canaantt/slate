"use strict";var Chunk=require("./chunk"),ObjectID=require("mongodb-core").BSON.ObjectID,ReadPreference=require("../read_preference"),Buffer=require("buffer").Buffer,Collection=require("../collection"),fs=require("fs"),timers=require("timers"),f=require("util").format,util=require("util"),Define=require("../metadata"),MongoError=require("mongodb-core").MongoError,inherits=util.inherits,Duplex=require("stream").Duplex||require("readable-stream").Duplex,shallowClone=require("../utils").shallowClone,REFERENCE_BY_FILENAME=0,REFERENCE_BY_ID=1,GridStore=function e(n,t,i,o,r){if(!(this instanceof e))return new e(n,t,i,o,r);this.db=n,"undefined"==typeof r&&(r={}),"undefined"==typeof o?(o=i,i=void 0):"object"==typeof o&&(r=o,o=i,i=void 0),t instanceof ObjectID?(this.referenceBy=REFERENCE_BY_ID,this.fileId=t,this.filename=i):"undefined"==typeof i?(this.referenceBy=REFERENCE_BY_FILENAME,this.filename=t,null!=o.indexOf("w")&&(this.fileId=new ObjectID)):(this.referenceBy=REFERENCE_BY_ID,this.fileId=t,this.filename=i),this.mode=null==o?"r":o,this.options=r||{},this.isOpen=!1,this.root=null==this.options.root?e.DEFAULT_ROOT_COLLECTION:this.options.root,this.position=0,this.readPreference=this.options.readPreference||n.options.readPreference||ReadPreference.PRIMARY,this.writeConcern=_getWriteConcern(n,this.options),this.internalChunkSize=null==this.options.chunkSize?Chunk.DEFAULT_CHUNK_SIZE:this.options.chunkSize;var l=this.options.promiseLibrary;l||(l="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),this.promiseLibrary=l,Object.defineProperty(this,"chunkSize",{enumerable:!0,get:function(){return this.internalChunkSize},set:function(e){"w"!=this.mode[0]||0!=this.position||null!=this.uploadDate?this.internalChunkSize=this.internalChunkSize:this.internalChunkSize=e}}),Object.defineProperty(this,"md5",{enumerable:!0,get:function(){return this.internalMd5}}),Object.defineProperty(this,"chunkNumber",{enumerable:!0,get:function(){return this.currentChunk&&this.currentChunk.chunkNumber?this.currentChunk.chunkNumber:null}})},define=GridStore.define=new Define("Gridstore",GridStore,!0);GridStore.prototype.open=function(e){var n=this;if("w"!=this.mode&&"w+"!=this.mode&&"r"!=this.mode)throw MongoError.create({message:"Illegal mode "+this.mode,driver:!0});return"function"==typeof e?open(n,e):new n.promiseLibrary(function(e,t){open(n,function(n,i){return n?t(n):void e(i)})})};var open=function(e,n){var t=_getWriteConcern(e.db,e.options);if("w"==e.mode||"w+"==e.mode){var i=e.collection();i.ensureIndex([["filename",1]],t,function(i,o){var r=e.chunkCollection(),l=shallowClone(t);l.unique=!0,r.ensureIndex([["files_id",1],["n",1]],l,function(i,o){_open(e,t,function(t,i){return t?n(t):(e.isOpen=!0,void n(t,i))})})})}else _open(e,t,function(t,i){return t?n(t):(e.isOpen=!0,void n(t,i))})};define.classMethod("open",{callback:!0,promise:!0}),GridStore.prototype.eof=function(){return this.position==this.length?!0:!1},define.classMethod("eof",{callback:!1,promise:!1,returns:[Boolean]}),GridStore.prototype.getc=function(e){var n=this;return"function"==typeof e?eof(n,e):new n.promiseLibrary(function(e,t){eof(n,function(n,i){return n?t(n):void e(i)})})};var eof=function(e,n){e.eof()?n(null,null):e.currentChunk.eof()?nthChunk(e,e.currentChunk.chunkNumber+1,function(t,i){e.currentChunk=i,e.position=e.position+1,n(t,e.currentChunk.getc())}):(e.position=e.position+1,n(null,e.currentChunk.getc()))};define.classMethod("getc",{callback:!0,promise:!0}),GridStore.prototype.puts=function(e,n){var t=this,i=null==e.match(/\n$/)?e+"\n":e;return"function"==typeof n?this.write(i,n):new t.promiseLibrary(function(e,n){t.write(i,function(t,i){return t?n(t):void e(i)})})},define.classMethod("puts",{callback:!0,promise:!0}),GridStore.prototype.stream=function(){return new GridStoreStream(this)},define.classMethod("stream",{callback:!1,promise:!1,returns:[GridStoreStream]}),GridStore.prototype.write=function(e,n,t){var i=this;return"function"==typeof t?_writeNormal(this,e,n,t):new i.promiseLibrary(function(t,o){_writeNormal(i,e,n,function(e,n){return e?o(e):void t(n)})})},define.classMethod("write",{callback:!0,promise:!0}),GridStore.prototype.destroy=function(){this.writable&&(this.readable=!1,this.writable&&(this.writable=!1,this._q.length=0,this.emit("close")))},define.classMethod("destroy",{callback:!1,promise:!1}),GridStore.prototype.writeFile=function(e,n){var t=this;return"function"==typeof n?writeFile(t,e,n):new t.promiseLibrary(function(n,i){writeFile(t,e,function(e,t){return e?i(e):void n(t)})})};var writeFile=function(e,n,t){return"string"==typeof n?void fs.open(n,"r",function(n,i){return n?t(n):void e.writeFile(i,t)}):void e.open(function(e,i){return e?t(e,i):void fs.fstat(n,function(e,o){if(e)return t(e,i);var r=0,l=0,u=(Math.min(o.size/i.chunkSize),function(){fs.read(n,i.chunkSize,r,"binary",function(e,s,a){if(e)return t(e,i);r+=a;var c=new Chunk(i,{n:l++},i.writeConcern);c.write(s,function(e,l){return e?t(e,i):void l.save({},function(e,a){return e?t(e,i):(i.position=i.position+s.length,i.currentChunk=l,r>=o.size?(fs.close(n),void i.close(function(e,n){return e?t(e,i):t(null,i)})):process.nextTick(u))})})})});process.nextTick(u)})})};define.classMethod("writeFile",{callback:!0,promise:!0}),GridStore.prototype.close=function(e){var n=this;return"function"==typeof e?close(n,e):new n.promiseLibrary(function(e,t){close(n,function(n,i){return n?t(n):void e(i)})})};var close=function(e,n){if("w"==e.mode[0]){var t=e.writeConcern;null!=e.currentChunk&&e.currentChunk.position>0?e.currentChunk.save({},function(i,o){return i&&"function"==typeof n?n(i):void e.collection(function(i,o){return i&&"function"==typeof n?n(i):void(null!=e.uploadDate?buildMongoObject(e,function(e,i){if(e){if("function"==typeof n)return n(e);throw e}o.save(i,t,function(e){"function"==typeof n&&n(e,i)})}):(e.uploadDate=new Date,buildMongoObject(e,function(e,i){if(e){if("function"==typeof n)return n(e);throw e}o.save(i,t,function(e){"function"==typeof n&&n(e,i)})})))})}):e.collection(function(i,o){return i&&"function"==typeof n?n(i):(e.uploadDate=new Date,void buildMongoObject(e,function(e,i){if(e){if("function"==typeof n)return n(e);throw e}o.save(i,t,function(e){"function"==typeof n&&n(e,i)})}))})}else"r"==e.mode[0]?"function"==typeof n&&n(null,null):"function"==typeof n&&n(MongoError.create({message:f("Illegal mode %s",e.mode),driver:!0}))};define.classMethod("close",{callback:!0,promise:!0}),GridStore.prototype.chunkCollection=function(e){return"function"==typeof e?this.db.collection(this.root+".chunks",e):this.db.collection(this.root+".chunks")},define.classMethod("chunkCollection",{callback:!0,promise:!1,returns:[Collection]}),GridStore.prototype.unlink=function(e){var n=this;return"function"==typeof e?unlink(n,e):new n.promiseLibrary(function(e,t){unlink(n,function(n,i){return n?t(n):void e(i)})})};var unlink=function(e,n){deleteChunks(e,function(t){return null!==t?(t.message="at deleteChunks: "+t.message,n(t)):void e.collection(function(t,i){return null!==t?(t.message="at collection: "+t.message,n(t)):void i.remove({_id:e.fileId},e.writeConcern,function(t){n(t,e)})})})};define.classMethod("unlink",{callback:!0,promise:!0}),GridStore.prototype.collection=function(e){return"function"==typeof e&&this.db.collection(this.root+".files",e),this.db.collection(this.root+".files")},define.classMethod("collection",{callback:!0,promise:!1,returns:[Collection]}),GridStore.prototype.readlines=function(e,n){var t=this,i=Array.prototype.slice.call(arguments,0);return n=i.pop(),"function"!=typeof n&&i.push(n),e=i.length?i.shift():"\n",e=e||"\n","function"==typeof n?readlines(t,e,n):new t.promiseLibrary(function(n,i){readlines(t,e,function(e,t){return e?i(e):void n(t)})})};var readlines=function(e,n,t){e.read(function(e,i){if(e)return t(e);var o=i.toString().split(n);o=o.length>0?o.splice(0,o.length-1):[];for(var r=0;r<o.length;r++)o[r]=o[r]+n;t(null,o)})};define.classMethod("readlines",{callback:!0,promise:!0}),GridStore.prototype.rewind=function(e){var n=this;return"function"==typeof e?rewind(n,e):new n.promiseLibrary(function(e,t){rewind(n,function(n,i){return n?t(n):void e(i)})})};var rewind=function(e,n){0!=e.currentChunk.chunkNumber?"w"==e.mode[0]?deleteChunks(e,function(t,i){return t?n(t):(e.currentChunk=new Chunk(e,{n:0},e.writeConcern),e.position=0,void n(null,e))}):e.currentChunk(0,function(t,i){return t?n(t):(e.currentChunk=i,e.currentChunk.rewind(),e.position=0,void n(null,e))}):(e.currentChunk.rewind(),e.position=0,n(null,e))};define.classMethod("rewind",{callback:!0,promise:!0}),GridStore.prototype.read=function(e,n,t){var i=this,o=Array.prototype.slice.call(arguments,0);return t=o.pop(),"function"!=typeof t&&o.push(t),e=o.length?o.shift():null,n=o.length?o.shift():null,"function"==typeof t?read(i,e,n,t):new i.promiseLibrary(function(t,o){read(i,e,n,function(e,n){return e?o(e):void t(n)})})};var read=function(e,n,t,i){var o=null==n?e.length-e.position:n,r=null==t?new Buffer(o):t;if(r._index=null!=t&&null!=t._index?t._index:0,e.currentChunk.length()-e.currentChunk.position+r._index>=o){var l=e.currentChunk.readSlice(o-r._index);return l.copy(r,r._index),e.position=e.position+r.length,0==o&&0==r.length?i(MongoError.create({message:"File does not exist",driver:!0}),null):i(null,r)}var l=e.currentChunk.readSlice(e.currentChunk.length()-e.currentChunk.position);l.copy(r,r._index),r._index+=l.length,nthChunk(e,e.currentChunk.chunkNumber+1,function(t,o){return t?i(t):void(o.length()>0?(e.currentChunk=o,e.read(n,r,i)):r._index>0?i(null,r):i(MongoError.create({message:"no chunks found for file, possibly corrupt",driver:!0}),null))})};define.classMethod("read",{callback:!0,promise:!0}),GridStore.prototype.tell=function(e){var n=this;return"function"==typeof e?e(null,this.position):new n.promiseLibrary(function(e,t){e(n.position)})},define.classMethod("tell",{callback:!0,promise:!0}),GridStore.prototype.seek=function(e,n,t){var i=this,o=Array.prototype.slice.call(arguments,1);return t=o.pop(),"function"!=typeof t&&o.push(t),n=o.length?o.shift():null,"function"==typeof t?seek(i,e,n,t):new i.promiseLibrary(function(t,o){seek(i,e,n,function(e,n){return e?o(e):void t(n)})})};var seek=function(e,n,t,i){if("r"!=e.mode)return i(MongoError.create({message:"seek is only supported for mode r",driver:!0}));var o=null==t?GridStore.IO_SEEK_SET:t,r=n,l=0;l=o==GridStore.IO_SEEK_CUR?e.position+r:o==GridStore.IO_SEEK_END?e.length+r:r;var u=Math.floor(l/e.chunkSize),s=function(){nthChunk(e,u,function(n,t){return n?i(n,null):null==t?i(new Error("no chunk found")):(e.currentChunk=t,e.position=l,e.currentChunk.position=e.position%e.chunkSize,void i(n,e))})};s()};define.classMethod("seek",{callback:!0,promise:!0});var _open=function(e,n,t){function i(e){i.err||t(i.err=e)}var o=e.collection(),r=e.referenceBy==REFERENCE_BY_ID?{_id:e.fileId}:{filename:e.filename};if(r=null==e.fileId&&null==e.filename?null:r,n.readPreference=e.readPreference,null!=r)o.findOne(r,n,function(o,r){if(o)return i(o);if(null!=r)e.fileId=r._id,e.filename="r"==e.mode||void 0==e.filename?r.filename:e.filename,e.contentType=r.contentType,e.internalChunkSize=r.chunkSize,e.uploadDate=r.uploadDate,e.aliases=r.aliases,e.length=r.length,e.metadata=r.metadata,e.internalMd5=r.md5;else{if("r"==e.mode){e.length=0;var l=e.fileId instanceof ObjectID?e.fileId.toHexString():e.fileId;return i(MongoError.create({message:f("file with id %s not opened for writing",e.referenceBy==REFERENCE_BY_ID?l:e.filename),driver:!0}),e)}e.fileId=null==e.fileId?new ObjectID:e.fileId,e.contentType=GridStore.DEFAULT_CONTENT_TYPE,e.internalChunkSize=null==e.internalChunkSize?Chunk.DEFAULT_CHUNK_SIZE:e.internalChunkSize,e.length=0}"r"==e.mode?nthChunk(e,0,n,function(n,o){return n?i(n):(e.currentChunk=o,e.position=0,void t(null,e))}):"w"==e.mode&&r?deleteChunks(e,n,function(n,o){return n?i(n):(e.currentChunk=new Chunk(e,{n:0},e.writeConcern),e.contentType=null==e.options.content_type?e.contentType:e.options.content_type,e.internalChunkSize=null==e.options.chunk_size?e.internalChunkSize:e.options.chunk_size,e.metadata=null==e.options.metadata?e.metadata:e.options.metadata,e.aliases=null==e.options.aliases?e.aliases:e.options.aliases,e.position=0,void t(null,e))}):"w"==e.mode?(e.currentChunk=new Chunk(e,{n:0},e.writeConcern),e.contentType=null==e.options.content_type?e.contentType:e.options.content_type,e.internalChunkSize=null==e.options.chunk_size?e.internalChunkSize:e.options.chunk_size,e.metadata=null==e.options.metadata?e.metadata:e.options.metadata,e.aliases=null==e.options.aliases?e.aliases:e.options.aliases,e.position=0,t(null,e)):"w+"==e.mode&&nthChunk(e,lastChunkNumber(e),n,function(n,o){return n?i(n):(e.currentChunk=null==o?new Chunk(e,{n:0},e.writeConcern):o,e.currentChunk.position=e.currentChunk.data.length(),e.metadata=null==e.options.metadata?e.metadata:e.options.metadata,e.aliases=null==e.options.aliases?e.aliases:e.options.aliases,e.position=e.length,void t(null,e))})});else{e.fileId=null==e.fileId?new ObjectID:e.fileId,e.contentType=GridStore.DEFAULT_CONTENT_TYPE,e.internalChunkSize=null==e.internalChunkSize?Chunk.DEFAULT_CHUNK_SIZE:e.internalChunkSize,e.length=0;e.chunkCollection();"w"==e.mode?deleteChunks(e,n,function(n,o){return n?i(n):(e.currentChunk=new Chunk(e,{n:0},e.writeConcern),e.contentType=null==e.options.content_type?e.contentType:e.options.content_type,e.internalChunkSize=null==e.options.chunk_size?e.internalChunkSize:e.options.chunk_size,e.metadata=null==e.options.metadata?e.metadata:e.options.metadata,e.aliases=null==e.options.aliases?e.aliases:e.options.aliases,e.position=0,void t(null,e))}):"w+"==e.mode&&nthChunk(e,lastChunkNumber(e),n,function(n,o){return n?i(n):(e.currentChunk=null==o?new Chunk(e,{n:0},e.writeConcern):o,e.currentChunk.position=e.currentChunk.data.length(),e.metadata=null==e.options.metadata?e.metadata:e.options.metadata,e.aliases=null==e.options.aliases?e.aliases:e.options.aliases,e.position=e.length,void t(null,e))})}},writeBuffer=function(e,n,t,i){"function"==typeof t&&(i=t,t=null);var o="boolean"==typeof t?t:!1;if("w"!=e.mode)i(MongoError.create({message:f("file with id %s not opened for writing",e.referenceBy==REFERENCE_BY_ID?e.referenceBy:e.filename),driver:!0}),null);else{if(!(e.currentChunk.position+n.length>=e.chunkSize))return e.position=e.position+n.length,e.currentChunk.write(n),o?e.close(function(n,t){i(n,e)}):i(null,e);for(var r=e.currentChunk.chunkNumber,l=e.chunkSize-e.currentChunk.position,u=n.slice(0,l),s=n.slice(l),a=[e.currentChunk.write(u)];s.length>=e.chunkSize;){var c=new Chunk(e,{n:r+1},e.writeConcern),u=s.slice(0,e.chunkSize);s=s.slice(e.chunkSize),r+=1,c.write(u),a.push(c)}e.currentChunk=new Chunk(e,{n:r+1},e.writeConcern),s.length>0&&e.currentChunk.write(s),e.position=e.position+n.length;for(var d=a.length,p=0;p<a.length;p++)a[p].save({},function(n,t){return n?i(n):(d-=1,0>=d?o?e.close(function(n,t){i(n,e)}):i(null,e):void 0)})}},buildMongoObject=function(e,n){var t={_id:e.fileId,filename:e.filename,contentType:e.contentType,length:e.position?e.position:0,chunkSize:e.chunkSize,uploadDate:e.uploadDate,aliases:e.aliases,metadata:e.metadata},i={filemd5:e.fileId,root:e.root};e.db.command(i,function(e,i){return e?n(e):(t.md5=i.md5,void n(null,t))})},nthChunk=function(e,n,t,i){"function"==typeof t&&(i=t,t={}),t=t||e.writeConcern,t.readPreference=e.readPreference,e.chunkCollection().findOne({files_id:e.fileId,n:n},t,function(n,t){if(n)return i(n);var o=null==t?{}:t;i(null,new Chunk(e,o,e.writeConcern))})},lastChunkNumber=function(e){return Math.floor((e.length?e.length-1:0)/e.chunkSize)},deleteChunks=function(e,n,t){"function"==typeof n&&(t=n,n={}),n=n||e.writeConcern,null!=e.fileId?e.chunkCollection().remove({files_id:e.fileId},n,function(e,n){return e?t(e,!1):void t(null,!0)}):t(null,!0)};GridStore.DEFAULT_ROOT_COLLECTION="fs",GridStore.DEFAULT_CONTENT_TYPE="binary/octet-stream",GridStore.IO_SEEK_SET=0,GridStore.IO_SEEK_CUR=1,GridStore.IO_SEEK_END=2,GridStore.exist=function(e,n,t,i,o){var r=Array.prototype.slice.call(arguments,2);o=r.pop(),"function"!=typeof o&&r.push(o),t=r.length?r.shift():null,i=r.length?r.shift():{},i=i||{};var l=i.promiseLibrary;return l||(l="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),"function"==typeof o?exists(e,n,t,i,o):new l(function(o,r){exists(e,n,t,i,function(e,n){return e?r(e):void o(n)})})};var exists=function(e,n,t,i,o){var r=i.readPreference||ReadPreference.PRIMARY,l=null!=t?t:GridStore.DEFAULT_ROOT_COLLECTION;e.collection(l+".files",function(e,t){if(e)return o(e);var i="string"==typeof n||"[object RegExp]"==Object.prototype.toString.call(n)?{filename:n}:{_id:n};null!=n&&"object"==typeof n&&"[object RegExp]"!=Object.prototype.toString.call(n)&&(i=n),t.findOne(i,{readPreference:r},function(e,n){return e?o(e):void o(null,null==n?!1:!0)})})};define.staticMethod("exist",{callback:!0,promise:!0}),GridStore.list=function(e,n,t,i){var o=Array.prototype.slice.call(arguments,1);i=o.pop(),"function"!=typeof i&&o.push(i),n=o.length?o.shift():null,t=o.length?o.shift():{},t=t||{};var r=t.promiseLibrary;return r||(r="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),"function"==typeof i?list(e,n,t,i):new r(function(i,o){list(e,n,t,function(e,n){return e?o(e):void i(n)})})};var list=function(e,n,t,i){null!=n&&"object"==typeof n&&(t=n,n=null);var o=t.readPreference||ReadPreference.PRIMARY,r=null!=t.id?t.id:!1,l=null!=n?n:GridStore.DEFAULT_ROOT_COLLECTION,u=[];e.collection(l+".files",function(e,n){return e?i(e):void n.find({},{readPreference:o},function(e,n){return e?i(e):void n.each(function(e,n){null!=n?u.push(r?n._id:n.filename):i(e,u)})})})};define.staticMethod("list",{callback:!0,promise:!0}),GridStore.read=function(e,n,t,i,o,r){var l=Array.prototype.slice.call(arguments,2);r=l.pop(),"function"!=typeof r&&l.push(r),t=l.length?l.shift():null,i=l.length?l.shift():null,o=l.length?l.shift():null,o=o||{};var u=o?o.promiseLibrary:null;return u||(u="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),"function"==typeof r?readStatic(e,n,t,i,o,r):new u(function(r,l){readStatic(e,n,t,i,o,function(e,n){return e?l(e):void r(n)})})};var readStatic=function(e,n,t,i,o,r){new GridStore(e,n,"r",o).open(function(e,n){return e?r(e):i&&i>=n.length?r("offset larger than size of file",null):t&&t>n.length?r("length is larger than the size of the file",null):i&&t&&i+t>n.length?r("offset and length is larger than the size of the file",null):void(null!=i?n.seek(i,function(e,n){return e?r(e):void n.read(t,r)}):n.read(t,r))})};define.staticMethod("read",{callback:!0,promise:!0}),GridStore.readlines=function(e,n,t,i,o){var r=Array.prototype.slice.call(arguments,2);o=r.pop(),"function"!=typeof o&&r.push(o),t=r.length?r.shift():null,i=r.length?r.shift():null,i=i||{};var l=i?i.promiseLibrary:null;return l||(l="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),"function"==typeof o?readlinesStatic(e,n,t,i,o):new l(function(o,r){readlinesStatic(e,n,t,i,function(e,n){return e?r(e):void o(n)})})};var readlinesStatic=function(e,n,t,i,o){var r=null==t?"\n":t;new GridStore(e,n,"r",i).open(function(e,n){return e?o(e):void n.readlines(r,o)})};define.staticMethod("readlines",{callback:!0,promise:!0}),GridStore.unlink=function(e,n,t,i){var o=this,r=Array.prototype.slice.call(arguments,2);i=r.pop(),"function"!=typeof i&&r.push(i),t=r.length?r.shift():{},t=t||{};var l=t.promiseLibrary;return l||(l="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),"function"==typeof i?unlinkStatic(o,e,n,t,i):new l(function(i,r){unlinkStatic(o,e,n,t,function(e,n){return e?r(e):void i(n)})})};var unlinkStatic=function(e,n,t,i,o){var r=_getWriteConcern(n,i);if(t.constructor==Array)for(var l=0,u=0;u<t.length;u++)++l,GridStore.unlink(n,t[u],i,function(n){0==--l&&o(null,e)});else new GridStore(n,t,"w",i).open(function(n,t){return n?o(n):void deleteChunks(t,function(n,i){return n?o(n):void t.collection(function(n,i){return n?o(n):void i.remove({_id:t.fileId},r,function(n,t){o(n,e)})})})})};define.staticMethod("unlink",{callback:!0,promise:!0});var _writeNormal=function(e,n,t,i){return Buffer.isBuffer(n)?writeBuffer(e,n,t,i):writeBuffer(e,new Buffer(n,"binary"),t,i)},_setWriteConcernHash=function(e){var n={};return null!=e.w&&(n.w=e.w),1==e.journal&&(n.j=e.journal),1==e.j&&(n.j=e.j),1==e.fsync&&(n.fsync=e.fsync),null!=e.wtimeout&&(n.wtimeout=e.wtimeout),n},_getWriteConcern=function(e,n){var t={w:1};if(n=n||{},null!=n.w||"boolean"==typeof n.j||"boolean"==typeof n.journal||"boolean"==typeof n.fsync?t=_setWriteConcernHash(n):null!=n.safe&&"object"==typeof n.safe?t=_setWriteConcernHash(n.safe):"boolean"==typeof n.safe?t={w:n.safe?1:0}:null!=e.options.w||"boolean"==typeof e.options.j||"boolean"==typeof e.options.journal||"boolean"==typeof e.options.fsync?t=_setWriteConcernHash(e.options):!e.safe||null==e.safe.w&&"boolean"!=typeof e.safe.j&&"boolean"!=typeof e.safe.journal&&"boolean"!=typeof e.safe.fsync?"boolean"==typeof e.safe&&(t={w:e.safe?1:0}):t=_setWriteConcernHash(e.safe),t.w<1&&(1==t.journal||1==t.j||1==t.fsync))throw MongoError.create({message:"No acknowledgement using w < 1 cannot be combined with journal:true or fsync:true",driver:!0});return t},GridStoreStream=function(e){Duplex.call(this),this.gs=e,this.endCalled=!1,this.totalBytesToRead=this.gs.length-this.gs.position,this.seekPosition=this.gs.position};inherits(GridStoreStream,Duplex),GridStoreStream.prototype._pipe=GridStoreStream.prototype.pipe,GridStoreStream.prototype.pipe=function(e){var n=this;return n.gs.isOpen?(n.totalBytesToRead=n.gs.length-n.gs.position,n._pipe.apply(n,[e])):n.gs.open(function(t){return t?n.emit("error",t):(n.totalBytesToRead=n.gs.length-n.gs.position,void n._pipe.apply(n,[e]))}),e},GridStoreStream.prototype._read=function(e){var n=this,t=function(){n.gs.read(i,function(e,t){return e&&!n.endCalled?n.emit("error",e):n.endCalled||null==t?n.push(null):(t.length<=n.totalBytesToRead?(n.totalBytesToRead=n.totalBytesToRead-t.length,n.push(t)):t.length>n.totalBytesToRead&&(n.totalBytesToRead=n.totalBytesToRead-t._index,n.push(t.slice(0,t._index))),void(n.totalBytesToRead<=0&&(n.endCalled=!0)))})},i=n.gs.length<n.gs.chunkSize?n.gs.length-n.seekPosition:n.gs.chunkSize;n.gs.isOpen?t():n.gs.open(function(e,i){return n.totalBytesToRead=n.gs.length-n.gs.position,e?n.emit("error",e):void t()})},GridStoreStream.prototype.destroy=function(){this.pause(),this.endCalled=!0,this.gs.close(),this.emit("end")},GridStoreStream.prototype.write=function(e,n,t){var i=this;return i.endCalled?i.emit("error",MongoError.create({message:"attempting to write to stream after end called",driver:!0})):i.gs.isOpen?(i.gs.write(e,function(){i.emit("drain")}),!0):(i.gs.open(function(){i.gs.isOpen=!0,i.gs.write(e,function(){process.nextTick(function(){i.emit("drain")})})}),!1)},GridStoreStream.prototype.end=function(e,n,t){var i=this,o=Array.prototype.slice.call(arguments,0);t=o.pop(),"function"!=typeof t&&o.push(t),e=o.length?o.shift():null,n=o.length?o.shift():null,i.endCalled=!0,e&&i.gs.write(e,function(){i.gs.close(function(){"function"==typeof t&&t(),i.emit("end")})}),i.gs.close(function(){"function"==typeof t&&t(),i.emit("end")})},module.exports=GridStore;