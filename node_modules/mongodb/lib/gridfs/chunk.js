"use strict";var Binary=require("mongodb-core").BSON.Binary,ObjectID=require("mongodb-core").BSON.ObjectID,Chunk=function(t,n,i){if(!(this instanceof Chunk))return new Chunk(t,n);this.file=t;var e=null==n?{}:n;if(this.writeConcern=i||{w:1},this.objectId=null==e._id?new ObjectID:e._id,this.chunkNumber=null==e.n?0:e.n,this.data=new Binary,null==e.data);else if("string"==typeof e.data){var r=new Buffer(e.data.length);r.write(e.data,0,e.data.length,"binary"),this.data=new Binary(r)}else if(Array.isArray(e.data)){var r=new Buffer(e.data.length),o=e.data.join("");r.write(o,0,o.length,"binary"),this.data=new Binary(r)}else if("Binary"===e.data._bsontype)this.data=e.data;else if(!Buffer.isBuffer(e.data))throw Error("Illegal chunk format");this.internalPosition=0};Chunk.prototype.write=function(t,n){return this.data.write(t,this.internalPosition,t.length,"binary"),this.internalPosition=this.data.length(),null!=n?n(null,this):this},Chunk.prototype.read=function(t){if(t=null==t||0==t?this.length():t,this.length()-this.internalPosition+1>=t){var n=this.data.read(this.internalPosition,t);return this.internalPosition=this.internalPosition+t,n}return""},Chunk.prototype.readSlice=function(t){if(this.length()-this.internalPosition>=t){var n=null;return null!=this.data.buffer?n=this.data.buffer.slice(this.internalPosition,this.internalPosition+t):(n=new Buffer(t),t=this.data.readInto(n,this.internalPosition)),this.internalPosition=this.internalPosition+t,n}return null},Chunk.prototype.eof=function(){return this.internalPosition==this.length()?!0:!1},Chunk.prototype.getc=function(){return this.read(1)},Chunk.prototype.rewind=function(){this.internalPosition=0,this.data=new Binary},Chunk.prototype.save=function(t,n){var i=this;"function"==typeof t&&(n=t,t={}),i.file.chunkCollection(function(e,r){if(e)return n(e);var o={upsert:!0};for(var a in t)o[a]=t[a];for(var a in i.writeConcern)o[a]=i.writeConcern[a];i.data.length()>0?i.buildMongoObject(function(t){var e={forceServerObjectId:!0};for(var a in i.writeConcern)e[a]=i.writeConcern[a];r.replaceOne({_id:i.objectId},t,o,function(t,e){n(t,i)})}):n(null,i)})},Chunk.prototype.buildMongoObject=function(t){var n={files_id:this.file.fileId,n:this.chunkNumber,data:this.data};null!=this.objectId&&(n._id=this.objectId),t(n)},Chunk.prototype.length=function(){return this.data.length()},Object.defineProperty(Chunk.prototype,"position",{enumerable:!0,get:function(){return this.internalPosition},set:function(t){this.internalPosition=t}}),Chunk.DEFAULT_CHUNK_SIZE=261120,module.exports=Chunk;