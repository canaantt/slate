"use strict";function MongoClient(){this.connect=MongoClient.connect}function translateOptions(e){return("string"==typeof e.readPreference||"string"==typeof e.read_preference)&&(e.readPreference=new ReadPreference(e.readPreference||e.read_preference)),e.readPreference&&(e.readPreferenceTags||e.read_preference_tags)&&(e.readPreference.tags=e.readPreferenceTags||e.read_preference_tags),e.maxStalenessMS&&(e.readPreference.maxStalenessMS=e.maxStalenessMS),null==!e.socketTimeoutMS&&(e.socketTimeoutMS=3e4),null==!e.connectTimeoutMS&&(e.connectTimeoutMS=3e4),e.servers.map(function(n){return n.domain_socket?new Server(n.domain_socket,27017,e):new Server(n.host,n.port,e)})}function createReplicaset(e,n){var r=translateOptions(e);new Db(e.dbName,new ReplSet(r,e),e).open(n)}function createMongos(e,n){var r=translateOptions(e);new Db(e.dbName,new Mongos(r,e),e).open(n)}function createServer(e,n){var r=translateOptions(e);new Db(e.dbName,r[0],e).open(n)}function connectHandler(e,n){return function(r,o){if(r)return process.nextTick(function(){try{n(e,null)}catch(e){throw o&&o.close(),e}});if(!e.auth)return process.nextTick(function(){try{n(e,o)}catch(e){throw o&&o.close(),e}});var t=o;e.authSource&&(t=o.db(e.authSource)),t.authenticate(e.user,e.password,e,function(r,t){t?process.nextTick(function(){try{n(null,o)}catch(e){throw o&&o.close(),e}}):(o&&o.close(),process.nextTick(function(){try{n(r?r:new Error("Could not authenticate user "+e.auth[0]),null)}catch(r){throw o&&o.close(),r}}))})}}var parse=require("./url_parser"),Server=require("./server"),Mongos=require("./mongos"),ReplSet=require("./replset"),Define=require("./metadata"),ReadPreference=require("./read_preference"),Logger=require("mongodb-core").Logger,MongoError=require("mongodb-core").MongoError,Db=require("./db"),dns=require("dns"),f=require("util").format,shallowClone=require("./utils").shallowClone,define=MongoClient.define=new Define("MongoClient",MongoClient,!1);MongoClient.connect=function(e,n,r){var o=Array.prototype.slice.call(arguments,1);r="function"==typeof o[o.length-1]?o.pop():null,n=o.length?o.shift():null,n=n||{};var t=n.promiseLibrary;return t||(t="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),"function"!=typeof r?new t(function(r,o){connect(e,n,function(e,n){return e?o(e):void r(n)})}):void connect(e,n,r)},define.staticMethod("connect",{callback:!0,promise:!0});var mergeOptions=function(e,n,r){for(var o in n)n[o]&&"object"==typeof n[o]&&r?e=mergeOptions(e,n[o],r):e[o]=n[o];return e},createUnifiedOptions=function(e,n){var r=["mongos","server","db","replset","db_options","server_options","rs_options","mongos_options"],o=["collation"];for(var t in n)-1!=o.indexOf(t.toLowerCase())?e[t]=n[t]:-1!=r.indexOf(t.toLowerCase())?e=mergeOptions(e,n[t],!1):!n[t]||"object"!=typeof n[t]||Buffer.isBuffer(n[t])||Array.isArray(n[t])?e[t]=n[t]:e=mergeOptions(e,n[t],!0);return e},connect=function(e,n,r){function o(e,n){return e&&"no mongos proxies found in seed list"==e.message?(t.isWarn()&&t.warn(f("seed list contains no mongos proxies, replicaset connections requires the parameter replicaSet to be supplied in the URI or options object, mongodb://server:port/db?replicaSet=name")),r(new MongoError("seed list contains no mongos proxies, replicaset connections requires the parameter replicaSet to be supplied in the URI or options object, mongodb://server:port/db?replicaSet=name"))):void r(e,n)}if(n=n||{},n=shallowClone(n),null==r)throw new Error("no callback function provided");var t=Logger("MongoClient",n),i=parse(e,n),c=createUnifiedOptions({},i);if(c=mergeOptions(c,i,!1),c=createUnifiedOptions(c,n),null==!c.socketTimeoutMS&&(c.socketTimeoutMS=12e4),null==!c.connectTimeoutMS&&(c.connectTimeoutMS=12e4),0==i.servers.length)throw new Error("connection string must contain at least one seed host");return c.replicaSet||c.rs_name?createReplicaset(c,connectHandler(c,o)):i.servers.length>1?createMongos(c,connectHandler(c,o)):createServer(c,connectHandler(c,o))};module.exports=MongoClient;