"use strict";function MongoClient(){this.connect=MongoClient.connect}var parse=require("./url_parser"),Server=require("./server"),Mongos=require("./mongos"),ReplSet=require("./replset"),Define=require("./metadata"),ReadPreference=require("./read_preference"),Db=require("./db"),define=MongoClient.define=new Define("MongoClient",MongoClient,!1);MongoClient.connect=function(e,s,o){var r=Array.prototype.slice.call(arguments,1);o="function"==typeof r[r.length-1]?r.pop():null,s=r.length?r.shift():null,s=s||{};var t=s.promiseLibrary;return t||(t="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),"function"!=typeof o?new t(function(o,r){connect(e,s,function(e,s){return e?r(e):void o(s)})}):void connect(e,s,o)},define.staticMethod("connect",{callback:!0,promise:!0});var serverOptions=["poolSize","ssl","sslValidate","checkServerIdentity","sslCA","sslCert","sslKey","sslPass","autoReconnect","noDelay","keepAlive","connectionTimeoutMS","socketTimeoutMS","reconnectTries","reconnectInterval"],replsetOptions=["ha","haInterval","replicaSet","secondaryAcceptableLatencyMS","connectWithNoPrimary","poolSize","ssl","checkServerIdentity","sslValidate","sslCA","sslCert","sslKey","sslPass","noDelay","keepAlive","connectTimeoutMS","socketTimeoutMS"],mongosOptions=["ha","haInterval","poolSize","ssl","checkServerIdentity","sslValidate","sslCA","sslCert","sslKey","sslPass","noDelay","keepAlive","connectTimeoutMS","socketTimeoutMS","acceptableLatencyMS"],dbOptions=["authSource","w","wtimeout","j","native_parser","forceServerObjectId","serializeFunctions","ignoreUndefined","raw","promoteLongs","bufferMaxEntries","readPreference","pkFactory","promiseLibrary","readConcern"],mergeTopLevel=function(e,s){e.server_options||(e.server_options={}),e.db_options||(e.db_options={}),e.rs_options||(e.rs_options={}),e.mongos_options||(e.mongos_options={});for(var o in s)-1!=serverOptions.indexOf(o)&&(e.server_options[o]=s[o]),-1!=replsetOptions.indexOf(o)&&(e.rs_options[o]=s[o]),-1!=mongosOptions.indexOf(o)&&(e.mongos_options[o]=s[o]),-1!=dbOptions.indexOf(o)&&(e.db_options[o]=s[o]);return e},connect=function(e,s,o){var r=s.server||{},t=s.mongos||{},n=s.replSet||s.replSetServers||{},i=s.db||{};if(null==o)throw new Error("no callback function provided");var a=parse(e,s);if(i)for(var c in i)a.db_options[c]=i[c];if(a.db_options.url=e,r)for(var c in r)a.server_options[c]=r[c];if(n)for(var c in n)a.rs_options[c]=n[c];if((n.ssl||n.sslValidate||n.checkServerIdentity||n.sslCA||n.sslCert||n.sslKey||n.sslPass)&&(a.server_options.ssl=n.ssl,a.server_options.sslValidate=n.sslValidate,a.server_options.checkServerIdentity=n.checkServerIdentity,a.server_options.sslCA=n.sslCA,a.server_options.sslCert=n.sslCert,a.server_options.sslKey=n.sslKey,a.server_options.sslPass=n.sslPass),t)for(var c in t)a.mongos_options[c]=t[c];"number"==typeof a.server_options.poolSize&&(a.mongos_options.poolSize||(a.mongos_options.poolSize=a.server_options.poolSize),a.rs_options.poolSize||(a.rs_options.poolSize=a.server_options.poolSize)),(t.ssl||t.sslValidate||t.checkServerIdentity||t.sslCA||t.sslCert||t.sslKey||t.sslPass)&&(a.server_options.ssl=t.ssl,a.server_options.sslValidate=t.sslValidate,a.server_options.checkServerIdentity=t.checkServerIdentity,a.server_options.sslCA=t.sslCA,a.server_options.sslCert=t.sslCert,a.server_options.sslKey=t.sslKey,a.server_options.sslPass=t.sslPass),a.db_options.promiseLibrary=s.promiseLibrary;var l=a.servers.length,p=0,_=0,d=null,v={};if(0==a.servers.length)throw new Error("connection string must contain at least one seed host");a.db_options.native_parser=_setNativeParser(a.db_options),"boolean"!=typeof a.server_options.auto_reconnect&&(a.server_options.auto_reconnect=!0),a=mergeTopLevel(a,s);for(var u=0;u<a.servers.length;u++){var f=a.server_options.socketOptions||{},m={poolSize:1,socketOptions:{connectTimeoutMS:f.connectTimeoutMS||12e4,socketTimeoutMS:f.socketTimeoutMS||12e4},auto_reconnect:!1};a.server_options.ssl?(m.ssl=a.server_options.ssl,m.sslValidate=a.server_options.sslValidate,m.checkServerIdentity=a.server_options.checkServerIdentity,m.sslCA=a.server_options.sslCA,m.sslCert=a.server_options.sslCert,m.sslKey=a.server_options.sslKey,m.sslPass=a.server_options.sslPass):a.rs_options.ssl&&(m.ssl=a.rs_options.ssl,m.sslValidate=a.rs_options.sslValidate,m.checkServerIdentity=a.rs_options.checkServerIdentity,m.sslCA=a.rs_options.sslCA,m.sslCert=a.rs_options.sslCert,m.sslKey=a.rs_options.sslKey,m.sslPass=a.rs_options.sslPass);var S=null,h=a.servers[u].domain_socket?new Server(a.servers[u].domain_socket,m):new Server(a.servers[u].host,a.servers[u].port,m),b=function(e){new Db(a.dbName,e,{w:1,native_parser:!1,promiseLibrary:s.promiseLibrary}).open(function(r,t){if(l-=1,r)S=r,v[e.host+":"+e.port]=e;else{t.close();var n=t.serverConfig.isMasterDoc;n.setName&&_++,n.msg&&"isdbgrid"==n.msg&&p++}if(0==l){if(0==_&&0==p&&S)return o(S,null);if(p>0&&_>0)return t&&t.close(),process.nextTick(function(){try{o(new Error("cannot combine a list of replicaset seeds and mongos seeds"))}catch(e){throw e}});if(0!=_||0!=p||1!=a.servers.length||a.rs_options.replicaSet&&a.rs_options.rs_name){if(_>0||p>0||a.rs_options.replicaSet||a.rs_options.rs_name){var i=a.servers.filter(function(e){return null==v[e.host+":"+e.port]}).map(function(e){return e.domain_socket?new Server(e.domain_socket,27017,a.server_options):new Server(e.host,e.port,a.server_options)});if(v={},_>0)try{1!=_||a.rs_options.replicaSet||a.rs_options.rs_name?1==_?(a.rs_options.replicaSet=a.rs_options.replicaSet||a.rs_options.rs_name,d=new ReplSet(i,a.rs_options)):d=new ReplSet(i,a.rs_options):d=i[0]}catch(r){return o(r,null)}else d=new Mongos(i,a.mongos_options)}}else{var c=a.servers[0];d=c.domain_socket?new Server(c.domain_socket,a.server_options):new Server(c.host,c.port,a.server_options)}if(null==d)return process.nextTick(function(){try{o(new Error("Could not locate any valid servers in initial seed list"))}catch(e){throw t&&t.close(),e}});d.emitOpen=!1,_finishConnecting(d,a,s,o)}})};b(h)}},_setNativeParser=function(e){if("boolean"==typeof e.native_parser)return e.native_parser;try{return require("mongodb-core").BSON.BSONNative.BSON,!0}catch(s){return!1}},_finishConnecting=function(e,s,o,r){"string"==typeof s.db_options.readPreference?s.db_options.readPreference=new ReadPreference(s.db_options.readPreference):"string"==typeof s.db_options.read_preference&&(s.db_options.readPreference=new ReadPreference(s.db_options.read_preference)),s.db_options.readPreference&&s.db_options.readPreferenceTags?s.db_options.readPreference.tags=s.db_options.readPreferenceTags:s.db_options.readPreference&&s.db_options.read_preference_tags&&(s.db_options.readPreference.tags=s.db_options.read_preference_tags);var t=s.server_options.socketOptions.socketTimeoutMS||0;e instanceof ReplSet&&(t=s.rs_options.socketOptions.socketTimeoutMS||t),e.connectTimeoutMS=e.connectTimeoutMS||3e4,e.socketTimeoutMS=e.connectTimeoutMS;var n=new Db(s.dbName,e,s.db_options);n.open(function(o,n){if(o)return process.nextTick(function(){try{r(e,null)}catch(e){throw n&&n.close(),e}});if(e.socketTimeoutMS=t||0,null==o&&s.auth){var i=n;s.db_options&&s.db_options.authSource&&(i=n.db(s.db_options.authSource));var a={};s.db_options.authMechanism&&(a.authMechanism=s.db_options.authMechanism),s.db_options.gssapiServiceName&&(a.gssapiServiceName=s.db_options.gssapiServiceName),s.db_options.gssapiServiceRealm&&(a.gssapiServiceRealm=s.db_options.gssapiServiceRealm),s.db_options.gssapiCanonicalizeHostName&&(a.gssapiCanonicalizeHostName=s.db_options.gssapiCanonicalizeHostName),i.authenticate(s.auth.user,s.auth.password,a,function(e,o){o?process.nextTick(function(){try{r(null,n)}catch(e){throw n&&n.close(),e}}):(n&&n.close(),process.nextTick(function(){try{r(e?e:new Error("Could not authenticate user "+s.auth[0]),null)}catch(e){throw n&&n.close(),e}}))})}else process.nextTick(function(){try{r(e,n)}catch(e){throw n&&n.close(),e}})})};module.exports=MongoClient;