"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,f=require("util").format,ServerCapabilities=require("./topology_base").ServerCapabilities,MongoCR=require("mongodb-core").MongoCR,MongoError=require("mongodb-core").MongoError,CMongos=require("mongodb-core").Mongos,Cursor=require("./cursor"),AggregationCursor=require("./aggregation_cursor"),CommandCursor=require("./command_cursor"),Define=require("./metadata"),Server=require("./server"),Store=require("./topology_base").Store,shallowClone=require("./utils").shallowClone,MAX_JS_INT=require("./utils").MAX_JS_INT,Mongos=function(e,o){if(!(this instanceof Mongos))return new Mongos(e,o);o=o||{};for(var t=this,s=0;s<e.length;s++)if(!(e[s]instanceof Server))throw MongoError.create({message:"all seed list instances must be of the Server type",driver:!0});var n={force:!1,bufferMaxEntries:-1};-1==n.bufferMaxEntries&&(n.bufferMaxEntries=MAX_JS_INT);var r=o.store||new Store(t,n);EventEmitter.call(this);var i=(o.tag,e.map(function(e){return{host:e.host,port:e.port}})),c=shallowClone(o);c.size="number"==typeof o.poolSize?o.poolSize:5,c.reconnect="boolean"==typeof o.auto_reconnect?o.auto_reconnect:!0,c.emitError="boolean"==typeof o.emitError?o.emitError:!0,c.cursorFactory=Cursor,c.disconnectHandler=r,o.sslCA&&(c.ca=o.sslCA),"boolean"==typeof o.sslValidate&&(c.rejectUnauthorized=o.sslValidate),o.sslKey&&(c.key=o.sslKey),o.sslCert&&(c.cert=o.sslCert),o.sslPass&&(c.passphrase=o.sslPass),o.checkServerIdentity&&(c.checkServerIdentity=o.checkServerIdentity),o.socketOptions&&(o.socketOptions.connectTimeoutMS&&(this.connectTimeoutMS=o.socketOptions.connectTimeoutMS,c.connectionTimeout=o.socketOptions.connectTimeoutMS),o.socketOptions.socketTimeoutMS&&(c.socketTimeout=o.socketOptions.socketTimeoutMS));var a="boolean"==typeof o.debug?o.debug:!1;a&&(c.debug=a),o.socketOptions&&"number"==typeof o.socketOptions.keepAlive&&(c.keepAlive=!0,"number"==typeof o.socketOptions.keepAlive&&(c.keepAliveInitialDelay=o.socketOptions.keepAlive)),o.socketOptions&&"number"==typeof o.socketOptions.connectionTimeout&&(c.connectionTimeout=o.socketOptions.connectionTimeout),o.socketOptions&&"number"==typeof o.socketOptions.socketTimeout&&(c.socketTimeout=o.socketOptions.socketTimeout),o.socketOptions&&"boolean"==typeof o.socketOptions.noDelay&&(c.noDelay=o.socketOptions.noDelay),"number"==typeof o.acceptableLatencyMS&&(c.localThresholdMS=o.acceptableLatencyMS||15),c.disconnectHandler=r;var l=new CMongos(i,c),u=null;l.addAuthProvider("mongocr",new MongoCR),this.s={mongos:l,sCapabilities:u,debug:a,storeOptions:n,clonedOptions:c,store:r,options:o},Object.defineProperty(this,"isMasterDoc",{enumerable:!0,get:function(){return t.s.mongos.lastIsMaster()}}),Object.defineProperty(this,"numberOfConnectedServers",{enumerable:!0,get:function(){return t.s.mongos.s.mongosState.connectedServers().length}}),Object.defineProperty(this,"bson",{enumerable:!0,get:function(){return t.s.mongos.bson}}),Object.defineProperty(this,"haInterval",{enumerable:!0,get:function(){return t.s.mongos.haInterval}})};inherits(Mongos,EventEmitter);var define=Mongos.define=new Define("Mongos",Mongos,!1);Mongos.prototype.connect=function(e,o,t){var s=this;"function"==typeof o&&(t=o,o={}),null==o&&(o={}),"function"!=typeof t&&(t=null),s.s.options=o,s.s.storeOptions.bufferMaxEntries=e.bufferMaxEntries;var n=function(e){return function(e){var o=["timeout","error","close"];o.forEach(function(e){s.removeListener(e,n)}),s.s.mongos.removeListener("connect",n);try{t(e)}catch(e){process.nextTick(function(){throw e})}}},r=function(e){return function(o){"error"!=e&&s.emit(e,o)}},i=function(e){s.emit("reconnect"),s.s.store.execute()},c=function(){["timeout","error","close","serverOpening","serverDescriptionChanged","serverHeartbeatStarted","serverHeartbeatSucceeded","serverHearbeatFailed","serverClosed","topologyOpening","topologyClosed","topologyDescriptionChanged"].forEach(function(e){s.s.mongos.removeAllListeners(e)}),s.s.mongos.once("timeout",r("timeout")),s.s.mongos.once("error",r("error")),s.s.mongos.once("close",r("close"));var e=function(e){return function(o,t){s.emit(e,o,t)}};s.s.mongos.on("serverDescriptionChanged",e("serverDescriptionChanged")),s.s.mongos.on("serverHeartbeatStarted",e("serverHeartbeatStarted")),s.s.mongos.on("serverHeartbeatSucceeded",e("serverHeartbeatSucceeded")),s.s.mongos.on("serverHearbeatFailed",e("serverHearbeatFailed")),s.s.mongos.on("serverOpening",e("serverOpening")),s.s.mongos.on("serverClosed",e("serverClosed")),s.s.mongos.on("topologyOpening",e("topologyOpening")),s.s.mongos.on("topologyClosed",e("topologyClosed")),s.s.mongos.on("topologyDescriptionChanged",e("topologyDescriptionChanged")),s.s.mongos.on("joined",e("joined")),s.s.mongos.on("left",e("left")),s.s.mongos.on("fullsetup",e("fullsetup")),s.emit("open",null,s);try{t(null,s)}catch(o){process.nextTick(function(){throw o})}};s.s.mongos.once("timeout",n("timeout")),s.s.mongos.once("error",n("error")),s.s.mongos.once("close",n("close")),s.s.mongos.once("connect",c),s.s.mongos.on("reconnect",i),s.s.mongos.connect(o)},Mongos.prototype.parserType=function(){return this.s.mongos.parserType()},define.classMethod("parserType",{callback:!1,promise:!1,returns:[String]}),Mongos.prototype.capabilities=function(){return this.s.sCapabilities?this.s.sCapabilities:null==this.s.mongos.lastIsMaster()?null:(this.s.sCapabilities=new ServerCapabilities(this.s.mongos.lastIsMaster()),this.s.sCapabilities)},define.classMethod("capabilities",{callback:!1,promise:!1,returns:[ServerCapabilities]}),Mongos.prototype.command=function(e,o,t,s){this.s.mongos.command(e,o,t,s)},define.classMethod("command",{callback:!0,promise:!1}),Mongos.prototype.insert=function(e,o,t,s){this.s.mongos.insert(e,o,t,function(e,o){s(e,o)})},define.classMethod("insert",{callback:!0,promise:!1}),Mongos.prototype.update=function(e,o,t,s){this.s.mongos.update(e,o,t,s)},define.classMethod("update",{callback:!0,promise:!1}),Mongos.prototype.remove=function(e,o,t,s){this.s.mongos.remove(e,o,t,s)},define.classMethod("remove",{callback:!0,promise:!1}),Mongos.prototype.isDestroyed=function(){return this.s.mongos.isDestroyed()},Mongos.prototype.isConnected=function(){return this.s.mongos.isConnected()},define.classMethod("isConnected",{callback:!1,promise:!1,returns:[Boolean]}),Mongos.prototype.cursor=function(e,o,t){return t.disconnectHandler=this.s.store,this.s.mongos.cursor(e,o,t)},define.classMethod("cursor",{callback:!1,promise:!1,returns:[Cursor,AggregationCursor,CommandCursor]}),Mongos.prototype.setBSONParserType=function(e){return this.s.mongos.setBSONParserType(e)},Mongos.prototype.lastIsMaster=function(){return this.s.mongos.lastIsMaster()},Mongos.prototype.close=function(e){this.s.mongos.destroy(),1==e&&(this.s.storeOptions.force=e,this.s.store.flush())},define.classMethod("close",{callback:!1,promise:!1}),Mongos.prototype.auth=function(){var e=Array.prototype.slice.call(arguments,0);this.s.mongos.auth.apply(this.s.mongos,e)},define.classMethod("auth",{callback:!0,promise:!1}),Mongos.prototype.connections=function(){return this.s.mongos.connections()},define.classMethod("connections",{callback:!1,promise:!1,returns:[Array]}),module.exports=Mongos;