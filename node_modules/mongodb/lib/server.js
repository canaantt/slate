"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,CServer=require("mongodb-core").Server,Cursor=require("./cursor"),AggregationCursor=require("./aggregation_cursor"),CommandCursor=require("./command_cursor"),f=require("util").format,ServerCapabilities=require("./topology_base").ServerCapabilities,Store=require("./topology_base").Store,Define=require("./metadata"),MongoError=require("mongodb-core").MongoError,shallowClone=require("./utils").shallowClone,MAX_JS_INT=require("./utils").MAX_JS_INT,translateOptions=require("./utils").translateOptions,filterOptions=require("./utils").filterOptions,mergeOptions=require("./utils").mergeOptions,os=require("os"),driverVersion=require(__dirname+"/../package.json").version,nodejsversion=f("Node.js %s, %s",process.version,os.endianness()),type=os.type(),name=process.platform,architecture=process.arch,release=os.release(),legalOptionNames=["ha","haInterval","acceptableLatencyMS","poolSize","ssl","checkServerIdentity","sslValidate","sslCA","sslCert","sslKey","sslPass","socketOptions","bufferMaxEntries","store","auto_reconnect","autoReconnect","emitError","keepAlive","noDelay","connectTimeoutMS","socketTimeoutMS","loggerLevel","logger","reconnectTries","reconnectInterval","monitoring","appname","domainsEnabled"],Server=function(e,r,t){if(t=t||{},!(this instanceof Server))return new Server(e,r,t);EventEmitter.call(this);var o=this;t=filterOptions(t,legalOptionNames);var s={force:!1,bufferMaxEntries:"number"==typeof t.bufferMaxEntries?t.bufferMaxEntries:MAX_JS_INT},n=t.store||new Store(o,s);if(-1!=e.indexOf("/"))null!=r&&"object"==typeof r&&(t=r,r=null);else if(null==r)throw MongoError.create({message:"port must be specified",driver:!0});var i="boolean"==typeof t.auto_reconnect?t.auto_reconnect:!0;i="boolean"==typeof t.autoReconnect?t.autoReconnect:i;var c=mergeOptions({},{host:e,port:r,disconnectHandler:n,cursorFactory:Cursor,reconnect:i,emitError:"boolean"==typeof t.emitError?t.emitError:!0,size:"number"==typeof t.poolSize?t.poolSize:5});c=translateOptions(c,t);var a=t.socketOptions&&Object.keys(t.socketOptions).length>0?t.socketOptions:t;c=translateOptions(c,a),"number"==typeof c.keepAlive&&(c.keepAliveInitialDelay=c.keepAlive,c.keepAlive=c.keepAlive>0),this.clientInfo={driver:{name:"nodejs",version:driverVersion},os:{type:type,name:name,architecture:architecture,version:release},platform:nodejsversion},c.clientInfo=this.clientInfo,t.appname&&(c.clientInfo.application={name:t.appname});var l=new CServer(c);this.s={server:l,sCapabilities:null,clonedOptions:c,reconnect:c.reconnect,emitError:c.emitError,poolSize:c.size,storeOptions:s,store:n,host:e,port:r,options:t}};inherits(Server,EventEmitter);var define=Server.define=new Define("Server",Server,!1);Object.defineProperty(Server.prototype,"bson",{enumerable:!0,get:function(){return this.s.server.s.bson}}),Object.defineProperty(Server.prototype,"isMasterDoc",{enumerable:!0,get:function(){return this.s.server.lastIsMaster()}}),Object.defineProperty(Server.prototype,"poolSize",{enumerable:!0,get:function(){return this.s.server.connections().length}}),Object.defineProperty(Server.prototype,"autoReconnect",{enumerable:!0,get:function(){return this.s.reconnect}}),Object.defineProperty(Server.prototype,"host",{enumerable:!0,get:function(){return this.s.host}}),Object.defineProperty(Server.prototype,"port",{enumerable:!0,get:function(){return this.s.port}}),Server.prototype.connect=function(e,r,t){var o=this;"function"==typeof r&&(t=r,r={}),null==r&&(r={}),"function"!=typeof t&&(t=null),o.s.options=r,o.s.storeOptions.bufferMaxEntries=e.bufferMaxEntries;var s=function(e){return function(e){var r=["timeout","error","close"];r.forEach(function(e){o.s.server.removeListener(e,p[e])}),o.s.server.removeListener("connect",s);try{t(e)}catch(e){process.nextTick(function(){throw e})}}},n=function(e){return function(r){"error"!=e&&o.emit(e,r)}},i=function(e){o.emit("reconnect",o),o.s.store.execute()},c=function(e){o.emit("reconnectFailed",e),o.s.store.flush(e)},a=function(){o.s.store.flush()},l=function(){["timeout","error","close","serverOpening","serverDescriptionChanged","serverHeartbeatStarted","serverHeartbeatSucceeded","serverHearbeatFailed","serverClosed","topologyOpening","topologyClosed","topologyDescriptionChanged"].forEach(function(e){o.s.server.removeAllListeners(e)}),o.s.server.once("timeout",n("timeout")),o.s.server.once("error",n("error")),o.s.server.on("close",n("close")),o.s.server.once("destroy",a);var e=function(e){return function(r,t){o.emit(e,r,t)}};o.s.server.on("serverDescriptionChanged",e("serverDescriptionChanged")),o.s.server.on("serverHeartbeatStarted",e("serverHeartbeatStarted")),o.s.server.on("serverHeartbeatSucceeded",e("serverHeartbeatSucceeded")),o.s.server.on("serverHearbeatFailed",e("serverHearbeatFailed")),o.s.server.on("serverOpening",e("serverOpening")),o.s.server.on("serverClosed",e("serverClosed")),o.s.server.on("topologyOpening",e("topologyOpening")),o.s.server.on("topologyClosed",e("topologyClosed")),o.s.server.on("topologyDescriptionChanged",e("topologyDescriptionChanged")),o.s.server.on("attemptReconnect",e("attemptReconnect")),o.s.server.on("monitoring",e("monitoring")),o.emit("open",null,o);try{t(null,o)}catch(r){console.log(r.stack),process.nextTick(function(){throw r})}},p={timeout:s("timeout"),error:s("error"),close:s("close")};o.s.server.once("timeout",p.timeout),o.s.server.once("error",p.error),o.s.server.once("close",p.close),o.s.server.once("connect",l),o.s.server.on("reconnect",i),o.s.server.on("reconnectFailed",c),o.s.server.connect(r)},Server.prototype.capabilities=function(){return this.s.sCapabilities?this.s.sCapabilities:null==this.s.server.lastIsMaster()?null:(this.s.sCapabilities=new ServerCapabilities(this.s.server.lastIsMaster()),this.s.sCapabilities)},define.classMethod("capabilities",{callback:!1,promise:!1,returns:[ServerCapabilities]}),Server.prototype.command=function(e,r,t,o){this.s.server.command(e,r,t,o)},define.classMethod("command",{callback:!0,promise:!1}),Server.prototype.insert=function(e,r,t,o){this.s.server.insert(e,r,t,o)},define.classMethod("insert",{callback:!0,promise:!1}),Server.prototype.update=function(e,r,t,o){this.s.server.update(e,r,t,o)},define.classMethod("update",{callback:!0,promise:!1}),Server.prototype.remove=function(e,r,t,o){this.s.server.remove(e,r,t,o)},define.classMethod("remove",{callback:!0,promise:!1}),Server.prototype.isConnected=function(){return this.s.server.isConnected()},Server.prototype.isDestroyed=function(){return this.s.server.isDestroyed()},define.classMethod("isConnected",{callback:!1,promise:!1,returns:[Boolean]}),Server.prototype.cursor=function(e,r,t){return t.disconnectHandler=this.s.store,this.s.server.cursor(e,r,t)},define.classMethod("cursor",{callback:!1,promise:!1,returns:[Cursor,AggregationCursor,CommandCursor]}),Server.prototype.lastIsMaster=function(){return this.s.server.lastIsMaster()},Server.prototype.unref=function(){this.s.server.unref()},Server.prototype.close=function(e){this.s.server.destroy(),1==e&&(this.s.storeOptions.force=e,this.s.store.flush())},define.classMethod("close",{callback:!1,promise:!1}),Server.prototype.auth=function(){var e=Array.prototype.slice.call(arguments,0);this.s.server.auth.apply(this.s.server,e)},define.classMethod("auth",{callback:!0,promise:!1}),Server.prototype.logout=function(){var e=Array.prototype.slice.call(arguments,0);this.s.server.logout.apply(this.s.server,e)},define.classMethod("logout",{callback:!0,promise:!1}),Server.prototype.connections=function(){return this.s.server.connections()},define.classMethod("connections",{callback:!1,promise:!1,returns:[Array]}),module.exports=Server;