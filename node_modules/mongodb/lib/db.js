"use strict";function decorateWithWriteConcern(e,r,n){if(r.s.topology.capabilities().commandsTakeWriteConcern){var o=writeConcern(shallowClone(n),r,n);o.writeConcern&&(e.writeConcern=o.writeConcern)}}var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,getSingleProperty=require("./utils").getSingleProperty,shallowClone=require("./utils").shallowClone,parseIndexOptions=require("./utils").parseIndexOptions,debugOptions=require("./utils").debugOptions,CommandCursor=require("./command_cursor"),handleCallback=require("./utils").handleCallback,filterOptions=require("./utils").filterOptions,toError=require("./utils").toError,ReadPreference=require("./read_preference"),f=require("util").format,Admin=require("./admin"),Code=require("mongodb-core").BSON.Code,CoreReadPreference=require("mongodb-core").ReadPreference,MongoError=require("mongodb-core").MongoError,ObjectID=require("mongodb-core").ObjectID,Define=require("./metadata"),Logger=require("mongodb-core").Logger,Collection=require("./collection"),crypto=require("crypto"),assign=require("./utils").assign,debugFields=["authSource","w","wtimeout","j","native_parser","forceServerObjectId","serializeFunctions","raw","promoteLongs","bufferMaxEntries","numberOfRetries","retryMiliSeconds","readPreference","pkFactory","parentDb","promiseLibrary","noListener"],legalOptionNames=["w","wtimeout","fsync","j","readPreference","readPreferenceTags","native_parser","forceServerObjectId","pkFactory","serializeFunctions","raw","bufferMaxEntries","authSource","ignoreUndefined","promoteLongs","promiseLibrary","readConcern","retryMiliSeconds","numberOfRetries","parentDb","noListener","loggerLevel","logger","collation"],Db=function(e,r,n){if(n=n||{},!(this instanceof Db))return new Db(e,r,n);EventEmitter.call(this);var o=this,t=n.promiseLibrary;t||(t="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),n=filterOptions(n,legalOptionNames),n.promiseLibrary=t,this.s={databaseName:e,dbCache:{},children:[],topology:r,options:n,logger:Logger("Db",n),bson:r?r.bson:null,authSource:n.authSource,readPreference:n.readPreference,bufferMaxEntries:"number"==typeof n.bufferMaxEntries?n.bufferMaxEntries:-1,parentDb:n.parentDb||null,pkFactory:n.pkFactory||ObjectID,nativeParser:n.nativeParser||n.native_parser,promiseLibrary:t,noListener:"boolean"==typeof n.noListener?n.noListener:!1,readConcern:n.readConcern,collation:n.collation},validateDatabaseName(o.s.databaseName),getSingleProperty(this,"serverConfig",o.s.topology),getSingleProperty(this,"bufferMaxEntries",o.s.bufferMaxEntries),getSingleProperty(this,"databaseName",o.s.databaseName),n.parentDb||this.s.noListener||(r.on("error",createListener(o,"error",o)),r.on("timeout",createListener(o,"timeout",o)),r.on("close",createListener(o,"close",o)),r.on("parseError",createListener(o,"parseError",o)),r.once("open",createListener(o,"open",o)),r.once("fullsetup",createListener(o,"fullsetup",o)),r.once("all",createListener(o,"all",o)),r.on("reconnect",createListener(o,"reconnect",o)))};inherits(Db,EventEmitter);var define=Db.define=new Define("Db",Db,!1);Object.defineProperty(Db.prototype,"topology",{enumerable:!0,get:function(){return this.s.topology}}),Object.defineProperty(Db.prototype,"options",{enumerable:!0,get:function(){return this.s.options}}),Object.defineProperty(Db.prototype,"slaveOk",{enumerable:!0,get:function(){return null==this.s.options.readPreference||"primary"==this.s.options.readPreference&&"primary"==this.s.options.readPreference.mode?!1:!0}}),Object.defineProperty(Db.prototype,"writeConcern",{enumerable:!0,get:function(){var e={};return null!=this.s.options.w&&(e.w=this.s.options.w),null!=this.s.options.j&&(e.j=this.s.options.j),null!=this.s.options.fsync&&(e.fsync=this.s.options.fsync),null!=this.s.options.wtimeout&&(e.wtimeout=this.s.options.wtimeout),e}});var open=function(e,r){e.s.topology.connect(e,e.s.options,function(n,o){if(null!=r){var t=r;return n?(e.close(),t(n)):void t(null,e)}})};Db.prototype.open=function(e){var r=this;return"function"==typeof e?open(r,e):new r.s.promiseLibrary(function(e,n){open(r,function(r,o){return r?n(r):void e(o)})})},define.classMethod("open",{callback:!0,promise:!0});var convertReadPreference=function(e){if(e&&"string"==typeof e)return new CoreReadPreference(e);if(e instanceof ReadPreference)return new CoreReadPreference(e.mode,e.tags,{maxStalenessMS:e.maxStalenessMS});if(e&&"object"==typeof e){var r=e.mode||e.preference;r&&"string"==typeof r&&(e=new CoreReadPreference(r,e.tags,{maxStalenessMS:e.maxStalenessMS}))}return e},executeCommand=function(e,r,n,o){if(e.serverConfig&&e.serverConfig.isDestroyed())return o(new MongoError("topology was destroyed"));var t=n.dbName||n.authdb||e.s.databaseName;null==n.readPreference&&e.s.readPreference&&(n.readPreference=e.s.readPreference),n.readPreference?n.readPreference=convertReadPreference(n.readPreference):n.readPreference=CoreReadPreference.primary,e.s.logger.isDebug()&&e.s.logger.debug(f("executing command %s against %s with options [%s]",JSON.stringify(r),f("%s.$cmd",t),JSON.stringify(debugOptions(debugFields,n)))),e.s.topology.command(f("%s.$cmd",t),r,n,function(e,r){return e?handleCallback(o,e):n.full?handleCallback(o,null,r):void handleCallback(o,null,r.result)})};Db.prototype.command=function(e,r,n){var o=this;return"function"==typeof r&&(n=r,r={}),r=shallowClone(r),"function"==typeof n?executeCommand(o,e,r,n):new this.s.promiseLibrary(function(n,t){executeCommand(o,e,r,function(e,r){return e?t(e):void n(r)})})},define.classMethod("command",{callback:!0,promise:!0}),Db.prototype.close=function(e,r){"function"==typeof e&&(r=e,e=!1),this.s.topology.close(e);var n=this;if(this.listeners("close").length>0){if(this.emit("close"),null==this.parentDb)for(var o=0;o<this.s.children.length;o++)this.s.children[o].emit("close");n.removeAllListeners("close")}return this.s.parentDb&&this.s.parentDb.close(),"function"==typeof r?process.nextTick(function(){handleCallback(r,null)}):new this.s.promiseLibrary(function(e,r){e()})},define.classMethod("close",{callback:!0,promise:!0}),Db.prototype.admin=function(){return new Admin(this,this.s.topology,this.s.promiseLibrary)},define.classMethod("admin",{callback:!1,promise:!1,returns:[Admin]}),Db.prototype.collection=function(e,r,n){var o=this;if("function"==typeof r&&(n=r,r={}),r=r||{},r=shallowClone(r),r.promiseLibrary=this.s.promiseLibrary,r.readConcern=r.readConcern||this.s.readConcern,!r.collation&&this.s.collation&&"object"==typeof this.s.collation&&(r.collation=this.s.collation),this.s.options.ignoreUndefined&&(r.ignoreUndefined=this.s.options.ignoreUndefined),null==r||!r.strict)try{var t=new Collection(this,this.s.topology,this.s.databaseName,e,this.s.pkFactory,r);return n&&n(null,t),t}catch(a){if(n)return n(a);throw a}if("function"!=typeof n)throw toError(f("A callback is required in strict mode. While getting collection %s.",e));return o.serverConfig&&o.serverConfig.isDestroyed()?n(new MongoError("topology was destroyed")):void this.listCollections({name:e}).toArray(function(t,a){if(null!=t)return handleCallback(n,t,null);if(0==a.length)return handleCallback(n,toError(f("Collection %s does not exist. Currently in strict mode.",e)),null);try{return handleCallback(n,null,new Collection(o,o.s.topology,o.s.databaseName,e,o.s.pkFactory,r))}catch(t){return handleCallback(n,t,null)}})},define.classMethod("collection",{callback:!0,promise:!1,returns:[Collection]});var createCollection=function(e,r,n,o){var t=writeConcern(shallowClone(n),e,n);return e.serverConfig&&e.serverConfig.isDestroyed()?o(new MongoError("topology was destroyed")):void e.listCollections({name:r}).setReadPreference(ReadPreference.PRIMARY).toArray(function(a,i){if(null!=a)return handleCallback(o,a,null);if(i.length>0&&t.strict)return handleCallback(o,MongoError.create({message:f("Collection %s already exists. Currently in strict mode.",r),driver:!0}),null);if(i.length>0)try{return handleCallback(o,null,new Collection(e,e.s.topology,e.s.databaseName,r,e.s.pkFactory,n))}catch(a){return handleCallback(o,a)}var s={create:r};decorateWithWriteConcern(s,e,n);for(var l in n)null!=n[l]&&"function"!=typeof n[l]&&(s[l]=n[l]);t.readPreference=ReadPreference.PRIMARY,e.command(s,t,function(t,a){return t?handleCallback(o,t):void handleCallback(o,null,new Collection(e,e.s.topology,e.s.databaseName,r,e.s.pkFactory,n))})})};Db.prototype.createCollection=function(e,r,n){var o=this,t=Array.prototype.slice.call(arguments,0);return n=t.pop(),"function"!=typeof n&&t.push(n),e=t.length?t.shift():null,r=t.length?t.shift()||{}:{},r.promiseLibrary=r.promiseLibrary||this.s.promiseLibrary,"string"==typeof n&&(e=n),"function"==typeof n?createCollection(o,e,r,n):new this.s.promiseLibrary(function(n,t){createCollection(o,e,r,function(e,r){return e?t(e):void n(r)})})},define.classMethod("createCollection",{callback:!0,promise:!0}),Db.prototype.stats=function(e,r){"function"==typeof e&&(r=e,e={}),e=e||{};var n={dbStats:!0};return null!=e.scale&&(n.scale=e.scale),null==e.readPreference&&this.s.readPreference&&(e.readPreference=this.s.readPreference),this.command(n,e,r)},define.classMethod("stats",{callback:!0,promise:!0});var listCollectionsTranforms=function(e){var r=f("%s.",e);return{doc:function(e){var n=e.name.indexOf(r);return e.name&&0==n&&(e.name=e.name.substr(n+r.length)),e}}};Db.prototype.listCollections=function(e,r){if(e=e||{},r=r||{},r=shallowClone(r),r.promiseLibrary=this.s.promiseLibrary,r.readPreference&&(r.readPreference=convertReadPreference(r.readPreference)),this.serverConfig.capabilities().hasListCollectionsCommand){var n=r.batchSize?{batchSize:r.batchSize}:{},o={listCollections:!0,filter:e,cursor:n};r.cursorFactory=CommandCursor;var n=this.s.topology.cursor(f("%s.$cmd",this.s.databaseName),o,r);return r.readPreference&&n.setReadPreference(r.readPreference),n}this.serverConfig.capabilities().hasListCollectionsCommand||"string"!=typeof e.name||new RegExp("^"+this.databaseName+"\\.").test(e.name)||(e=shallowClone(e),e.name=f("%s.%s",this.s.databaseName,e.name)),null==e&&(e.name=f("/%s/",this.s.databaseName)),e=e.name?{$and:[{name:e.name},{name:/^((?!\$).)*$/}]}:{name:/^((?!\$).)*$/};var t={transforms:listCollectionsTranforms(this.s.databaseName)},n=this.collection(Db.SYSTEM_NAMESPACE_COLLECTION).find(e,t);return r.readPreference&&n.setReadPreference(r.readPreference),r.batchSize&&(n=n.batchSize(r.batchSize)),n},define.classMethod("listCollections",{callback:!1,promise:!1,returns:[CommandCursor]});var evaluate=function(e,r,n,o,t){var a=r,i=[];if(e.serverConfig&&e.serverConfig.isDestroyed())return t(new MongoError("topology was destroyed"));a instanceof Code||(a=new Code(a)),null==n||Array.isArray(n)||"function"==typeof n?null!=n&&Array.isArray(n)&&"function"!=typeof n&&(i=n):i=[n];var s={$eval:a,args:i};o.nolock&&(s.nolock=o.nolock),o.readPreference=new CoreReadPreference(ReadPreference.PRIMARY),e.command(s,o,function(e,r){return e?handleCallback(t,e,null):r&&1==r.ok?handleCallback(t,null,r.retval):r?handleCallback(t,MongoError.create({message:f("eval failed: %s",r.errmsg),driver:!0}),null):void handleCallback(t,e,r)})};Db.prototype.eval=function(e,r,n,o){var t=this,a=Array.prototype.slice.call(arguments,1);return o=a.pop(),"function"!=typeof o&&a.push(o),r=a.length?a.shift():r,n=a.length?a.shift()||{}:{},"function"==typeof o?evaluate(t,e,r,n,o):new this.s.promiseLibrary(function(o,a){evaluate(t,e,r,n,function(e,r){return e?a(e):void o(r)})})},define.classMethod("eval",{callback:!0,promise:!0}),Db.prototype.renameCollection=function(e,r,n,o){var t=this;return"function"==typeof n&&(o=n,n={}),n=n||{},n.new_collection=!0,"function"==typeof o?this.collection(e).rename(r,n,o):new this.s.promiseLibrary(function(o,a){t.collection(e).rename(r,n,function(e,r){return e?a(e):void o(r)})})},define.classMethod("renameCollection",{callback:!0,promise:!0}),Db.prototype.dropCollection=function(e,r,n){var o=this;"function"==typeof r&&(n=r,r={}),r=r||{};var t={drop:e};if(decorateWithWriteConcern(t,o,r),r=assign({},this.s.options,{readPreference:ReadPreference.PRIMARY}),"function"==typeof n)return this.command(t,r,function(e,r){return o.serverConfig&&o.serverConfig.isDestroyed()?n(new MongoError("topology was destroyed")):e?handleCallback(n,e):r.ok?handleCallback(n,null,!0):void handleCallback(n,null,!1)});var r=shallowClone(o.s.options);return r.readPreference=ReadPreference.PRIMARY,new this.s.promiseLibrary(function(e,n){o.command(t,r,function(r,t){return o.serverConfig&&o.serverConfig.isDestroyed()?n(new MongoError("topology was destroyed")):r?n(r):t.ok?e(!0):void e(!1)})})},define.classMethod("dropCollection",{callback:!0,promise:!0}),Db.prototype.dropDatabase=function(e,r){var n=this;"function"==typeof e&&(r=e,e={});var o={dropDatabase:1};decorateWithWriteConcern(o,n,e);var e=assign({},this.s.options,{readPreference:ReadPreference.PRIMARY});return"function"==typeof r?this.command(o,e,function(e,o){if(n.serverConfig&&n.serverConfig.isDestroyed())return r(new MongoError("topology was destroyed"));if(null!=r)return e?handleCallback(r,e,null):void handleCallback(r,null,o.ok?!0:!1)}):new this.s.promiseLibrary(function(r,t){n.command(o,e,function(e,o){return n.serverConfig&&n.serverConfig.isDestroyed()?t(new MongoError("topology was destroyed")):e?t(e):o.ok?r(!0):void r(!1)})})},define.classMethod("dropDatabase",{callback:!0,promise:!0});var collections=function(e,r){e.listCollections().toArray(function(n,o){return null!=n?handleCallback(r,n,null):(o=o.filter(function(e){return-1==e.name.indexOf("$")}),void handleCallback(r,null,o.map(function(r){return new Collection(e,e.s.topology,e.s.databaseName,r.name.replace(e.s.databaseName+".",""),e.s.pkFactory,e.s.options)})))})};Db.prototype.collections=function(e){var r=this;return"function"==typeof e?collections(r,e):new r.s.promiseLibrary(function(e,n){collections(r,function(r,o){return r?n(r):void e(o)})})},define.classMethod("collections",{callback:!0,promise:!0}),Db.prototype.executeDbAdminCommand=function(e,r,n){var o=this;return"function"==typeof r&&(n=r,r={}),r=r||{},"function"==typeof n?(r.readPreference&&(r.readPreference=convertReadPreference(r.readPreference)),o.s.topology.command("admin.$cmd",e,r,function(e,r){return o.serverConfig&&o.serverConfig.isDestroyed()?n(new MongoError("topology was destroyed")):e?handleCallback(n,e):void handleCallback(n,null,r.result)})):new o.s.promiseLibrary(function(n,t){o.s.topology.command("admin.$cmd",e,r,function(e,r){return o.serverConfig&&o.serverConfig.isDestroyed()?t(new MongoError("topology was destroyed")):e?t(e):void n(r.result)})})},define.classMethod("executeDbAdminCommand",{callback:!0,promise:!0}),Db.prototype.createIndex=function(e,r,n,o){var t=this,a=Array.prototype.slice.call(arguments,2);return o=a.pop(),"function"!=typeof o&&a.push(o),n=a.length?a.shift()||{}:{},n="function"==typeof o?n:o,n=null==n?{}:n,n=shallowClone(n),n.readPreference=ReadPreference.PRIMARY,"function"==typeof o?createIndex(t,e,r,n,o):new this.s.promiseLibrary(function(o,a){createIndex(t,e,r,n,function(e,r){return e?a(e):void o(r)})})};var createIndex=function(e,r,n,o,t){var a=writeConcern({},e,o);if(a.writeConcern&&"function"!=typeof t)throw MongoError.create({message:"Cannot use a writeConcern without a provided callback",driver:!0});return e.serverConfig&&e.serverConfig.isDestroyed()?t(new MongoError("topology was destroyed")):void createIndexUsingCreateIndexes(e,r,n,o,function(i,s){if(null==i)return handleCallback(t,i,s);if(67===i.code||11e3==i.code)return handleCallback(t,i,s);var l=createCreateIndexCommand(e,r,n,o);a.checkKeys=!1,e.s.topology.insert(f("%s.%s",e.s.databaseName,Db.SYSTEM_INDEX_COLLECTION),l,a,function(e,r){return null!=t?e?handleCallback(t,e):null==r?handleCallback(t,null,null):r.result.writeErrors?handleCallback(t,MongoError.create(r.result.writeErrors[0]),null):void handleCallback(t,null,l.name):void 0})})};define.classMethod("createIndex",{callback:!0,promise:!0}),Db.prototype.ensureIndex=function(e,r,n,o){var t=this;return"function"==typeof n&&(o=n,n={}),n=n||{},"function"==typeof o?ensureIndex(t,e,r,n,o):new this.s.promiseLibrary(function(o,a){ensureIndex(t,e,r,n,function(e,r){return e?a(e):void o(r)})})};var ensureIndex=function(e,r,n,o,t){var a=writeConcern({},e,o),i=createCreateIndexCommand(e,r,n,o),s=i.name;if(e.serverConfig&&e.serverConfig.isDestroyed())return t(new MongoError("topology was destroyed"));e.indexInformation(r,a,function(a,i){if(null!=a&&26!=a.code)return handleCallback(t,a,null);if(null!=i&&i[s]){if("function"==typeof t)return handleCallback(t,null,s)}else e.createIndex(r,n,o,t)})};define.classMethod("ensureIndex",{callback:!0,promise:!0}),Db.prototype.addChild=function(e){return this.s.parentDb?this.s.parentDb.addChild(e):void this.s.children.push(e)},Db.prototype.db=function(e,r){r=r||{};var n=assign({},this.options,r);if(this.s.dbCache[e]&&n.returnNonCachedInstance!==!0)return this.s.dbCache[e];(null==n.noListener||0==n.noListener)&&(n.parentDb=this),n.promiseLibrary=this.s.promiseLibrary;var o=new Db(e,this.s.topology,n);return(null==n.noListener||0==n.noListener)&&this.addChild(o),this.s.dbCache[e]=o,o},define.classMethod("db",{callback:!1,promise:!1,returns:[Db]});var _executeAuthCreateUserCommand=function(e,r,n,o,t){if("string"==typeof r&&null!=n&&"object"==typeof n&&(o=n,n=null),"function"==typeof o&&(t=o,o={}),null!=o.digestPassword)throw toError("The digestPassword option is not supported via add_user. Please use db.command('createUser', ...) instead for this option.");var a=null!=o.customData?o.customData:{},i=Array.isArray(o.roles)?o.roles:[],s="number"==typeof o.maxTimeMS?o.maxTimeMS:null;0==i.length&&console.log("Creating a user without roles is deprecated in MongoDB >= 2.6");var l={writeCommand:!0};o.dbName&&(l.dbName=o.dbName),null!=s&&(l.maxTimeMS=s),"admin"!=e.databaseName.toLowerCase()&&"admin"!=o.dbName||Array.isArray(o.roles)?Array.isArray(o.roles)||(i=["dbOwner"]):i=["root"];var c={createUser:r,customData:a,roles:i,digestPassword:!1};c=writeConcern(c,e,o);var u=crypto.createHash("md5");u.update(r+":mongo:"+n);var d=u.digest("hex");"string"==typeof n&&(c.pwd=d),l.readPreference=ReadPreference.primary,e.command(c,l,function(e,n){return e&&0==e.ok&&void 0==e.code?handleCallback(t,{code:-5e3},null):e?handleCallback(t,e,null):void handleCallback(t,n.ok?null:toError(n),n.ok?[{user:r,pwd:""}]:null)})},addUser=function(e,r,n,o,t){return e.serverConfig&&e.serverConfig.isDestroyed()?t(new MongoError("topology was destroyed")):void _executeAuthCreateUserCommand(e,r,n,o,function(a,i){if(a&&-5e3==a.code){var s=writeConcern(shallowClone(o),e,o),l=crypto.createHash("md5");l.update(r+":mongo:"+n);var c=l.digest("hex"),u=o.dbName?e.db(o.dbName):e,d=u.collection(Db.SYSTEM_USER_COLLECTION);return void d.count({},function(e,n){return null!=e?handleCallback(t,e,null):void d.find({user:r},{dbName:o.dbName}).toArray(function(e,o){return null!=e?handleCallback(t,e,null):(s.upsert=!0,void d.update({user:r},{$set:{user:r,pwd:c}},s,function(e,o,a){return 0==n&&e?handleCallback(t,null,[{user:r,pwd:c}]):e?handleCallback(t,e,null):void handleCallback(t,null,[{user:r,pwd:c}])}))})})}return a?handleCallback(t,a):void handleCallback(t,a,i)})};Db.prototype.addUser=function(e,r,n,o){var t=this,a=Array.prototype.slice.call(arguments,2);return o=a.pop(),"function"!=typeof o&&a.push(o),n=a.length?a.shift()||{}:{},"function"==typeof o?addUser(t,e,r,n,o):new this.s.promiseLibrary(function(o,a){addUser(t,e,r,n,function(e,r){return e?a(e):void o(r)})})},define.classMethod("addUser",{callback:!0,promise:!0});var _executeAuthRemoveUserCommand=function(e,r,n,o){if("function"==typeof n&&(o=n,n={}),e.serverConfig&&e.serverConfig.isDestroyed())return o(new MongoError("topology was destroyed"));var t={writeCommand:!0};n.dbName&&(t.dbName=n.dbName);var a="number"==typeof n.maxTimeMS?n.maxTimeMS:null;null!=a&&(t.maxTimeMS=a);var i={dropUser:r};i=writeConcern(i,e,n),t.readPreference=ReadPreference.primary,e.command(i,t,function(e,r){return e&&!e.ok&&void 0==e.code?handleCallback(o,{code:-5e3}):e?handleCallback(o,e,null):void handleCallback(o,null,r.ok?!0:!1)})},removeUser=function(e,r,n,o){_executeAuthRemoveUserCommand(e,r,n,function(t,a){if(t&&-5e3==t.code){var i=writeConcern(shallowClone(n),e,n),s=n.dbName?e.db(n.dbName):e,l=s.collection(Db.SYSTEM_USER_COLLECTION);return void l.findOne({user:r},{},function(e,n){return null==n?handleCallback(o,e,!1):void l.remove({user:r},i,function(e,r){handleCallback(o,e,!0)})})}return t?handleCallback(o,t):void handleCallback(o,t,a)})};define.classMethod("removeUser",{callback:!0,promise:!0}),Db.prototype.removeUser=function(e,r,n){var o=this,t=Array.prototype.slice.call(arguments,1);return n=t.pop(),"function"!=typeof n&&t.push(n),r=t.length?t.shift()||{}:{},"function"==typeof n?removeUser(o,e,r,n):new this.s.promiseLibrary(function(n,t){removeUser(o,e,r,function(e,r){return e?t(e):void n(r)})})};var authenticate=function(e,r,n,o,t){if(e.serverConfig&&e.serverConfig.isDestroyed())return t(new MongoError("topology was destroyed"));var a=o.authdb?o.authdb:o.dbName;a=o.authSource?o.authSource:a,a=a?a:e.databaseName;var i=function(r,n){e.listeners("authenticated").length>0&&e.emit("authenticated",r,n),handleCallback(t,r,n)},s=o.authMechanism||"";s=s.toUpperCase(),"MONGODB-CR"==s?e.s.topology.auth("mongocr",a,r,n,function(e,r){return e?handleCallback(t,e,!1):void i(null,!0)}):"PLAIN"==s?e.s.topology.auth("plain",a,r,n,function(e,r){return e?handleCallback(t,e,!1):void i(null,!0)}):"MONGODB-X509"==s?e.s.topology.auth("x509",a,r,n,function(e,r){return e?handleCallback(t,e,!1):void i(null,!0)}):"SCRAM-SHA-1"==s?e.s.topology.auth("scram-sha-1",a,r,n,function(e,r){return e?handleCallback(t,e,!1):void i(null,!0)}):"GSSAPI"==s?"win32"==process.platform?e.s.topology.auth("sspi",a,r,n,o,function(e,r){return e?handleCallback(t,e,!1):void i(null,!0)}):e.s.topology.auth("gssapi",a,r,n,o,function(e,r){return e?handleCallback(t,e,!1):void i(null,!0)}):"DEFAULT"==s?e.s.topology.auth("default",a,r,n,function(e,r){return e?handleCallback(t,e,!1):void i(null,!0)}):handleCallback(t,MongoError.create({message:f("authentication mechanism %s not supported",o.authMechanism),driver:!0}))};Db.prototype.authenticate=function(e,r,n,o){"function"==typeof n&&(o=n,n={});var t=this;if(n=shallowClone(n),n.authMechanism){if("GSSAPI"!=n.authMechanism&&"DEFAULT"!=n.authMechanism&&"MONGODB-CR"!=n.authMechanism&&"MONGODB-X509"!=n.authMechanism&&"SCRAM-SHA-1"!=n.authMechanism&&"PLAIN"!=n.authMechanism)return handleCallback(o,MongoError.create({message:"only DEFAULT, GSSAPI, PLAIN, MONGODB-X509, SCRAM-SHA-1 or MONGODB-CR is supported by authMechanism",driver:!0}))}else n.authMechanism="DEFAULT";return"function"==typeof o?authenticate(t,e,r,n,function(e,r){return e&&e.message&&-1!=e.message.indexOf("saslStart")&&(e.code=59),e?o(e,r):void o(null,r)}):new this.s.promiseLibrary(function(o,a){authenticate(t,e,r,n,function(e,r){return e&&e.message&&-1!=e.message.indexOf("saslStart")&&(e.code=59),e?a(e):void o(r)})})},define.classMethod("authenticate",{callback:!0,promise:!0}),Db.prototype.logout=function(e,r){var n=this;"function"==typeof e&&(r=e,e={}),e=e||{};var o=this.s.authSource?this.s.authSource:this.s.databaseName;return o=e.dbName?e.dbName:o,"function"==typeof r?n.s.topology.logout(o,function(e,n){return e?r(e):void r(null,!0)}):new this.s.promiseLibrary(function(e,r){n.s.topology.logout(o,function(n,o){return n?r(n):void e(!0)})})},define.classMethod("logout",{callback:!0,promise:!0});var getReadPreference=function(e,r){return e.readPreference?e:(r.readPreference&&(e.readPreference=r.readPreference),e)};Db.prototype.indexInformation=function(e,r,n){var o=this;return"function"==typeof r&&(n=r,r={}),r=r||{},"function"==typeof n?indexInformation(o,e,r,n):new this.s.promiseLibrary(function(n,t){indexInformation(o,e,r,function(e,r){return e?t(e):void n(r)})})};var indexInformation=function(e,r,n,o){var t=null==n.full?!1:n.full;if(e.serverConfig&&e.serverConfig.isDestroyed())return o(new MongoError("topology was destroyed"));var a=function(e){for(var r={},n=0;n<e.length;n++){var o=e[n];r[o.name]=[];for(var t in o.key)r[o.name].push([t,o.key[t]])}return r};e.collection(r).listIndexes().toArray(function(e,r){return e?o(toError(e)):Array.isArray(r)?t?handleCallback(o,null,r):void handleCallback(o,null,a(r)):handleCallback(o,null,[])})};define.classMethod("indexInformation",{callback:!0,promise:!0});var createCreateIndexCommand=function(e,r,n,o){var t=parseIndexOptions(n),a=t.fieldHash,i=(t.keys,"string"==typeof o.name?o.name:t.name),s={ns:e.databaseName+"."+r,key:a,name:i},l=null==o||"object"==typeof o?!1:o;o=null==o||"boolean"==typeof o?{}:o;var c=Object.keys(s);for(var u in o)-1==c.indexOf(u)&&(s[u]=o[u]);null==s.unique&&(s.unique=l);for(var d=["w","wtimeout","j","fsync","readPreference"],f=0;f<d.length;f++)delete s[d[f]];return s},createIndexUsingCreateIndexes=function(e,r,n,o,t){var a=parseIndexOptions(n),i="string"==typeof o.name?o.name:a.name,s=[{name:i,key:a.fieldHash}],l=Object.keys(s[0]);for(var c in o){-1==l.indexOf(c)&&(s[0][c]=o[c]);for(var u=["w","wtimeout","j","fsync","readPreference"],d=0;d<u.length;d++)delete s[0][u[d]]}var p=e.s.topology.capabilities();if(s[0].collation&&p&&!p.commandsTakeCollation){var m=new MongoError(f("server/primary/mongos does not support collation"));return m.code=67,t(m)}var h=writeConcern({createIndexes:r,indexes:s},e,o);decorateWithWriteConcern(h,e,o),o.readPreference=ReadPreference.PRIMARY,e.command(h,o,function(e,r){return e?handleCallback(t,e,null):0==r.ok?handleCallback(t,toError(r),null):void handleCallback(t,null,i)})},validateDatabaseName=function(e){if("string"!=typeof e)throw MongoError.create({message:"database name must be a string",driver:!0});if(0===e.length)throw MongoError.create({message:"database name cannot be the empty string",driver:!0});if("$external"!=e)for(var r=[" ",".","$","/","\\"],n=0;n<r.length;n++)if(-1!=e.indexOf(r[n]))throw MongoError.create({message:"database names cannot contain the character '"+r[n]+"'",driver:!0})},writeConcern=function(e,r,n){if(null!=n.w||null!=n.j||null!=n.fsync){var o={};n.w&&(o.w=n.w),n.wtimeout&&(o.wtimeout=n.wtimeout),n.j&&(o.j=n.j),n.fsync&&(o.fsync=n.fsync),e.writeConcern=o}else(null!=r.writeConcern.w||null!=r.writeConcern.j||null!=r.writeConcern.fsync)&&(e.writeConcern=r.writeConcern);return e},createListener=function(e,r,n){var o=function(o){if(n.listeners(r).length>0){n.emit(r,o,e);for(var t=0;t<e.s.children.length;t++)e.s.children[t].emit(r,o,e.s.children[t])}};return o};Db.prototype.unref=function(e,r){this.s.topology.unref()},Db.SYSTEM_NAMESPACE_COLLECTION="system.namespaces",Db.SYSTEM_INDEX_COLLECTION="system.indexes",Db.SYSTEM_PROFILE_COLLECTION="system.profile",Db.SYSTEM_USER_COLLECTION="system.users",Db.SYSTEM_COMMAND_COLLECTION="$cmd",Db.SYSTEM_JS_COLLECTION="system.js",module.exports=Db;