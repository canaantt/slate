"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,f=require("util").format,Server=require("./server"),Mongos=require("./mongos"),Cursor=require("./cursor"),AggregationCursor=require("./aggregation_cursor"),CommandCursor=require("./command_cursor"),ReadPreference=require("./read_preference"),MongoCR=require("mongodb-core").MongoCR,MongoError=require("mongodb-core").MongoError,ServerCapabilities=require("./topology_base").ServerCapabilities,Store=require("./topology_base").Store,Define=require("./metadata"),CServer=require("mongodb-core").Server,CReplSet=require("mongodb-core").ReplSet,CoreReadPreference=require("mongodb-core").ReadPreference,shallowClone=require("./utils").shallowClone,MAX_JS_INT=require("./utils").MAX_JS_INT,translateOptions=require("./utils").translateOptions,filterOptions=require("./utils").filterOptions,mergeOptions=require("./utils").mergeOptions,os=require("os"),legalOptionNames=["ha","haInterval","replicaSet","rs_name","secondaryAcceptableLatencyMS","connectWithNoPrimary","poolSize","ssl","checkServerIdentity","sslValidate","sslCA","sslCert","sslKey","sslPass","socketOptions","bufferMaxEntries","store","auto_reconnect","autoReconnect","emitError","keepAlive","noDelay","connectTimeoutMS","socketTimeoutMS","strategy","debug","loggerLevel","logger","reconnectTries","appname","domainsEnabled"],driverVersion=require(__dirname+"/../package.json").version,nodejsversion=f("Node.js %s, %s",process.version,os.endianness()),type=os.type(),name=process.platform,architecture=process.arch,release=os.release(),ReplSet=function(e,r){if(!(this instanceof ReplSet))return new ReplSet(e,r);r=r||{};var t=this;EventEmitter.call(this),r=filterOptions(r,legalOptionNames);for(var s=0;s<e.length;s++)if(!(e[s]instanceof Server))throw MongoError.create({message:"all seed list instances must be of the Server type",driver:!0});var o={force:!1,bufferMaxEntries:"number"==typeof r.bufferMaxEntries?r.bufferMaxEntries:MAX_JS_INT},n=r.store||new Store(t,o),i=e.map(function(e){return{host:e.host,port:e.port}}),l=mergeOptions({},{disconnectHandler:n,cursorFactory:Cursor,reconnect:!1,emitError:"boolean"==typeof r.emitError?r.emitError:!0,size:"number"==typeof r.poolSize?r.poolSize:5});l=translateOptions(l,r);var a=r.socketOptions&&Object.keys(r.socketOptions).length>0?r.socketOptions:r;l=translateOptions(l,a),"number"==typeof l.keepAlive&&(l.keepAliveInitialDelay=l.keepAlive,l.keepAlive=l.keepAlive>0),this.clientInfo={driver:{name:"nodejs",version:driverVersion},os:{type:type,name:name,architecture:architecture,version:release},platform:nodejsversion},l.clientInfo=this.clientInfo,r.appname&&(l.clientInfo.application={name:r.appname});var p=new CReplSet(i,l);p.on("reconnect",function(){t.emit("reconnect"),n.execute()}),this.s={replset:p,sCapabilities:null,tag:r.tag,storeOptions:o,clonedOptions:l,store:n,options:r},l.debug&&Object.defineProperty(this,"replset",{enumerable:!0,get:function(){return p}})};inherits(ReplSet,EventEmitter),Object.defineProperty(ReplSet.prototype,"isMasterDoc",{enumerable:!0,get:function(){return this.s.replset.lastIsMaster()}}),Object.defineProperty(ReplSet.prototype,"bson",{enumerable:!0,get:function(){return this.s.replset.s.bson}}),Object.defineProperty(ReplSet.prototype,"haInterval",{enumerable:!0,get:function(){return this.s.replset.s.haInterval}});var define=ReplSet.define=new Define("ReplSet",ReplSet,!1),translateReadPreference=function(e){return"string"==typeof e.readPreference?e.readPreference=new CoreReadPreference(e.readPreference):e.readPreference instanceof ReadPreference&&(e.readPreference=new CoreReadPreference(e.readPreference.mode,e.readPreference.tags,{maxStalenessMS:e.readPreference.maxStalenessMS})),e};ReplSet.prototype.connect=function(e,r,t){var s=this;"function"==typeof r&&(t=r,r={}),null==r&&(r={}),"function"!=typeof t&&(t=null),s.s.options=r,s.s.storeOptions.bufferMaxEntries=e.bufferMaxEntries;var o=function(e){return function(r){"error"!=e&&s.emit(e,r)}},n=function(){["timeout","error","close","serverOpening","serverDescriptionChanged","serverHeartbeatStarted","serverHeartbeatSucceeded","serverHearbeatFailed","serverClosed","topologyOpening","topologyClosed","topologyDescriptionChanged"].forEach(function(e){s.s.replset.removeAllListeners(e)}),s.s.replset.once("timeout",o("timeout")),s.s.replset.once("error",o("error")),s.s.replset.once("close",o("close"));var e=function(e){return function(r,t){s.emit(e,r,t)}},r=function(e){return function(r,t){s.emit(e,r,t.lastIsMaster(),t)}},n=function(e,r){s.emit("ha",e,r),"start"==e?s.emit("ha_connect",e,r):"end"==e&&s.emit("ha_ismaster",e,r)};s.s.replset.on("joined",r("joined")),s.s.replset.on("left",e("left")),s.s.replset.on("ping",e("ping")),s.s.replset.on("ha",n),s.s.replset.on("serverDescriptionChanged",e("serverDescriptionChanged")),s.s.replset.on("serverHeartbeatStarted",e("serverHeartbeatStarted")),s.s.replset.on("serverHeartbeatSucceeded",e("serverHeartbeatSucceeded")),s.s.replset.on("serverHearbeatFailed",e("serverHearbeatFailed")),s.s.replset.on("serverOpening",e("serverOpening")),s.s.replset.on("serverClosed",e("serverClosed")),s.s.replset.on("topologyOpening",e("topologyOpening")),s.s.replset.on("topologyClosed",e("topologyClosed")),s.s.replset.on("topologyDescriptionChanged",e("topologyDescriptionChanged")),s.s.replset.on("fullsetup",function(e){s.emit("fullsetup",null,s)}),s.s.replset.on("all",function(e){s.emit("all",null,s)}),s.emit("open",null,s);try{t(null,s)}catch(i){process.nextTick(function(){throw i})}},i=function(e){return function(e){["timeout","error","close"].forEach(function(e){s.s.replset.removeListener(e,i)}),s.s.replset.removeListener("connect",i),s.s.replset.destroy();try{t(e)}catch(e){s.s.replset.isConnected()||process.nextTick(function(){throw e})}}};s.s.replset.once("timeout",i("timeout")),s.s.replset.once("error",i("error")),s.s.replset.once("close",i("close")),s.s.replset.once("connect",n),s.s.replset.connect(r)},ReplSet.prototype.capabilities=function(){return this.s.sCapabilities?this.s.sCapabilities:null==this.s.replset.lastIsMaster()?null:(this.s.sCapabilities=new ServerCapabilities(this.s.replset.lastIsMaster()),this.s.sCapabilities)},define.classMethod("capabilities",{callback:!1,promise:!1,returns:[ServerCapabilities]}),ReplSet.prototype.command=function(e,r,t,s){t=translateReadPreference(t),this.s.replset.command(e,r,t,s)},define.classMethod("command",{callback:!0,promise:!1}),ReplSet.prototype.insert=function(e,r,t,s){this.s.replset.insert(e,r,t,s)},define.classMethod("insert",{callback:!0,promise:!1}),ReplSet.prototype.update=function(e,r,t,s){this.s.replset.update(e,r,t,s)},define.classMethod("update",{callback:!0,promise:!1}),ReplSet.prototype.remove=function(e,r,t,s){this.s.replset.remove(e,r,t,s)},define.classMethod("remove",{callback:!0,promise:!1}),ReplSet.prototype.isDestroyed=function(){return this.s.replset.isDestroyed()},ReplSet.prototype.isConnected=function(){return this.s.replset.isConnected()},define.classMethod("isConnected",{callback:!1,promise:!1,returns:[Boolean]}),ReplSet.prototype.cursor=function(e,r,t){return t=translateReadPreference(t),t.disconnectHandler=this.s.store,this.s.replset.cursor(e,r,t)},define.classMethod("cursor",{callback:!1,promise:!1,returns:[Cursor,AggregationCursor,CommandCursor]}),ReplSet.prototype.lastIsMaster=function(){return this.s.replset.lastIsMaster()},ReplSet.prototype.close=function(e){var r=this;this.s.replset.destroy(),1==e&&(this.s.storeOptions.force=e,this.s.store.flush());var t=["timeout","error","close","joined","left"];t.forEach(function(e){r.removeAllListeners(e)})},define.classMethod("close",{callback:!1,promise:!1}),ReplSet.prototype.auth=function(){var e=Array.prototype.slice.call(arguments,0);this.s.replset.auth.apply(this.s.replset,e)},define.classMethod("auth",{callback:!0,promise:!1}),ReplSet.prototype.logout=function(){var e=Array.prototype.slice.call(arguments,0);this.s.replset.logout.apply(this.s.replset,e)},define.classMethod("logout",{callback:!0,promise:!1}),ReplSet.prototype.connections=function(){return this.s.replset.connections()},define.classMethod("connections",{callback:!1,promise:!1,returns:[Array]}),module.exports=ReplSet;