"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,f=require("util").format,Server=require("./server"),Mongos=require("./mongos"),Cursor=require("./cursor"),AggregationCursor=require("./aggregation_cursor"),CommandCursor=require("./command_cursor"),ReadPreference=require("./read_preference"),MongoCR=require("mongodb-core").MongoCR,MongoError=require("mongodb-core").MongoError,ServerCapabilities=require("./topology_base").ServerCapabilities,Store=require("./topology_base").Store,Define=require("./metadata"),CServer=require("mongodb-core").Server,CReplSet=require("mongodb-core").ReplSet,CoreReadPreference=require("mongodb-core").ReadPreference,shallowClone=require("./utils").shallowClone,MAX_JS_INT=require("./utils").MAX_JS_INT,ReplSet=function(e,t){if(!(this instanceof ReplSet))return new ReplSet(e,t);t=t||{};for(var r=this,o=0;o<e.length;o++)if(!(e[o]instanceof Server))throw MongoError.create({message:"all seed list instances must be of the Server type",driver:!0});var s={force:!1,bufferMaxEntries:-1};-1==s.bufferMaxEntries&&(s.bufferMaxEntries=MAX_JS_INT);var n=t.store||new Store(r,s);EventEmitter.call(this);var i=(t.tag,e.map(function(e){return{host:e.host,port:e.port}})),c=shallowClone(t);c.size="number"==typeof t.poolSize?t.poolSize:5,c.reconnect="boolean"==typeof t.auto_reconnect?t.auto_reconnect:!0,c.emitError="boolean"==typeof t.emitError?t.emitError:!0,c.cursorFactory=Cursor,c.disconnectHandler=n,t.socketOptions&&(t.socketOptions.connectTimeoutMS&&(this.connectTimeoutMS=t.socketOptions.connectTimeoutMS,c.connectionTimeout=t.socketOptions.connectTimeoutMS),t.socketOptions.socketTimeoutMS&&(c.socketTimeout=t.socketOptions.socketTimeoutMS));var l=t.replicaSet||t.rs_name;c.setName=l;var a="boolean"==typeof t.debug?t.debug:!1;a&&(c.debug=a),t.socketOptions&&"number"==typeof t.socketOptions.keepAlive&&(c.keepAlive=!0,"number"==typeof t.socketOptions.keepAlive&&(c.keepAliveInitialDelay=t.socketOptions.keepAlive)),t.socketOptions&&"number"==typeof t.socketOptions.connectionTimeout&&(c.connectionTimeout=t.socketOptions.connectionTimeout),t.socketOptions&&"number"==typeof t.socketOptions.socketTimeout&&(c.socketTimeout=t.socketOptions.socketTimeout),t.socketOptions&&"boolean"==typeof t.socketOptions.noDelay&&(c.noDelay=t.socketOptions.noDelay),"number"==typeof t.secondaryAcceptableLatencyMS&&(c.acceptableLatency=t.secondaryAcceptableLatencyMS),1==t.connectWithNoPrimary&&(c.secondaryOnlyConnectionAllowed=!0),c.disconnectHandler=n,t.sslCA&&(c.ca=t.sslCA),"boolean"==typeof t.sslValidate&&(c.rejectUnauthorized=t.sslValidate),t.sslKey&&(c.key=t.sslKey),t.sslCert&&(c.cert=t.sslCert),t.sslPass&&(c.passphrase=t.sslPass),t.checkServerIdentity&&(c.checkServerIdentity=t.checkServerIdentity);var p=new CReplSet(i,c);p.on("reconnect",function(){r.emit("reconnect"),n.execute()}),this.s={replset:p,sCapabilities:null,tag:t.tag,storeOptions:s,clonedOptions:c,store:n,options:t},a&&Object.defineProperty(this,"replset",{enumerable:!0,get:function(){return p}}),Object.defineProperty(this,"isMasterDoc",{enumerable:!0,get:function(){return p.lastIsMaster()}}),Object.defineProperty(this,"bson",{enumerable:!0,get:function(){return p.bson}}),Object.defineProperty(this,"haInterval",{enumerable:!0,get:function(){return p.haInterval}})};inherits(ReplSet,EventEmitter);var define=ReplSet.define=new Define("ReplSet",ReplSet,!1),translateReadPreference=function(e){return"string"==typeof e.readPreference?e.readPreference=new CoreReadPreference(e.readPreference):e.readPreference instanceof ReadPreference&&(e.readPreference=new CoreReadPreference(e.readPreference.mode,e.readPreference.tags)),e};ReplSet.prototype.parserType=function(){return this.s.replset.parserType()},define.classMethod("parserType",{callback:!1,promise:!1,returns:[String]}),ReplSet.prototype.connect=function(e,t,r){var o=this;"function"==typeof t&&(r=t,t={}),null==t&&(t={}),"function"!=typeof r&&(r=null),o.s.options=t,o.s.storeOptions.bufferMaxEntries=e.bufferMaxEntries;var s=function(e){return function(t){"error"!=e&&o.emit(e,t)}},n=function(){["timeout","error","close","serverOpening","serverDescriptionChanged","serverHeartbeatStarted","serverHeartbeatSucceeded","serverHearbeatFailed","serverClosed","topologyOpening","topologyClosed","topologyDescriptionChanged"].forEach(function(e){o.s.replset.removeAllListeners(e)}),o.s.replset.once("timeout",s("timeout")),o.s.replset.once("error",s("error")),o.s.replset.once("close",s("close"));var e=function(e){return function(t,r){o.emit(e,t,r)}},t=function(e){return function(t,r){o.emit(e,t,r.lastIsMaster(),r)}},n=function(e,t){o.emit("ha",e,t),"start"==e?o.emit("ha_connect",e,t):"end"==e&&o.emit("ha_ismaster",e,t)};o.s.replset.on("joined",t("joined")),o.s.replset.on("left",e("left")),o.s.replset.on("ping",e("ping")),o.s.replset.on("ha",n),o.s.replset.on("serverDescriptionChanged",e("serverDescriptionChanged")),o.s.replset.on("serverHeartbeatStarted",e("serverHeartbeatStarted")),o.s.replset.on("serverHeartbeatSucceeded",e("serverHeartbeatSucceeded")),o.s.replset.on("serverHearbeatFailed",e("serverHearbeatFailed")),o.s.replset.on("serverOpening",e("serverOpening")),o.s.replset.on("serverClosed",e("serverClosed")),o.s.replset.on("topologyOpening",e("topologyOpening")),o.s.replset.on("topologyClosed",e("topologyClosed")),o.s.replset.on("topologyDescriptionChanged",e("topologyDescriptionChanged")),o.s.replset.on("fullsetup",function(e){o.emit("fullsetup",null,o)}),o.s.replset.on("all",function(e){o.emit("all",null,o)}),o.emit("open",null,o);try{r(null,o)}catch(i){process.nextTick(function(){throw i})}},i=function(e){return function(e){["timeout","error","close"].forEach(function(e){o.s.replset.removeListener(e,i)}),o.s.replset.removeListener("connect",i),o.s.replset.destroy();try{r(e)}catch(e){o.s.replset.isConnected()||process.nextTick(function(){throw e})}}};o.s.replset.once("timeout",i("timeout")),o.s.replset.once("error",i("error")),o.s.replset.once("close",i("close")),o.s.replset.once("connect",n),o.s.replset.connect(t)},ReplSet.prototype.capabilities=function(){return this.s.sCapabilities?this.s.sCapabilities:null==this.s.replset.lastIsMaster()?null:(this.s.sCapabilities=new ServerCapabilities(this.s.replset.lastIsMaster()),this.s.sCapabilities)},define.classMethod("capabilities",{callback:!1,promise:!1,returns:[ServerCapabilities]}),ReplSet.prototype.command=function(e,t,r,o){r=translateReadPreference(r),this.s.replset.command(e,t,r,o)},define.classMethod("command",{callback:!0,promise:!1}),ReplSet.prototype.insert=function(e,t,r,o){this.s.replset.insert(e,t,r,o)},define.classMethod("insert",{callback:!0,promise:!1}),ReplSet.prototype.update=function(e,t,r,o){this.s.replset.update(e,t,r,o)},define.classMethod("update",{callback:!0,promise:!1}),ReplSet.prototype.remove=function(e,t,r,o){this.s.replset.remove(e,t,r,o)},define.classMethod("remove",{callback:!0,promise:!1}),ReplSet.prototype.isDestroyed=function(){return this.s.replset.isDestroyed()},ReplSet.prototype.isConnected=function(){return this.s.replset.isConnected()},define.classMethod("isConnected",{callback:!1,promise:!1,returns:[Boolean]}),ReplSet.prototype.setBSONParserType=function(e){return this.s.replset.setBSONParserType(e)},ReplSet.prototype.cursor=function(e,t,r){return r=translateReadPreference(r),r.disconnectHandler=this.s.store,this.s.replset.cursor(e,t,r)},define.classMethod("cursor",{callback:!1,promise:!1,returns:[Cursor,AggregationCursor,CommandCursor]}),ReplSet.prototype.lastIsMaster=function(){return this.s.replset.lastIsMaster()},ReplSet.prototype.close=function(e){var t=this;this.s.replset.destroy(),1==e&&(this.s.storeOptions.force=e,this.s.store.flush());var r=["timeout","error","close","joined","left"];r.forEach(function(e){t.removeAllListeners(e)})},define.classMethod("close",{callback:!1,promise:!1}),ReplSet.prototype.auth=function(){var e=Array.prototype.slice.call(arguments,0);this.s.replset.auth.apply(this.s.replset,e)},define.classMethod("auth",{callback:!0,promise:!1}),ReplSet.prototype.connections=function(){return this.s.replset.connections()},define.classMethod("connections",{callback:!1,promise:!1,returns:[Array]}),module.exports=ReplSet;