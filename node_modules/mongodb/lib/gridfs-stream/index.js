function GridFSBucket(e,t){if(Emitter.apply(this),this.setMaxListeners(0),t&&"object"==typeof t){t=shallowClone(t);for(var i=Object.keys(DEFAULT_GRIDFS_BUCKET_OPTIONS),r=0;r<i.length;++r)t[i[r]]||(t[i[r]]=DEFAULT_GRIDFS_BUCKET_OPTIONS[i[r]])}else t=DEFAULT_GRIDFS_BUCKET_OPTIONS;this.s={db:e,options:t,_chunksCollection:e.collection(t.bucketName+".chunks"),_filesCollection:e.collection(t.bucketName+".files"),checkedIndexes:!1,calledOpenUploadStream:!1,promiseLibrary:e.s.promiseLibrary||("function"==typeof global.Promise?global.Promise:require("es6-promise").Promise)}}function _delete(e,t,i){e.s._filesCollection.deleteOne({_id:t},function(r,n){return r?i(r):void e.s._chunksCollection.deleteMany({files_id:t},function(e){if(e)return i(e);if(!n.result.n){var r="FileNotFound: no file with id "+t+" found";return i(new Error(r))}i()})})}function _rename(e,t,i,r){var n={_id:t},o={$set:{filename:i}};e.s._filesCollection.updateOne(n,o,function(e,i){return e?r(e):i.result.n?void r():r(toError("File with id "+t+" not found"))})}function _drop(e,t){e.s._filesCollection.drop(function(i){return i?t(i):void e.s._chunksCollection.drop(function(e){return e?t(e):t()})})}var Emitter=require("events").EventEmitter,GridFSBucketReadStream=require("./download"),GridFSBucketWriteStream=require("./upload"),shallowClone=require("../utils").shallowClone,toError=require("../utils").toError,util=require("util"),DEFAULT_GRIDFS_BUCKET_OPTIONS={bucketName:"fs",chunkSizeBytes:261120};module.exports=GridFSBucket,util.inherits(GridFSBucket,Emitter),GridFSBucket.prototype.openUploadStream=function(e,t){return t=t?shallowClone(t):{},t.chunkSizeBytes||(t.chunkSizeBytes=this.s.options.chunkSizeBytes),new GridFSBucketWriteStream(this,e,t)},GridFSBucket.prototype.openDownloadStream=function(e,t){var i={_id:e},t={start:t&&t.start,end:t&&t.end};return new GridFSBucketReadStream(this.s._chunksCollection,this.s._filesCollection,this.s.options.readPreference,i,t)},GridFSBucket.prototype["delete"]=function(e,t){if("function"==typeof t)return _delete(this,e,t);var i=this;return new this.s.promiseLibrary(function(t,r){_delete(i,e,function(e,i){e?r(e):t(i)})})},GridFSBucket.prototype.find=function(e,t){e=e||{},t=t||{};var i=this.s._filesCollection.find(e);return null!=t.batchSize&&i.batchSize(t.batchSize),null!=t.limit&&i.limit(t.limit),null!=t.maxTimeMS&&i.maxTimeMS(t.maxTimeMS),null!=t.noCursorTimeout&&i.addCursorFlag("noCursorTimeout",t.noCursorTimeout),null!=t.skip&&i.skip(t.skip),null!=t.sort&&i.sort(t.sort),i},GridFSBucket.prototype.openDownloadStreamByName=function(e,t){var i={uploadDate:-1},r=null;t&&null!=t.revision&&(t.revision>=0?(i={uploadDate:1},r=t.revision):r=-t.revision-1);var n={filename:e},t={sort:i,skip:r,start:t&&t.start,end:t&&t.end};return new GridFSBucketReadStream(this.s._chunksCollection,this.s._filesCollection,this.s.options.readPreference,n,t)},GridFSBucket.prototype.rename=function(e,t,i){if("function"==typeof i)return _rename(this,e,t,i);var r=this;return new this.s.promiseLibrary(function(i,n){_rename(r,e,t,function(e,t){e?n(e):i(t)})})},GridFSBucket.prototype.drop=function(e){if("function"==typeof e)return _drop(this,e);var t=this;return new this.s.promiseLibrary(function(e,i){_drop(t,function(t,r){t?i(t):e(r)})})};