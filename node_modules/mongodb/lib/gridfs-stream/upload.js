function GridFSBucketWriteStream(e,t,n){if(n=n||{},this.bucket=e,this.chunks=e.s._chunksCollection,this.filename=t,this.files=e.s._filesCollection,this.options=n,this.id=n.id?n.id:core.BSON.ObjectId(),this.chunkSizeBytes=this.options.chunkSizeBytes,this.bufToStore=new Buffer(this.chunkSizeBytes),this.length=0,this.md5=crypto.createHash("md5"),this.n=0,this.pos=0,this.state={streamEnd:!1,outstandingRequests:0,errored:!1,aborted:!1,promiseLibrary:this.bucket.s.promiseLibrary},!this.bucket.s.calledOpenUploadStream){this.bucket.s.calledOpenUploadStream=!0;var r=this;checkIndexes(this,function(){r.bucket.s.checkedIndexes=!0,r.bucket.emit("index")})}}function __handleError(e,t,n){return e.state.errored?void 0:(e.state.errored=!0,n?n(t):void e.emit("error",t))}function createChunkDoc(e,t,n){return{_id:core.BSON.ObjectId(),files_id:e,n:t,data:n}}function checkChunksIndex(e,t){e.chunks.listIndexes().toArray(function(n,r){if(n){if(n.code===ERROR_NAMESPACE_NOT_FOUND){var i={files_id:1,n:1};return void e.chunks.createIndex(i,{background:!1},function(e){return e?t(e):void t()})}return t(n)}var o=!1;if(r.forEach(function(e){if(e.key){var t=Object.keys(e.key);2===t.length&&1===e.key.files_id&&1===e.key.n&&(o=!0)}}),o)t();else{var i={files_id:1,n:1},s=getWriteOptions(e);s.background=!1,s.unique=!0,e.chunks.createIndex(i,s,function(e){return e?t(e):void t()})}})}function checkDone(e,t){if(e.state.streamEnd&&0===e.state.outstandingRequests&&!e.state.errored){var n=createFilesDoc(e.id,e.length,e.chunkSizeBytes,e.md5.digest("hex"),e.filename,e.options.contentType,e.options.aliases,e.options.metadata);return checkAborted(e,t)?!1:(e.files.insert(n,getWriteOptions(e),function(r){return r?__handleError(e,r,t):void e.emit("finish",n)}),!0)}return!1}function checkIndexes(e,t){e.files.findOne({},{_id:1},function(n,r){return n?t(n):r?t():void e.files.listIndexes().toArray(function(n,r){if(n){if(n.code===ERROR_NAMESPACE_NOT_FOUND){var i={filename:1,uploadDate:1};return void e.files.createIndex(i,{background:!1},function(n){return n?t(n):void checkChunksIndex(e,t)})}return t(n)}var o=!1;if(r.forEach(function(e){var t=Object.keys(e.key);2===t.length&&1===e.key.filename&&1===e.key.uploadDate&&(o=!0)}),o)checkChunksIndex(e,t);else{var i={filename:1,uploadDate:1},s=getWriteOptions(e);s.background=!1,e.files.createIndex(i,s,function(n){return n?t(n):void checkChunksIndex(e,t)})}})})}function createFilesDoc(e,t,n,r,i,o,s,c){var a={_id:e,length:t,chunkSize:n,uploadDate:new Date,md5:r,filename:i};return o&&(a.contentType=o),s&&(a.aliases=s),c&&(a.metadata=c),a}function doWrite(e,t,n,r){if(checkAborted(e,r))return!1;var i=Buffer.isBuffer(t)?t:new Buffer(t,n);if(e.length+=i.length,e.pos+i.length<e.chunkSizeBytes)return i.copy(e.bufToStore,e.pos),e.pos+=i.length,r&&r(),!0;for(var o=i.length,s=e.chunkSizeBytes-e.pos,c=Math.min(s,i.length),a=0;o>0;){var u=i.length-o;if(i.copy(e.bufToStore,e.pos,u,u+c),e.pos+=c,s-=c,0===s){e.md5.update(e.bufToStore);var d=createChunkDoc(e.id,e.n,e.bufToStore);if(++e.state.outstandingRequests,++a,checkAborted(e,r))return!1;e.chunks.insert(d,getWriteOptions(e),function(t){return t?__handleError(e,t):(--e.state.outstandingRequests,--a,void(a||(e.emit("drain",d),r&&r(),checkDone(e))))}),s=e.chunkSizeBytes,e.pos=0,++e.n}o-=c,c=Math.min(s,o)}return!1}function getWriteOptions(e){var t={};return e.options.writeConcern&&(t.w=concern.w,t.wtimeout=concern.wtimeout,t.j=concern.j),t}function waitForIndexes(e,t){return e.bucket.s.checkedIndexes?t(!1):(e.bucket.once("index",function(){t(!0)}),!0)}function writeRemnant(e,t){if(0===e.pos)return checkDone(e,t);++e.state.outstandingRequests;var n=new Buffer(e.pos);e.bufToStore.copy(n,0,0,e.pos),e.md5.update(n);var r=createChunkDoc(e.id,e.n,n);return checkAborted(e,t)?!1:void e.chunks.insert(r,getWriteOptions(e),function(t){return t?__handleError(e,t):(--e.state.outstandingRequests,void checkDone(e))})}function checkAborted(e,t){return e.state.aborted?("function"==typeof t&&t(new Error("this stream has been aborted")),!0):!1}var core=require("mongodb-core"),crypto=require("crypto"),shallowClone=require("../utils").shallowClone,stream=require("stream"),util=require("util"),ERROR_NAMESPACE_NOT_FOUND=26;module.exports=GridFSBucketWriteStream,util.inherits(GridFSBucketWriteStream,stream.Writable),GridFSBucketWriteStream.prototype.write=function(e,t,n){var r=this;return waitForIndexes(this,function(){return doWrite(r,e,t,n)})},GridFSBucketWriteStream.prototype.abort=function(e){if(this.state.streamEnd){var t=new Error("Cannot abort a stream that has already completed");return"function"==typeof e?e(t):this.state.promiseLibrary.reject(t)}if(this.state.aborted){var t=new Error("Cannot call abort() on a stream twice");return"function"==typeof e?e(t):this.state.promiseLibrary.reject(t)}this.state.aborted=!0,this.chunks.deleteMany({files_id:this.id},function(t){"function"==typeof e&&e(t)})},GridFSBucketWriteStream.prototype.end=function(e,t,n){if(!checkAborted(this,n)){var r=this;if(this.state.streamEnd=!0,n&&this.once("finish",n),!e)return void waitForIndexes(this,function(){writeRemnant(r)});var r=this;Buffer.isBuffer(e)?e:new Buffer(e,t);this.write(e,t,function(){writeRemnant(r)})}};