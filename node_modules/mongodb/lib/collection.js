"use strict";function decorateWithWriteConcern(e,n,r){var o=n.s.topology.capabilities();if(o&&o.commandsTakeWriteConcern){var t=writeConcern(shallowClone(r),n.s.db,n,r);t.writeConcern&&(e.writeConcern=t.writeConcern)}}function decorateWithCollation(e,n,r){var o=n.s.topology.capabilities();o&&o.commandsTakeCollation&&(r.collation&&"object"==typeof r.collation?e.collation=r.collation:n.s.collation&&"object"==typeof n.s.collation?e.collation=n.s.collation:n.s.db.s.collation&&"object"==typeof n.s.db.s.collation&&(e.collation=n.s.db.s.collation))}function processScope(e){if(!isObject(e))return e;for(var n,r=Object.keys(e),o=r.length,t={};o--;)n=r[o],"function"==typeof e[n]?t[n]=new Code(String(e[n])):t[n]=processScope(e[n]);return t}var checkCollectionName=require("./utils").checkCollectionName,ObjectID=require("mongodb-core").BSON.ObjectID,Long=require("mongodb-core").BSON.Long,Code=require("mongodb-core").BSON.Code,f=require("util").format,AggregationCursor=require("./aggregation_cursor"),MongoError=require("mongodb-core").MongoError,shallowClone=require("./utils").shallowClone,isObject=require("./utils").isObject,toError=require("./utils").toError,normalizeHintField=require("./utils").normalizeHintField,handleCallback=require("./utils").handleCallback,decorateCommand=require("./utils").decorateCommand,formattedOrderClause=require("./utils").formattedOrderClause,ReadPreference=require("./read_preference"),CoreReadPreference=require("mongodb-core").ReadPreference,CommandCursor=require("./command_cursor"),Define=require("./metadata"),Cursor=require("./cursor"),unordered=require("./bulk/unordered"),ordered=require("./bulk/ordered"),assign=require("./utils").assign,Collection=function(e,n,r,o,t,i){checkCollectionName(o);var l=null,a=null==i||null==i.slaveOk?e.slaveOk:i.slaveOk,s=null==i||null==i.serializeFunctions?e.serializeFunctions:i.serializeFunctions,c=null==i||null==i.raw?e.raw:i.raw,u=null,d=null,p=f("%s.%s",r,o),h=i.promiseLibrary;h||(h="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise),i&&i.readPreference?u=i.readPreference:e.options.readPreference&&(u=e.options.readPreference),t=null==t?ObjectID:t,this.s={pkFactory:t,db:e,topology:n,dbName:r,options:i,namespace:p,readPreference:u,raw:c,slaveOk:a,serializeFunctions:s,internalHint:l,collectionHint:d,name:o,promiseLibrary:h,readConcern:i.readConcern,collation:i.collation}},define=Collection.define=new Define("Collection",Collection,!1);Object.defineProperty(Collection.prototype,"collectionName",{enumerable:!0,get:function(){return this.s.name}}),Object.defineProperty(Collection.prototype,"namespace",{enumerable:!0,get:function(){return this.s.namespace}}),Object.defineProperty(Collection.prototype,"readConcern",{enumerable:!0,get:function(){return this.s.readConcern||{level:"local"}}}),Object.defineProperty(Collection.prototype,"writeConcern",{enumerable:!0,get:function(){var e={};return null!=this.s.options.w&&(e.w=this.s.options.w),null!=this.s.options.j&&(e.j=this.s.options.j),null!=this.s.options.fsync&&(e.fsync=this.s.options.fsync),null!=this.s.options.wtimeout&&(e.wtimeout=this.s.options.wtimeout),e}}),Object.defineProperty(Collection.prototype,"hint",{enumerable:!0,get:function(){return this.s.collectionHint},set:function(e){this.s.collectionHint=normalizeHintField(e)}}),Collection.prototype.find=function(){var e,n=Array.prototype.slice.call(arguments,0),r="function"==typeof n[n.length-1],o="function"==typeof n[0],t=r?n.pop():o?n.shift():null,i=n.length,l=i>=1?n[0]:{},a=i>=2?n[1]:void 0;if(1===i&&o&&(l={},e=n[0]),2!==i||void 0===a||Array.isArray(a)){if(2===i&&Array.isArray(a)&&!Array.isArray(a[0])){for(var s={},c=0;c<a.length;c++)s[a[c]]=1;a=s}}else{for(var u=Object.keys(a),d=!1,c=0;c<u.length;c++)if(null!=testForFields[u[c]]){d=!0;break}d?(e=a,a=void 0):e={}}3===i&&(e=n[2]),l=null==l?{}:l;var f=l;if(Buffer.isBuffer(f)){var p=f[0]|f[1]<<8|f[2]<<16|f[3]<<24;if(p!=f.length){var h=new Error("query selector raw message size does not match message header size ["+f.length+"] != ["+p+"]");throw h.name="MongoError",h}}var f=a;if(Buffer.isBuffer(f)){var p=f[0]|f[1]<<8|f[2]<<16|f[3]<<24;if(p!=f.length){var h=new Error("query fields raw message size does not match message header size ["+f.length+"] != ["+p+"]");throw h.name="MongoError",h}}if((l instanceof ObjectID||null!=l&&"ObjectID"==l._bsontype)&&(l={_id:l}),e&&e.fields&&!Buffer.isBuffer(e.fields))if(a={},Array.isArray(e.fields))if(e.fields.length)for(var c=0,m=e.fields.length;m>c;c++)a[e.fields[c]]=1;else a._id=1;else a=e.fields;e||(e={});var y={};for(var b in e)y[b]=e[b];if(y.skip=i>3?n[2]:e.skip?e.skip:0,y.limit=i>3?n[3]:e.limit?e.limit:0,y.raw=null!=e.raw&&"boolean"==typeof e.raw?e.raw:this.s.raw,y.hint=null!=e.hint?normalizeHintField(e.hint):this.s.collectionHint,y.timeout=5==i?n[4]:"undefined"==typeof e.timeout?void 0:e.timeout,y.slaveOk=null!=e.slaveOk?e.slaveOk:this.s.db.slaveOk,y=getReadPreference(this,y,this.s.db,this),null==y.readPreference||"primary"==y.readPreference&&"primary"==y.readPreference.mode||(y.slaveOk=!0),null!=l&&"object"!=typeof l)throw MongoError.create({message:"query selector must be an object",driver:!0});var C={find:this.s.namespace,limit:y.limit,skip:y.skip,query:l};"boolean"==typeof y.awaitdata&&(y.awaitData=y.awaitdata),"boolean"==typeof y.timeout&&(y.noCursorTimeout=y.timeout);for(var v in y)null!=y[v]&&(C[v]=y[v]);var g=function(e){var n={};if(Array.isArray(e))for(var r=0;r<e.length;r++)Array.isArray(e[r])?n[e[r][0]]=e[r][1]:n[e[r][0]]=1;else n=e;return n};return a&&(C.fields=g(a)),y.db=this.s.db,y.promiseLibrary=this.s.promiseLibrary,null==y.raw&&this.s.raw&&(y.raw=this.s.raw),C.sort&&(C.sort=formattedOrderClause(C.sort)),this.s.readConcern&&(C.readConcern=this.s.readConcern),decorateWithCollation(C,this,e),"function"==typeof t?handleCallback(t,null,this.s.topology.cursor(this.s.namespace,C,y)):this.s.topology.cursor(this.s.namespace,C,y)},define.classMethod("find",{callback:!1,promise:!1,returns:[Cursor]}),Collection.prototype.insertOne=function(e,n,r){var o=this;return"function"==typeof n&&(r=n,n={}),n=n||{},Array.isArray(e)&&"function"==typeof r?r(MongoError.create({message:"doc parameter must be an object",driver:!0})):Array.isArray(e)?new this.s.promiseLibrary(function(e,n){n(MongoError.create({message:"doc parameter must be an object",driver:!0}))}):(this.s.options.ignoreUndefined&&(n=shallowClone(n),n.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof r?insertOne(o,e,n,r):new this.s.promiseLibrary(function(r,t){insertOne(o,e,n,function(e,n){return e?t(e):void r(n)})}))};var insertOne=function(e,n,r,o){insertDocuments(e,[n],r,function(e,r){if(null!=o){if(e&&o)return o(e);if(null==r)return o(null,{result:{ok:1}});r.insertedCount=r.result.n,r.insertedId=n._id,o&&o(null,r)}})},mapInserManyResults=function(e,n){for(var r=n.getInsertedIds(),o=Object.keys(r),t=new Array(o.length),i=0;i<o.length;i++)r[o[i]]._id&&(t[r[o[i]].index]=r[o[i]]._id);var l={result:{ok:1,n:n.insertedCount},ops:e,insertedCount:n.insertedCount,insertedIds:t};return n.getLastOp()&&(l.result.opTime=n.getLastOp()),l};define.classMethod("insertOne",{callback:!0,promise:!0}),Collection.prototype.insertMany=function(e,n,r){var o=this;if("function"==typeof n&&(r=n,n={}),n=n||{ordered:!0},!Array.isArray(e)&&"function"==typeof r)return r(MongoError.create({message:"docs parameter must be an array of documents",driver:!0}));if(!Array.isArray(e))return new this.s.promiseLibrary(function(e,n){n(MongoError.create({message:"docs parameter must be an array of documents",driver:!0}))});"boolean"!=typeof n.checkKeys&&(n.checkKeys=!0),n.serializeFunctions=n.serializeFunctions||o.s.serializeFunctions;var t="boolean"==typeof n.forceServerObjectId?n.forceServerObjectId:o.s.db.options.forceServerObjectId;if(t!==!0)for(var i=0;i<e.length;i++)null==e[i]._id&&(e[i]._id=o.s.pkFactory.createPk());var l=[{insertMany:e}];return"function"==typeof r?bulkWrite(o,l,n,function(n,o){return n?r(n,o):void r(null,mapInserManyResults(e,o))}):new this.s.promiseLibrary(function(r,t){bulkWrite(o,l,n,function(n,o){return n?t(n):void r(mapInserManyResults(e,o))})})},define.classMethod("insertMany",{callback:!0,promise:!0}),Collection.prototype.bulkWrite=function(e,n,r){var o=this;if("function"==typeof n&&(r=n,n={}),n=n||{ordered:!0},!Array.isArray(e))throw MongoError.create({message:"operations must be an array of documents",driver:!0});return"function"==typeof r?bulkWrite(o,e,n,r):new this.s.promiseLibrary(function(r,t){bulkWrite(o,e,n,function(e,n){return e&&null==n?t(e):void r(n)})})};var bulkWrite=function(e,n,r,o){e.s.options.ignoreUndefined&&(r=shallowClone(r),r.ignoreUndefined=e.s.options.ignoreUndefined);var t=1==r.ordered||null==r.ordered?e.initializeOrderedBulkOp(r):e.initializeUnorderedBulkOp(r),i=!1;try{for(var l=0;l<n.length;l++){var a=Object.keys(n[l])[0];n[l][a].collation&&(i=!0),t.raw(n[l])}}catch(s){return o(s,null)}var c=writeConcern(shallowClone(r),e.s.db,e,r),u=c.writeConcern?c.writeConcern:{},d=e.s.topology.capabilities();return i&&d&&!d.commandsTakeCollation?o(new MongoError(f("server/primary/mongos does not support collation"))):void t.execute(u,function(e,n){if(!n&&e)return o(e,null);if(n&&n.hasWriteErrors()&&1==n.getWriteErrorCount())return o(toError(n.getWriteErrorAt(0)),n);n.insertedCount=n.nInserted,n.matchedCount=n.nMatched,n.modifiedCount=n.nModified||0,n.deletedCount=n.nRemoved,n.upsertedCount=n.getUpsertedIds().length,n.upsertedIds={},n.insertedIds={},n.n=n.insertedCount;for(var r=n.getInsertedIds(),t=0;t<r.length;t++)n.insertedIds[r[t].index]=r[t]._id;for(var i=n.getUpsertedIds(),t=0;t<i.length;t++)n.upsertedIds[i[t].index]=i[t]._id;if(n.hasWriteErrors()){var l=n.getWriteErrors();return o(toError({message:"write operation failed",code:l[0].code,writeErrors:l}),n)}return n.getWriteConcernError()?o(toError(n.getWriteConcernError()),n):void o(null,n)})},insertDocuments=function(e,n,r,o){"function"==typeof r&&(o=r,r={}),r=r||{},n=Array.isArray(n)?n:[n];var t=writeConcern(shallowClone(r),e.s.db,e,r);"boolean"!=typeof t.checkKeys&&(t.checkKeys=!0),1==t.keepGoing&&(t.ordered=!1),t.serializeFunctions=r.serializeFunctions||e.s.serializeFunctions;var i="boolean"==typeof r.forceServerObjectId?r.forceServerObjectId:e.s.db.options.forceServerObjectId;if(i!==!0)for(var l=0;l<n.length;l++)null==n[l]._id&&(n[l]._id=e.s.pkFactory.createPk());e.s.topology.insert(e.s.namespace,n,t,function(e,r){if(null!=o){if(e)return handleCallback(o,e);if(null==r)return handleCallback(o,null,null);if(r.result.code)return handleCallback(o,toError(r.result));if(r.result.writeErrors)return handleCallback(o,toError(r.result.writeErrors[0]));r.ops=n,handleCallback(o,null,r)}})};define.classMethod("bulkWrite",{callback:!0,promise:!0}),Collection.prototype.insert=function(e,n,r){return"function"==typeof n&&(r=n,n={}),n=n||{ordered:!1},e=Array.isArray(e)?e:[e],1==n.keepGoing&&(n.ordered=!1),this.insertMany(e,n,r)},define.classMethod("insert",{callback:!0,promise:!0}),Collection.prototype.updateOne=function(e,n,r,o){var t=this;return"function"==typeof r&&(o=r,r={}),r=shallowClone(r),this.s.options.ignoreUndefined&&(r=shallowClone(r),r.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof o?updateOne(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){updateOne(t,e,n,r,function(e,n){return e?i(e):void o(n)})})};var updateOne=function(e,n,r,o,t){o.multi=!1,updateDocuments(e,n,r,o,function(e,n){if(null!=t){if(e&&t)return t(e);if(null==n)return t(null,{result:{ok:1}});n.matchedCount=n.result.n,n.modifiedCount=null!=n.result.nModified?n.result.nModified:n.result.n,n.upsertedId=Array.isArray(n.result.upserted)&&n.result.upserted.length>0?n.result.upserted[0]:null,n.upsertedCount=Array.isArray(n.result.upserted)&&n.result.upserted.length?n.result.upserted.length:0,t&&t(null,n)}})};define.classMethod("updateOne",{callback:!0,promise:!0}),Collection.prototype.replaceOne=function(e,n,r,o){var t=this;return"function"==typeof r&&(o=r,r={}),r=shallowClone(r),this.s.options.ignoreUndefined&&(r=shallowClone(r),r.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof o?replaceOne(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){replaceOne(t,e,n,r,function(e,n){return e?i(e):void o(n)})})};var replaceOne=function(e,n,r,o,t){o.multi=!1,updateDocuments(e,n,r,o,function(e,n){if(null!=t){if(e&&t)return t(e);if(null==n)return t(null,{result:{ok:1}});n.matchedCount=n.result.n,n.modifiedCount=null!=n.result.nModified?n.result.nModified:n.result.n,n.upsertedId=Array.isArray(n.result.upserted)&&n.result.upserted.length>0?n.result.upserted[0]:null,n.upsertedCount=Array.isArray(n.result.upserted)&&n.result.upserted.length?n.result.upserted.length:0,n.ops=[r],t&&t(null,n)}})};define.classMethod("replaceOne",{callback:!0,promise:!0}),Collection.prototype.updateMany=function(e,n,r,o){var t=this;return"function"==typeof r&&(o=r,r={}),r=shallowClone(r),this.s.options.ignoreUndefined&&(r=shallowClone(r),r.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof o?updateMany(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){updateMany(t,e,n,r,function(e,n){return e?i(e):void o(n)})})};var updateMany=function(e,n,r,o,t){o.multi=!0,updateDocuments(e,n,r,o,function(e,n){if(null!=t){if(e&&t)return t(e);if(null==n)return t(null,{result:{ok:1}});n.matchedCount=n.result.n,n.modifiedCount=null!=n.result.nModified?n.result.nModified:n.result.n,n.upsertedId=Array.isArray(n.result.upserted)&&n.result.upserted.length>0?n.result.upserted[0]:null,n.upsertedCount=Array.isArray(n.result.upserted)&&n.result.upserted.length?n.result.upserted.length:0,t&&t(null,n)}})};define.classMethod("updateMany",{callback:!0,promise:!0});var updateDocuments=function(e,n,r,o,t){if("function"==typeof o&&(t=o,o=null),null==o&&(o={}),"function"!=typeof t&&(t=null),null==n||"object"!=typeof n)return t(toError("selector must be a valid JavaScript object"));if(null==r||"object"!=typeof r)return t(toError("document must be a valid JavaScript object"));var i=writeConcern(shallowClone(o),e.s.db,e,o);i.serializeFunctions=o.serializeFunctions||e.s.serializeFunctions;var l={q:n,u:r};l.upsert="boolean"==typeof o.upsert?o.upsert:!1,l.multi="boolean"==typeof o.multi?o.multi:!1,decorateWithCollation(i,e,o),e.s.topology.update(e.s.namespace,[l],i,function(e,n){return null!=t?e?handleCallback(t,e,null):null==n?handleCallback(t,null,null):n.result.code?handleCallback(t,toError(n.result)):n.result.writeErrors?handleCallback(t,toError(n.result.writeErrors[0])):void handleCallback(t,null,n):void 0})};Collection.prototype.update=function(e,n,r,o){var t=this;return this.s.options.ignoreUndefined&&(r=shallowClone(r),r.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof o?updateDocuments(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){updateDocuments(t,e,n,r,function(e,n){return e?i(e):void o(n)})})},define.classMethod("update",{callback:!0,promise:!0}),Collection.prototype.deleteOne=function(e,n,r){var o=this;"function"==typeof n&&(r=n,n={});var n=shallowClone(n);return this.s.options.ignoreUndefined&&(n=shallowClone(n),n.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof r?deleteOne(o,e,n,r):new this.s.promiseLibrary(function(r,t){deleteOne(o,e,n,function(e,n){return e?t(e):void r(n)})})};var deleteOne=function(e,n,r,o){r.single=!0,removeDocuments(e,n,r,function(e,n){if(null!=o){if(e&&o)return o(e);if(null==n)return o(null,{result:{ok:1}});n.deletedCount=n.result.n,o&&o(null,n)}})};define.classMethod("deleteOne",{callback:!0,promise:!0}),Collection.prototype.removeOne=Collection.prototype.deleteOne,define.classMethod("removeOne",{callback:!0,promise:!0}),Collection.prototype.deleteMany=function(e,n,r){var o=this;"function"==typeof n&&(r=n,n={});var n=shallowClone(n);return this.s.options.ignoreUndefined&&(n=shallowClone(n),n.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof r?deleteMany(o,e,n,r):new this.s.promiseLibrary(function(r,t){deleteMany(o,e,n,function(e,n){return e?t(e):void r(n)})})};var deleteMany=function(e,n,r,o){r.single=!1,removeDocuments(e,n,r,function(e,n){if(null!=o){if(e&&o)return o(e);if(null==n)return o(null,{result:{ok:1}});n.deletedCount=n.result.n,o&&o(null,n)}})},removeDocuments=function(e,n,r,o){"function"==typeof r?(o=r,r={}):"function"==typeof n&&(o=n,r={},n={}),r=r||{};var t=writeConcern(shallowClone(r),e.s.db,e,r);null==n&&(n={});var i={q:n,limit:0};r.single&&(i.limit=1),decorateWithCollation(t,e,r),e.s.topology.remove(e.s.namespace,[i],t,function(e,n){return null!=o?e?handleCallback(o,e,null):null==n?handleCallback(o,null,null):n.result.code?handleCallback(o,toError(n.result)):n.result.writeErrors?handleCallback(o,toError(n.result.writeErrors[0])):void handleCallback(o,null,n):void 0})};define.classMethod("deleteMany",{callback:!0,promise:!0}),Collection.prototype.removeMany=Collection.prototype.deleteMany,define.classMethod("removeMany",{callback:!0,promise:!0}),Collection.prototype.remove=function(e,n,r){var o=this;return this.s.options.ignoreUndefined&&(n=shallowClone(n),n.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof r?removeDocuments(o,e,n,r):new this.s.promiseLibrary(function(r,t){removeDocuments(o,e,n,function(e,n){return e?t(e):void r(n)})})},define.classMethod("remove",{callback:!0,promise:!0}),Collection.prototype.save=function(e,n,r){var o=this;return"function"==typeof n&&(r=n,n={}),n=n||{},this.s.options.ignoreUndefined&&(n=shallowClone(n),n.ignoreUndefined=this.s.options.ignoreUndefined),"function"==typeof r?save(o,e,n,r):new this.s.promiseLibrary(function(r,t){save(o,e,n,function(e,n){return e?t(e):void r(n)})})};var save=function(e,n,r,o){var t=writeConcern(shallowClone(r),e.s.db,e,r);return null!=n._id?(t.upsert=!0,updateDocuments(e,{_id:n._id},n,t,o)):void insertDocuments(e,[n],r,function(e,r){return null!=o?null==n?handleCallback(o,null,null):e?handleCallback(o,e,null):void handleCallback(o,null,r):void 0})};define.classMethod("save",{callback:!0,promise:!0}),Collection.prototype.findOne=function(){var e=this,n=Array.prototype.slice.call(arguments,0),r=n.pop();return"function"!=typeof r&&n.push(r),"function"==typeof r?findOne(e,n,r):new this.s.promiseLibrary(function(r,o){findOne(e,n,function(e,n){return e?o(e):void r(n)})})};var findOne=function(e,n,r){var o=e.find.apply(e,n).limit(-1).batchSize(1);o.next(function(e,n){return null!=e?handleCallback(r,toError(e),null):void handleCallback(r,null,n)})};define.classMethod("findOne",{callback:!0,promise:!0}),Collection.prototype.rename=function(e,n,r){var o=this;return"function"==typeof n&&(r=n,n={}),n=assign({},n,{readPreference:ReadPreference.PRIMARY}),"function"==typeof r?rename(o,e,n,r):new this.s.promiseLibrary(function(r,t){rename(o,e,n,function(e,n){return e?t(e):void r(n)})})};var rename=function(e,n,r,o){checkCollectionName(n);var t=f("%s.%s",e.s.dbName,e.s.name),i=f("%s.%s",e.s.dbName,n),l="boolean"==typeof r.dropTarget?r.dropTarget:!1,a={renameCollection:t,to:i,dropTarget:l};decorateWithWriteConcern(a,e,r),e.s.db.admin().command(a,r,function(r,t){if(r)return handleCallback(o,r,null);if(t.errmsg)return handleCallback(o,toError(t),null);try{return handleCallback(o,null,new Collection(e.s.db,e.s.topology,e.s.dbName,n,e.s.pkFactory,e.s.options))}catch(r){return handleCallback(o,toError(r),null)}})};define.classMethod("rename",{callback:!0,promise:!0}),Collection.prototype.drop=function(e,n){var r=this;return"function"==typeof e&&(n=e,e={}),e=e||{},"function"==typeof n?r.s.db.dropCollection(r.s.name,e,n):new this.s.promiseLibrary(function(n,o){r.s.db.dropCollection(r.s.name,e,function(e,r){return e?o(e):void n(r)})})},define.classMethod("drop",{callback:!0,promise:!0}),Collection.prototype.options=function(e){var n=this;return"function"==typeof e?options(n,e):new this.s.promiseLibrary(function(e,r){options(n,function(n,o){return n?r(n):void e(o)})})};var options=function(e,n){e.s.db.listCollections({name:e.s.name}).toArray(function(r,o){return r?handleCallback(n,r):0==o.length?handleCallback(n,MongoError.create({message:f("collection %s not found",e.s.namespace),driver:!0})):void handleCallback(n,r,o[0].options||null)})};define.classMethod("options",{callback:!0,promise:!0}),Collection.prototype.isCapped=function(e){var n=this;return"function"==typeof e?isCapped(n,e):new this.s.promiseLibrary(function(e,r){isCapped(n,function(n,o){return n?r(n):void e(o)})})};var isCapped=function(e,n){e.options(function(e,r){return e?handleCallback(n,e):void handleCallback(n,null,r&&r.capped)})};define.classMethod("isCapped",{callback:!0,promise:!0}),Collection.prototype.createIndex=function(e,n,r){var o=this,t=Array.prototype.slice.call(arguments,1);return r=t.pop(),"function"!=typeof r&&t.push(r),n=t.length?t.shift()||{}:{},n="function"==typeof r?n:r,n=null==n?{}:n,"function"==typeof r?createIndex(o,e,n,r):new this.s.promiseLibrary(function(r,t){createIndex(o,e,n,function(e,n){return e?t(e):void r(n)})})};var createIndex=function(e,n,r,o){e.s.db.createIndex(e.s.name,n,r,o)};define.classMethod("createIndex",{callback:!0,promise:!0}),Collection.prototype.createIndexes=function(e,n){var r=this;return"function"==typeof n?createIndexes(r,e,n):new this.s.promiseLibrary(function(n,o){createIndexes(r,e,function(e,r){return e?o(e):void n(r)})})};var createIndexes=function(e,n,r){for(var o=e.s.topology.capabilities(),t=0;t<n.length;t++)if(null==n[t].name){var i=[];if(n[t].collation&&o&&!o.commandsTakeCollation)return r(new MongoError(f("server/primary/mongos does not support collation")));for(var l in n[t].key)i.push(f("%s_%s",l,n[t].key[l]));n[t].name=i.join("_")}e.s.db.command({createIndexes:e.s.name,indexes:n},{readPreference:ReadPreference.PRIMARY},r)};define.classMethod("createIndexes",{callback:!0,promise:!0}),Collection.prototype.dropIndex=function(e,n,r){var o=this,t=Array.prototype.slice.call(arguments,1);return r=t.pop(),"function"!=typeof r&&t.push(r),n=t.length?t.shift()||{}:{},n.readPreference=ReadPreference.PRIMARY,"function"==typeof r?dropIndex(o,e,n,r):new this.s.promiseLibrary(function(r,t){dropIndex(o,e,n,function(e,n){return e?t(e):void r(n)})})};var dropIndex=function(e,n,r,o){var t={dropIndexes:e.s.name,index:n};decorateWithWriteConcern(t,e,r),e.s.db.command(t,r,function(e,n){return"function"==typeof o?e?handleCallback(o,e,null):void handleCallback(o,null,n):void 0})};define.classMethod("dropIndex",{callback:!0,promise:!0}),Collection.prototype.dropIndexes=function(e,n){var r=this;return"function"==typeof e&&(n=e,e={}),e=e||{},"function"==typeof n?dropIndexes(r,e,n):new this.s.promiseLibrary(function(e,n){dropIndexes(r,function(r,o){return r?n(r):void e(o)})})};var dropIndexes=function(e,n,r){e.dropIndex("*",n,function(e,n){return e?handleCallback(r,e,!1):void handleCallback(r,null,!0)})};define.classMethod("dropIndexes",{callback:!0,promise:!0}),Collection.prototype.dropAllIndexes=Collection.prototype.dropIndexes,define.classMethod("dropAllIndexes",{callback:!0,promise:!0}),Collection.prototype.reIndex=function(e,n){var r=this;return"function"==typeof e&&(n=e,e={}),e=e||{},"function"==typeof n?reIndex(r,e,n):new this.s.promiseLibrary(function(n,o){reIndex(r,e,function(e,r){return e?o(e):void n(r)})})};var reIndex=function(e,n,r){var o={reIndex:e.s.name};decorateWithWriteConcern(o,e,n),e.s.db.command(o,n,function(e,n){return null!=r?e?handleCallback(r,e,null):void handleCallback(r,null,n.ok?!0:!1):void 0})};define.classMethod("reIndex",{callback:!0,promise:!0}),Collection.prototype.listIndexes=function(e){if(e=e||{},e=shallowClone(e),e=getReadPreference(this,e,this.s.db,this),e.cursorFactory=CommandCursor,e.promiseLibrary=this.s.promiseLibrary,!this.s.topology.capabilities())throw new MongoError("cannot connect to server");if(this.s.topology.capabilities().hasListIndexesCommand){var n=e.batchSize?{batchSize:e.batchSize}:{},r={listIndexes:this.s.name,cursor:n},n=this.s.topology.cursor(f("%s.$cmd",this.s.dbName),r,e);return e.readPreference&&n.setReadPreference(e.readPreference),n}var o=f("%s.system.indexes",this.s.dbName),n=this.s.topology.cursor(o,{find:o,query:{ns:this.s.namespace}},e);return e.readPreference&&n.setReadPreference(e.readPreference),e.batchSize&&(n=n.batchSize(e.batchSize)),n},define.classMethod("listIndexes",{callback:!1,promise:!1,returns:[CommandCursor]}),Collection.prototype.ensureIndex=function(e,n,r){var o=this;return"function"==typeof n&&(r=n,n={}),n=n||{},"function"==typeof r?ensureIndex(o,e,n,r):new this.s.promiseLibrary(function(r,t){ensureIndex(o,e,n,function(e,n){return e?t(e):void r(n)})})};var ensureIndex=function(e,n,r,o){e.s.db.ensureIndex(e.s.name,n,r,o)};define.classMethod("ensureIndex",{callback:!0,promise:!0}),Collection.prototype.indexExists=function(e,n){var r=this;return"function"==typeof n?indexExists(r,e,n):new this.s.promiseLibrary(function(n,o){indexExists(r,e,function(e,r){return e?o(e):void n(r)})})};var indexExists=function(e,n,r){e.indexInformation(function(e,o){if(null!=e)return handleCallback(r,e,null);if(!Array.isArray(n))return handleCallback(r,null,null!=o[n]);for(var t=0;t<n.length;t++)if(null==o[n[t]])return handleCallback(r,null,!1);return handleCallback(r,null,!0)})};define.classMethod("indexExists",{callback:!0,promise:!0}),Collection.prototype.indexInformation=function(e,n){var r=this,o=Array.prototype.slice.call(arguments,0);return n=o.pop(),"function"!=typeof n&&o.push(n),e=o.length?o.shift()||{}:{},"function"==typeof n?indexInformation(r,e,n):new this.s.promiseLibrary(function(n,o){indexInformation(r,e,function(e,r){return e?o(e):void n(r)})})};var indexInformation=function(e,n,r){e.s.db.indexInformation(e.s.name,n,r)};define.classMethod("indexInformation",{callback:!0,promise:!0}),Collection.prototype.count=function(e,n,r){var o=this,t=Array.prototype.slice.call(arguments,0);r=t.pop(),"function"!=typeof r&&t.push(r);var i=t.length?t.shift()||{}:{},l=t.length?t.shift()||{}:{};return"function"==typeof r?count(o,i,l,r):(e=e||{},n=n||{},new this.s.promiseLibrary(function(r,t){count(o,e,n,function(e,n){return e?t(e):void r(n)})}))};var count=function(e,n,r,o){var t=r.skip,i=r.limit,l=r.hint,a=(r.maxTimeMS,{count:e.s.name,query:n});"number"==typeof t&&(a.skip=t),"number"==typeof i&&(a.limit=i),l&&(r.hint=l),r=shallowClone(r),r=getReadPreference(e,r,e.s.db,e),e.s.readConcern&&(a.readConcern=e.s.readConcern),decorateWithCollation(a,e,r),e.s.db.command(a,r,function(e,n){return e?handleCallback(o,e):void handleCallback(o,null,n.n)})};define.classMethod("count",{callback:!0,promise:!0}),Collection.prototype.distinct=function(e,n,r,o){var t=this,i=Array.prototype.slice.call(arguments,1);o=i.pop(),"function"!=typeof o&&i.push(o);var l=i.length?i.shift()||{}:{},a=i.length?i.shift()||{}:{};return"function"==typeof o?distinct(t,e,l,a,o):(n=n||{},r=r||{},new this.s.promiseLibrary(function(o,i){distinct(t,e,n,r,function(e,n){return e?i(e):void o(n)})}))};var distinct=function(e,n,r,o,t){var i=(o.maxTimeMS,{distinct:e.s.name,key:n,query:r});o=shallowClone(o),o=getReadPreference(e,o,e.s.db,e),e.s.readConcern&&(i.readConcern=e.s.readConcern),decorateWithCollation(i,e,o),e.s.db.command(i,o,function(e,n){return e?handleCallback(t,e):void handleCallback(t,null,n.values)})};define.classMethod("distinct",{callback:!0,promise:!0}),Collection.prototype.indexes=function(e){var n=this;return"function"==typeof e?indexes(n,e):new this.s.promiseLibrary(function(e,r){indexes(n,function(n,o){return n?r(n):void e(o)})})};var indexes=function(e,n){e.s.db.indexInformation(e.s.name,{full:!0},n)};define.classMethod("indexes",{callback:!0,promise:!0}),Collection.prototype.stats=function(e,n){var r=this,o=Array.prototype.slice.call(arguments,0);return n=o.pop(),"function"!=typeof n&&o.push(n),e=o.length?o.shift()||{}:{},"function"==typeof n?stats(r,e,n):new this.s.promiseLibrary(function(n,o){stats(r,e,function(e,r){return e?o(e):void n(r)})})};var stats=function(e,n,r){var o={collStats:e.s.name};null!=n.scale&&(o.scale=n.scale),n=shallowClone(n),n=getReadPreference(e,n,e.s.db,e),e.s.db.command(o,n,r)};define.classMethod("stats",{callback:!0,promise:!0}),Collection.prototype.findOneAndDelete=function(e,n,r){var o=this;if("function"==typeof n&&(r=n,n={}),n=n||{},null==e||"object"!=typeof e)throw toError("filter parameter must be an object");return"function"==typeof r?findOneAndDelete(o,e,n,r):new this.s.promiseLibrary(function(r,t){n=n||{},findOneAndDelete(o,e,n,function(e,n){return e?t(e):void r(n)})})};var findOneAndDelete=function(e,n,r,o){var t=shallowClone(r);t.fields=r.projection,t.remove=!0,e.findAndModify(n,r.sort,null,t,o)};define.classMethod("findOneAndDelete",{callback:!0,promise:!0}),Collection.prototype.findOneAndReplace=function(e,n,r,o){var t=this;if("function"==typeof r&&(o=r,r={}),r=r||{},null==e||"object"!=typeof e)throw toError("filter parameter must be an object");if(null==n||"object"!=typeof n)throw toError("replacement parameter must be an object");return"function"==typeof o?findOneAndReplace(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){r=r||{},findOneAndReplace(t,e,n,r,function(e,n){return e?i(e):void o(n)})})};var findOneAndReplace=function(e,n,r,o,t){var i=shallowClone(o);i.fields=o.projection,i.update=!0,i["new"]="boolean"==typeof o.returnOriginal?!o.returnOriginal:!1,i.upsert="boolean"==typeof o.upsert?o.upsert:!1,e.findAndModify(n,o.sort,r,i,t)};define.classMethod("findOneAndReplace",{callback:!0,promise:!0}),Collection.prototype.findOneAndUpdate=function(e,n,r,o){var t=this;if("function"==typeof r&&(o=r,r={}),r=r||{},null==e||"object"!=typeof e)throw toError("filter parameter must be an object");if(null==n||"object"!=typeof n)throw toError("update parameter must be an object");return"function"==typeof o?findOneAndUpdate(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){r=r||{},findOneAndUpdate(t,e,n,r,function(e,n){return e?i(e):void o(n)})})};var findOneAndUpdate=function(e,n,r,o,t){var i=shallowClone(o);i.fields=o.projection,i.update=!0,i["new"]="boolean"==typeof o.returnOriginal?!o.returnOriginal:!1,i.upsert="boolean"==typeof o.upsert?o.upsert:!1,e.findAndModify(n,o.sort,r,i,t)};define.classMethod("findOneAndUpdate",{callback:!0,promise:!0}),Collection.prototype.findAndModify=function(e,n,r,o,t){var i=this,l=Array.prototype.slice.call(arguments,1);t=l.pop(),"function"!=typeof t&&l.push(t),n=l.length?l.shift()||[]:[],r=l.length?l.shift():null,o=l.length?l.shift()||{}:{};var o=shallowClone(o);return o.readPreference=ReadPreference.PRIMARY,"function"==typeof t?findAndModify(i,e,n,r,o,t):new this.s.promiseLibrary(function(t,l){o=o||{},findAndModify(i,e,n,r,o,function(e,n){return e?l(e):void t(n)})})};var findAndModify=function(e,n,r,o,t,i){var l={findandmodify:e.s.name,query:n};r=formattedOrderClause(r),r&&(l.sort=r),l["new"]=t["new"]?!0:!1,l.remove=t.remove?!0:!1,l.upsert=t.upsert?!0:!1,t.fields&&(l.fields=t.fields),o&&!t.remove&&(l.update=o),null!=t.serializeFunctions?t.serializeFunctions=t.serializeFunctions:t.serializeFunctions=e.s.serializeFunctions,t.checkKeys=!1;var a=writeConcern(t,e.s.db,e,t);a.writeConcern&&(l.writeConcern=a.writeConcern),"boolean"==typeof a.bypassDocumentValidation&&(l.bypassDocumentValidation=a.bypassDocumentValidation),decorateWithCollation(l,e,t),e.s.db.command(l,t,function(e,n){return e?handleCallback(i,e,null):handleCallback(i,null,n)})};define.classMethod("findAndModify",{callback:!0,promise:!0}),Collection.prototype.findAndRemove=function(e,n,r,o){var t=this,i=Array.prototype.slice.call(arguments,1);return o=i.pop(),"function"!=typeof o&&i.push(o),n=i.length?i.shift()||[]:[],r=i.length?i.shift()||{}:{},"function"==typeof o?findAndRemove(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){findAndRemove(t,e,n,r,function(e,n){return e?i(e):void o(n)})})};var findAndRemove=function(e,n,r,o,t){o.remove=!0,e.findAndModify(n,r,null,o,t)};define.classMethod("findAndRemove",{callback:!0,promise:!0}),Collection.prototype.aggregate=function(e,n,r){var o=this;if(Array.isArray(e))"function"==typeof n&&(r=n,n={}),null==n&&null==r&&(n={});else{var t=Array.prototype.slice.call(arguments,0);r=t.pop();var i=t[t.length-1];n=i&&(i.readPreference||i.explain||i.cursor||i.out||i.maxTimeMS||i.allowDiskUse)?t.pop():{},e=t}var l=!1;"string"==typeof n.out?(e.push({$out:n.out}),l=!0):e.length>0&&e[e.length-1].$out&&(l=!0);var a={aggregate:this.s.name,pipeline:e};if(decorateWithWriteConcern(a,o,n),decorateWithCollation(a,o,n),"boolean"==typeof n.bypassDocumentValidation&&(a.bypassDocumentValidation=n.bypassDocumentValidation),!l&&this.s.readConcern&&(a.readConcern=this.s.readConcern),n.allowDiskUse&&(a.allowDiskUse=n.allowDiskUse),"number"==typeof n.maxTimeMS&&(a.maxTimeMS=n.maxTimeMS),n=shallowClone(n),n=getReadPreference(this,n,this.s.db,this),n.explain&&(a.explain=n.explain),null!=n.cursor&&"object"!=typeof n.cursor)throw toError("cursor options must be an object");
if(n.promiseLibrary=this.s.promiseLibrary,n.cursorFactory=AggregationCursor,"function"!=typeof r){if(!this.s.topology.capabilities())throw new MongoError("cannot connect to server");return this.s.topology.capabilities().hasAggregationCursor&&(n.cursor=n.cursor||{batchSize:1e3},a.cursor=n.cursor),"boolean"==typeof n.allowDiskUse&&(a.allowDiskUse=n.allowDiskUse),"number"==typeof n.maxTimeMS&&(a.maxTimeMS=n.maxTimeMS),this.s.topology.cursor(this.s.namespace,a,n)}return n.cursor?this.s.topology.cursor(this.s.namespace,a,n):void this.s.db.command(a,n,function(e,n){e?handleCallback(r,e):n.err||n.errmsg?handleCallback(r,toError(n)):"object"==typeof n&&n.serverPipeline?handleCallback(r,null,n.serverPipeline):"object"==typeof n&&n.stages?handleCallback(r,null,n.stages):handleCallback(r,null,n.result)})},define.classMethod("aggregate",{callback:!0,promise:!1}),Collection.prototype.parallelCollectionScan=function(e,n){var r=this;return"function"==typeof e&&(n=e,e={numCursors:1}),e.numCursors=e.numCursors||1,e.batchSize=e.batchSize||1e3,e=shallowClone(e),e=getReadPreference(this,e,this.s.db,this),e.promiseLibrary=this.s.promiseLibrary,"function"==typeof n?parallelCollectionScan(r,e,n):new this.s.promiseLibrary(function(n,o){parallelCollectionScan(r,e,function(e,r){return e?o(e):void n(r)})})};var parallelCollectionScan=function(e,n,r){var o={parallelCollectionScan:e.s.name,numCursors:n.numCursors};e.s.readConcern&&(o.readConcern=e.s.readConcern);var t=n.raw;delete n.raw,e.s.db.command(o,n,function(o,i){if(o)return handleCallback(r,o,null);if(null==i)return handleCallback(r,new Error("no result returned for parallelCollectionScan"),null);var l=[];t&&(n.raw=t);for(var a=0;a<i.cursors.length;a++){var s=i.cursors[a].cursor.id,c="number"==typeof s?Long.fromNumber(s):s;({batchSize:n.batchSize,cursorId:c,items:i.cursors[a].cursor.firstBatch});l.push(e.s.topology.cursor(e.s.namespace,c,n))}handleCallback(r,null,l)})};define.classMethod("parallelCollectionScan",{callback:!0,promise:!0}),Collection.prototype.geoNear=function(e,n,r,o){var t=this,i="object"==typeof e&&e,l=Array.prototype.slice.call(arguments,i?1:2);return o=l.pop(),"function"!=typeof o&&l.push(o),r=l.length?l.shift()||{}:{},"function"==typeof o?geoNear(t,e,n,i,r,o):new this.s.promiseLibrary(function(o,l){geoNear(t,e,n,i,r,function(e,n){return e?l(e):void o(n)})})};var geoNear=function(e,n,r,o,t,i){var l={geoNear:e.s.name,near:o||[n,r]};t=shallowClone(t),t=getReadPreference(e,t,e.s.db,e);var a={readPreference:!0,geoNear:!0,near:!0};l=decorateCommand(l,t,a),e.s.readConcern&&(l.readConcern=e.s.readConcern),decorateWithCollation(l,e,t),e.s.db.command(l,t,function(e,n){return e?handleCallback(i,e):n.err||n.errmsg?handleCallback(i,toError(n)):void handleCallback(i,null,n)})};define.classMethod("geoNear",{callback:!0,promise:!0}),Collection.prototype.geoHaystackSearch=function(e,n,r,o){var t=this,i=Array.prototype.slice.call(arguments,2);return o=i.pop(),"function"!=typeof o&&i.push(o),r=i.length?i.shift()||{}:{},"function"==typeof o?geoHaystackSearch(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){geoHaystackSearch(t,e,n,r,function(e,n){return e?i(e):void o(n)})})};var geoHaystackSearch=function(e,n,r,o,t){var i={geoSearch:e.s.name,near:[n,r]};i=decorateCommand(i,o,{readPreference:!0}),o=shallowClone(o),o=getReadPreference(e,o,e.s.db,e),e.s.readConcern&&(i.readConcern=e.s.readConcern),e.s.db.command(i,o,function(e,n){return e?handleCallback(t,e):((n.err||n.errmsg)&&handleCallback(t,utils.toError(n)),void handleCallback(t,null,n))})};define.classMethod("geoHaystackSearch",{callback:!0,promise:!0});var groupFunction='function () {\nvar c = db[ns].find(condition);\nvar map = new Map();\nvar reduce_function = reduce;\n\nwhile (c.hasNext()) {\nvar obj = c.next();\nvar key = {};\n\nfor (var i = 0, len = keys.length; i < len; ++i) {\nvar k = keys[i];\nkey[k] = obj[k];\n}\n\nvar aggObj = map.get(key);\n\nif (aggObj == null) {\nvar newObj = Object.extend({}, key);\naggObj = Object.extend(newObj, initial);\nmap.put(key, aggObj);\n}\n\nreduce_function(obj, aggObj);\n}\n\nreturn { "result": map.values() };\n}';Collection.prototype.group=function(e,n,r,o,t,i,l,a){var s=this,c=Array.prototype.slice.call(arguments,3);return a=c.pop(),"function"!=typeof a&&c.push(a),o=c.length?c.shift():null,t=c.length?c.shift():null,i=c.length?c.shift():null,l=c.length?c.shift()||{}:{},"function"!=typeof t&&(i=t,t=null),Array.isArray(e)||!(e instanceof Object)||"function"==typeof e||e instanceof Code||(e=Object.keys(e)),"function"==typeof o&&(o=o.toString()),"function"==typeof t&&(t=t.toString()),i=null==i?!0:i,"function"==typeof a?group(s,e,n,r,o,t,i,l,a):new this.s.promiseLibrary(function(a,c){group(s,e,n,r,o,t,i,l,function(e,n){return e?c(e):void a(n)})})};var group=function(e,n,r,o,t,i,l,a,s){if(l){var c=t instanceof Code?t:new Code(t),u={group:{ns:e.s.name,$reduce:c,cond:r,initial:o,out:"inline"}};if(null!=i&&(u.group.finalize=i),"function"==typeof n||n instanceof Code)u.group.$keyf=n instanceof Code?n:new Code(n);else{var d={};n.forEach(function(e){d[e]=1}),u.group.key=d}a=shallowClone(a),a=getReadPreference(e,a,e.s.db,e),e.s.readConcern&&(u.readConcern=e.s.readConcern),decorateWithCollation(u,e,a),e.s.db.command(u,a,function(e,n){return e?handleCallback(s,e,null):void handleCallback(s,null,n.retval)})}else{var f=null!=t&&t instanceof Code?t.scope:{};f.ns=e.s.name,f.keys=n,f.condition=r,f.initial=o;var p=groupFunction.replace(/ reduce;/,t.toString()+";");e.s.db.eval(new Code(p,f),function(e,n){return e?handleCallback(s,e,null):void handleCallback(s,null,n.result||n)})}};define.classMethod("group",{callback:!0,promise:!0}),Collection.prototype.mapReduce=function(e,n,r,o){var t=this;if("function"==typeof r&&(o=r,r={}),null==r.out)throw new Error("the out option parameter must be defined, see mongodb docs for possible values");return"function"==typeof e&&(e=e.toString()),"function"==typeof n&&(n=n.toString()),"function"==typeof r.finalize&&(r.finalize=r.finalize.toString()),"function"==typeof o?mapReduce(t,e,n,r,o):new this.s.promiseLibrary(function(o,i){mapReduce(t,e,n,r,function(e,n,r){return e?i(e):r?void o({results:n,stats:r}):o(n)})})};var mapReduce=function(e,n,r,o,t){var i={mapreduce:e.s.name,map:n,reduce:r};for(var l in o)"scope"==l?i[l]=processScope(o[l]):i[l]=o[l];o=shallowClone(o),o=getReadPreference(e,o,e.s.db,e),0!=o.readPreference&&"primary"!=o.readPreference&&o.out&&1!=o.out.inline&&"inline"!=o.out?(o.readPreference="primary",decorateWithWriteConcern(i,e,o)):e.s.readConcern&&(i.readConcern=e.s.readConcern),"boolean"==typeof o.bypassDocumentValidation&&(i.bypassDocumentValidation=o.bypassDocumentValidation),decorateWithCollation(i,e,o),e.s.db.command(i,{readPreference:o.readPreference},function(n,r){if(n)return handleCallback(t,n);if(1!=r.ok||r.err||r.errmsg)return handleCallback(t,toError(r));var i={};if(r.timeMillis&&(i.processtime=r.timeMillis),r.counts&&(i.counts=r.counts),r.timing&&(i.timing=r.timing),r.results)return null!=o.verbose&&o.verbose?handleCallback(t,null,r.results,i):handleCallback(t,null,r.results);var l=null;if(null!=r.result&&"object"==typeof r.result){var a=r.result;l=e.s.db.db(a.db).collection(a.collection)}else l=e.s.db.collection(r.result);return null!=o.verbose&&o.verbose?void handleCallback(t,n,l,i):handleCallback(t,n,l)})};define.classMethod("mapReduce",{callback:!0,promise:!0}),Collection.prototype.initializeUnorderedBulkOp=function(e){return e=e||{},e.promiseLibrary=this.s.promiseLibrary,unordered(this.s.topology,this,e)},define.classMethod("initializeUnorderedBulkOp",{callback:!1,promise:!1,returns:[ordered.UnorderedBulkOperation]}),Collection.prototype.initializeOrderedBulkOp=function(e){return e=e||{},e.promiseLibrary=this.s.promiseLibrary,ordered(this.s.topology,this,e)},define.classMethod("initializeOrderedBulkOp",{callback:!1,promise:!1,returns:[ordered.OrderedBulkOperation]});var writeConcern=function(e,n,r,o){if(null!=o.w||null!=o.j||null!=o.fsync){var t={};null!=o.w&&(t.w=o.w),null!=o.wtimeout&&(t.wtimeout=o.wtimeout),null!=o.j&&(t.j=o.j),null!=o.fsync&&(t.fsync=o.fsync),e.writeConcern=t}else null!=r.writeConcern.w||null!=r.writeConcern.j||null!=r.writeConcern.fsync?e.writeConcern=r.writeConcern:(null!=n.writeConcern.w||null!=n.writeConcern.j||null!=n.writeConcern.fsync)&&(e.writeConcern=n.writeConcern);return e},getReadPreference=function(e,n,r,o){var t=null;if(n.readPreference?t=n.readPreference:e.s.readPreference?t=e.s.readPreference:r.s.readPreference&&(t=r.s.readPreference),t instanceof ReadPreference)n.readPreference=new CoreReadPreference(t.mode,t.tags,{maxStalenessMS:t.maxStalenessMS});else if("string"==typeof t)n.readPreference=new CoreReadPreference(t);else if(t&&!(t instanceof ReadPreference)&&"object"==typeof t){var i=t.mode||t.preference;i&&"string"==typeof i&&(n.readPreference=new CoreReadPreference(i,t.tags,{maxStalenessMS:t.maxStalenessMS}))}return n},testForFields={limit:1,sort:1,fields:1,skip:1,hint:1,explain:1,snapshot:1,timeout:1,tailable:1,tailableRetryInterval:1,numberOfRetries:1,awaitdata:1,awaitData:1,exhaust:1,batchSize:1,returnKey:1,maxScan:1,min:1,max:1,showDiskLoc:1,comment:1,raw:1,readPreference:1,partial:1,read:1,dbName:1,oplogReplay:1,connection:1,maxTimeMS:1,transforms:1,collation:1};module.exports=Collection;