"use strict";var toError=require("./utils").toError,Define=require("./metadata"),shallowClone=require("./utils").shallowClone,Admin=function(n,e,t){if(!(this instanceof Admin))return new Admin(n,e);this.s={db:n,topology:e,promiseLibrary:t}},define=Admin.define=new Define("Admin",Admin,!1);Admin.prototype.command=function(n,e,t){var r=this,i=Array.prototype.slice.call(arguments,1);return t=i.pop(),"function"!=typeof t&&i.push(t),e=i.length?i.shift():{},"function"==typeof t?this.s.db.executeDbAdminCommand(n,e,function(n,e){return null!=t?t(n,e):null}):new this.s.promiseLibrary(function(t,i){r.s.db.executeDbAdminCommand(n,e,function(n,e){return n?i(n):void t(e)})})},define.classMethod("command",{callback:!0,promise:!0}),Admin.prototype.buildInfo=function(n){var e=this;return"function"==typeof n?this.serverInfo(n):new this.s.promiseLibrary(function(n,t){e.serverInfo(function(e,r){return e?t(e):void n(r)})})},define.classMethod("buildInfo",{callback:!0,promise:!0}),Admin.prototype.serverInfo=function(n){var e=this;return"function"==typeof n?this.s.db.executeDbAdminCommand({buildinfo:1},function(e,t){return null!=e?n(e,null):void n(null,t)}):new this.s.promiseLibrary(function(n,t){e.s.db.executeDbAdminCommand({buildinfo:1},function(e,r){return e?t(e):void n(r)})})},define.classMethod("serverInfo",{callback:!0,promise:!0}),Admin.prototype.serverStatus=function(n){var e=this;return"function"==typeof n?serverStatus(e,n):new this.s.promiseLibrary(function(n,t){serverStatus(e,function(e,r){return e?t(e):void n(r)})})};var serverStatus=function(n,e){n.s.db.executeDbAdminCommand({serverStatus:1},function(n,t){return null!=n||1!==t.ok?n?e(n,!1):e(toError(t),!1):void e(null,t)})};define.classMethod("serverStatus",{callback:!0,promise:!0}),Admin.prototype.profilingLevel=function(n){var e=this;return"function"==typeof n?profilingLevel(e,n):new this.s.promiseLibrary(function(n,t){profilingLevel(e,function(e,r){return e?t(e):void n(r)})})};var profilingLevel=function(n,e){n.s.db.executeDbAdminCommand({profile:-1},function(n,t){if(t=t,null==n&&1===t.ok){var r=t.was;return 0==r?e(null,"off"):1==r?e(null,"slow_only"):2==r?e(null,"all"):e(new Error("Error: illegal profiling level value "+r),null)}null!=n?e(n,null):e(new Error("Error with profile command"),null)})};define.classMethod("profilingLevel",{callback:!0,promise:!0}),Admin.prototype.ping=function(n,e){var t=this,r=Array.prototype.slice.call(arguments,0);return e=r.pop(),"function"!=typeof e&&r.push(e),"function"==typeof e?this.s.db.executeDbAdminCommand({ping:1},e):new this.s.promiseLibrary(function(n,e){t.s.db.executeDbAdminCommand({ping:1},function(t,r){return t?e(t):void n(r)})})},define.classMethod("ping",{callback:!0,promise:!0}),Admin.prototype.authenticate=function(n,e,t,r){var i=this;return"function"==typeof t&&(r=t,t={}),t=shallowClone(t),t.authdb="admin","function"==typeof r?this.s.db.authenticate(n,e,t,r):new this.s.promiseLibrary(function(r,o){i.s.db.authenticate(n,e,t,function(n,e){return n?o(n):void r(e)})})},define.classMethod("authenticate",{callback:!0,promise:!0}),Admin.prototype.logout=function(n){var e=this;return"function"==typeof n?this.s.db.logout({authdb:"admin"},n):new this.s.promiseLibrary(function(n,t){e.s.db.logout({authdb:"admin"},function(e,r){return e?t(e):void n(r)})})},define.classMethod("logout",{callback:!0,promise:!0});var writeConcern=function(n,e){return n=shallowClone(n),n.w||n.wtimeout||n.j||n.fsync?n:(e.writeConcern&&(n.w&&(n.w=e.writeConcern.w),n.wtimeout&&(n.wtimeout=e.writeConcern.wtimeout),n.j&&(n.j=e.writeConcern.j),n.fsync&&(n.fsync=e.writeConcern.fsync)),n)};Admin.prototype.addUser=function(n,e,t,r){var i=this,o=Array.prototype.slice.call(arguments,2);return r=o.pop(),"function"!=typeof r&&o.push(r),t=o.length?o.shift():{},t=t||{},t=writeConcern(t,i.s.db),t.dbName="admin","function"==typeof r?i.s.db.addUser(n,e,t,r):new this.s.promiseLibrary(function(r,o){i.s.db.addUser(n,e,t,function(n,e){return n?o(n):void r(e)})})},define.classMethod("addUser",{callback:!0,promise:!0}),Admin.prototype.removeUser=function(n,e,t){var r=this,i=Array.prototype.slice.call(arguments,1);return t=i.pop(),"function"!=typeof t&&i.push(t),e=i.length?i.shift():{},e=e||{},e=writeConcern(e,r.s.db),e.dbName="admin","function"==typeof t?r.s.db.removeUser(n,e,t):new this.s.promiseLibrary(function(t,i){r.s.db.removeUser(n,e,function(n,e){return n?i(n):void t(e)})})},define.classMethod("removeUser",{callback:!0,promise:!0}),Admin.prototype.setProfilingLevel=function(n,e){var t=this;return"function"==typeof e?setProfilingLevel(t,n,e):new this.s.promiseLibrary(function(e,r){setProfilingLevel(t,n,function(n,t){return n?r(n):void e(t)})})};var setProfilingLevel=function(n,e,t){var r={},i=0;if("off"==e)i=0;else if("slow_only"==e)i=1;else{if("all"!=e)return t(new Error("Error: illegal profiling level value "+e));i=2}r.profile=i,n.s.db.executeDbAdminCommand(r,function(n,r){return r=r,null==n&&1===r.ok?t(null,e):null!=n?t(n,null):t(new Error("Error with profile command"),null)})};define.classMethod("setProfilingLevel",{callback:!0,promise:!0}),Admin.prototype.profilingInfo=function(n){var e=this;return"function"==typeof n?profilingInfo(e,n):new this.s.promiseLibrary(function(n,t){profilingInfo(e,function(e,r){return e?t(e):void n(r)})})};var profilingInfo=function(n,e){try{n.s.topology.cursor("admin.system.profile",{find:"system.profile",query:{}},{}).toArray(e)}catch(t){return e(t,null)}};define.classMethod("profilingLevel",{callback:!0,promise:!0}),Admin.prototype.validateCollection=function(n,e,t){var r=this,i=Array.prototype.slice.call(arguments,1);return t=i.pop(),"function"!=typeof t&&i.push(t),e=i.length?i.shift():{},e=e||{},"function"==typeof t?validateCollection(r,n,e,t):new this.s.promiseLibrary(function(t,i){validateCollection(r,n,e,function(n,e){return n?i(n):void t(e)})})};var validateCollection=function(n,e,t,r){for(var i={validate:e},o=Object.keys(t),l=0;l<o.length;l++)t.hasOwnProperty(o[l])&&(i[o[l]]=t[o[l]]);n.s.db.command(i,function(n,t){return null!=n?r(n,null):0===t.ok?r(new Error("Error with validate command"),null):null!=t.result&&t.result.constructor!=String?r(new Error("Error with validation data"),null):null!=t.result&&null!=t.result.match(/exception|corrupt/)?r(new Error("Error: invalid collection "+e),null):null==t.valid||t.valid?r(null,t):r(new Error("Error: invalid collection "+e),null)})};define.classMethod("validateCollection",{callback:!0,promise:!0}),Admin.prototype.listDatabases=function(n){var e=this;return"function"==typeof n?e.s.db.executeDbAdminCommand({listDatabases:1},{},n):new this.s.promiseLibrary(function(n,t){e.s.db.executeDbAdminCommand({listDatabases:1},{},function(e,r){return e?t(e):void n(r)})})},define.classMethod("listDatabases",{callback:!0,promise:!0}),Admin.prototype.replSetGetStatus=function(n){var e=this;return"function"==typeof n?replSetGetStatus(e,n):new this.s.promiseLibrary(function(n,t){replSetGetStatus(e,function(e,r){return e?t(e):void n(r)})})};var replSetGetStatus=function(n,e){n.s.db.executeDbAdminCommand({replSetGetStatus:1},function(n,t){return null==n&&1===t.ok?e(null,t):n?e(n,!1):void e(toError(t),!1)})};define.classMethod("replSetGetStatus",{callback:!0,promise:!0}),module.exports=Admin;