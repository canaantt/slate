"use strict";function OrderedBulkOperation(e,t,r){r=null==r?{}:r;var n=!1,o=null,s=e.bson,i=t.collectionName,a=e.isMasterDoc&&e.isMasterDoc.maxBsonObjectSize?e.isMasterDoc.maxBsonObjectSize:16793600,c=e.isMasterDoc&&e.isMasterDoc.maxWriteBatchSize?e.isMasterDoc.maxWriteBatchSize:1e3,u=common.writeConcern(shallowClone(r),t,r),l=r.promiseLibrary;l||(l="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise);var d={ok:1,writeErrors:[],writeConcernErrors:[],insertedIds:[],nInserted:0,nUpserted:0,nMatched:0,nModified:0,nRemoved:0,upserted:[]};this.s={bulkResult:d,currentBatch:null,currentIndex:0,currentBatchSize:0,currentBatchSizeBytes:0,batches:[],writeConcern:u,maxBatchSizeBytes:a,maxWriteBatchSize:c,namespace:i,bson:s,topology:e,options:r,currentOp:o,executed:n,collection:t,promiseLibrary:l,err:null,bypassDocumentValidation:"boolean"==typeof r.bypassDocumentValidation?r.bypassDocumentValidation:!1}}var common=require("./common"),utils=require("../utils"),toError=require("../utils").toError,f=require("util").format,handleCallback=require("../utils").handleCallback,shallowClone=utils.shallowClone,WriteError=common.WriteError,BulkWriteResult=common.BulkWriteResult,LegacyOp=common.LegacyOp,ObjectID=require("mongodb-core").BSON.ObjectID,Define=require("../metadata"),BSON=require("mongodb-core").BSON,Batch=common.Batch,mergeBatchResults=common.mergeBatchResults,bson=new BSON.BSONPure,FindOperatorsOrdered=function(e){this.s=e.s};FindOperatorsOrdered.prototype.update=function(e){var t="boolean"==typeof this.s.currentOp.upsert?this.s.currentOp.upsert:!1,r={q:this.s.currentOp.selector,u:e,multi:!0,upsert:t};return this.s.currentOp=null,addToOperationsList(this,common.UPDATE,r)},FindOperatorsOrdered.prototype.updateOne=function(e){var t="boolean"==typeof this.s.currentOp.upsert?this.s.currentOp.upsert:!1,r={q:this.s.currentOp.selector,u:e,multi:!1,upsert:t};return this.s.currentOp=null,addToOperationsList(this,common.UPDATE,r)},FindOperatorsOrdered.prototype.replaceOne=function(e){this.updateOne(e)},FindOperatorsOrdered.prototype.upsert=function(){return this.s.currentOp.upsert=!0,this},FindOperatorsOrdered.prototype.deleteOne=function(){var e={q:this.s.currentOp.selector,limit:1};return this.s.currentOp=null,addToOperationsList(this,common.REMOVE,e)},FindOperatorsOrdered.prototype.removeOne=FindOperatorsOrdered.prototype.deleteOne,FindOperatorsOrdered.prototype["delete"]=function(){var e={q:this.s.currentOp.selector,limit:0};return this.s.currentOp=null,addToOperationsList(this,common.REMOVE,e)},FindOperatorsOrdered.prototype.remove=FindOperatorsOrdered.prototype["delete"];var addToOperationsList=function(e,t,r){var n=bson.calculateObjectSize(r,!1);if(n>=e.s.maxBatchSizeBytes)throw toError("document is larger than the maximum size "+e.s.maxBatchSizeBytes);if(null==e.s.currentBatch&&(e.s.currentBatch=new Batch(t,e.s.currentIndex)),e.s.currentBatchSize+1>=e.s.maxWriteBatchSize||e.s.currentBatchSizeBytes+e.s.currentBatchSizeBytes>=e.s.maxBatchSizeBytes||e.s.currentBatch.batchType!=t?(e.s.batches.push(e.s.currentBatch),e.s.currentBatch=new Batch(t,e.s.currentIndex),e.s.currentBatchSize=0,e.s.currentBatchSizeBytes=0):(e.s.currentBatchSize=e.s.currentBatchSize+1,e.s.currentBatchSizeBytes=e.s.currentBatchSizeBytes+n),t==common.INSERT&&e.s.bulkResult.insertedIds.push({index:e.s.currentIndex,_id:r._id}),Array.isArray(r))throw toError("operation passed in cannot be an Array");return e.s.currentBatch.originalIndexes.push(e.s.currentIndex),e.s.currentBatch.operations.push(r),e.s.currentBatchSizeBytes=e.s.currentBatchSizeBytes+n,e.s.currentIndex=e.s.currentIndex+1,e},define=OrderedBulkOperation.define=new Define("OrderedBulkOperation",OrderedBulkOperation,!1);OrderedBulkOperation.prototype.raw=function(e){var t=Object.keys(e)[0],r="boolean"==typeof this.s.options.forceServerObjectId?this.s.options.forceServerObjectId:this.s.collection.s.db.options.forceServerObjectId;if(e.updateOne&&e.updateOne.q||e.updateMany&&e.updateMany.q||e.replaceOne&&e.replaceOne.q)return e[t].multi=e.updateOne||e.replaceOne?!1:!0,addToOperationsList(this,common.UPDATE,e[t]);if(e.updateOne||e.updateMany||e.replaceOne){var n=e.updateOne||e.replaceOne?!1:!0,o={q:e[t].filter,u:e[t].update||e[t].replacement,multi:n};return o.upsert=e[t].upsert?!0:!1,addToOperationsList(this,common.UPDATE,o)}if(e.removeOne||e.removeMany||e.deleteOne&&e.deleteOne.q||e.deleteMany&&e.deleteMany.q)return e[t].limit=e.removeOne?1:0,addToOperationsList(this,common.REMOVE,e[t]);if(e.deleteOne||e.deleteMany){var s=e.deleteOne?1:0,o={q:e[t].filter,limit:s};return addToOperationsList(this,common.REMOVE,o)}if(e.insertOne&&null==e.insertOne.document)return r!==!0&&null==e.insertOne._id&&(e.insertOne._id=new ObjectID),addToOperationsList(this,common.INSERT,e.insertOne);if(e.insertOne&&e.insertOne.document)return r!==!0&&null==e.insertOne.document._id&&(e.insertOne.document._id=new ObjectID),addToOperationsList(this,common.INSERT,e.insertOne.document);if(!e.insertMany)throw toError("bulkWrite only supports insertOne, insertMany, updateOne, updateMany, removeOne, removeMany, deleteOne, deleteMany");for(var i=0;i<e.insertMany.length;i++)r!==!0&&null==e.insertMany[i]._id&&(e.insertMany[i]._id=new ObjectID),addToOperationsList(this,common.INSERT,e.insertMany[i])},OrderedBulkOperation.prototype.insert=function(e){return this.s.collection.s.db.options.forceServerObjectId!==!0&&null==e._id&&(e._id=new ObjectID),addToOperationsList(this,common.INSERT,e)},OrderedBulkOperation.prototype.find=function(e){if(!e)throw toError("Bulk find operation must specify a selector");return this.s.currentOp={selector:e},new FindOperatorsOrdered(this)},Object.defineProperty(OrderedBulkOperation.prototype,"length",{enumerable:!0,get:function(){return this.s.currentIndex}});var executeCommands=function(e,t){if(0==e.s.batches.length)return handleCallback(t,null,new BulkWriteResult(e.s.bulkResult));var r=e.s.batches.shift(),n=function(n,o){if(n&&n.driver||n&&n.message)return handleCallback(t,n);n&&(n.ok=0);var s=mergeBatchResults(!0,r,e.s.bulkResult,n,o);return null!=s?handleCallback(t,null,new BulkWriteResult(e.s.bulkResult)):e.s.bulkResult.writeErrors.length>0?handleCallback(t,toError(e.s.bulkResult.writeErrors[0]),new BulkWriteResult(e.s.bulkResult)):void executeCommands(e,t)},o={ordered:!0};null!=e.s.writeConcern&&(o.writeConcern=e.s.writeConcern),e.operationId&&(n.operationId=e.operationId),e.s.options.serializeFunctions&&(o.serializeFunctions=!0),e.s.options.ignoreUndefined&&(o.ignoreUndefined=!0),1==e.s.bypassDocumentValidation&&(o.bypassDocumentValidation=!0);try{r.batchType==common.INSERT?e.s.topology.insert(e.s.collection.namespace,r.operations,o,n):r.batchType==common.UPDATE?e.s.topology.update(e.s.collection.namespace,r.operations,o,n):r.batchType==common.REMOVE&&e.s.topology.remove(e.s.collection.namespace,r.operations,o,n)}catch(s){s.ok=0,handleCallback(t,null,mergeBatchResults(!1,r,e.s.bulkResult,s,null))}};OrderedBulkOperation.prototype.execute=function(e,t){var r=this;if(this.s.executed)throw new toError("batch cannot be re-executed");if("function"==typeof e?t=e:this.s.writeConcern=e,this.s.currentBatch&&this.s.batches.push(this.s.currentBatch),0==this.s.batches.length)throw toError("Invalid Operation, No operations in bulk");return"function"==typeof t?executeCommands(this,t):new this.s.promiseLibrary(function(e,t){executeCommands(r,function(r,n){return r?t(r):void e(n)})})},define.classMethod("execute",{callback:!0,promise:!1});var initializeOrderedBulkOp=function(e,t,r){return new OrderedBulkOperation(e,t,r)};initializeOrderedBulkOp.OrderedBulkOperation=OrderedBulkOperation,module.exports=initializeOrderedBulkOp,module.exports.Bulk=OrderedBulkOperation;