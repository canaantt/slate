"use strict";var utils=require("../utils"),Long=require("mongodb-core").BSON.Long,Timestamp=require("mongodb-core").BSON.Timestamp,UNKNOWN_ERROR=8,INVALID_BSON_ERROR=22,WRITE_CONCERN_ERROR=64,MULTIPLE_ERROR=65,INSERT=1,UPDATE=2,REMOVE=3,writeConcern=function(r,e,t){return null!=t.w||null!=t.j||null!=t.fsync?r.writeConcern=t:(null!=e.writeConcern.w||null!=e.writeConcern.j||null!=e.writeConcern.fsync)&&(r.writeConcern=e.writeConcern),r},defineReadOnlyProperty=function(r,e,t){Object.defineProperty(r,e,{enumerable:!0,get:function(){return t}})},Batch=function(r,e){this.originalZeroIndex=e,this.currentIndex=0,this.originalIndexes=[],this.batchType=r,this.operations=[],this.size=0,this.sizeBytes=0},LegacyOp=function(r,e,t){this.batchType=r,this.index=t,this.operation=e},BulkWriteResult=function(r){defineReadOnlyProperty(this,"ok",r.ok),defineReadOnlyProperty(this,"nInserted",r.nInserted),defineReadOnlyProperty(this,"nUpserted",r.nUpserted),defineReadOnlyProperty(this,"nMatched",r.nMatched),defineReadOnlyProperty(this,"nModified",r.nModified),defineReadOnlyProperty(this,"nRemoved",r.nRemoved),this.getInsertedIds=function(){return r.insertedIds},this.getUpsertedIds=function(){return r.upserted},this.getUpsertedIdAt=function(e){return r.upserted[e]},this.getRawResponse=function(){return r},this.hasWriteErrors=function(){return r.writeErrors.length>0},this.getWriteErrorCount=function(){return r.writeErrors.length},this.getWriteErrorAt=function(e){return e<r.writeErrors.length?r.writeErrors[e]:null},this.getWriteErrors=function(){return r.writeErrors},this.getLastOp=function(){return r.lastOp},this.getWriteConcernError=function(){if(0==r.writeConcernErrors.length)return null;if(1==r.writeConcernErrors.length)return r.writeConcernErrors[0];for(var e="",t=0;t<r.writeConcernErrors.length;t++){var n=r.writeConcernErrors[t];e+=n.errmsg,0==t&&(e+=" and ")}return new WriteConcernError({errmsg:e,code:WRITE_CONCERN_ERROR})},this.toJSON=function(){return r},this.toString=function(){return"BulkWriteResult("+this.toJSON(r)+")"},this.isOk=function(){return 1==r.ok}},WriteConcernError=function(r){return this instanceof WriteConcernError?(defineReadOnlyProperty(this,"code",r.code),defineReadOnlyProperty(this,"errmsg",r.errmsg),this.toJSON=function(){return{code:r.code,errmsg:r.errmsg}},void(this.toString=function(){return"WriteConcernError("+r.errmsg+")"})):new WriteConcernError(r)},WriteError=function(r){return this instanceof WriteError?(defineReadOnlyProperty(this,"code",r.code),defineReadOnlyProperty(this,"index",r.index),defineReadOnlyProperty(this,"errmsg",r.errmsg),this.getOperation=function(){return r.op},this.toJSON=function(){return{code:r.code,index:r.index,errmsg:r.errmsg,op:r.op}},void(this.toString=function(){return"WriteError("+JSON.stringify(this.toJSON())+")"})):new WriteError(r)},mergeBatchResults=function(r,e,t,n,i){if(n)i=n;else if(i&&i.result)i=i.result;else if(null==i)return;if(0==i.ok&&1==t.ok){t.ok=0;var o={index:0,code:i.code||0,errmsg:i.message,op:e.operations[0]};return void t.writeErrors.push(new WriteError(o))}if(0!=i.ok||0!=t.ok){if(i.opTime||i.lastOp){var s=i.lastOp||i.opTime,u=null,d=null;if(s instanceof Timestamp)null==t.lastOp?t.lastOp=s:s.greaterThan(t.lastOp)&&(t.lastOp=s);else{t.lastOp&&(u="number"==typeof t.lastOp.ts?Long.fromNumber(t.lastOp.ts):t.lastOp.ts,d="number"==typeof t.lastOp.t?Long.fromNumber(t.lastOp.t):t.lastOp.t);var p="number"==typeof s.ts?Long.fromNumber(s.ts):s.ts,c="number"==typeof s.t?Long.fromNumber(s.t):s.t;null==t.lastOp?t.lastOp=s:p.greaterThan(u)?t.lastOp=s:p.equals(u)&&c.greaterThan(d)&&(t.lastOp=s)}}e.batchType==INSERT&&i.n&&(t.nInserted=t.nInserted+i.n),e.batchType==REMOVE&&i.n&&(t.nRemoved=t.nRemoved+i.n);var l=0;if(Array.isArray(i.upserted)){l=i.upserted.length;for(var a=0;a<i.upserted.length;a++)t.upserted.push({index:i.upserted[a].index+e.originalZeroIndex,_id:i.upserted[a]._id})}else i.upserted&&(l=1,t.upserted.push({index:e.originalZeroIndex,_id:i.upserted}));if(e.batchType==UPDATE&&i.n){var E=i.nModified;t.nUpserted=t.nUpserted+l,t.nMatched=t.nMatched+(i.n-l),"number"==typeof E?t.nModified=t.nModified+E:t.nModified=null}if(Array.isArray(i.writeErrors))for(var a=0;a<i.writeErrors.length;a++){var o={index:e.originalZeroIndex+i.writeErrors[a].index,code:i.writeErrors[a].code,errmsg:i.writeErrors[a].errmsg,op:e.operations[i.writeErrors[a].index]};t.writeErrors.push(new WriteError(o))}i.writeConcernError&&t.writeConcernErrors.push(new WriteConcernError(i.writeConcernError))}},cloneOptions=function(r){for(var e={},t=Object.keys(r),n=0;n<t.length;n++)e[t[n]]=r[t[n]];return e};exports.BulkWriteResult=BulkWriteResult,exports.WriteError=WriteError,exports.Batch=Batch,exports.LegacyOp=LegacyOp,exports.mergeBatchResults=mergeBatchResults,exports.cloneOptions=cloneOptions,exports.writeConcern=writeConcern,exports.INVALID_BSON_ERROR=INVALID_BSON_ERROR,exports.WRITE_CONCERN_ERROR=WRITE_CONCERN_ERROR,exports.MULTIPLE_ERROR=MULTIPLE_ERROR,exports.UNKNOWN_ERROR=UNKNOWN_ERROR,exports.INSERT=INSERT,exports.UPDATE=UPDATE,exports.REMOVE=REMOVE;