"use strict";var common=require("./common"),utils=require("../utils"),toError=require("../utils").toError,f=require("util").format,handleCallback=require("../utils").handleCallback,shallowClone=utils.shallowClone,WriteError=common.WriteError,BulkWriteResult=common.BulkWriteResult,LegacyOp=common.LegacyOp,ObjectID=require("mongodb-core").BSON.ObjectID,BSON=require("mongodb-core").BSON,Define=require("../metadata"),Batch=common.Batch,mergeBatchResults=common.mergeBatchResults,bson=new BSON.BSONPure,FindOperatorsUnordered=function(e){this.s=e.s};FindOperatorsUnordered.prototype.update=function(e){var t="boolean"==typeof this.s.currentOp.upsert?this.s.currentOp.upsert:!1,r={q:this.s.currentOp.selector,u:e,multi:!0,upsert:t};return this.s.currentOp=null,addToOperationsList(this,common.UPDATE,r)},FindOperatorsUnordered.prototype.updateOne=function(e){var t="boolean"==typeof this.s.currentOp.upsert?this.s.currentOp.upsert:!1,r={q:this.s.currentOp.selector,u:e,multi:!1,upsert:t};return this.s.currentOp=null,addToOperationsList(this,common.UPDATE,r)},FindOperatorsUnordered.prototype.replaceOne=function(e){this.updateOne(e)},FindOperatorsUnordered.prototype.upsert=function(){return this.s.currentOp.upsert=!0,this},FindOperatorsUnordered.prototype.removeOne=function(){var e={q:this.s.currentOp.selector,limit:1};return this.s.currentOp=null,addToOperationsList(this,common.REMOVE,e)},FindOperatorsUnordered.prototype.remove=function(){var e={q:this.s.currentOp.selector,limit:0};return this.s.currentOp=null,addToOperationsList(this,common.REMOVE,e)};var addToOperationsList=function(e,t,r){var n=bson.calculateObjectSize(r,!1);if(n>=e.s.maxBatchSizeBytes)throw toError("document is larger than the maximum size "+e.s.maxBatchSizeBytes);if(e.s.currentBatch=null,t==common.INSERT?e.s.currentBatch=e.s.currentInsertBatch:t==common.UPDATE?e.s.currentBatch=e.s.currentUpdateBatch:t==common.REMOVE&&(e.s.currentBatch=e.s.currentRemoveBatch),null==e.s.currentBatch&&(e.s.currentBatch=new Batch(t,e.s.currentIndex)),(e.s.currentBatch.size+1>=e.s.maxWriteBatchSize||e.s.currentBatch.sizeBytes+n>=e.s.maxBatchSizeBytes||e.s.currentBatch.batchType!=t)&&(e.s.batches.push(e.s.currentBatch),e.s.currentBatch=new Batch(t,e.s.currentIndex)),Array.isArray(r))throw toError("operation passed in cannot be an Array");return e.s.currentBatch.operations.push(r),e.s.currentBatch.originalIndexes.push(e.s.currentIndex),e.s.currentIndex=e.s.currentIndex+1,t==common.INSERT?(e.s.currentInsertBatch=e.s.currentBatch,e.s.bulkResult.insertedIds.push({index:e.s.currentIndex,_id:r._id})):t==common.UPDATE?e.s.currentUpdateBatch=e.s.currentBatch:t==common.REMOVE&&(e.s.currentRemoveBatch=e.s.currentBatch),e.s.currentBatch.size=e.s.currentBatch.size+1,e.s.currentBatch.sizeBytes=e.s.currentBatch.sizeBytes+n,e},UnorderedBulkOperation=function(e,t,r){r=null==r?{}:r;var n=t.collectionName,o=!1,s=null,i=e.bson,a=e.isMasterDoc&&e.isMasterDoc.maxBsonObjectSize?e.isMasterDoc.maxBsonObjectSize:16793600,c=e.isMasterDoc&&e.isMasterDoc.maxWriteBatchSize?e.isMasterDoc.maxWriteBatchSize:1e3,u=common.writeConcern(shallowClone(r),t,r),l=r.promiseLibrary;l||(l="function"==typeof global.Promise?global.Promise:require("es6-promise").Promise);var d={ok:1,writeErrors:[],writeConcernErrors:[],insertedIds:[],nInserted:0,nUpserted:0,nMatched:0,nModified:0,nRemoved:0,upserted:[]};this.s={bulkResult:d,currentInsertBatch:null,currentUpdateBatch:null,currentRemoveBatch:null,currentBatch:null,currentIndex:0,batches:[],writeConcern:u,maxBatchSizeBytes:a,maxWriteBatchSize:c,namespace:n,bson:i,topology:e,options:r,currentOp:s,executed:o,collection:t,promiseLibrary:l,bypassDocumentValidation:"boolean"==typeof r.bypassDocumentValidation?r.bypassDocumentValidation:!1}},define=UnorderedBulkOperation.define=new Define("UnorderedBulkOperation",UnorderedBulkOperation,!1);UnorderedBulkOperation.prototype.insert=function(e){return this.s.collection.s.db.options.forceServerObjectId!==!0&&null==e._id&&(e._id=new ObjectID),addToOperationsList(this,common.INSERT,e)},UnorderedBulkOperation.prototype.find=function(e){if(!e)throw toError("Bulk find operation must specify a selector");return this.s.currentOp={selector:e},new FindOperatorsUnordered(this)},Object.defineProperty(UnorderedBulkOperation.prototype,"length",{enumerable:!0,get:function(){return this.s.currentIndex}}),UnorderedBulkOperation.prototype.raw=function(e){var t=Object.keys(e)[0],r="boolean"==typeof this.s.options.forceServerObjectId?this.s.options.forceServerObjectId:this.s.collection.s.db.options.forceServerObjectId;if(e.updateOne&&e.updateOne.q||e.updateMany&&e.updateMany.q||e.replaceOne&&e.replaceOne.q)return e[t].multi=e.updateOne||e.replaceOne?!1:!0,addToOperationsList(this,common.UPDATE,e[t]);if(e.updateOne||e.updateMany||e.replaceOne){var n=e.updateOne||e.replaceOne?!1:!0,o={q:e[t].filter,u:e[t].update||e[t].replacement,multi:n};return e[t].upsert&&(o.upsert=!0),addToOperationsList(this,common.UPDATE,o)}if(e.removeOne||e.removeMany||e.deleteOne&&e.deleteOne.q||e.deleteMany&&e.deleteMany.q)return e[t].limit=e.removeOne?1:0,addToOperationsList(this,common.REMOVE,e[t]);if(e.deleteOne||e.deleteMany){var s=e.deleteOne?1:0,o={q:e[t].filter,limit:s};return addToOperationsList(this,common.REMOVE,o)}if(e.insertOne&&null==e.insertOne.document)return r!==!0&&null==e.insertOne._id&&(e.insertOne._id=new ObjectID),addToOperationsList(this,common.INSERT,e.insertOne);if(e.insertOne&&e.insertOne.document)return r!==!0&&null==e.insertOne.document._id&&(e.insertOne.document._id=new ObjectID),addToOperationsList(this,common.INSERT,e.insertOne.document);if(!e.insertMany)throw toError("bulkWrite only supports insertOne, insertMany, updateOne, updateMany, removeOne, removeMany, deleteOne, deleteMany");for(var i=0;i<e.insertMany.length;i++)r!==!0&&null==e.insertMany[i]._id&&(e.insertMany[i]._id=new ObjectID),addToOperationsList(this,common.INSERT,e.insertMany[i])};var executeBatch=function(e,t,r){var n={ordered:!1};null!=e.s.writeConcern&&(n.writeConcern=e.s.writeConcern);var o=function(n,o){return n&&n.driver||n&&n.message?handleCallback(r,n):(n&&(n.ok=0),void handleCallback(r,null,mergeBatchResults(!1,t,e.s.bulkResult,n,o)))};e.operationId&&(o.operationId=e.operationId),e.s.options.serializeFunctions&&(n.serializeFunctions=!0),1==e.s.bypassDocumentValidation&&(n.bypassDocumentValidation=!0);try{t.batchType==common.INSERT?e.s.topology.insert(e.s.collection.namespace,t.operations,n,o):t.batchType==common.UPDATE?e.s.topology.update(e.s.collection.namespace,t.operations,n,o):t.batchType==common.REMOVE&&e.s.topology.remove(e.s.collection.namespace,t.operations,n,o)}catch(s){s.ok=0,handleCallback(r,null,mergeBatchResults(!1,t,e.s.bulkResult,s,null))}},executeBatches=function(e,t){for(var r=e.s.batches.length,n=0;n<e.s.batches.length;n++)executeBatch(e,e.s.batches[n],function(n,o){if(n&&(s=n),r-=1,0==r){if(s)return handleCallback(t,s);var s=e.s.bulkResult.writeErrors.length>0?toError(e.s.bulkResult.writeErrors[0]):null;handleCallback(t,s,new BulkWriteResult(e.s.bulkResult))}})};UnorderedBulkOperation.prototype.execute=function(e,t){var r=this;if(this.s.executed)throw toError("batch cannot be re-executed");if("function"==typeof e?t=e:this.s.writeConcern=e,this.s.currentInsertBatch&&this.s.batches.push(this.s.currentInsertBatch),this.s.currentUpdateBatch&&this.s.batches.push(this.s.currentUpdateBatch),this.s.currentRemoveBatch&&this.s.batches.push(this.s.currentRemoveBatch),0==this.s.batches.length)throw toError("Invalid Operation, No operations in bulk");return"function"==typeof t?executeBatches(this,t):new this.s.promiseLibrary(function(e,t){executeBatches(r,function(r,n){return r?t(r):void e(n)})})},define.classMethod("execute",{callback:!0,promise:!1});var initializeUnorderedBulkOp=function(e,t,r){return new UnorderedBulkOperation(e,t,r)};initializeUnorderedBulkOp.UnorderedBulkOperation=UnorderedBulkOperation,module.exports=initializeUnorderedBulkOp,module.exports.Bulk=UnorderedBulkOperation;