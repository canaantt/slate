"use strict";var writeIEEE754=require("../float_parser").writeIEEE754,readIEEE754=require("../float_parser").readIEEE754,f=require("util").format,Long=require("../long").Long,Double=require("../double").Double,Timestamp=require("../timestamp").Timestamp,ObjectID=require("../objectid").ObjectID,Symbol=require("../symbol").Symbol,Code=require("../code").Code,MinKey=require("../min_key").MinKey,MaxKey=require("../max_key").MaxKey,DBRef=require("../db_ref").DBRef,BSONRegExp=require("../regexp").BSONRegExp,Binary=require("../binary").Binary,BSON={},functionCache=BSON.functionCache={};BSON.BSON_DATA_NUMBER=1,BSON.BSON_DATA_STRING=2,BSON.BSON_DATA_OBJECT=3,BSON.BSON_DATA_ARRAY=4,BSON.BSON_DATA_BINARY=5,BSON.BSON_DATA_OID=7,BSON.BSON_DATA_BOOLEAN=8,BSON.BSON_DATA_DATE=9,BSON.BSON_DATA_NULL=10,BSON.BSON_DATA_REGEXP=11,BSON.BSON_DATA_CODE=13,BSON.BSON_DATA_SYMBOL=14,BSON.BSON_DATA_CODE_W_SCOPE=15,BSON.BSON_DATA_INT=16,BSON.BSON_DATA_TIMESTAMP=17,BSON.BSON_DATA_LONG=18,BSON.BSON_DATA_MIN_KEY=255,BSON.BSON_DATA_MAX_KEY=127,BSON.BSON_BINARY_SUBTYPE_DEFAULT=0,BSON.BSON_BINARY_SUBTYPE_FUNCTION=1,BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2,BSON.BSON_BINARY_SUBTYPE_UUID=3,BSON.BSON_BINARY_SUBTYPE_MD5=4,BSON.BSON_BINARY_SUBTYPE_USER_DEFINED=128,BSON.BSON_INT32_MAX=2147483647,BSON.BSON_INT32_MIN=-2147483648,BSON.BSON_INT64_MAX=Math.pow(2,63)-1,BSON.BSON_INT64_MIN=-Math.pow(2,63),BSON.JS_INT_MAX=9007199254740992,BSON.JS_INT_MIN=-9007199254740992;var JS_INT_MAX_LONG=Long.fromNumber(9007199254740992),JS_INT_MIN_LONG=Long.fromNumber(-9007199254740992),deserialize=function(e,r,n){var t=0,i=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24;if(5>i||e.length<i)throw new Error("corrupt bson message");if(0!=e[i-1])throw new Error("One object, sized correctly, with a spot for an EOO, but the EOO isn't 0x00");return deserializeObject(e,r,n)},readCStyleStringSpecial=function(e,r){for(var n=r;0!==e[n]&&n<e.length;)n++;if(n>=e.length)throw new Error("Bad BSON Document: illegal CString");return e.toString("utf8",r,n)},DeserializationMethods={};DeserializationMethods[BSON.BSON_DATA_OID]=function(e,r,n,t){var i=n.toString("binary",t,t+12);return r[e]=new ObjectID(i),t+12},DeserializationMethods[BSON.BSON_DATA_NUMBER]=function(e,r,n,t){return r[e]=n.readDoubleLE(t),t+8},DeserializationMethods[BSON.BSON_DATA_INT]=function(e,r,n,t){return r[e]=n.readInt32LE(t),t+4},DeserializationMethods[BSON.BSON_DATA_TIMESTAMP]=function(e,r,n,t){var i=n[t++]|n[t++]<<8|n[t++]<<16|n[t++]<<24,o=n[t++]|n[t++]<<8|n[t++]<<16|n[t++]<<24;return r[e]=new Timestamp(i,o),t},DeserializationMethods[BSON.BSON_DATA_STRING]=function(e,r,n,t){var i=n[t++]|n[t++]<<8|n[t++]<<16|n[t++]<<24;if(0>=i||i>n.length-t||0!=n[t+i-1])throw new Error("bad string length in bson");return r[e]=n.toString("utf8",t,t+i-1),t+i},DeserializationMethods[BSON.BSON_DATA_BOOLEAN]=function(e,r,n,t){return r[e]=1==n[t++],t};var deserializeObject=function(e,r,n){r=null==r?{}:r;null==r.evalFunctions?!1:r.evalFunctions,null==r.cacheFunctions?!1:r.cacheFunctions,null==r.cacheFunctionsCrc32?!1:r.cacheFunctionsCrc32,null==r.promoteLongs?!0:r.promoteLongs,null==r.fieldsAsRaw?{}:r.fieldsAsRaw,"boolean"==typeof r.bsonRegExp?r.bsonRegExp:!1,null==r.promoteBuffers?!1:r.promoteBuffers;if(e.length<5)throw new Error("corrupt bson message < 5 bytes long");var t="number"==typeof r.index?r.index:0,i=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24;if(5>i||i>e.length)throw new Error("corrupt bson message");for(var o=n?[]:{};;){var N=e[t++];if(0==N)break;var S=readCStyleStringSpecial(e,t);t=t+S.length+1,t=DeserializationMethods[N](S,o,e,t)}return null!=o.$id&&(o=new DBRef(o.$ref,o.$id,o.$db)),o},isolateEvalWithHash=function(functionCache,hash,functionString,object){var value=null;return null==functionCache[hash]&&(eval("value = "+functionString),functionCache[hash]=value),functionCache[hash].bind(object)},isolateEval=function(functionString){var value=null;return eval("value = "+functionString),value};module.exports=deserialize;