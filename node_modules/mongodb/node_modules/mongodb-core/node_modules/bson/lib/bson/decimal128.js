"use strict";var Long=require("./long"),PARSE_STRING_REGEXP=/^(\+|\-)?(\d+|(\d*\.\d*))?(E|e)?([\-\+])?(\d+)?$/,PARSE_INF_REGEXP=/^(\+|\-)?(Infinity|inf)$/i,PARSE_NAN_REGEXP=/^(\+|\-)?NaN$/i,EXPONENT_MAX=6111,EXPONENT_MIN=-6176,EXPONENT_BIAS=6176,MAX_DIGITS=34,NAN_BUFFER=[124,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0].reverse(),INF_NEGATIVE_BUFFER=[248,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0].reverse(),INF_POSITIVE_BUFFER=[120,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0].reverse(),EXPONENT_REGEX=/^([\-\+])?(\d+)?$/,isDigit=function(r){return!isNaN(parseInt(r,10))},divideu128=function(r){var e=Long.fromNumber(1e9),i=Long.fromNumber(0),o=0;if(!(r.parts[0]||r.parts[1]||r.parts[2]||r.parts[3]))return{quotient:r,rem:i};for(var o=0;3>=o;o++)i=i.shiftLeft(32),i=i.add(new Long(r.parts[o],0)),r.parts[o]=i.div(e).low_,i=i.modulo(e);return{quotient:r,rem:i}},multiply64x2=function(r,e){if(!r&&!e)return{high:Long.fromNumber(0),low:Long.fromNumber(0)};var i=r.shiftRightUnsigned(32),o=new Long(r.getLowBits(),0),n=e.shiftRightUnsigned(32),t=new Long(e.getLowBits(),0),f=i.multiply(n),h=i.multiply(t),N=o.multiply(n),a=o.multiply(t);return f=f.add(h.shiftRightUnsigned(32)),h=new Long(h.getLowBits(),0).add(N).add(a.shiftRightUnsigned(32)),f=f.add(h.shiftRightUnsigned(32)),a=h.shiftLeft(32).add(new Long(a.getLowBits(),0)),{high:f,low:a}},lessThan=function(r,e){var i=r.high_>>>0,o=e.high_>>>0;if(o>i)return!0;if(i==o){var n=r.low_>>>0,t=e.low_>>>0;if(t>n)return!0}return!1},longtoHex=function(r){var e=new Buffer(8),i=0;return e[i++]=255&r.low_,e[i++]=r.low_>>8&255,e[i++]=r.low_>>16&255,e[i++]=r.low_>>24&255,e[i++]=255&r.high_,e[i++]=r.high_>>8&255,e[i++]=r.high_>>16&255,e[i++]=r.high_>>24&255,e.reverse().toString("hex")},int32toHex=function(r){var e=new Buffer(4),i=0;return e[i++]=255&r,e[i++]=r>>8&255,e[i++]=r>>16&255,e[i++]=r>>24&255,e.reverse().toString("hex")},Decimal128=function(r){this._bsontype="Decimal128",this.bytes=r};Decimal128.fromString=function(r){var e=!1,i=!1,o=!1,n=0,t=0,f=0,h=0,N=0,a=[0],g=0,u=0,m=0,E=0,l=0,_=0,s=[0,0],w=[0,0],I=0,d=0;r=r.trim();var p=r.match(PARSE_STRING_REGEXP),L=r.match(PARSE_INF_REGEXP),v=r.match(PARSE_NAN_REGEXP);if(!p&&!L&&!v||0==r.length)throw new Error(""+r+" not a valid Decimal128 string");if(p&&p[4]&&void 0===p[2])throw new Error(""+r+" not a valid Decimal128 string");if(("+"==r[d]||"-"==r[d])&&(e="-"==r[d++]),!isDigit(r[d])&&"."!=r[d]){if("i"==r[d]||"I"==r[d])return new Decimal128(new Buffer(e?INF_NEGATIVE_BUFFER:INF_POSITIVE_BUFFER));if("N"==r[d])return new Decimal128(new Buffer(NAN_BUFFER))}for(;isDigit(r[d])||"."==r[d];)if("."!=r[d])34>g&&("0"!=r[d]||o)&&(o||(N=t),o=!0,a[u++]=parseInt(r[d],10),g+=1),o&&(f+=1),i&&(h+=1),t+=1,d+=1;else{if(i)return new Decimal128(new Buffer(NAN_BUFFER));i=!0,d+=1}if(i&&!t)throw new Error(""+r+" not a valid Decimal128 string");if("e"==r[d]||"E"==r[d]){var A=r.substr(++d).match(EXPONENT_REGEX);if(!A||!A[2])return new Decimal128(new Buffer(NAN_BUFFER));l=parseInt(A[0],10),d+=A[0].length}if(r[d])return new Decimal128(new Buffer(NAN_BUFFER));if(m=0,g){if(E=g-1,n=f,0!=l&&1!=n)for(;"0"==r[N+n-1];)n-=1}else m=0,E=0,a[0]=0,f=1,g=1,n=0;for(h>=l&&h-l>16384?l=EXPONENT_MIN:l-=h;l>EXPONENT_MAX;){if(E+=1,E-m>MAX_DIGITS){var T=a.join("");if(T.match(/^0+$/)){l=EXPONENT_MAX;break}return new Decimal128(new Buffer(e?INF_NEGATIVE_BUFFER:INF_POSITIVE_BUFFER))}l-=1}for(;EXPONENT_MIN>l||f>g;){if(0==E){l=EXPONENT_MIN,n=0;break}if(f>g?f-=1:E-=1,!(EXPONENT_MAX>l)){var T=a.join("");if(T.match(/^0+$/)){l=EXPONENT_MAX;break}return new Decimal128(new Buffer(e?INF_NEGATIVE_BUFFER:INF_POSITIVE_BUFFER))}l+=1}if(n>E-m+1&&"0"!=r[n]){var F=t;i&&l==EXPONENT_MIN&&(N+=1,F+=1);var B=parseInt(r[N+E+1],10),O=0;if(B>=5&&(O=1,5==B)){O=a[E]%2==1;for(var _=N+E+2;F>_;_++)if(parseInt(r[_],10)){O=1;break}}if(O)for(var c=E;c>=0&&++a[c]>9;c--)if(a[c]=0,0==c){if(!(EXPONENT_MAX>l))return new Decimal128(new Buffer(e?INF_NEGATIVE_BUFFER:INF_POSITIVE_BUFFER));l+=1,a[c]=1}}if(s=Long.fromNumber(0),w=Long.fromNumber(0),0==n)s=Long.fromNumber(0),w=Long.fromNumber(0);else if(17>E-m){var c=m;for(w=Long.fromNumber(a[c++]),s=new Long(0,0);E>=c;c++)w=w.multiply(Long.fromNumber(10)),w=w.add(Long.fromNumber(a[c]))}else{var c=m;for(s=Long.fromNumber(a[c++]);E-17>=c;c++)s=s.multiply(Long.fromNumber(10)),s=s.add(Long.fromNumber(a[c]));for(w=Long.fromNumber(a[c++]);E>=c;c++)w=w.multiply(Long.fromNumber(10)),w=w.add(Long.fromNumber(a[c]))}var R=multiply64x2(s,Long.fromString("100000000000000000"));R.low=R.low.add(w),lessThan(R.low,w)&&(R.high=R.high.add(Long.fromNumber(1)));var I=l+EXPONENT_BIAS,b={low:Long.fromNumber(0),high:Long.fromNumber(0)};R.high.shiftRightUnsigned(49).and(Long.fromNumber(1)).equals(Long.fromNumber)?(b.high=b.high.or(Long.fromNumber(3).shiftLeft(61)),b.high=b.high.or(Long.fromNumber(I).and(Long.fromNumber(16383).shiftLeft(47))),b.high=b.high.or(R.high.and(Long.fromNumber(0x7fffffffffff)))):(b.high=b.high.or(Long.fromNumber(16383&I).shiftLeft(49)),b.high=b.high.or(R.high.and(Long.fromNumber(562949953421311)))),b.low=R.low,e&&(b.high=b.high.or(Long.fromString("9223372036854775808")));var P=new Buffer(16),d=0;return P[d++]=255&b.low.low_,P[d++]=b.low.low_>>8&255,P[d++]=b.low.low_>>16&255,P[d++]=b.low.low_>>24&255,P[d++]=255&b.low.high_,P[d++]=b.low.high_>>8&255,P[d++]=b.low.high_>>16&255,P[d++]=b.low.high_>>24&255,P[d++]=255&b.high.low_,P[d++]=b.high.low_>>8&255,P[d++]=b.high.low_>>16&255,P[d++]=b.high.low_>>24&255,P[d++]=255&b.high.high_,P[d++]=b.high.high_>>8&255,P[d++]=b.high.high_>>16&255,P[d++]=b.high.high_>>24&255,new Decimal128(P)};var COMBINATION_MASK=31,EXPONENT_MASK=16383,COMBINATION_INFINITY=30,COMBINATION_NAN=31,COMBINATION_SNAN=32,EXPONENT_BIAS=6176;Decimal128.prototype.toString=function(){for(var r,e,i,o,n,t,f=0,h=new Array(36),N=0;N<h.length;N++)h[N]=0;var a,g,u,N,m,E,l=0,_=!1,s={parts:new Array(4)},w=[],l=0,I=this.bytes;o=I[l++]|I[l++]<<8|I[l++]<<16|I[l++]<<24,i=I[l++]|I[l++]<<8|I[l++]<<16|I[l++]<<24,e=I[l++]|I[l++]<<8|I[l++]<<16|I[l++]<<24,r=I[l++]|I[l++]<<8|I[l++]<<16|I[l++]<<24;var l=0,d={low:new Long(o,i),high:new Long(e,r)};if(d.high.lessThan(Long.ZERO)&&w.push("-"),n=r>>26&COMBINATION_MASK,n>>3==3){if(n==COMBINATION_INFINITY)return w.join("")+"Infinity";if(n==COMBINATION_NAN)return"NaN";t=r>>15&EXPONENT_MASK,u=8+(r>>14&1)}else u=r>>14&7,t=r>>17&EXPONENT_MASK;if(a=t-EXPONENT_BIAS,s.parts[0]=(16383&r)+((15&u)<<14),s.parts[1]=e,s.parts[2]=i,s.parts[3]=o,0==s.parts[0]&&0==s.parts[1]&&0==s.parts[2]&&0==s.parts[3])_=!0;else for(var E=3;E>=0;E--){var p=0,L=divideu128(s);if(s=L.quotient,p=L.rem.low_)for(var m=8;m>=0;m--)h[9*E+m]=p%10,p=Math.floor(p/10)}if(_)f=1,h[l]=0;else{f=36;for(var N=0;!h[l];)N++,f-=1,l+=1}if(g=f-1+a,g>=34||-7>=g||a>0){w.push(h[l++]),f-=1,f&&w.push(".");for(var N=0;f>N;N++)w.push(h[l++]);w.push("E"),g>0?w.push("+"+g):w.push(g)}else if(a>=0)for(var N=0;f>N;N++)w.push(h[l++]);else{var v=f+a;if(v>0)for(var N=0;v>N;N++)w.push(h[l++]);else w.push("0");for(w.push(".");v++<0;)w.push("0");for(var N=0;N<f-Math.max(v-1,0);N++)w.push(h[l++])}return w.join("")},Decimal128.prototype.toJSON=function(){return{$numberDecimal:this.toString()}},module.exports=Decimal128,module.exports.Decimal128=Decimal128;