"use strict";var writeIEEE754=require("../float_parser").writeIEEE754,readIEEE754=require("../float_parser").readIEEE754,Long=require("../long").Long,Map=require("../map"),Double=require("../double").Double,Timestamp=require("../timestamp").Timestamp,ObjectID=require("../objectid").ObjectID,Symbol=require("../symbol").Symbol,Code=require("../code").Code,BSONRegExp=require("../regexp").BSONRegExp,MinKey=require("../min_key").MinKey,MaxKey=require("../max_key").MaxKey,Decimal128=require("../decimal128"),DBRef=require("../db_ref").DBRef,Binary=require("../binary").Binary;try{var _Buffer=Uint8Array}catch(e){var _Buffer=Buffer}var regexp=/\x00/,isDate=function(e){return"object"==typeof e&&"[object Date]"===Object.prototype.toString.call(e)},isRegExp=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},serializeString=function(e,i,r,t){e[t++]=BSON.BSON_DATA_STRING;var n=e.write(i,t,"utf8");t=t+n+1,e[t-1]=0;var o=e.write(r,t+4,"utf8");return e[t+3]=o+1>>24&255,e[t+2]=o+1>>16&255,e[t+1]=o+1>>8&255,e[t]=o+1&255,t=t+4+o,e[t++]=0,t},serializeNumber=function(e,i,r,t){if(Math.floor(r)===r&&r>=BSON.JS_INT_MIN&&r<=BSON.JS_INT_MAX)if(r>=BSON.BSON_INT32_MIN&&r<=BSON.BSON_INT32_MAX){e[t++]=BSON.BSON_DATA_INT;var n=e.write(i,t,"utf8");t+=n,e[t++]=0,e[t++]=255&r,e[t++]=r>>8&255,e[t++]=r>>16&255,e[t++]=r>>24&255}else if(r>=BSON.JS_INT_MIN&&r<=BSON.JS_INT_MAX){e[t++]=BSON.BSON_DATA_NUMBER;var n=e.write(i,t,"utf8");t+=n,e[t++]=0,writeIEEE754(e,r,t,"little",52,8),t+=8}else{e[t++]=BSON.BSON_DATA_LONG;var n=e.write(i,t,"utf8");t+=n,e[t++]=0;var o=Long.fromNumber(r),a=o.getLowBits(),B=o.getHighBits();e[t++]=255&a,e[t++]=a>>8&255,e[t++]=a>>16&255,e[t++]=a>>24&255,e[t++]=255&B,e[t++]=B>>8&255,e[t++]=B>>16&255,e[t++]=B>>24&255}else{e[t++]=BSON.BSON_DATA_NUMBER;var n=e.write(i,t,"utf8");t+=n,e[t++]=0,writeIEEE754(e,r,t,"little",52,8),t+=8}return t},serializeUndefined=function(e,i,r,t){e[t++]=BSON.BSON_DATA_NULL;var n=e.write(i,t,"utf8");return t+=n,e[t++]=0,t},serializeBoolean=function(e,i,r,t){e[t++]=BSON.BSON_DATA_BOOLEAN;var n=e.write(i,t,"utf8");return t+=n,e[t++]=0,e[t++]=r?1:0,t},serializeDate=function(e,i,r,t){e[t++]=BSON.BSON_DATA_DATE;var n=e.write(i,t,"utf8");t+=n,e[t++]=0;var o=Long.fromNumber(r.getTime()),a=o.getLowBits(),B=o.getHighBits();return e[t++]=255&a,e[t++]=a>>8&255,e[t++]=a>>16&255,e[t++]=a>>24&255,e[t++]=255&B,e[t++]=B>>8&255,e[t++]=B>>16&255,e[t++]=B>>24&255,t},serializeRegExp=function(e,i,r,t){e[t++]=BSON.BSON_DATA_REGEXP;var n=e.write(i,t,"utf8");if(t+=n,e[t++]=0,r.source&&null!=r.source.match(regexp))throw Error("value "+r.source+" must not contain null bytes");return t+=e.write(r.source,t,"utf8"),e[t++]=0,r.global&&(e[t++]=115),r.ignoreCase&&(e[t++]=105),r.multiline&&(e[t++]=109),e[t++]=0,t},serializeBSONRegExp=function(e,i,r,t){e[t++]=BSON.BSON_DATA_REGEXP;var n=e.write(i,t,"utf8");return t+=n,e[t++]=0,t+=e.write(r.pattern,t,"utf8"),e[t++]=0,t+=e.write(r.options,t,"utf8"),e[t++]=0,t},serializeMinMax=function(e,i,r,t){null===r?e[t++]=BSON.BSON_DATA_NULL:r instanceof MinKey?e[t++]=BSON.BSON_DATA_MIN_KEY:e[t++]=BSON.BSON_DATA_MAX_KEY;var n=e.write(i,t,"utf8");return t+=n,e[t++]=0,t},serializeObjectId=function(e,i,r,t){e[t++]=BSON.BSON_DATA_OID;var n=e.write(i,t,"utf8");return t+=n,e[t++]=0,"string"==typeof r.id?e.write(r.id,t,"binary"):r.id.copy(e,t,0,12),t+12},serializeBuffer=function(e,i,r,t){e[t++]=BSON.BSON_DATA_BINARY;var n=e.write(i,t,"utf8");t+=n,e[t++]=0;var o=r.length;return e[t++]=255&o,e[t++]=o>>8&255,e[t++]=o>>16&255,e[t++]=o>>24&255,e[t++]=BSON.BSON_BINARY_SUBTYPE_DEFAULT,r.copy(e,t,0,o),t+=o},serializeObject=function(e,i,r,t,n,o,a,B){e[t++]=Array.isArray(r)?BSON.BSON_DATA_ARRAY:BSON.BSON_DATA_OBJECT;var N=e.write(i,t,"utf8");t+=N,e[t++]=0;var _=serializeInto(e,r,n,t,o+1,a,B);return _},serializeDecimal128=function(e,i,r,t){e[t++]=BSON.BSON_DATA_DECIMAL128;var n=e.write(i,t,"utf8");return t+=n,e[t++]=0,r.bytes.copy(e,t,0,16),t+16},serializeLong=function(e,i,r,t){e[t++]="Long"==r._bsontype?BSON.BSON_DATA_LONG:BSON.BSON_DATA_TIMESTAMP;var n=e.write(i,t,"utf8");t+=n,e[t++]=0;var o=r.getLowBits(),a=r.getHighBits();return e[t++]=255&o,e[t++]=o>>8&255,e[t++]=o>>16&255,e[t++]=o>>24&255,e[t++]=255&a,e[t++]=a>>8&255,e[t++]=a>>16&255,e[t++]=a>>24&255,t},serializeDouble=function(e,i,r,t){e[t++]=BSON.BSON_DATA_NUMBER;var n=e.write(i,t,"utf8");return t+=n,e[t++]=0,writeIEEE754(e,r,t,"little",52,8),t+=8},serializeFunction=function(e,i,r,t,n,o){e[t++]=BSON.BSON_DATA_CODE;var a=e.write(i,t,"utf8");t+=a,e[t++]=0;var B=r.toString(),N=e.write(B,t+4,"utf8")+1;return e[t]=255&N,e[t+1]=N>>8&255,e[t+2]=N>>16&255,e[t+3]=N>>24&255,t=t+4+N-1,e[t++]=0,t},serializeCode=function(e,i,r,t,n,o,a,B){if(r.scope&&"object"==typeof r.scope){e[t++]=BSON.BSON_DATA_CODE_W_SCOPE;var N=e.write(i,t,"utf8");t+=N,e[t++]=0;var _=t,s="string"==typeof r.code?r.code:r.code.toString();t+=4;var S=e.write(s,t+4,"utf8")+1;e[t]=255&S,e[t+1]=S>>8&255,e[t+2]=S>>16&255,e[t+3]=S>>24&255,e[t+4+S-1]=0,t=t+S+4;var O=serializeInto(e,r.scope,n,t,o+1,a,B);t=O-1;var l=O-_;e[_++]=255&l,e[_++]=l>>8&255,e[_++]=l>>16&255,e[_++]=l>>24&255,e[t++]=0}else{e[t++]=BSON.BSON_DATA_CODE;var N=e.write(i,t,"utf8");t+=N,e[t++]=0;var s=r.code.toString(),u=e.write(s,t+4,"utf8")+1;e[t]=255&u,e[t+1]=u>>8&255,e[t+2]=u>>16&255,e[t+3]=u>>24&255,t=t+4+u-1,e[t++]=0}return t},serializeBinary=function(e,i,r,t){e[t++]=BSON.BSON_DATA_BINARY;var n=e.write(i,t,"utf8");t+=n,e[t++]=0;var o=r.value(!0),a=r.position;return r.sub_type==Binary.SUBTYPE_BYTE_ARRAY&&(a+=4),e[t++]=255&a,e[t++]=a>>8&255,e[t++]=a>>16&255,e[t++]=a>>24&255,e[t++]=r.sub_type,r.sub_type==Binary.SUBTYPE_BYTE_ARRAY&&(a-=4,e[t++]=255&a,e[t++]=a>>8&255,e[t++]=a>>16&255,e[t++]=a>>24&255),o.copy(e,t,0,r.position),t+=r.position},serializeSymbol=function(e,i,r,t){e[t++]=BSON.BSON_DATA_SYMBOL;var n=e.write(i,t,"utf8");t+=n,e[t++]=0;var o=e.write(r.value,t+4,"utf8")+1;return e[t]=255&o,e[t+1]=o>>8&255,e[t+2]=o>>16&255,e[t+3]=o>>24&255,t=t+4+o-1,e[t++]=0,t},serializeDBRef=function(e,i,r,t,n,o){e[t++]=BSON.BSON_DATA_OBJECT;var a=e.write(i,t,"utf8");t+=a,e[t++]=0;var B,N=t;B=null!=r.db?serializeInto(e,{$ref:r.namespace,$id:r.oid,$db:r.db},!1,t,n+1,o):serializeInto(e,{$ref:r.namespace,$id:r.oid},!1,t,n+1,o);var _=B-N;return e[N++]=255&_,e[N++]=_>>8&255,e[N++]=_>>16&255,e[N++]=_>>24&255,B},serializeInto=function(e,i,r,t,n,o,a){t=t||0;var B=t+4;if(Array.isArray(i))for(var N=0;N<i.length;N++){var _=""+N,s=i[N];if(s&&s.toBSON){if("function"!=typeof s.toBSON)throw new Error("toBSON is not a function");s=s.toBSON()}var S=typeof s;"string"==S?B=serializeString(e,_,s,B):"number"==S?B=serializeNumber(e,_,s,B):"boolean"==S?B=serializeBoolean(e,_,s,B):s instanceof Date||isDate(s)?B=serializeDate(e,_,s,B):"undefined"==S||null==s?B=serializeUndefined(e,_,s,B):"ObjectID"==s._bsontype?B=serializeObjectId(e,_,s,B):Buffer.isBuffer(s)?B=serializeBuffer(e,_,s,B):s instanceof RegExp||isRegExp(s)?B=serializeRegExp(e,_,s,B):"object"==S&&null==s._bsontype?B=serializeObject(e,_,s,B,r,n,o,a):"object"==S&&"Decimal128"==s._bsontype?B=serializeDecimal128(e,_,s,B):"Long"==s._bsontype||"Timestamp"==s._bsontype?B=serializeLong(e,_,s,B):"Double"==s._bsontype?B=serializeDouble(e,_,s,B):"function"==typeof s&&o?B=serializeFunction(e,_,s,B,r,n,o):"Code"==s._bsontype?B=serializeCode(e,_,s,B,r,n,o,a):"Binary"==s._bsontype?B=serializeBinary(e,_,s,B):"Symbol"==s._bsontype?B=serializeSymbol(e,_,s,B):"DBRef"==s._bsontype?B=serializeDBRef(e,_,s,B,n,o):"BSONRegExp"==s._bsontype?B=serializeBSONRegExp(e,_,s,B):("MinKey"==s._bsontype||"MaxKey"==s._bsontype)&&(B=serializeMinMax(e,_,s,B))}else if(i instanceof Map)for(var O=i.entries(),l=!1;!l;){var u=O.next();if(l=u.done,!l){var _=u.value[0],s=u.value[1],S=typeof s;if("$db"!=_&&"$ref"!=_&&"$id"!=_){if(null!=_.match(regexp))throw Error("key "+_+" must not contain null bytes");if(r){if("$"==_[0])throw Error("key "+_+" must not start with '$'");if(~_.indexOf("."))throw Error("key "+_+" must not contain '.'")}}"string"==S?B=serializeString(e,_,s,B):"number"==S?B=serializeNumber(e,_,s,B):"boolean"==S?B=serializeBoolean(e,_,s,B):s instanceof Date||isDate(s)?B=serializeDate(e,_,s,B):void 0===s&&1==a||(null===s||void 0===s?B=serializeUndefined(e,_,s,B):"ObjectID"==s._bsontype?B=serializeObjectId(e,_,s,B):Buffer.isBuffer(s)?B=serializeBuffer(e,_,s,B):s instanceof RegExp||isRegExp(s)?B=serializeRegExp(e,_,s,B):"object"==S&&null==s._bsontype?B=serializeObject(e,_,s,B,r,n,o,a):"object"==S&&"Decimal128"==s._bsontype?B=serializeDecimal128(e,_,s,B):"Long"==s._bsontype||"Timestamp"==s._bsontype?B=serializeLong(e,_,s,B):"Double"==s._bsontype?B=serializeDouble(e,_,s,B):"Code"==s._bsontype?B=serializeCode(e,_,s,B,r,n,o,a):"function"==typeof s&&o?B=serializeFunction(e,_,s,B,r,n,o):"Binary"==s._bsontype?B=serializeBinary(e,_,s,B):"Symbol"==s._bsontype?B=serializeSymbol(e,_,s,B):"DBRef"==s._bsontype?B=serializeDBRef(e,_,s,B,n,o):"BSONRegExp"==s._bsontype?B=serializeBSONRegExp(e,_,s,B):("MinKey"==s._bsontype||"MaxKey"==s._bsontype)&&(B=serializeMinMax(e,_,s,B)))}}else{if(i.toBSON){if("function"!=typeof i.toBSON)throw new Error("toBSON is not a function");if(i=i.toBSON(),null!=i&&"object"!=typeof i)throw new Error("toBSON function did not return an object")}for(var _ in i){var s=i[_];if(s&&s.toBSON){if("function"!=typeof s.toBSON)throw new Error("toBSON is not a function");s=s.toBSON()}var S=typeof s;if("$db"!=_&&"$ref"!=_&&"$id"!=_){if(null!=_.match(regexp))throw Error("key "+_+" must not contain null bytes");if(r){if("$"==_[0])throw Error("key "+_+" must not start with '$'");if(~_.indexOf("."))throw Error("key "+_+" must not contain '.'")}}"string"==S?B=serializeString(e,_,s,B):"number"==S?B=serializeNumber(e,_,s,B):"boolean"==S?B=serializeBoolean(e,_,s,B):s instanceof Date||isDate(s)?B=serializeDate(e,_,s,B):void 0===s&&1==a||(null===s||void 0===s?B=serializeUndefined(e,_,s,B):"ObjectID"==s._bsontype?B=serializeObjectId(e,_,s,B):Buffer.isBuffer(s)?B=serializeBuffer(e,_,s,B):s instanceof RegExp||isRegExp(s)?B=serializeRegExp(e,_,s,B):"object"==S&&null==s._bsontype?B=serializeObject(e,_,s,B,r,n,o,a):"object"==S&&"Decimal128"==s._bsontype?B=serializeDecimal128(e,_,s,B):"Long"==s._bsontype||"Timestamp"==s._bsontype?B=serializeLong(e,_,s,B):"Double"==s._bsontype?B=serializeDouble(e,_,s,B):"Code"==s._bsontype?B=serializeCode(e,_,s,B,r,n,o,a):"function"==typeof s&&o?B=serializeFunction(e,_,s,B,r,n,o):"Binary"==s._bsontype?B=serializeBinary(e,_,s,B):"Symbol"==s._bsontype?B=serializeSymbol(e,_,s,B):"DBRef"==s._bsontype?B=serializeDBRef(e,_,s,B,n,o):"BSONRegExp"==s._bsontype?B=serializeBSONRegExp(e,_,s,B):("MinKey"==s._bsontype||"MaxKey"==s._bsontype)&&(B=serializeMinMax(e,_,s,B)))}}e[B++]=0;var f=B-t;return e[t++]=255&f,e[t++]=f>>8&255,e[t++]=f>>16&255,e[t++]=f>>24&255,B},BSON={},functionCache=BSON.functionCache={};BSON.BSON_DATA_NUMBER=1,BSON.BSON_DATA_STRING=2,BSON.BSON_DATA_OBJECT=3,BSON.BSON_DATA_ARRAY=4,BSON.BSON_DATA_BINARY=5,BSON.BSON_DATA_UNDEFINED=6,BSON.BSON_DATA_OID=7,BSON.BSON_DATA_BOOLEAN=8,BSON.BSON_DATA_DATE=9,BSON.BSON_DATA_NULL=10,BSON.BSON_DATA_REGEXP=11,BSON.BSON_DATA_CODE=13,BSON.BSON_DATA_SYMBOL=14,BSON.BSON_DATA_CODE_W_SCOPE=15,BSON.BSON_DATA_INT=16,BSON.BSON_DATA_TIMESTAMP=17,BSON.BSON_DATA_LONG=18,BSON.BSON_DATA_DECIMAL128=19,BSON.BSON_DATA_MIN_KEY=255,BSON.BSON_DATA_MAX_KEY=127,BSON.BSON_BINARY_SUBTYPE_DEFAULT=0,BSON.BSON_BINARY_SUBTYPE_FUNCTION=1,BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2,BSON.BSON_BINARY_SUBTYPE_UUID=3,BSON.BSON_BINARY_SUBTYPE_MD5=4,BSON.BSON_BINARY_SUBTYPE_USER_DEFINED=128,BSON.BSON_INT32_MAX=2147483647,BSON.BSON_INT32_MIN=-2147483648,BSON.BSON_INT64_MAX=Math.pow(2,63)-1,BSON.BSON_INT64_MIN=-Math.pow(2,63),BSON.JS_INT_MAX=9007199254740992,BSON.JS_INT_MIN=-9007199254740992;var JS_INT_MAX_LONG=Long.fromNumber(9007199254740992),JS_INT_MIN_LONG=Long.fromNumber(-9007199254740992);module.exports=serializeInto;