"use strict";var readIEEE754=require("../float_parser").readIEEE754,f=require("util").format,Long=require("../long").Long,Double=require("../double").Double,Timestamp=require("../timestamp").Timestamp,ObjectID=require("../objectid").ObjectID,Symbol=require("../symbol").Symbol,Code=require("../code").Code,MinKey=require("../min_key").MinKey,MaxKey=require("../max_key").MaxKey,Decimal128=require("../decimal128"),DBRef=require("../db_ref").DBRef,BSONRegExp=require("../regexp").BSONRegExp,Binary=require("../binary").Binary,deserialize=function(e,r,n){r=null==r?{}:r;var t=r&&r.index?r.index:0,i=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24;if(5>i||e.length<i||i+t<e.length)throw new Error("corrupt bson message");if(0!=e[t+i-1])throw new Error("One object, sized correctly, with a spot for an EOO, but the EOO isn't 0x00");return deserializeObject(e,t,r,n)},deserializeObject=function(e,r,n,t){var i=null==n.evalFunctions?!1:n.evalFunctions,o=null==n.cacheFunctions?!1:n.cacheFunctions,a=null==n.cacheFunctionsCrc32?!1:n.cacheFunctionsCrc32,l=null==n.promoteLongs?!0:n.promoteLongs,N=null==n.fieldsAsRaw?null:n.fieldsAsRaw,B=null==n.raw?!1:n.raw,S="boolean"==typeof n.bsonRegExp?n.bsonRegExp:!1,O=null==n.promoteBuffers?!1:n.promoteBuffers,_=r;if(e.length<5)throw new Error("corrupt bson message < 5 bytes long");var s=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(5>s||s>e.length)throw new Error("corrupt bson message");for(var f=t?[]:{},A=0;;){var u=e[r++];if(0==u)break;for(var c=r;0!==e[c]&&c<e.length;)c++;if(c>=e.length)throw new Error("Bad BSON Document: illegal CString");var h=t?A++:e.toString("utf8",r,c);if(r=c+1,u==BSON.BSON_DATA_STRING){var w=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(0>=w||w>e.length-r||0!=e[r+w-1])throw new Error("bad string length in bson");f[h]=e.toString("utf8",r,r+w-1),r+=w}else if(u==BSON.BSON_DATA_OID){var E=new Buffer(12);e.copy(E,0,r,r+12),f[h]=new ObjectID(E),r+=12}else if(u==BSON.BSON_DATA_INT)f[h]=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;else if(u==BSON.BSON_DATA_NUMBER)f[h]=e.readDoubleLE(r),r+=8;else if(u==BSON.BSON_DATA_DATE){var g=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,T=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;f[h]=new Date(new Long(g,T).toNumber())}else if(u==BSON.BSON_DATA_BOOLEAN){if(0!=e[r]&&1!=e[r])throw new Error("illegal boolean type value");f[h]=1==e[r++]}else if(u==BSON.BSON_DATA_OBJECT){var D=r,b=e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24;if(0>=b||b>e.length-r)throw new Error("bad embedded document length in bson");B?f[h]=e.slice(r,r+b):f[h]=deserializeObject(e,D,n,!1),r+=b}else if(u==BSON.BSON_DATA_ARRAY){var D=r,b=e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,v=n,y=r+b;if(N&&N[h]){v={};for(var d in n)v[d]=n[d];v.raw=!0}if(f[h]=deserializeObject(e,D,v,!0),r+=b,0!=e[r-1])throw new Error("invalid array terminator byte");if(r!=y)throw new Error("corrupted array bson")}else if(u==BSON.BSON_DATA_UNDEFINED)f[h]=void 0;else if(u==BSON.BSON_DATA_NULL)f[h]=null;else if(u==BSON.BSON_DATA_LONG){var g=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,T=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,p=new Long(g,T);l?f[h]=p.lessThanOrEqual(JS_INT_MAX_LONG)&&p.greaterThanOrEqual(JS_INT_MIN_LONG)?p.toNumber():p:f[h]=p}else if(u==BSON.BSON_DATA_DECIMAL128){var m=new Buffer(16);e.copy(m,0,r,r+16),r+=16;var I=new Decimal128(m);f[h]=I.toObject?I.toObject():I}else if(u==BSON.BSON_DATA_BINARY){var R=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,M=R,C=e[r++];if(0>R)throw new Error("Negative binary type element size found");if(R>e.length)throw new Error("Binary type size larger than document size");if(null!=e.slice){if(C==Binary.SUBTYPE_BYTE_ARRAY){if(R=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,0>R)throw new Error("Negative binary type element size found for subtype 0x02");if(R>M-4)throw new Error("Binary type with subtype 0x02 contains to long binary size");if(M-4>R)throw new Error("Binary type with subtype 0x02 contains to short binary size")}O?f[h]=e.slice(r,r+R):f[h]=new Binary(e.slice(r,r+R),C)}else{var Y="undefined"!=typeof Uint8Array?new Uint8Array(new ArrayBuffer(R)):new Array(R);if(C==Binary.SUBTYPE_BYTE_ARRAY){if(R=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,0>R)throw new Error("Negative binary type element size found for subtype 0x02");if(R>M-4)throw new Error("Binary type with subtype 0x02 contains to long binary size");if(M-4>R)throw new Error("Binary type with subtype 0x02 contains to short binary size")}for(var c=0;R>c;c++)Y[c]=e[r+c];O?f[h]=Y:f[h]=new Binary(Y,C)}r+=R}else if(u==BSON.BSON_DATA_REGEXP&&0==S){for(var c=r;0!==e[c]&&c<e.length;)c++;if(c>=e.length)throw new Error("Bad BSON Document: illegal CString");var L=e.toString("utf8",r,c);r=c+1;for(var c=r;0!==e[c]&&c<e.length;)c++;if(c>=e.length)throw new Error("Bad BSON Document: illegal CString");var x=e.toString("utf8",r,c);r=c+1;for(var U=new Array(x.length),c=0;c<x.length;c++)switch(x[c]){case"m":U[c]="m";break;case"s":U[c]="g";break;case"i":U[c]="i"}f[h]=new RegExp(L,U.join(""))}else if(u==BSON.BSON_DATA_REGEXP&&1==S){for(var c=r;0!==e[c]&&c<e.length;)c++;if(c>=e.length)throw new Error("Bad BSON Document: illegal CString");var L=e.toString("utf8",r,c);r=c+1;for(var c=r;0!==e[c]&&c<e.length;)c++;if(c>=e.length)throw new Error("Bad BSON Document: illegal CString");var x=e.toString("utf8",r,c);r=c+1,f[h]=new BSONRegExp(L,x)}else if(u==BSON.BSON_DATA_SYMBOL){var w=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(0>=w||w>e.length-r||0!=e[r+w-1])throw new Error("bad string length in bson");f[h]=new Symbol(e.toString("utf8",r,r+w-1)),r+=w}else if(u==BSON.BSON_DATA_TIMESTAMP){var g=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,T=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;f[h]=new Timestamp(g,T)}else if(u==BSON.BSON_DATA_MIN_KEY)f[h]=new MinKey;else if(u==BSON.BSON_DATA_MAX_KEY)f[h]=new MaxKey;else if(u==BSON.BSON_DATA_CODE){var w=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(0>=w||w>e.length-r||0!=e[r+w-1])throw new Error("bad string length in bson");var z=e.toString("utf8",r,r+w-1);if(i){if(o){var j=a?crc32(z):z;f[h]=isolateEvalWithHash(functionCache,j,z,f)}else f[h]=isolateEval(z)}else f[h]=new Code(z);r+=w}else{if(u!=BSON.BSON_DATA_CODE_W_SCOPE)throw new Error("Detected unknown BSON type "+u.toString(16)+' for fieldname "'+h+'", are you using the latest BSON parser');var q=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(13>q)throw new Error("code_w_scope total size shorter minimum expected length");var w=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(0>=w||w>e.length-r||0!=e[r+w-1])throw new Error("bad string length in bson");var z=e.toString("utf8",r,r+w-1);r+=w;var D=r,b=e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,P=deserializeObject(e,D,n,!1);if(r+=b,8+b+w>q)throw new Error("code_w_scope total size is to short, truncating scope");if(q>8+b+w)throw new Error("code_w_scope total size is to long, clips outer document");if(i){if(o){var j=a?crc32(z):z;f[h]=isolateEvalWithHash(functionCache,j,z,f)}else f[h]=isolateEval(z);f[h].scope=P}else f[h]=new Code(z,P)}}if(s!=r-_){if(t)throw new Error("corrupt array bson");throw new Error("corrupt object bson")}return null!=f.$id&&(f=new DBRef(f.$ref,f.$id,f.$db)),f},isolateEvalWithHash=function(functionCache,hash,functionString,object){var value=null;return null==functionCache[hash]&&(eval("value = "+functionString),functionCache[hash]=value),functionCache[hash].bind(object)},isolateEval=function(functionString){var value=null;return eval("value = "+functionString),value},BSON={},functionCache=BSON.functionCache={};BSON.BSON_DATA_NUMBER=1,BSON.BSON_DATA_STRING=2,BSON.BSON_DATA_OBJECT=3,BSON.BSON_DATA_ARRAY=4,BSON.BSON_DATA_BINARY=5,BSON.BSON_DATA_UNDEFINED=6,BSON.BSON_DATA_OID=7,BSON.BSON_DATA_BOOLEAN=8,BSON.BSON_DATA_DATE=9,BSON.BSON_DATA_NULL=10,BSON.BSON_DATA_REGEXP=11,BSON.BSON_DATA_CODE=13,BSON.BSON_DATA_SYMBOL=14,BSON.BSON_DATA_CODE_W_SCOPE=15,BSON.BSON_DATA_INT=16,BSON.BSON_DATA_TIMESTAMP=17,BSON.BSON_DATA_LONG=18,BSON.BSON_DATA_DECIMAL128=19,BSON.BSON_DATA_MIN_KEY=255,BSON.BSON_DATA_MAX_KEY=127,BSON.BSON_BINARY_SUBTYPE_DEFAULT=0,BSON.BSON_BINARY_SUBTYPE_FUNCTION=1,BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2,BSON.BSON_BINARY_SUBTYPE_UUID=3,BSON.BSON_BINARY_SUBTYPE_MD5=4,BSON.BSON_BINARY_SUBTYPE_USER_DEFINED=128,BSON.BSON_INT32_MAX=2147483647,BSON.BSON_INT32_MIN=-2147483648,BSON.BSON_INT64_MAX=Math.pow(2,63)-1,BSON.BSON_INT64_MIN=-Math.pow(2,63),BSON.JS_INT_MAX=9007199254740992,BSON.JS_INT_MIN=-9007199254740992;var JS_INT_MAX_LONG=Long.fromNumber(9007199254740992),JS_INT_MIN_LONG=Long.fromNumber(-9007199254740992);module.exports=deserialize;