"use strict";var Insert=require("./commands").Insert,Update=require("./commands").Update,Remove=require("./commands").Remove,Query=require("../connection/commands").Query,copy=require("../connection/utils").copy,KillCursor=require("../connection/commands").KillCursor,GetMore=require("../connection/commands").GetMore,Query=require("../connection/commands").Query,ReadPreference=require("../topologies/read_preference"),f=require("util").format,CommandResult=require("../connection/command_result"),MongoError=require("../error"),Long=require("bson").Long,getReadPreference=require("./shared").getReadPreference,WireProtocol=function(e){this.legacyWireProtocol=e},executeWrite=function(e,r,o,n,t,i,a,c){if(0==i.length)throw new MongoError("insert must contain at least one document");"function"==typeof a&&(c=a,a={},a=a||{});var u=t.split("."),s=u.shift(),l="boolean"==typeof a.ordered?a.ordered:!0,m=a.writeConcern,d={};d[o]=u.join("."),d[n]=i,d.ordered=l,m&&Object.keys(m).length>0&&(d.writeConcern=m),a.collation&&(d.collation=a.collation),"boolean"==typeof a.bypassDocumentValidation&&(d.bypassDocumentValidation=a.bypassDocumentValidation);var p={command:!0},y={checkKeys:!1,numberToSkip:0,numberToReturn:1};"insert"==o&&(y.checkKeys=!0),a.serializeFunctions&&(y.serializeFunctions=a.serializeFunctions),a.ignoreUndefined&&(y.ignoreUndefined=a.ignoreUndefined);try{var g=new Query(r,f("%s.$cmd",s),d,y);e.write(g.toBin(),p,c)}catch(h){c(h)}};WireProtocol.prototype.insert=function(e,r,o,n,t,i,a){executeWrite(e,n,"insert","documents",o,t,i,a)},WireProtocol.prototype.update=function(e,r,o,n,t,i,a){executeWrite(e,n,"update","updates",o,t,i,a)},WireProtocol.prototype.remove=function(e,r,o,n,t,i,a){executeWrite(e,n,"delete","deletes",o,t,i,a)},WireProtocol.prototype.killCursor=function(e,r,o,n,t){var i=r.split(/\./),a=f("%s.$cmd",i.shift()),c={killCursors:i.join("."),cursors:[o]},u=new Query(e,a,c,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,returnFieldSelector:null});u.slaveOk=!0;var s=function(e,r){if(e){if("function"!=typeof t)return;return t(e)}var o=r.message;if(0!=(1&o.responseFlags)){if("function"!=typeof t)return;return t(new MongoError("cursor killed or timed out"),null)}if(!Array.isArray(o.documents)||0==o.documents.length){if("function"!=typeof t)return;return t(new MongoError(f("invalid killCursors result returned for cursor id %s",cursorState.cursorId)))}"function"==typeof t&&t(null,o.documents[0])};n&&n.isConnected()&&n.write(u.toBin(),{command:!0},s)},WireProtocol.prototype.getMore=function(e,r,o,n,t,i,a,c){a=a||{};var u=r.split(/\./),s=f("%s.$cmd",u.shift()),l=("number"==typeof o.cmd.maxTimeMS?o.cmd.maxTimeMS:3e3,{getMore:o.cursorId,collection:u.join("."),batchSize:Math.abs(n)});o.cmd.tailable&&"number"==typeof o.cmd.maxAwaitTimeMS&&(l.maxTimeMS=o.cmd.maxAwaitTimeMS);var m=new Query(e,s,l,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,returnFieldSelector:null});m.slaveOk=!0;var d=function(e,r){if(e)return c(e);var n=r.message;if(0!=(1&n.responseFlags))return c(new MongoError("cursor killed or timed out"),null);if(t)return o.documents=n.documents,o.cursorId=n.cursorId,c(null,n.documents);if(0==n.documents[0].ok)return c(MongoError.create(n.documents[0]));var i="number"==typeof n.documents[0].cursor.id?Long.fromNumber(n.documents[0].cursor.id):n.documents[0].cursor.id;o.documents=n.documents[0].cursor.nextBatch,o.cursorId=i,c(null,n.documents[0],n.connection)},p={command:!0};t&&(p.raw=t),p.documentsReturnedIn="nextBatch","boolean"==typeof o.promoteLongs&&(p.promoteLongs=o.promoteLongs),i.write(m.toBin(),p,d),global.debug=!0},WireProtocol.prototype.command=function(e,r,o,n,t,i){if(o.find){var a=executeFindCommand(e,r,o,n,t,i);return o.virtual=!1,a.documentsReturnedIn="firstBatch",a}if(null==n.cursorId){if(o)return setupCommand(e,r,o,n,t,i);throw new MongoError(f("command %s does not return a cursor",JSON.stringify(o)))}};var executeFindCommand=function(e,r,o,n,t,i){i=i||{};var a=getReadPreference(o,i);n.batchSize=o.batchSize||n.batchSize;var c=r.split(/\./),u=f("%s.$cmd",c.shift()),s={find:c.join(".")};o.query&&(o.query.$query?s.filter=o.query.$query:s.filter=o.query);var l=o.sort;if(Array.isArray(l)){var m={};if(l.length>0&&!Array.isArray(l[0])){var d=l[1];"asc"==d?d=1:"desc"==d&&(d=-1),m[l[0]]=d}else for(var p=0;p<l.length;p++){var d=l[p][1];"asc"==d?d=1:"desc"==d&&(d=-1),m[l[p][0]]=d}l=m}o.sort&&(s.sort=l),o.fields&&(s.projection=o.fields),o.hint&&(s.hint=o.hint),o.skip&&(s.skip=o.skip),o.limit&&(s.limit=o.limit),"number"==typeof o.batchSize&&(s.batchSize=Math.abs(o.batchSize)),o.limit<0&&(s.limit=Math.abs(o.limit),s.singleBatch=!0),o.comment&&(s.comment=o.comment),o.maxScan&&(s.maxScan=o.maxScan),o.maxTimeMS&&(s.maxTimeMS=o.maxTimeMS),o.min&&(s.min=o.min),o.max&&(s.max=o.max),o.returnKey&&(s.returnKey=o.returnKey),o.showDiskLoc&&(s.showRecordId=o.showDiskLoc),o.snapshot&&(s.snapshot=o.snapshot),o.tailable&&(s.tailable=o.tailable),o.oplogReplay&&(s.oplogReplay=o.oplogReplay),o.noCursorTimeout&&(s.noCursorTimeout=o.noCursorTimeout),o.awaitData&&(s.awaitData=o.awaitData),o.awaitdata&&(s.awaitData=o.awaitdata),o.partial&&(s.partial=o.partial),o.collation&&(s.collation=o.collation),o.explain&&(s={explain:s}),o.readConcern&&(s.readConcern=o.readConcern);var y="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,g="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;"mongos"==t.type&&a&&"primary"!=a.preference&&(s={$query:s,$readPreference:a.toJSON()});var h=new Query(e,u,s,{numberToSkip:0,numberToReturn:1,checkKeys:!1,returnFieldSelector:null,serializeFunctions:y,ignoreUndefined:g});return h.slaveOk=a.slaveOk(),h},setupCommand=function(e,r,o,n,t,i){i=i||{};var a=getReadPreference(o,i),c={};for(var u in o)c[u]=o[u];var s=r.split(/\./),l="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,m="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;"mongos"==t.type&&a&&"primary"!=a.preference&&(c={$query:c,$readPreference:a.toJSON()});var d=new Query(e,f("%s.$cmd",s.shift()),c,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,serializeFunctions:l,ignoreUndefined:m});return d.slaveOk=a.slaveOk(),d};module.exports=WireProtocol;