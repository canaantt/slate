"use strict";var Insert=require("./commands").Insert,Update=require("./commands").Update,Remove=require("./commands").Remove,Query=require("../connection/commands").Query,copy=require("../connection/utils").copy,KillCursor=require("../connection/commands").KillCursor,GetMore=require("../connection/commands").GetMore,Query=require("../connection/commands").Query,ReadPreference=require("../topologies/read_preference"),f=require("util").format,CommandResult=require("../connection/command_result"),MongoError=require("../error"),Long=require("bson").Long,getReadPreference=require("./shared").getReadPreference,WireProtocol=function(){},executeWrite=function(e,o,r,n,t,i,a,c){if(0==i.length)throw new MongoError("insert must contain at least one document");"function"==typeof a&&(c=a,a={},a=a||{});var s=t.split("."),u=s.shift(),l="boolean"==typeof a.ordered?a.ordered:!0,d=a.writeConcern,m={};m[r]=s.join("."),m[n]=i,m.ordered=l,d&&Object.keys(d).length>0&&(m.writeConcern=d),"boolean"==typeof a.bypassDocumentValidation&&(m.bypassDocumentValidation=a.bypassDocumentValidation);var p={command:!0},y={checkKeys:!1,numberToSkip:0,numberToReturn:1};"insert"==r&&(y.checkKeys=!0),a.serializeFunctions&&(y.serializeFunctions=a.serializeFunctions),a.ignoreUndefined&&(y.ignoreUndefined=a.ignoreUndefined);try{var b=new Query(o,f("%s.$cmd",u),m,y);e.write(b.toBin(),p,c)}catch(g){c(g)}};WireProtocol.prototype.insert=function(e,o,r,n,t,i,a){executeWrite(e,n,"insert","documents",r,t,i,a)},WireProtocol.prototype.update=function(e,o,r,n,t,i,a){executeWrite(e,n,"update","updates",r,t,i,a)},WireProtocol.prototype.remove=function(e,o,r,n,t,i,a){executeWrite(e,n,"delete","deletes",r,t,i,a)},WireProtocol.prototype.killCursor=function(e,o,r,n,t){var i=new KillCursor(e,[r]);n&&n.isConnected()&&n.write(i.toBin(),{immediateRelease:!0,noResponse:!0}),"function"==typeof t&&t(null,null)},WireProtocol.prototype.getMore=function(e,o,r,n,t,i,a,c){var s=new GetMore(e,o,r.cursorId,{numberToReturn:n}),u=function(e,o){if(e)return c(e);var n=o.message;if(0!=(1&n.responseFlags))return c(new MongoError("cursor does not exist, was killed or timed out"),null);var t="number"==typeof n.cursorId?Long.fromNumber(n.cursorId):n.cursorId;r.documents=n.documents,r.cursorId=t,c(null,null,n.connection)};t&&(u.raw=t),"boolean"==typeof r.promoteLongs&&(u.promoteLongs=r.promoteLongs),i.write(s.toBin(),u)},WireProtocol.prototype.command=function(e,o,r,n,t,i){if(r.find)return setupClassicFind(e,o,r,n,t,i);if(null==n.cursorId){if(r)return setupCommand(e,o,r,n,t,i);throw new MongoError(f("command %s does not return a cursor",JSON.stringify(r)))}};var setupClassicFind=function(e,o,r,n,t,i){i=i||{};var a=getReadPreference(r,i);n.batchSize=r.batchSize||n.batchSize;var c=0;c=0==n.limit?n.batchSize:n.limit<0||n.limit<n.batchSize||n.limit>0&&0==n.batchSize?n.limit:n.batchSize;var s=n.skip||0,u={},l=!1;if("mongos"==t.type&&a&&(u.$readPreference=a.toJSON(),l=!0),r.sort&&(u.orderby=r.sort,l=!0),r.hint&&(u.$hint=r.hint,l=!0),r.snapshot&&(u.$snapshot=r.snapshot,l=!0),r.returnKey&&(u.$returnKey=r.returnKey,l=!0),r.maxScan&&(u.$maxScan=r.maxScan,l=!0),r.min&&(u.$min=r.min,l=!0),r.max&&(u.$max=r.max,l=!0),r.showDiskLoc&&(u.$showDiskLoc=r.showDiskLoc,l=!0),r.comment&&(u.$comment=r.comment,l=!0),r.maxTimeMS&&(u.$maxTimeMS=r.maxTimeMS,l=!0),r.explain&&(c=-Math.abs(r.limit||0),l=!0,u.$explain=!0),l?u.$query=r.query:u=r.query,r.readConcern&&"local"!=r.readConcern.level)throw new MongoError(f("server find command does not support a readConcern level of %s",r.readConcern.level));r.readConcern&&(r=copy(r),delete r.readConcern);var d="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,m="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1,p=new Query(e,o,u,{numberToSkip:s,numberToReturn:c,checkKeys:!1,returnFieldSelector:r.fields,serializeFunctions:d,ignoreUndefined:m});return p.slaveOk=a.slaveOk(),"boolean"==typeof r.tailable&&(p.tailable=r.tailable),"boolean"==typeof r.oplogReplay&&(p.oplogReplay=r.oplogReplay),"boolean"==typeof r.noCursorTimeout&&(p.noCursorTimeout=r.noCursorTimeout),"boolean"==typeof r.awaitData&&(p.awaitData=r.awaitData),"boolean"==typeof r.partial&&(p.partial=r.partial),p},setupCommand=function(e,o,r,n,t,i){i=i||{};var a=getReadPreference(r,i),c={};for(var s in r)c[s]=r[s];var u=o.split(/\./),l="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,d="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;if(r.readConcern&&"local"!=r.readConcern.level)throw new MongoError(f("server %s command does not support a readConcern level of %s",JSON.stringify(r),r.readConcern.level));r.readConcern&&delete r.readConcern,"mongos"==t.type&&a&&"primary"!=a.preference&&(c={$query:c,$readPreference:a.toJSON()});var m=new Query(e,f("%s.$cmd",u.shift()),c,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,serializeFunctions:l,ignoreUndefined:d});return m.slaveOk=a.slaveOk(),m};module.exports=WireProtocol;