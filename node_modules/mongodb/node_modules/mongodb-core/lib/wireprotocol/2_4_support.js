"use strict";var Insert=require("./commands").Insert,Update=require("./commands").Update,Remove=require("./commands").Remove,Query=require("../connection/commands").Query,copy=require("../connection/utils").copy,KillCursor=require("../connection/commands").KillCursor,GetMore=require("../connection/commands").GetMore,Query=require("../connection/commands").Query,ReadPreference=require("../topologies/read_preference"),f=require("util").format,CommandResult=require("../connection/command_result"),MongoError=require("../error"),Long=require("bson").Long,getReadPreference=require("./shared").getReadPreference,writeConcernFields=["w","wtimeout","j","fsync"],WireProtocol=function(){};WireProtocol.prototype.insert=function(e,r,n,o,t,i,s){i=i||{};var a="boolean"==typeof i.ordered?i.ordered:!0;"boolean"==typeof i.legacy?i.legacy:!1;if(t=Array.isArray(t)?t:[t],t.length>1e3)return s(new MongoError("exceeded maximum write batch size of 1000"));var u=i.writeConcern||{w:1};return a&&0!=u.w?executeOrdered("insert",Insert,r,n,o,e,t,i,s):executeUnordered("insert",Insert,r,n,o,e,t,i,s)},WireProtocol.prototype.update=function(e,r,n,o,t,i,s){i=i||{};var a="boolean"==typeof i.ordered?i.ordered:!0;t=Array.isArray(t)?t:[t];var u=i.writeConcern||{w:1};return a&&0!=u.w?executeOrdered("update",Update,r,n,o,e,t,i,s):executeUnordered("update",Update,r,n,o,e,t,i,s)},WireProtocol.prototype.remove=function(e,r,n,o,t,i,s){i=i||{};var a="boolean"==typeof i.ordered?i.ordered:!0;t=Array.isArray(t)?t:[t];var u=i.writeConcern||{w:1};return a&&0!=u.w?executeOrdered("remove",Remove,r,n,o,e,t,i,s):executeUnordered("remove",Remove,r,n,o,e,t,i,s)},WireProtocol.prototype.killCursor=function(e,r,n,o,t){var i=new KillCursor(e,[n]);o&&o.isConnected()&&o.write(i.toBin(),{immediateRelease:!0,noResponse:!0}),"function"==typeof t&&t(null,null)},WireProtocol.prototype.getMore=function(e,r,n,o,t,i,s,a){var u=new GetMore(e,r,n.cursorId,{numberToReturn:o}),c=function(e,r){if(e)return a(e);var o=r.message;if(0!=(1&o.responseFlags))return a(new MongoError("cursor does not exist, was killed or timed out"),null);var t="number"==typeof o.cursorId?Long.fromNumber(o.cursorId):o.cursorId;n.documents=o.documents,n.cursorId=t,a(null,null,o.connection)};t&&(c.raw=t),"boolean"==typeof n.promoteLongs&&(c.promoteLongs=n.promoteLongs),i.write(u.toBin(),c)},WireProtocol.prototype.command=function(e,r,n,o,t,i){if(n.find)return setupClassicFind(e,r,n,o,t,i);if(null==o.cursorId){if(n)return setupCommand(e,r,n,o,t,i);throw new MongoError(f("command %s does not return a cursor",JSON.stringify(n)))}};var setupClassicFind=function(e,r,n,o,t,i){i=i||{};var s=getReadPreference(n,i);o.batchSize=n.batchSize||o.batchSize;var a=0;a=0==o.limit?o.batchSize:o.limit<0||o.limit<o.batchSize||o.limit>0&&0==o.batchSize?o.limit:o.batchSize;var u=o.skip||0,c={},l=!1;if("mongos"==t.type&&s&&(c.$readPreference=s.toJSON(),l=!0),n.sort&&(c.orderby=n.sort,l=!0),n.hint&&(c.$hint=n.hint,l=!0),n.snapshot&&(c.$snapshot=n.snapshot,l=!0),n.returnKey&&(c.$returnKey=n.returnKey,l=!0),n.maxScan&&(c.$maxScan=n.maxScan,l=!0),n.min&&(c.$min=n.min,l=!0),n.max&&(c.$max=n.max,l=!0),n.showDiskLoc&&(c.$showDiskLoc=n.showDiskLoc,l=!0),n.comment&&(c.$comment=n.comment,l=!0),n.maxTimeMS&&(c.$maxTimeMS=n.maxTimeMS,l=!0),n.explain&&(a=-Math.abs(n.limit||0),l=!0,c.$explain=!0),l?c.$query=n.query:c=n.query,n.readConcern&&"local"!=n.readConcern.level)throw new MongoError(f("server find command does not support a readConcern level of %s",n.readConcern.level));n.readConcern&&(n=copy(n),delete n.readConcern);var d="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,m="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1,p=new Query(e,r,c,{numberToSkip:u,numberToReturn:a,checkKeys:!1,returnFieldSelector:n.fields,serializeFunctions:d,ignoreUndefined:m});return p.slaveOk=s.slaveOk(),"boolean"==typeof n.tailable&&(p.tailable=n.tailable),"boolean"==typeof n.oplogReplay&&(p.oplogReplay=n.oplogReplay),"boolean"==typeof n.noCursorTimeout&&(p.noCursorTimeout=n.noCursorTimeout),"boolean"==typeof n.awaitData&&(p.awaitData=n.awaitData),"boolean"==typeof n.partial&&(p.partial=n.partial),p},setupCommand=function(e,r,n,o,t,i){i=i||{};var s=getReadPreference(n,i),a={};for(var u in n)a[u]=n[u];var c=r.split(/\./);if(n.readConcern&&"local"!=n.readConcern.level)throw new MongoError(f("server %s command does not support a readConcern level of %s",JSON.stringify(n),n.readConcern.level));n.readConcern&&delete n.readConcern;var l="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,d="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1;"mongos"==t.type&&s&&"primary"!=s.preference&&(a={$query:a,$readPreference:s.toJSON()});var m=new Query(e,f("%s.$cmd",c.shift()),a,{numberToSkip:0,numberToReturn:-1,checkKeys:!1,serializeFunctions:l,ignoreUndefined:d});return m.slaveOk=s.slaveOk(),m},hasWriteConcern=function(e){return e.w||e.wtimeout||1==e.j||1==e.fsync||0==Object.keys(e).length?!0:!1},cloneWriteConcern=function(e){var r={};return null!=e.w&&(r.w=e.w),null!=e.wtimeout&&(r.wtimeout=e.wtimeout),null!=e.j&&(r.j=e.j),null!=e.fsync&&(r.fsync=e.fsync),r},aggregateWriteOperationResults=function(e,r,n,o){for(var t={ok:1,n:0},i=0;i<n.length;i++){var s=n[i],a=r[i];!s.upserted&&0!=s.updatedExisting||null!=t.upserted||(t.upserted=[]),s.upserted&&t.upserted.push({index:i,_id:s.upserted}),0==s.updatedExisting&&1==s.n&&null==s.upserted&&t.upserted.push({index:i,_id:a.q._id}),1==s.ok&&"insert"==e&&null==s.err&&(t.n=t.n+1),null!=s&&0==s.ok||s.err||s.errmsg?(0==s.ok&&(t.ok=0),t.code=s.code,t.errmsg=s.errmsg||s.err||s.errMsg,11e3==s.code||11001==s.code||12582==s.code||16544==s.code||16538==s.code||16542==s.code||14==s.code||13511==s.code?(null==t.writeErrors&&(t.writeErrors=[]),t.writeErrors.push({index:i,code:s.code,errmsg:s.errmsg||s.err||s.errMsg})):t.writeConcernError={code:s.code,errmsg:s.errmsg||s.err||s.errMsg}):"number"==typeof s.n?t.n+=s.n:t.n+=1,null!=s&&s.lastOp&&(t.lastOp=s.lastOp)}return new CommandResult(t,o)},executeOrdered=function(e,r,n,o,t,i,s,a,u){var c=s.slice(0),l=[],d=function(c,m){if(0==c.length)return process.nextTick(function(){m(null,aggregateWriteOperationResults(e,s,l,null))});var p=c.shift(),g=new r(Query.getRequestId(),n,t,o,[p],a),y=a.writeConcern||{w:1},w=cloneWriteConcern(y),v=o.split(".").shift();try{for(var h=[g.toBin()],C={getlasterror:1},b=0;b<writeConcernFields.length;b++)null!=w[writeConcernFields[b]]&&(C[writeConcernFields[b]]=w[writeConcernFields[b]]);var R=new Query(t,f("%s.$cmd",v),C,{numberToReturn:-1});h.push(R.toBin());var x=function(r,n){if(r)return u(r);var o=n.result;return l.push(o),0==o.ok||o.err||o.errmsg?u(null,aggregateWriteOperationResults(e,s,l,n.connection)):void d(c,u)};i.write(h,x)}catch(k){"string"==typeof k&&(k=new MongoError(k)),l.push({ok:1,errmsg:k.message,code:14}),process.nextTick(function(){m(null,aggregateWriteOperationResults(e,s,l,null))})}};d(c,u)},executeUnordered=function(e,r,n,o,t,i,s,a,u){for(var c,l=s.length,d=[],m=a.writeConcern||{w:1},p=cloneWriteConcern(m),g=0;g<s.length;g++){var y=new r(Query.getRequestId(),n,t,o,[s[g]],a),w=o.split(".").shift();try{var v=[y.toBin()];if(hasWriteConcern(p)){for(var h={getlasterror:1},C=0;C<writeConcernFields.length;C++)null!=p[writeConcernFields[C]]&&(h[writeConcernFields[C]]=p[writeConcernFields[C]]);var b=new Query(t,f("%s.$cmd",w),h,{numberToReturn:-1});v.push(b.toBin());var R=function(r){return function(n,o){n&&(c=n),l-=1,n||(d[r]=o.result),0==l&&process.nextTick(function(){return c?u(c):void u(null,aggregateWriteOperationResults(e,s,d,o.connection))})}};i.write(v,R(g))}else i.write(v,{immediateRelease:!0,noResponse:!0})}catch(x){"string"==typeof x&&(x=new MongoError(x)),l-=1,d[g]={ok:1,errmsg:x.message,code:14},0==l&&u(null,aggregateWriteOperationResults(e,s,d,null))}}p&&0==p.w&&u&&u(null,new CommandResult({ok:1},null))};module.exports=WireProtocol;