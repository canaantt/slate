"use strict";var MongoError=require("../error"),OP_UPDATE=2001,OP_INSERT=2002,OP_DELETE=2006,Insert=function(e,s,t,i,n,r){if(null==i)throw new MongoError("ns must be specified for query");if(!Array.isArray(n)||0==n.length)throw new MongoError("documents array must contain at least one document to insert");if(~i.indexOf("\x00"))throw new MongoError("namespace cannot contain a null character");this.requestId=e,this.bson=t,this.ns=i,this.documents=n,this.ismaster=s,r=r||{},this.serializeFunctions="boolean"==typeof r.serializeFunctions?r.serializeFunctions:!1,this.ignoreUndefined="boolean"==typeof r.ignoreUndefined?r.ignoreUndefined:!1,this.checkKeys="boolean"==typeof r.checkKeys?r.checkKeys:!0,this.continueOnError="boolean"==typeof r.continueOnError?r.continueOnError:!1,this.flags=this.continueOnError?1:0};Insert.prototype.toBin=function(){var e=[],s=new Buffer(20+Buffer.byteLength(this.ns)+1);e.push(s);for(var t=s.length,i=0;i<this.documents.length;i++){var n=this.bson.serialize(this.documents[i],this.checkKeys,!0,this.serializeFunctions,0,this.ignoreUndefined);if(n.length>this.ismaster.maxBsonObjectSize)throw new MongoError("Document exceeds maximum allowed bson size of "+this.ismaster.maxBsonObjectSize+" bytes");t+=n.length,e.push(n)}if(t>this.ismaster.maxMessageSizeBytes)throw new MongoError("Command exceeds maximum message size of "+this.ismaster.maxMessageSizeBytes+" bytes");var r=0;return s[r+3]=t>>24&255,s[r+2]=t>>16&255,s[r+1]=t>>8&255,s[r]=255&t,r+=4,s[r+3]=this.requestId>>24&255,s[r+2]=this.requestId>>16&255,s[r+1]=this.requestId>>8&255,s[r]=255&this.requestId,r+=4,s[r+3]=0,s[r+2]=0,s[r+1]=0,s[r]=0,r+=4,s[r+3]=OP_INSERT>>24&255,s[r+2]=OP_INSERT>>16&255,s[r+1]=OP_INSERT>>8&255,s[r]=255&OP_INSERT,r+=4,s[r+3]=this.flags>>24&255,s[r+2]=this.flags>>16&255,s[r+1]=this.flags>>8&255,s[r]=255&this.flags,r+=4,r=r+s.write(this.ns,r,"utf8")+1,s[r-1]=0,e};var Update=function(e,s,t,i,n,r){if(null==i)throw new MongoError("ns must be specified for query");r=r||{},this.requestId=e,this.bson=t,this.ns=i,this.ismaster=s,this.serializeFunctions="boolean"==typeof r.serializeFunctions?r.serializeFunctions:!1,this.ignoreUndefined="boolean"==typeof r.ignoreUndefined?r.ignoreUndefined:!1,this.checkKeys="boolean"==typeof r.checkKeys?r.checkKeys:!1,this.upsert="boolean"==typeof n[0].upsert?n[0].upsert:!1,this.multi="boolean"==typeof n[0].multi?n[0].multi:!1,this.q=n[0].q,this.u=n[0].u,this.flags=this.upsert?1:0,this.flags=this.multi?2|this.flags:this.flags};Update.prototype.toBin=function(){var e=[],s=new Buffer(20+Buffer.byteLength(this.ns)+1+4);e.push(s);var t=s.length,i=this.bson.serialize(this.q,this.checkKeys,!0,this.serializeFunctions,0,this.ignoreUndefined);e.push(i),t+=i.length;var n=this.bson.serialize(this.u,this.checkKeys,!0,this.serializeFunctions,0,this.ignoreUndefined);e.push(n),t+=n.length;var r=0;return s[r+3]=t>>24&255,s[r+2]=t>>16&255,s[r+1]=t>>8&255,s[r]=255&t,r+=4,s[r+3]=this.requestId>>24&255,s[r+2]=this.requestId>>16&255,s[r+1]=this.requestId>>8&255,s[r]=255&this.requestId,r+=4,s[r+3]=0,s[r+2]=0,s[r+1]=0,s[r]=0,r+=4,s[r+3]=OP_UPDATE>>24&255,s[r+2]=OP_UPDATE>>16&255,s[r+1]=OP_UPDATE>>8&255,s[r]=255&OP_UPDATE,r+=4,s[r+3]=0,s[r+2]=0,s[r+1]=0,s[r]=0,r+=4,r=r+s.write(this.ns,r,"utf8")+1,s[r-1]=0,s[r+3]=this.flags>>24&255,s[r+2]=this.flags>>16&255,s[r+1]=this.flags>>8&255,s[r]=255&this.flags,r+=4,e};var Remove=function(e,s,t,i,n,r){if(null==i)throw new MongoError("ns must be specified for query");r=r||{},this.requestId=e,this.bson=t,this.ns=i,this.ismaster=s,this.serializeFunctions="boolean"==typeof r.serializeFunctions?r.serializeFunctions:!1,this.ignoreUndefined="boolean"==typeof r.ignoreUndefined?r.ignoreUndefined:!1,this.checkKeys="boolean"==typeof r.checkKeys?r.checkKeys:!1,this.limit="number"==typeof n[0].limit?n[0].limit:1,this.q=n[0].q,this.flags=1==this.limit?1:0};Remove.prototype.toBin=function(){var e=[],s=new Buffer(20+Buffer.byteLength(this.ns)+1+4);e.push(s);var t=s.length,i=this.bson.serialize(this.q,this.checkKeys,!0,this.serializeFunctions,0,this.ignoreUndefined);e.push(i),t+=i.length;var n=0;return s[n+3]=t>>24&255,s[n+2]=t>>16&255,s[n+1]=t>>8&255,s[n]=255&t,n+=4,s[n+3]=this.requestId>>24&255,s[n+2]=this.requestId>>16&255,s[n+1]=this.requestId>>8&255,s[n]=255&this.requestId,n+=4,s[n+3]=0,s[n+2]=0,s[n+1]=0,s[n]=0,n+=4,s[n+3]=OP_DELETE>>24&255,s[n+2]=OP_DELETE>>16&255,s[n+1]=OP_DELETE>>8&255,s[n]=255&OP_DELETE,n+=4,s[n+3]=0,s[n+2]=0,s[n+1]=0,s[n]=0,n+=4,n=n+s.write(this.ns,n,"utf8")+1,s[n-1]=0,s[n+3]=this.flags>>24&255,s[n+2]=this.flags>>16&255,s[n+1]=this.flags>>8&255,s[n]=255&this.flags,n+=4,e},module.exports={Insert:Insert,Update:Update,Remove:Remove};