"use strict";var f=require("util").format,crypto=require("crypto"),require_optional=require("require_optional"),Query=require("../connection/commands").Query,MongoError=require("../error"),AuthSession=function(n,r,o,t){this.db=n,this.username=r,this.password=o,this.options=t};AuthSession.prototype.equal=function(n){return n.db==this.db&&n.username==this.username&&n.password==this.password};var Kerberos=null,MongoAuthProcess=null;try{Kerberos=require_optional("kerberos").Kerberos,MongoAuthProcess=require_optional("kerberos").processes.MongoAuthProcess}catch(err){}var GSSAPI=function(n){this.bson=n,this.authStore=[]};GSSAPI.prototype.auth=function(n,r,o,t,e,i,u){var s=this;if(null==Kerberos)return u(new Error("Kerberos library is not installed"));var a=i.gssapiServiceName||"mongodb",l=r.length;if(0==l)return u(null,null);for(var c=0,S=!1,h=null;r.length>0;){var d=function(r){GSSAPIInitialize(s,o,t,e,o,a,n,r,i,function(n,r){l-=1,n?h=n:r.result.$err?h=r.result:r.result.errmsg?h=r.result:(S=!0,c+=1),0==l&&c>0?(addAuthSession(s.authStore,new AuthSession(o,t,e,i)),u(null,!0)):0==l&&(null==h&&(h=new MongoError(f("failed to authenticate using mongocr"))),u(h,!1))})},p=function(n){process.nextTick(function(){d(n)})};p(r.shift())}};var GSSAPIInitialize=function(n,r,o,t,e,i,u,s,a,l){var c=new MongoAuthProcess(s.host,s.port,i,a);c.init(o,t,function(i,a){return i?l(i,!1):void c.transition("",function(i,a){return i?l(i,!1):void MongoDBGSSAPIFirstStep(n,c,a,r,o,t,e,u,s,l)})})},MongoDBGSSAPIFirstStep=function(n,r,o,t,e,i,u,s,a,l){var c={saslStart:1,mechanism:"GSSAPI",payload:o,autoAuthorize:1};s(a,new Query(n.bson,"$external.$cmd",c,{numberToSkip:0,numberToReturn:1}).toBin(),function(o,c){if(o)return l(o,!1);var S=c.result;r.transition(c.result.payload,function(o,c){return o?l(o,!1):void MongoDBGSSAPISecondStep(n,r,c,S,t,e,i,u,s,a,l)})})},MongoDBGSSAPISecondStep=function(n,r,o,t,e,i,u,s,a,l,c){var S={saslContinue:1,conversationId:t.conversationId,payload:o};a(l,new Query(n.bson,"$external.$cmd",S,{numberToSkip:0,numberToReturn:1}).toBin(),function(o,t){if(o)return c(o,!1);var S=t.result;r.transition(S.payload,function(o,t){return o?c(o,!1):void MongoDBGSSAPIThirdStep(n,r,t,S,e,i,u,s,a,l,c)})})},MongoDBGSSAPIThirdStep=function(n,r,o,t,e,i,u,s,a,l,c){var S={saslContinue:1,conversationId:t.conversationId,payload:o};a(l,new Query(n.bson,"$external.$cmd",S,{numberToSkip:0,numberToReturn:1}).toBin(),function(n,o){return n?c(n,!1):void r.transition(null,function(n,r){return n?c(n,null):void c(null,o)})})},addAuthSession=function(n,r){for(var o=!1,t=0;t<n.length;t++)if(n[t].equal(r)){o=!0;break}o||n.push(r)};GSSAPI.prototype.logout=function(n){this.authStore=this.authStore.filter(function(r){return r.db!=n})},GSSAPI.prototype.reauthenticate=function(n,r,o){var t=this.authStore.slice(0),e=t.length;if(0==e)return o(null,null);for(var i=0;i<t.length;i++)this.auth(n,r,t[i].db,t[i].username,t[i].password,t[i].options,function(n,r){n&&(n=n),e-=1,0==e&&o(n,null)})},module.exports=GSSAPI;