"use strict";var f=require("util").format,crypto=require("crypto"),require_optional=require("require_optional"),Query=require("../connection/commands").Query,MongoError=require("../error"),AuthSession=function(r,n,e,t){this.db=r,this.username=n,this.password=e,this.options=t};AuthSession.prototype.equal=function(r){return r.db==this.db&&r.username==this.username&&r.password==this.password};var Kerberos=null,MongoAuthProcess=null;try{Kerberos=require_optional("kerberos").Kerberos,MongoAuthProcess=require_optional("kerberos").processes.MongoAuthProcess}catch(err){}var SSPI=function(r){this.bson=r,this.authStore=[]};SSPI.prototype.auth=function(r,n,e,t,o,u,i){var s=this;if(null==Kerberos)return i(new Error("Kerberos library is not installed"));var a=u.gssapiServiceName||"mongodb",l=n.length;if(0==l)return i(null,null);for(var c=0,h=!1,d=null;n.length>0;){var p=function(n){SSIPAuthenticate(s,t,o,a,r,n,u,function(r,n){l-=1,r?d=r:n&&"object"==typeof n&&n.result.$err?d=n.result:n&&"object"==typeof n&&n.result.errmsg?d=n.result:(h=!0,c+=1),0==l&&c>0?(addAuthSession(s.authStore,new AuthSession(e,t,o,u)),i(null,!0)):0==l&&(null==d&&(d=new MongoError(f("failed to authenticate using mongocr"))),i(d,!1))})},S=function(r){process.nextTick(function(){p(r)})};S(n.shift())}};var SSIPAuthenticate=function(r,n,e,t,o,u,i,s){var a={saslStart:1,mechanism:"GSSAPI",payload:"",autoAuthorize:1},l=new MongoAuthProcess(u.host,u.port,t,i);o(u,new Query(r.bson,"$external.$cmd",a,{numberToSkip:0,numberToReturn:1}).toBin(),function(t,i){if(t)return s(t,!1);var a=i.result;l.init(n,e,function(n){return n?s(n):void l.transition(a.payload,function(n,e){if(n)return s(n);var t={saslContinue:1,conversationId:a.conversationId,payload:e};o(u,new Query(r.bson,"$external.$cmd",t,{numberToSkip:0,numberToReturn:1}).toBin(),function(n,e){if(n)return s(n,!1);var t=e.result;l.transition(t.payload,function(n,e){if(n)return s(n);var i={saslContinue:1,conversationId:t.conversationId,payload:e};o(u,new Query(r.bson,"$external.$cmd",i,{numberToSkip:0,numberToReturn:1}).toBin(),function(n,e){if(n)return s(n,!1);var t=e.result;l.transition(t.payload,function(n,e){var i={saslContinue:1,conversationId:t.conversationId,payload:e};o(u,new Query(r.bson,"$external.$cmd",i,{numberToSkip:0,numberToReturn:1}).toBin(),function(r,n){if(r)return s(r,!1);var e=n.result;return e.done?s(null,!0):void s(new Error("Authentication failed"),!1)})})})})})})})})},addAuthSession=function(r,n){for(var e=!1,t=0;t<r.length;t++)if(r[t].equal(n)){e=!0;break}e||r.push(n)};SSPI.prototype.logout=function(r){this.authStore=this.authStore.filter(function(n){return n.db!=r})},SSPI.prototype.reauthenticate=function(r,n,e){var t=this.authStore.slice(0),o=t.length;if(0==o)return e(null,null);for(var u=0;u<t.length;u++)this.auth(r,n,t[u].db,t[u].username,t[u].password,t[u].options,function(r,n){r&&(r=r),o-=1,0==o&&e(r,null)})},module.exports=SSPI;