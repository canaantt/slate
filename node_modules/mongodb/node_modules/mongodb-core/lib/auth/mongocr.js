"use strict";var f=require("util").format,crypto=require("crypto"),Query=require("../connection/commands").Query,MongoError=require("../error"),AuthSession=function(t,e,n){this.db=t,this.username=e,this.password=n};AuthSession.prototype.equal=function(t){return t.db==this.db&&t.username==this.username&&t.password==this.password};var MongoCR=function(t){this.bson=t,this.authStore=[]},addAuthSession=function(t,e){for(var n=!1,r=0;r<t.length;r++)if(t[r].equal(e)){n=!0;break}n||t.push(e)};MongoCR.prototype.auth=function(t,e,n,r,o,u){var s=this,i=e.length;if(0==i)return u(null,null);for(var a=0,l=!1,h=null;e.length>0;){var c=function(e){t(e,new Query(s.bson,f("%s.$cmd",n),{getnonce:1},{numberToSkip:0,numberToReturn:1}).toBin(),function(c,d){var p=null,g=null;if(null==c){p=d.result.nonce;var m=crypto.createHash("md5");m.update(r+":mongo:"+o,"utf8");var b=m.digest("hex");m=crypto.createHash("md5"),m.update(p+r+b,"utf8"),g=m.digest("hex")}t(e,new Query(s.bson,f("%s.$cmd",n),{authenticate:1,user:r,nonce:p,key:g},{numberToSkip:0,numberToReturn:1}).toBin(),function(t,e){i-=1,t?h=t:e.result.$err?h=e.result:e.result.errmsg?h=e.result:(l=!0,a+=1),0==i&&a>0?(addAuthSession(s.authStore,new AuthSession(n,r,o)),u(null,!0)):0==i&&(null==h&&(h=new MongoError(f("failed to authenticate using mongocr"))),u(h,!1))})})},d=function(t){process.nextTick(function(){c(t)})};d(e.shift())}},MongoCR.prototype.logout=function(t){this.authStore=this.authStore.filter(function(e){return e.db!=t})},MongoCR.prototype.reauthenticate=function(t,e,n){var r=this.authStore.slice(0),o=r.length;if(0==o)return n(null,null);for(var u=0;u<r.length;u++)this.auth(t,e,r[u].db,r[u].username,r[u].password,function(t,e){t&&(t=t),o-=1,0==o&&n(t,null)})},module.exports=MongoCR;