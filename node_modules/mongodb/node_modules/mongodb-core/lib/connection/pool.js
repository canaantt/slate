"use strict";function stateTransition(e,n){var t={disconnected:[CONNECTING,DESTROYING,DISCONNECTED],connecting:[CONNECTING,DESTROYING,CONNECTED,DISCONNECTED],connected:[CONNECTED,DISCONNECTED,DESTROYING],destroying:[DESTROYING,DESTROYED],destroyed:[DESTROYED]},o=t[e.state];o&&-1!=o.indexOf(n)?e.state=n:e.logger.error(f("Pool with id [%s] failed attempted illegal state transition from [%s] to [%s] only following state allowed [%s]",e.id,e.state,n,o))}function authenticate(e,n,t,o){if(void 0===n[0])return o(null);var i=n[0],r=n[1];if(!e.authProviders[i])throw new MongoError(f("authMechanism %s not supported",i));var s=e.authProviders[i];s.auth.apply(s,[write(e),[t],r].concat(n.slice(2)).concat([o]))}function write(e){return function(n,t,o){return e.state==DESTROYED||e.state==DESTROYING?o(new MongoError("pool destroyed")):(n.workItem={cb:o,command:!0},void n.write(t))}}function reauthenticate(e,n,t){function o(e,n,t,i){if(0==t.length)return i();var r=e.authProviders[t.pop()];r.reauthenticate(write(e),[n],function(r,s){return r?i(r):void o(e,n,t,i)})}o(e,n,Object.keys(e.authProviders),t)}function connectionFailureHandler(e,n){return function(t){if(this.destroy(),removeConnection(e,this),this.workItem&&this.workItem.cb){var o=this.workItem;this.workItem=null,o.cb(t)}return"timeout"==n&&(e.numberOfConsecutiveTimeouts=e.numberOfConsecutiveTimeouts+1,e.numberOfConsecutiveTimeouts>e.options.reconnectTries)?(e.numberOfConsecutiveTimeouts=0,e.destroy(!0),e.emit("close",e)):(0==e.socketCount()&&(e.state!=DESTROYED&&e.state!=DESTROYING&&stateTransition(e,DISCONNECTED),n="error"==n?"close":n,e.emit(n,t)),void(!e.reconnectId&&e.options.reconnect&&(e.reconnectId=setTimeout(attemptReconnect(e),e.options.reconnectInterval))))}}function attemptReconnect(e){return function(){function n(e,n){return function(){this.destroy(),e.retriesLeft=e.retriesLeft-1,0==e.retriesLeft?(e.destroy(),e.emit("reconnectFailed",new MongoError(f("failed to reconnect after %s attempts with interval %s ms",e.options.reconnectTries,e.options.reconnectInterval)))):e.reconnectId=setTimeout(attemptReconnect(e),e.options.reconnectInterval)}}function t(e){return function(){var n=this;return e.state==DESTROYED||e.state==DESTROYING?n.destroy():(handlers.forEach(function(e){n.removeAllListeners(e)}),e.reconnectId=null,n.on("error",connectionFailureHandler(e,"error")),n.on("close",connectionFailureHandler(e,"close")),n.on("timeout",connectionFailureHandler(e,"timeout")),n.on("parseError",connectionFailureHandler(e,"parseError")),void reauthenticate(e,this,function(t){e.retriesLeft=e.options.reconnectTries,e.availableConnections.push(n),e.emit("reconnect",e),_execute(e)()}))}}if(e.emit("attemptReconnect",e),e.state!=DESTROYED&&e.state!=DESTROYING){if(e.isConnected())return void(e.reconnectId=null);var o=new Connection(messageHandler(e),e.options);o.on("close",n(e,"close")),o.on("error",n(e,"error")),o.on("timeout",n(e,"timeout")),o.on("parseError",n(e,"parseError")),o.on("connect",t(e)),o.connect()}}}function moveConnectionBetween(e,n,t){var o=n.indexOf(e);-1!=o&&(n.splice(o,1),t.push(e))}function messageHandler(e){return function(n,t){function o(e,n,t){var o=e.nonAuthenticatedConnections.slice(0),i=e.nonAuthenticatedConnections;if(e.nonAuthenticatedConnections=[],(1==n.workItem.authenticating||"number"==typeof n.workItem.authenticatingTimestamp&&n.workItem.authenticatingTimestamp!=e.authenticatingTimestamp)&&o.push(n),n.workItem=null,0==o.length)return moveConnectionBetween(n,e.inUseConnections,e.availableConnections),t();for(var r=o.length,s=0;r>s;s++)reauthenticate(e,o[s],function(o){r-=1,0==r&&(e.availableConnections=e.availableConnections.concat(i),moveConnectionBetween(n,e.inUseConnections,e.availableConnections),t())})}var i=t.workItem;e.numberOfConsecutiveTimeouts=0,i.socketTimeout&&t.resetSocketTimeout(),e.logger.isDebug()&&e.logger.debug(f("message [%s] received from %s:%s",n.raw.toString("hex"),e.options.host,e.options.port)),o(e,t,function(o){if(process.nextTick(function(){_execute(e)()}),!i.immediateRelease){try{n.parse(i)}catch(o){return i.cb(MongoError.create(o))}if(i.command&&n.documents[0]&&(0==n.documents[0].ok||n.documents[0].$err||n.documents[0].errmsg||n.documents[0].code))return i.cb(MongoError.create(n.documents[0]));i.cb(null,new CommandResult(n.documents[0],t,n))}})}}function destroy(e,n){n.forEach(function(e){for(var n=0;n<events.length;n++)e.removeAllListeners(events[n]);e.destroy()}),e.inUseConnections=[],e.availableConnections=[],e.nonAuthenticatedConnections=[],e.connectingConnections=[],stateTransition(e,DESTROYED)}function remove(e,n){for(var t=0;t<n.length;t++)if(n[t]===e)return n.splice(t,1),!0}function removeConnection(e,n){remove(n,e.availableConnections)||remove(n,e.inUseConnections)||remove(n,e.connectingConnections)||remove(n,e.nonAuthenticatedConnections)}function _createConnection(e){var n=new Connection(messageHandler(e),e.options);e.connectingConnections.push(n);var t=function(n){return function(t){n.destroy(),removeConnection(e,n),!e.reconnectId&&e.options.reconnect&&(e.reconnectId=setTimeout(attemptReconnect(e),e.options.reconnectInterval))}},o=function(n){return function(){return e.state==DESTROYED||e.state==DESTROYING?(removeConnection(e,n),n.destroy()):(handlers.forEach(function(e){n.removeAllListeners(e)}),n.once("close",connectionFailureHandler(e,"close")),n.once("error",connectionFailureHandler(e,"error")),n.once("timeout",connectionFailureHandler(e,"timeout")),n.once("parseError",connectionFailureHandler(e,"parseError")),void reauthenticate(e,n,function(t){return e.state==DESTROYED||e.state==DESTROYING?n.destroy():(removeConnection(e,n),t?n.destroy():void(e.authenticating?e.nonAuthenticatedConnections.push(n):(e.availableConnections.push(n),_execute(e)())))}))}};n.once("close",t(n)),n.once("error",t(n)),n.once("timeout",t(n)),n.once("parseError",t(n)),n.once("connect",o(n)),n.connect()}function flushMonitoringOperations(e){for(var n=0;n<e.length;n++)if(e[n].monitoring){var t=e[n];e.splice(n,1),t.cb(new MongoError("no connection available for monitoring"))}}function _execute(e){return function(){function n(t){return e.authenticating?void setTimeout(function(){n(t)},1):t()}e.state!=DESTROYED&&(e.executing||(e.executing=!0,n(function(){for(;;){var n=e.availableConnections.length+e.connectingConnections.length+e.inUseConnections.length;if(0==e.availableConnections.length&&0==e.connectingConnections.length&&n<e.options.size&&e.queue.length>0)return _createConnection(e),void(e.executing=!1);if(0==e.availableConnections.length){flushMonitoringOperations(e.queue);break}if(0==e.queue.length)break;var t=e.availableConnections.pop();if(t.isConnected()){var o=e.queue.shift(),i=o.buffer;if(e.inUseConnections.push(t),o.authenticating=e.authenticating,o.authenticatingTimestamp=e.authenticatingTimestamp,t.workItem=o,o.immediateRelease||"number"!=typeof o.socketTimeout||t.setSocketTimeout(o.socketTimeout),Array.isArray(i))for(var r=0;r<i.length;r++)t.write(i[r]);else t.write(i);o.immediateRelease&&!e.authenticating?(e.inUseConnections.pop(),e.availableConnections.push(t)):o.immediateRelease&&e.authenticating&&(e.inUseConnections.pop(),e.nonAuthenticatedConnections.push(t))}else flushMonitoringOperations(e.queue)}}),e.executing=!1))}}var inherits=require("util").inherits,EventEmitter=require("events").EventEmitter,Connection=require("./connection"),MongoError=require("../error"),Logger=require("./logger"),f=require("util").format,Query=require("./commands").Query,CommandResult=require("./command_result"),assign=require("../topologies/shared").assign,MongoCR=require("../auth/mongocr"),X509=require("../auth/x509"),Plain=require("../auth/plain"),GSSAPI=require("../auth/gssapi"),SSPI=require("../auth/sspi"),ScramSHA1=require("../auth/scram"),DISCONNECTED="disconnected",CONNECTING="connecting",CONNECTED="connected",DESTROYING="destroying",DESTROYED="destroyed",_id=0,Pool=function(e){if(EventEmitter.call(this),this.options=assign({host:"localhost",port:27017,size:5,connectionTimeout:3e4,socketTimeout:3e4,keepAlive:!0,keepAliveInitialDelay:0,noDelay:!0,ssl:!1,checkServerIdentity:!1,ca:null,cert:null,key:null,passPhrase:null,rejectUnauthorized:!1,promoteLongs:!0,reconnect:!0,reconnectInterval:1e3,reconnectTries:30,domainsEnabled:!1},e),this.id=_id++,this.retriesLeft=this.options.reconnectTries,this.reconnectId=null,!e.bson||e.bson&&("function"!=typeof e.bson.serialize||"function"!=typeof e.bson.deserialize))throw new Error("must pass in valid bson parser");this.logger=Logger("Pool",e),this.state=DISCONNECTED,this.availableConnections=[],this.inUseConnections=[],this.connectingConnections=[],this.executing=!1,this.queue=[],this.authProviders=e.authProviders||{mongocr:new MongoCR(e.bson),x509:new X509(e.bson),plain:new Plain(e.bson),gssapi:new GSSAPI(e.bson),sspi:new SSPI(e.bson),"scram-sha-1":new ScramSHA1(e.bson)},this.authenticating=!1,this.loggingout=!1,this.nonAuthenticatedConnections=[],this.authenticatingTimestamp=null,this.numberOfConsecutiveTimeouts=0};inherits(Pool,EventEmitter),Object.defineProperty(Pool.prototype,"size",{enumerable:!0,get:function(){return this.options.size}}),Object.defineProperty(Pool.prototype,"connectionTimeout",{enumerable:!0,get:function(){return this.options.connectionTimeout}}),Object.defineProperty(Pool.prototype,"socketTimeout",{enumerable:!0,get:function(){return this.options.socketTimeout}}),Pool.prototype.socketCount=function(){return this.availableConnections.length+this.inUseConnections.length+this.connectingConnections.length},Pool.prototype.allConnections=function(){return this.availableConnections.concat(this.inUseConnections).concat(this.connectingConnections)},Pool.prototype.get=function(){return this.allConnections()[0]},Pool.prototype.isConnected=function(){if(this.state==DESTROYED||this.state==DESTROYING)return!1;for(var e=this.availableConnections.concat(this.inUseConnections).concat(this.connectingConnections),n=0;n<e.length;n++)if(e[n].isConnected())return!0;return 0==e.length&&this.authenticating?!0:!1},Pool.prototype.isDestroyed=function(){return this.state==DESTROYED||this.state==DESTROYING},Pool.prototype.isDisconnected=function(){return this.state==DISCONNECTED},Pool.prototype.connect=function(e){if(this.state!=DISCONNECTED)throw new MongoError("connection in unlawful state "+this.state);var n=this;stateTransition(this,CONNECTING);var t=Array.prototype.slice.call(arguments,0),o=new Connection(messageHandler(n),this.options);this.connectingConnections.push(o),o.once("connect",function(e){return n.state==DESTROYED||n.state==DESTROYING?n.destroy():void reauthenticate(n,e,function(o){return n.state==DESTROYED||n.state==DESTROYING?n.destroy():o?(n.destroy(),n.emit("error",o)):void authenticate(n,t,e,function(t){return n.state==DESTROYED||n.state==DESTROYING?n.destroy():t?(n.destroy(),n.emit("error",t)):(stateTransition(n,CONNECTED),moveConnectionBetween(e,n.connectingConnections,n.availableConnections),void n.emit("connect",n))})})}),o.once("error",connectionFailureHandler(this,"error")),o.once("close",connectionFailureHandler(this,"close")),o.once("timeout",connectionFailureHandler(this,"timeout")),o.once("parseError",connectionFailureHandler(this,"parseError"));try{o.connect()}catch(i){n.emit("error",i)}},Pool.prototype.auth=function(e,n){function t(e,n,t){var o=e.availableConnections;e.availableConnections=[];var i=o.length,r=null;if(0==i)return s(null);for(var c=0;c<o.length;c++)authenticate(e,n,o[c],function(n){if(i-=1,n&&(r=n),0==i){if(e.authenticating=!1,e.availableConnections=e.availableConnections.concat(o),r)return e.logger.isError()&&e.logger.error(f("[%s] failed to authenticate against server %s:%s",e.id,e.options.host,e.options.port)),t(r);t(null)}})}function o(e,n){return e.loggingout?void setTimeout(function(){o(e,n)},1):n()}var i=this,r=Array.prototype.slice.call(arguments,0),s=r.pop();if(null==i.authProviders[e]&&"default"!=e)throw new MongoError(f("auth provider %s does not exist",e));this.authenticating=!0,this.authenticatingTimestamp=(new Date).getTime(),o(i,function(){t(i,r,function(e){i.authenticating=!1,s(e)})})},Pool.prototype.logout=function(e,n){var t=this;if("string"!=typeof e)throw new MongoError("logout method requires a db name as first argument");if("function"!=typeof n)throw new MongoError("logout method requires a callback");this.loggingout=!0;for(var o=t.availableConnections.concat(t.inUseConnections),i=o.length,r=null,s=0;s<o.length;s++){var c=new Query(this.options.bson,f("%s.$cmd",e),{logout:1},{numberToSkip:0,numberToReturn:1});write(t)(o[s],c.toBin(),function(e,o){i-=1,e&&(r=e),0==i&&(t.loggingout=!1,n(r))})}},Pool.prototype.unref=function(){var e=this.availableConnections.concat(this.inUseConnections).concat(this.connectingConnections);e.forEach(function(e){e.unref()})};var events=["error","close","timeout","parseError","connect"];Pool.prototype.destroy=function(e){function n(){if(0==t.queue.length){for(var e=t.availableConnections.concat(t.inUseConnections).concat(t.nonAuthenticatedConnections).concat(t.connectingConnections),o=0;o<e.length;o++)if(e[o].workItem)return setTimeout(n,1);destroy(t,e)}else setTimeout(n,1)}var t=this;if(this.state!=DESTROYED&&t.state!=DESTROYING){if(stateTransition(this,DESTROYING),e){var o=t.availableConnections.concat(t.inUseConnections).concat(t.nonAuthenticatedConnections).concat(t.connectingConnections);return destroy(t,o)}n()}},Pool.prototype.write=function(e,n,t){if("function"==typeof n&&(t=n),n=n||{},this.state==DESTROYED||this.state==DESTROYING)return void(t&&t(new MongoError("pool destroyed")));if(this.options.domainsEnabled&&process.domain&&"function"==typeof t){var o=t;t=process.domain.bind(function(){for(var e=new Array(arguments.length),n=0;n<arguments.length;n++)e[n]=arguments[n];process.nextTick(function(){o.apply(null,e)})})}var i={buffer:e,cb:t,raw:!1,promoteLongs:!0};if(i.promoteLongs="boolean"==typeof n.promoteLongs?n.promoteLongs:!0,i.raw="boolean"==typeof n.raw?n.raw:!1,i.immediateRelease="boolean"==typeof n.immediateRelease?n.immediateRelease:!1,i.documentsReturnedIn=n.documentsReturnedIn,i.command="boolean"==typeof n.command?n.command:!1,i.socketTimeout=n.socketTimeout,i.monitoring=n.monitoring,"function"!=typeof t&&!n.noResponse)throw new MongoError("write method must provide a callback");n.monitoring?this.queue.unshift(i):this.queue.push(i),_execute(this)()};var handlers=["close","message","error","timeout","parseError","connect"];module.exports=Pool;