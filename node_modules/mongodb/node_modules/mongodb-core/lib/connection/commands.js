"use strict";var f=require("util").format,Long=require("bson").Long,setProperty=require("./utils").setProperty,getProperty=require("./utils").getProperty,getSingleProperty=require("./utils").getSingleProperty,_requestId=0,OP_QUERY=2004,OP_GETMORE=2005,OP_KILL_CURSORS=2007,OPTS_NONE=0,OPTS_TAILABLE_CURSOR=2,OPTS_SLAVE=4,OPTS_OPLOG_REPLAY=8,OPTS_NO_CURSOR_TIMEOUT=16,OPTS_AWAIT_DATA=32,OPTS_EXHAUST=64,OPTS_PARTIAL=128,CURSOR_NOT_FOUND=0,QUERY_FAILURE=2,SHARD_CONFIG_STALE=4,AWAIT_CAPABLE=8,Query=function(t,e,s,i){var r=this;if(null==e)throw new Error("ns must be specified for query");if(null==s)throw new Error("query must be specified for query");if(~e.indexOf("\x00"))throw new Error("namespace cannot contain a null character");this.bson=t,this.ns=e,this.query=s,this.options=i||{},this.numberToSkip=i.numberToSkip||0,this.numberToReturn=i.numberToReturn||0,this.returnFieldSelector=i.returnFieldSelector||null,this.requestId=_requestId++,this.serializeFunctions="boolean"==typeof i.serializeFunctions?i.serializeFunctions:!1,this.ignoreUndefined="boolean"==typeof i.ignoreUndefined?i.ignoreUndefined:!1,this.maxBsonSize=i.maxBsonSize||16777216,this.checkKeys="boolean"==typeof i.checkKeys?i.checkKeys:!0,this.batchSize=r.numberToReturn,this.tailable=!1,this.slaveOk="boolean"==typeof i.slaveOk?i.slaveOk:!1,this.oplogReplay=!1,this.noCursorTimeout=!1,this.awaitData=!1,this.exhaust=!1,this.partial=!1};Query.prototype.incRequestId=function(){this.requestId=_requestId++},Query.nextRequestId=function(){return _requestId+1},Query.prototype.toBin=function(){var t=this,e=[],s=null,i=0;this.tailable&&(i|=OPTS_TAILABLE_CURSOR),this.slaveOk&&(i|=OPTS_SLAVE),this.oplogReplay&&(i|=OPTS_OPLOG_REPLAY),this.noCursorTimeout&&(i|=OPTS_NO_CURSOR_TIMEOUT),this.awaitData&&(i|=OPTS_AWAIT_DATA),this.exhaust&&(i|=OPTS_EXHAUST),this.partial&&(i|=OPTS_PARTIAL),t.batchSize!=t.numberToReturn&&(t.numberToReturn=t.batchSize);var r=new Buffer(20+Buffer.byteLength(t.ns)+1+4+4);e.push(r);var n=t.bson.serialize(this.query,this.checkKeys,!0,this.serializeFunctions,0,this.ignoreUndefined);e.push(n),t.returnFieldSelector&&Object.keys(t.returnFieldSelector).length>0&&(s=t.bson.serialize(this.returnFieldSelector,this.checkKeys,!0,this.serializeFunctions,this.ignoreUndefined),e.push(s));var h=r.length+n.length+(s?s.length:0),o=4;return r[3]=h>>24&255,r[2]=h>>16&255,r[1]=h>>8&255,r[0]=255&h,r[o+3]=this.requestId>>24&255,r[o+2]=this.requestId>>16&255,r[o+1]=this.requestId>>8&255,r[o]=255&this.requestId,o+=4,r[o+3]=0,r[o+2]=0,r[o+1]=0,r[o]=0,o+=4,r[o+3]=OP_QUERY>>24&255,r[o+2]=OP_QUERY>>16&255,r[o+1]=OP_QUERY>>8&255,r[o]=255&OP_QUERY,o+=4,r[o+3]=i>>24&255,r[o+2]=i>>16&255,r[o+1]=i>>8&255,r[o]=255&i,o+=4,o=o+r.write(this.ns,o,"utf8")+1,r[o-1]=0,r[o+3]=this.numberToSkip>>24&255,r[o+2]=this.numberToSkip>>16&255,r[o+1]=this.numberToSkip>>8&255,r[o]=255&this.numberToSkip,o+=4,r[o+3]=this.numberToReturn>>24&255,r[o+2]=this.numberToReturn>>16&255,r[o+1]=this.numberToReturn>>8&255,r[o]=255&this.numberToReturn,o+=4,e},Query.getRequestId=function(){return++_requestId};var GetMore=function(t,e,s,i){i=i||{},this.numberToReturn=i.numberToReturn||0,this.requestId=_requestId++,this.bson=t,this.ns=e,this.cursorId=s};GetMore.prototype.toBin=function(){var t=4+Buffer.byteLength(this.ns)+1+4+8+16,e=0,s=new Buffer(t);return s[e+3]=t>>24&255,s[e+2]=t>>16&255,s[e+1]=t>>8&255,s[e]=255&t,e+=4,s[e+3]=this.requestId>>24&255,s[e+2]=this.requestId>>16&255,s[e+1]=this.requestId>>8&255,s[e]=255&this.requestId,e+=4,s[e+3]=0,s[e+2]=0,s[e+1]=0,s[e]=0,e+=4,s[e+3]=OP_GETMORE>>24&255,s[e+2]=OP_GETMORE>>16&255,s[e+1]=OP_GETMORE>>8&255,s[e]=255&OP_GETMORE,e+=4,s[e+3]=0,s[e+2]=0,s[e+1]=0,s[e]=0,e+=4,e=e+s.write(this.ns,e,"utf8")+1,s[e-1]=0,s[e+3]=this.numberToReturn>>24&255,s[e+2]=this.numberToReturn>>16&255,s[e+1]=this.numberToReturn>>8&255,s[e]=255&this.numberToReturn,e+=4,s[e+3]=this.cursorId.getLowBits()>>24&255,s[e+2]=this.cursorId.getLowBits()>>16&255,s[e+1]=this.cursorId.getLowBits()>>8&255,s[e]=255&this.cursorId.getLowBits(),e+=4,s[e+3]=this.cursorId.getHighBits()>>24&255,s[e+2]=this.cursorId.getHighBits()>>16&255,s[e+1]=this.cursorId.getHighBits()>>8&255,s[e]=255&this.cursorId.getHighBits(),e+=4,s};var KillCursor=function(t,e){this.requestId=_requestId++,this.cursorIds=e};KillCursor.prototype.toBin=function(){var t=24+8*this.cursorIds.length,e=0,s=new Buffer(t);s[e+3]=t>>24&255,s[e+2]=t>>16&255,s[e+1]=t>>8&255,s[e]=255&t,e+=4,s[e+3]=this.requestId>>24&255,s[e+2]=this.requestId>>16&255,s[e+1]=this.requestId>>8&255,s[e]=255&this.requestId,e+=4,s[e+3]=0,s[e+2]=0,s[e+1]=0,s[e]=0,e+=4,s[e+3]=OP_KILL_CURSORS>>24&255,s[e+2]=OP_KILL_CURSORS>>16&255,s[e+1]=OP_KILL_CURSORS>>8&255,s[e]=255&OP_KILL_CURSORS,e+=4,s[e+3]=0,s[e+2]=0,s[e+1]=0,s[e]=0,e+=4,s[e+3]=this.cursorIds.length>>24&255,s[e+2]=this.cursorIds.length>>16&255,s[e+1]=this.cursorIds.length>>8&255,s[e]=255&this.cursorIds.length,e+=4;for(var i=0;i<this.cursorIds.length;i++)s[e+3]=this.cursorIds[i].getLowBits()>>24&255,s[e+2]=this.cursorIds[i].getLowBits()>>16&255,s[e+1]=this.cursorIds[i].getLowBits()>>8&255,s[e]=255&this.cursorIds[i].getLowBits(),e+=4,s[e+3]=this.cursorIds[i].getHighBits()>>24&255,s[e+2]=this.cursorIds[i].getHighBits()>>16&255,s[e+1]=this.cursorIds[i].getHighBits()>>8&255,s[e]=255&this.cursorIds[i].getHighBits(),e+=4;return s};var Response=function(t,e,s){s=s||{promoteLongs:!0},this.parsed=!1,this.index=0,this.raw=e,this.data=e,this.bson=t,this.opts=s,this.length=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24,this.index=this.index+4,this.requestId=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24,this.index=this.index+4,this.responseTo=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24,this.index=this.index+4,this.index=this.index+4,this.responseFlags=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24,this.index=this.index+4;var i=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24;this.index=this.index+4;var r=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24;this.index=this.index+4,this.cursorId=new Long(i,r),this.startingFrom=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24,this.index=this.index+4,this.numberReturned=e[this.index]|e[this.index+1]<<8|e[this.index+2]<<16|e[this.index+3]<<24,this.index=this.index+4,this.documents=new Array(this.numberReturned),this.cursorNotFound=0!=(this.responseFlags&CURSOR_NOT_FOUND),this.queryFailure=0!=(this.responseFlags&QUERY_FAILURE),this.shardConfigStale=0!=(this.responseFlags&SHARD_CONFIG_STALE),this.awaitCapable=0!=(this.responseFlags&AWAIT_CAPABLE),this.promoteLongs="boolean"==typeof s.promoteLongs?s.promoteLongs:!0};Response.prototype.isParsed=function(){return this.parsed};var firstBatch=new Buffer("firstBatch","utf8"),nextBatch=new Buffer("nextBatch","utf8"),cursorId=new Buffer("id","utf8").toString("hex"),documentBuffers={firstBatch:firstBatch.toString("hex"),nextBatch:nextBatch.toString("hex")};Response.prototype.parse=function(t){if(!this.parsed){t=t||{};var e=t.raw||!1,s=t.documentsReturnedIn||null;if(1==this.numberReturned&&null!=s&&e){var i=this.data[this.index]|this.data[this.index+1]<<8|this.data[this.index+2]<<16|this.data[this.index+3]<<24,r=this.data.slice(this.index,this.index+i),n={};n[s]=!0;var h={promoteLongs:this.opts.promoteLongs,fieldsAsRaw:n},o=this.bson.deserialize(r,h);return this.documents=o.cursor[s],this.numberReturned=this.documents.length,this.cursorId="number"==typeof o.cursor.id?Long.fromNumber(o.cursor.id):o.cursor.id,this.index=this.index+i,void(this.parsed=!0)}for(var u=0;u<this.numberReturned;u++){var i=this.data[this.index]|this.data[this.index+1]<<8|this.data[this.index+2]<<16|this.data[this.index+3]<<24,h={promoteLongs:this.opts.promoteLongs};e?this.documents[u]=this.data.slice(this.index,this.index+i):this.documents[u]=this.bson.deserialize(this.data.slice(this.index,this.index+i),h),this.index=this.index+i}this.parsed=!0}},module.exports={Query:Query,GetMore:GetMore,Response:Response,KillCursor:KillCursor};