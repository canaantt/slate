"use strict";var inherits=require("util").inherits,EventEmitter=require("events").EventEmitter,net=require("net"),tls=require("tls"),f=require("util").format,debugOptions=require("./utils").debugOptions,Response=require("./commands").Response,MongoError=require("../error"),Logger=require("./logger"),_id=0,debugFields=["host","port","size","keepAlive","keepAliveInitialDelay","noDelay","connectionTimeout","socketTimeout","singleBufferSerializtion","ssl","ca","cert","rejectUnauthorized","promoteLongs","checkServerIdentity"],connectionAccounting=!1,connections={},Connection=function(e,t){if(EventEmitter.call(this),this.options=t||{},this.id=_id++,this.logger=Logger("Connection",t),!t.bson)throw new Error("must pass in valid bson parser");this.bson=t.bson,this.tag=t.tag,this.messageHandler=e,this.maxBsonMessageSize=t.maxBsonMessageSize||67108864,this.logger.isDebug()&&this.logger.debug(f("creating connection %s with options [%s]",this.id,JSON.stringify(debugOptions(debugFields,t)))),this.port=t.port||27017,this.host=t.host||"localhost",this.keepAlive="boolean"==typeof t.keepAlive?t.keepAlive:!0,this.keepAliveInitialDelay=t.keepAliveInitialDelay||0,this.noDelay="boolean"==typeof t.noDelay?t.noDelay:!0,this.connectionTimeout=t.connectionTimeout||0,this.socketTimeout=t.socketTimeout||0,this.destroyed=!1,this.domainSocket=-1!=this.host.indexOf("/"),this.singleBufferSerializtion="boolean"==typeof t.singleBufferSerializtion?t.singleBufferSerializtion:!0,this.serializationFunction=this.singleBufferSerializtion?"toBinUnified":"toBin",this.ca=t.ca||null,this.cert=t.cert||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.ssl="boolean"==typeof t.ssl?t.ssl:!1,this.rejectUnauthorized="boolean"==typeof t.rejectUnauthorized?t.rejectUnauthorized:!0,this.checkServerIdentity="boolean"==typeof t.checkServerIdentity||"function"==typeof t.checkServerIdentity?t.checkServerIdentity:!0,this.ssl||(this.rejectUnauthorized=!1),this.responseOptions={promoteLongs:"boolean"==typeof t.promoteLongs?t.promoteLongs:!0},this.flushing=!1,this.queue=[],this.connection=null,this.writeStream=null};inherits(Connection,EventEmitter),Connection.prototype.setSocketTimeout=function(e){this.connection&&this.connection.setTimeout(e)},Connection.prototype.resetSocketTimeout=function(e){this.connection&&this.connection.setTimeout(this.socketTimeout)},Connection.enableConnectionAccounting=function(){connectionAccounting=!0,connections={}},Connection.disableConnectionAccounting=function(){connectionAccounting=!1},Connection.connections=function(){return connections};var errorHandler=function(e){return function(t){connectionAccounting&&delete connections[e.id],e.logger.isDebug()&&e.logger.debug(f("connection %s for [%s:%s] errored out with [%s]",e.id,e.host,e.port,JSON.stringify(t))),e.listeners("error").length>0&&e.emit("error",MongoError.create(t),e)}},timeoutHandler=function(e){return function(t){connectionAccounting&&delete connections[e.id],e.logger.isDebug()&&e.logger.debug(f("connection %s for [%s:%s] timed out",e.id,e.host,e.port)),e.emit("timeout",MongoError.create(f("connection %s to %s:%s timed out",e.id,e.host,e.port)),e)}},closeHandler=function(e){return function(t){connectionAccounting&&delete connections[e.id],e.logger.isDebug()&&e.logger.debug(f("connection %s with for [%s:%s] closed",e.id,e.host,e.port)),t||e.emit("close",MongoError.create(f("connection %s to %s:%s closed",e.id,e.host,e.port)),e)}},dataHandler=function(e){return function(t){for(;t.length>0;)if(e.bytesRead>0&&e.sizeOfMessage>0){var n=e.sizeOfMessage-e.bytesRead;if(n>t.length)t.copy(e.buffer,e.bytesRead),e.bytesRead=e.bytesRead+t.length,t=new Buffer(0);else{t.copy(e.buffer,e.bytesRead,0,n),t=t.slice(n);try{var o=e.buffer;e.buffer=null,e.sizeOfMessage=0,e.bytesRead=0,e.stubBuffer=null,e.messageHandler(new Response(e.bson,o,e.responseOptions),e)}catch(i){var s={err:"socketHandler",trace:i,bin:e.buffer,parseState:{sizeOfMessage:e.sizeOfMessage,bytesRead:e.bytesRead,stubBuffer:e.stubBuffer}};e.emit("parseError",s,e)}}}else if(null!=e.stubBuffer&&e.stubBuffer.length>0)if(e.stubBuffer.length+t.length>4){var r=new Buffer(e.stubBuffer.length+t.length);e.stubBuffer.copy(r,0),t.copy(r,e.stubBuffer.length),t=r,e.buffer=null,e.sizeOfMessage=0,e.bytesRead=0,e.stubBuffer=null}else{var c=new Buffer(e.stubBuffer.length+t.length);e.stubBuffer.copy(c,0),t.copy(c,e.stubBuffer.length),t=new Buffer(0)}else if(t.length>4){var u=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;if(0>u||u>e.maxBsonMessageSize){var s={err:"socketHandler",trace:"",bin:e.buffer,parseState:{sizeOfMessage:u,bytesRead:e.bytesRead,stubBuffer:e.stubBuffer}};return void e.emit("parseError",s,e)}if(u>4&&u<e.maxBsonMessageSize&&u>t.length)e.buffer=new Buffer(u),t.copy(e.buffer,0),e.bytesRead=t.length,e.sizeOfMessage=u,e.stubBuffer=null,t=new Buffer(0);else if(u>4&&u<e.maxBsonMessageSize&&u==t.length)try{var o=t;e.buffer=null,e.sizeOfMessage=0,e.bytesRead=0,e.stubBuffer=null,t=new Buffer(0),e.messageHandler(new Response(e.bson,o,e.responseOptions),e)}catch(i){e.emit("parseError",i,e)}else if(4>=u||u>e.maxBsonMessageSize){var s={err:"socketHandler",trace:null,bin:t,parseState:{sizeOfMessage:u,bytesRead:0,buffer:null,stubBuffer:null}};e.emit("parseError",s,e),e.buffer=null,e.sizeOfMessage=0,e.bytesRead=0,e.stubBuffer=null,t=new Buffer(0)}else{var o=t.slice(0,u);e.buffer=null,e.sizeOfMessage=0,e.bytesRead=0,e.stubBuffer=null,t=t.slice(u),e.messageHandler(new Response(e.bson,o,e.responseOptions),e)}}else e.stubBuffer=new Buffer(t.length),t.copy(e.stubBuffer,0),t=new Buffer(0)}};Connection.prototype.connect=function(e){var t=this;if(e=e||{},connectionAccounting&&(connections[this.id]=this),"boolean"==typeof e.promoteLongs&&(t.responseOptions.promoteLongs=e.promoteLongs),t.connection=t.domainSocket?net.createConnection(t.host):net.createConnection(t.port,t.host),t.connection.setKeepAlive(t.keepAlive,t.keepAliveInitialDelay),t.connection.setTimeout(t.connectionTimeout),t.connection.setNoDelay(t.noDelay),t.ssl){var n={socket:t.connection,rejectUnauthorized:t.rejectUnauthorized};t.ca&&(n.ca=t.ca),t.cert&&(n.cert=t.cert),t.key&&(n.key=t.key),t.passphrase&&(n.passphrase=t.passphrase),0==t.checkServerIdentity?n.checkServerIdentity=function(e,t){return void 0}:"function"==typeof t.checkServerIdentity&&(n.checkServerIdentity=t.checkServerIdentity),t.connection=tls.connect(t.port,t.host,n,function(){return t.connection.authorizationError&&t.rejectUnauthorized?t.emit("error",t.connection.authorizationError,t,{ssl:!0}):(t.connection.setTimeout(t.socketTimeout),void t.emit("connect",t))}),t.connection.setTimeout(t.connectionTimeout)}else t.connection.on("connect",function(){t.connection.setTimeout(t.socketTimeout),t.emit("connect",t)});t.connection.once("error",errorHandler(t)),t.connection.once("timeout",timeoutHandler(t)),t.connection.once("close",closeHandler(t)),t.connection.on("data",dataHandler(t))},Connection.prototype.unref=function(){if(this.connection)this.connection.unref();else{var e=this;this.once("connect",function(){e.connection.unref()})}},Connection.prototype.destroy=function(){connectionAccounting&&delete connections[this.id],this.connection&&(this.connection.end(),this.connection.destroy()),this.destroyed=!0},Connection.prototype.write=function(e){if(this.logger.isDebug())if(Array.isArray(e))for(var t=0;t<e.length;t++)this.logger.debug(f("writing buffer [%s] to %s:%s",e[t].toString("hex"),this.host,this.port));else this.logger.debug(f("writing buffer [%s] to %s:%s",e.toString("hex"),this.host,this.port));if(!Array.isArray(e))return this.connection.write(e,"binary");for(var t=0;t<e.length;t++)this.connection.write(e[t],"binary")},Connection.prototype.toString=function(){return""+this.id},Connection.prototype.toJSON=function(){return{id:this.id,host:this.host,port:this.port}},Connection.prototype.isConnected=function(){return this.destroyed?!1:!this.connection.destroyed&&this.connection.writable},module.exports=Connection;