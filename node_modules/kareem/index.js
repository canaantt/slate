"use strict";function Kareem(){this._pres={},this._posts={}}function _handleWrapError(n,t,e,r,o,u,s){if(u.useErrorHandlers){for(var i={error:t},l=[],a=o.length;a>=0;--a)(l.length>0||void 0!==o[a])&&l.unshift(o[a]);return n.execPost(e,r,l,i,function(n){return"function"==typeof s&&s(n)})}return"function"==typeof s?s(t):void 0}Kareem.prototype.execPre=function(n,t,e){var r=this._pres[n]||[],o=r.length,u=r.numAsync||0,s=0,i=u,l=!1;if(!o)return process.nextTick(function(){e(null)});var a=function(){if(!(s>=o)){var n=r[s];if(n.isAsync)n.fn.call(t,function(n){if(n){if(l)return;return l=!0,e(n)}++s,a.apply(t,arguments)},function(n){if(n){if(l)return;return l=!0,e(n)}return 0===--u?e(null):void 0});else if(n.fn.length>0){var p=[function(n){if(n){if(l)return;return l=!0,e(n)}return++s>=o?i>0?void 0:e(null):void a.apply(t,arguments)}];if(arguments.length>=2)for(var c=1;c<arguments.length;++c)p.push(arguments[c]);n.fn.apply(t,p)}else{if(n.fn.call(t),++s>=o)return i>0?void 0:process.nextTick(function(){e(null)});a()}}};a()},Kareem.prototype.execPreSync=function(n,t){for(var e=this._pres[n]||[],r=e.length,o=0;r>o;++o)e[o].fn.call(t)},Kareem.prototype.execPost=function(n,t,e,r,o){arguments.length<5&&(o=r,r=null);var u=this._posts[n]||[],s=u.length,i=0,l=null;if(r&&r.error&&(l=r.error),!s)return process.nextTick(function(){o.apply(null,[l].concat(e))});var a=function(){var n=u[i];if(l)if(n.length===e.length+2)n.apply(t,[l].concat(e).concat(function(n){return n&&(l=n),++i>=s?o.call(null,l):void a()}));else{if(++i>=s)return o.call(null,l);a()}else{if(n.length===e.length+2)return++i>=s?o.apply(null,[null].concat(e)):a();if(n.length===e.length+1)n.apply(t,e.concat(function(n){return n?(l=n,a()):++i>=s?o.apply(null,[null].concat(e)):void a()}));else{if(n.apply(t,e),++i>=s)return o.apply(null,[null].concat(e));a()}}};a()},Kareem.prototype.execPostSync=function(n,t){for(var e=this._posts[n]||[],r=e.length,o=0;r>o;++o)e[o].call(t)},Kareem.prototype.wrap=function(n,t,e,r,o){var u,s=r.length>0?r[r.length-1]:null,i="function"==typeof s?r.slice(0,r.length-1):r,l=this;u="object"==typeof o?o&&o.useLegacyPost:o,o=o||{},this.execPre(n,e,function(a){if(a)return _handleWrapError(l,a,n,e,i,o,s);var p="function"==typeof s?r.length-1:r.length;t.apply(e,r.slice(0,p).concat(function(){var t=arguments,r=Array.prototype.slice.call(arguments,1);return arguments[0]?_handleWrapError(l,arguments[0],n,e,t,o,s):(u&&"function"==typeof s&&s.apply(e,arguments),void l.execPost(n,e,r,function(){return arguments[0]?"function"==typeof s?s(arguments[0]):void 0:"function"!=typeof s||u?void 0:s.apply(e,arguments)}))}))})},Kareem.prototype.createWrapper=function(n,t,e,r){var o=this;return function(){var u=Array.prototype.slice.call(arguments);o.wrap(n,t,e,u,r)}},Kareem.prototype.pre=function(n,t,e,r){"boolean"!=typeof arguments[1]&&(r=e,e=t,t=!1),this._pres[n]=this._pres[n]||[];var o=this._pres[n];return t&&(o.numAsync=o.numAsync||0,++o.numAsync),o.push({fn:e,isAsync:t}),this},Kareem.prototype.post=function(n,t){return(this._posts[n]=this._posts[n]||[]).push(t),this},Kareem.prototype.clone=function(){var n=new Kareem;for(var t in this._pres)n._pres[t]=this._pres[t].slice();for(var t in this._posts)n._posts[t]=this._posts[t].slice();return n},module.exports=Kareem;