function calculateObjectSize(e){var t=5;for(var r in e)t+=calculateElement(r,e[r]);return t}function calculateElement(e,t){var r=1;if(e&&(r+=Buffer.byteLength(e,"utf8")+1),void 0===t||null===t)return r;switch(t.constructor){case ObjectID:return r+12;case String:return r+4+Buffer.byteLength(t,"utf8")+1;case Number:return Math.floor(t)===t&&2147483647>=t&&t>=-2147483647?r+4:r+8;case Boolean:return r+1;case Array:case Object:return r+calculateObjectSize(t);case Buffer:return r+4+t.length+1;case Regex:return r+Buffer.byteLength(t.source,"utf8")+1+(t.global?1:0)+(t.ignoreCase?1:0)+(t.multiline?1:0)+1;case Date:case Long:case Timestamp:case Double:return r+8;case MinKey:case MaxKey:return r}return 0}function serializeFast(e,t,r,n){var o=r.length;if(r[n++]=255&o,r[n++]=o>>8&255,r[n++]=o>>16&255,r[n++]=o>>24&255,e.constructor===Array)for(var i=0;i<e.length;i++)n=packElement(i.toString(),e[i],t,r,n);else for(var a in e){if(t&&(a.indexOf("\x00")>=0||"$where"===a))return console.log("checkKeys error: "),new Error("Illegal object key!");n=packElement(a,e[a],t,r,n)}return r[n++]=0,n}function packElement(e,t,r,n,o){if(void 0===t||null===t)return n[o++]=10,o+=n.write(e,o,"utf8"),n[o++]=0,o;switch(t.constructor){case ObjectID:return n[o++]=7,o+=n.write(e,o,"utf8"),n[o++]=0,t.id.copy(n,o),o+=12;case String:n[o++]=2,o+=n.write(e,o,"utf8"),n[o++]=0;var i=Buffer.byteLength(t)+1;return n[o++]=255&i,n[o++]=i>>8&255,n[o++]=i>>16&255,n[o++]=i>>24&255,o+=n.write(t,o,"utf8"),n[o++]=0,o;case Number:if(~~t===t)if(2147483647>=t&&t>=-2147483647)n[o++]=16,o+=n.write(e,o,"utf8"),n[o++]=0,n[o++]=255&t,n[o++]=t>>8&255,n[o++]=t>>16&255,n[o++]=t>>24&255;else{n[o++]=18,o+=n.write(e,o,"utf8"),n[o++]=0;var a=t%4294967296|0,u=t/4294967296|0;n[o++]=255&a,n[o++]=a>>8&255,n[o++]=a>>16&255,n[o++]=a>>24&255,n[o++]=255&u,n[o++]=u>>8&255,n[o++]=u>>16&255,n[o++]=u>>24&255}else n[o++]=1,o+=n.write(e,o,"utf8"),n[o++]=0,n.writeDoubleLE(t,o),o+=8;return o;case Boolean:return n[o++]=8,o+=n.write(e,o,"utf8"),n[o++]=0,n[o++]=t?1:0,o;case Array:case Object:n[o++]=t.constructor===Array?4:3,o+=n.write(e,o,"utf8"),n[o++]=0;var c=serializeFast(t,r,n,o),i=c-o;return n[o++]=255&i,n[o++]=i>>8&255,n[o++]=i>>16&255,n[o++]=i>>24&255,c;case Buffer:n[o++]=5,o+=n.write(e,o,"utf8"),n[o++]=0;var i=t.length;return n[o++]=255&i,n[o++]=i>>8&255,n[o++]=i>>16&255,n[o++]=i>>24&255,n[o++]=0,t.copy(n,o),o+=i;case RegExp:return n[o++]=11,o+=n.write(e,o,"utf8"),n[o++]=0,o+=n.write(t.source,o,"utf8"),n[o++]=0,t.global&&(n[o++]=115),t.ignoreCase&&(n[o++]=105),t.multiline&&(n[o++]=109),n[o++]=0,o;case Date:n[o++]=9,o+=n.write(e,o,"utf8"),n[o++]=0;var s=t.getTime(),a=s%4294967296|0,u=s/4294967296|0;return n[o++]=255&a,n[o++]=a>>8&255,n[o++]=a>>16&255,n[o++]=a>>24&255,n[o++]=255&u,n[o++]=u>>8&255,n[o++]=u>>16&255,n[o++]=u>>24&255,o;case Long:case Timestamp:n[o++]=t.constructor===Long?18:17,o+=n.write(e,o,"utf8"),n[o++]=0;var a=t.getLowBits(),u=t.getHighBits();return n[o++]=255&a,n[o++]=a>>8&255,n[o++]=a>>16&255,n[o++]=a>>24&255,n[o++]=255&u,n[o++]=u>>8&255,n[o++]=u>>16&255,n[o++]=u>>24&255,o;case Double:return n[o++]=1,o+=n.write(e,o,"utf8"),n[o++]=0,n.writeDoubleLE(t,o),o+=8;case MinKey:return n[o++]=127,o+=n.write(e,o,"utf8"),n[o++]=0,o;case MaxKey:return n[o++]=255,o+=n.write(e,o,"utf8"),n[o++]=0,o}return o}function deserializeFast(e,t,r){if(e.length<5)return new Error("Corrupt bson message < 5 bytes long");var n,o,i,a,u=0;t||(t=0);var c=r?[]:{},s=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24;if(5>s||s>e.length)return new Error("Corrupt BSON message");for(;;){if(n=e[t++],0===n)break;for(u=t;0!==e[u];)u++;if(u>=e.length)return new Error("Corrupt BSON document: illegal CString");switch(o=e.toString("utf8",t,u),t=u+1,n){case 7:var f=new Buffer(12);e.copy(f,0,t,t+=12),c[o]=new ObjectID(f);break;case 2:s=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,c[o]=e.toString("utf8",t,t+=s-1),t++;break;case 16:c[o]=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24;break;case 1:c[o]=e.readDoubleLE(t),t+=8;break;case 8:c[o]=1==e[t++];break;case 6:case 10:c[o]=null;break;case 4:s=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,c[o]=deserializeFast(e,t,!0),t+=s;break;case 3:s=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,c[o]=deserializeFast(e,t,!1),t+=s;break;case 5:s=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,e[t++],c[o]=e.slice(t,t+=s);break;case 9:i=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,a=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,c[o]=new Date(4294967296*a+(0>i?i+4294967296:i));break;case 18:i=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,a=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,s=4294967296*a+(0>i?i+4294967296:i),s<JS_INT_MAX&&s>JS_INT_MIN?c[o]=s:c[o]=new Long(i,a);break;case 127:c[o]=new MinKey;break;case 255:c[o]=new MaxKey;break;case 17:i=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,a=e[t++]|e[t++]<<8|e[t++]<<16|e[t++]<<24,c[o]=new Timestamp(i,a)}}return c}function MinKey(){this._bsontype="MinKey"}function MaxKey(){this._bsontype="MaxKey"}function Long(e,t){this._bsontype="Long",this.low_=0|e,this.high_=0|t}function Double(e){this._bsontype="Double",this.value=e}function Timestamp(e,t){this._bsontype="Timestamp",this.low_=0|e,this.high_=0|t}function encodeIntBE(e,t){var r="";return t>=4&&(r+=String.fromCharCode(Math.floor(e/16777216)),e%=16777216),t>=3&&(r+=String.fromCharCode(Math.floor(e/65536)),e%=65536),t>=2&&(r+=String.fromCharCode(Math.floor(e/256)),e%=256),r+=String.fromCharCode(Math.floor(e))}function ObjectID(e){this._bsontype="ObjectID",e?e.constructor===Buffer?this.id=e:e.constructor===String?24===e.length&&checkForHex.test(e)?this.id=new Buffer(e,"hex"):this.id=new Error("Illegal/faulty Hexadecimal string supplied!"):e.constructor===Number&&(this.id=createFromTime(e)):this.id=createFromScratch()}function createFromScratch(){var e=new Buffer(12),t=0,r=~~(Date.now()/1e3);return e[t++]=r>>24&255,e[t++]=r>>16&255,e[t++]=r>>8&255,e[t++]=255&r,e.write(MACHINE_AND_PROC,t,5,"utf8"),t+=5,_counter=++_counter%16777215,e[t++]=_counter>>16&255,e[t++]=_counter>>8&255,e[t++]=255&_counter,e}function createFromTime(e){e||(e=~~(Date.now()/1e3));var t=new Buffer(12),r=0;for(t[r++]=e>>24&255,t[r++]=e>>16&255,t[r++]=e>>8&255,t[r++]=255&e;12>r;++r)t[r]=0;return t}module.exports.calculateObjectSize=calculateObjectSize,module.exports.serializeFast=serializeFast,module.exports.serialize=function(e,t,r,n,o){var i=new Buffer(calculateObjectSize(e));return serializeFast(e,t,i,0)},module.exports.deserializeFast=deserializeFast,Long.prototype.getLowBits=function(){return this.low_},Long.prototype.getHighBits=function(){return this.high_},Long.prototype.toNumber=function(){return 4294967296*this.high_+(this.low_<0?this.low_+4294967296:this.low_)},Long.fromNumber=function(e){return new Long(e%4294967296,e/4294967296)},Timestamp.prototype.getLowBits=function(){return this.low_},Timestamp.prototype.getHighBits=function(){return this.high_};var MACHINE=parseInt(16777215*Math.random(),10),PROCESS=process.pid%65535,MACHINE_AND_PROC=encodeIntBE(MACHINE,3)+encodeIntBE(PROCESS,2),_counter=~~(16777215*Math.random()),checkForHex=new RegExp("^[0-9a-fA-F]{24}$");ObjectID.prototype.toHexString=function(){return this.id.toString("hex")},ObjectID.prototype.getTimestamp=function(){return this.id.readUIntBE(0,4)},ObjectID.prototype.getTimestampDate=function(){var e=new Date;return e.setTime(1e3*this.id.readUIntBE(0,4)),e},ObjectID.createPk=function(){return new ObjectID},ObjectID.prototype.toJSON=function(){return"ObjectID('"+this.id.toString("hex")+"')"},module.exports.ObjectID=ObjectID,module.exports.MinKey=MinKey,module.exports.MaxKey=MaxKey,module.exports.Long=Long;