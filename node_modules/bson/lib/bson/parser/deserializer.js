"use strict";var readIEEE754=require("../float_parser").readIEEE754,f=require("util").format,Long=require("../long").Long,Double=require("../double").Double,Timestamp=require("../timestamp").Timestamp,ObjectID=require("../objectid").ObjectID,Symbol=require("../symbol").Symbol,Code=require("../code").Code,MinKey=require("../min_key").MinKey,MaxKey=require("../max_key").MaxKey,DBRef=require("../db_ref").DBRef,BSONRegExp=require("../regexp").BSONRegExp,Binary=require("../binary").Binary,deserialize=function(e,r,n){r=null==r?{}:r;var i=r&&r.index?r.index:0,t=e[i]|e[i+1]<<8|e[i+2]<<16|e[i+3]<<24;if(5>t||e.length<t)throw new Error("corrupt bson message");if(0!=e[i+t-1])throw new Error("One object, sized correctly, with a spot for an EOO, but the EOO isn't 0x00");return deserializeObject(e,i,r,n)},deserializeObject=function(e,r,n,i){var t=null==n.evalFunctions?!1:n.evalFunctions,N=null==n.cacheFunctions?!1:n.cacheFunctions,S=null==n.cacheFunctionsCrc32?!1:n.cacheFunctionsCrc32,a=null==n.promoteLongs?!0:n.promoteLongs,B=null==n.fieldsAsRaw?null:n.fieldsAsRaw,o=null==n.raw?!1:n.raw,O="boolean"==typeof n.bsonRegExp?n.bsonRegExp:!1,l=null==n.promoteBuffers?!1:n.promoteBuffers;if(e.length<5)throw new Error("corrupt bson message < 5 bytes long");var _=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(5>_||_>e.length)throw new Error("corrupt bson message");for(var A=i?[]:{};;){var s=e[r++];if(0==s)break;for(var f=r;0!==e[f]&&f<e.length;)f++;if(f>=e.length)throw new Error("Bad BSON Document: illegal CString");var u=e.toString("utf8",r,f);if(r=f+1,s==BSON.BSON_DATA_STRING){var E=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(0>=E||E>e.length-r||0!=e[r+E-1])throw new Error("bad string length in bson");A[u]=e.toString("utf8",r,r+E-1),r+=E}else if(s==BSON.BSON_DATA_OID){var T=e.toString("binary",r,r+12);A[u]=new ObjectID(T),r+=12}else if(s==BSON.BSON_DATA_INT)A[u]=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;else if(s==BSON.BSON_DATA_NUMBER)A[u]=e.readDoubleLE(r),r+=8;else if(s==BSON.BSON_DATA_DATE){var c=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,g=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;A[u]=new Date(new Long(c,g).toNumber())}else if(s==BSON.BSON_DATA_BOOLEAN)A[u]=1==e[r++];else if(s==BSON.BSON_DATA_OBJECT){var h=r,D=e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24;if(0>=D||D>e.length-r)throw new Error("bad embedded document length in bson");o?A[u]=e.slice(r,r+D):A[u]=deserializeObject(e,h,n,!1),r+=D}else if(s==BSON.BSON_DATA_ARRAY){var h=r,D=e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,w=n;if(B&&B[u]){w={};for(var v in n)w[v]=n[v];w.raw=!0}A[u]=deserializeObject(e,h,w,!0),r+=D}else if(s==BSON.BSON_DATA_UNDEFINED||s==BSON.BSON_DATA_NULL)A[u]=null;else if(s==BSON.BSON_DATA_LONG){var c=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,g=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,b=new Long(c,g);a?A[u]=b.lessThanOrEqual(JS_INT_MAX_LONG)&&b.greaterThanOrEqual(JS_INT_MIN_LONG)?b.toNumber():b:A[u]=b}else if(s==BSON.BSON_DATA_BINARY){var d=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,I=e[r++];if(null!=e.slice)I==Binary.SUBTYPE_BYTE_ARRAY&&(d=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24),l?A[u]=e.slice(r,r+d):A[u]=new Binary(e.slice(r,r+d),I);else{var m="undefined"!=typeof Uint8Array?new Uint8Array(new ArrayBuffer(d)):new Array(d);I==Binary.SUBTYPE_BYTE_ARRAY&&(d=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24);for(var f=0;d>f;f++)m[f]=e[r+f];l?A[u]=m:A[u]=new Binary(m,I)}r+=d}else if(s==BSON.BSON_DATA_REGEXP&&0==O){for(var f=r;0!==e[f]&&f<e.length;)f++;if(f>=e.length)throw new Error("Bad BSON Document: illegal CString");var R=e.toString("utf8",r,f);r=f+1;for(var f=r;0!==e[f]&&f<e.length;)f++;if(f>=e.length)throw new Error("Bad BSON Document: illegal CString");var M=e.toString("utf8",r,f);r=f+1;for(var Y=new Array(M.length),f=0;f<M.length;f++)switch(M[f]){case"m":Y[f]="m";break;case"s":Y[f]="g";break;case"i":Y[f]="i"}A[u]=new RegExp(R,Y.join(""))}else if(s==BSON.BSON_DATA_REGEXP&&1==O){for(var f=r;0!==e[f]&&f<e.length;)f++;if(f>=e.length)throw new Error("Bad BSON Document: illegal CString");var R=e.toString("utf8",r,f);r=f+1;for(var f=r;0!==e[f]&&f<e.length;)f++;if(f>=e.length)throw new Error("Bad BSON Document: illegal CString");var M=e.toString("utf8",r,f);r=f+1,A[u]=new BSONRegExp(R,M)}else if(s==BSON.BSON_DATA_SYMBOL){var E=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(0>=E||E>e.length-r||0!=e[r+E-1])throw new Error("bad string length in bson");A[u]=new Symbol(e.toString("utf8",r,r+E-1)),r+=E}else if(s==BSON.BSON_DATA_TIMESTAMP){var c=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,g=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;A[u]=new Timestamp(c,g)}else if(s==BSON.BSON_DATA_MIN_KEY)A[u]=new MinKey;else if(s==BSON.BSON_DATA_MAX_KEY)A[u]=new MaxKey;else if(s==BSON.BSON_DATA_CODE){var E=e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24;if(0>=E||E>e.length-r||0!=e[r+E-1])throw new Error("bad string length in bson");var y=e.toString("utf8",r,r+E-1);if(t){if(N){var C=S?crc32(y):y;A[u]=isolateEvalWithHash(functionCache,C,y,A)}else A[u]=isolateEval(y)}else A[u]=new Code(y,{});r+=E}else if(s==BSON.BSON_DATA_CODE_W_SCOPE){var E=(e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24,e[r++]|e[r++]<<8|e[r++]<<16|e[r++]<<24);if(0>=E||E>e.length-r||0!=e[r+E-1])throw new Error("bad string length in bson");var y=e.toString("utf8",r,r+E-1);r+=E;var h=r,D=e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,p=deserializeObject(e,h,n,!1);if(r+=D,t){if(N){var C=S?crc32(y):y;A[u]=isolateEvalWithHash(functionCache,C,y,A)}else A[u]=isolateEval(y);A[u].scope=p}else A[u]=new Code(y,p)}}return null!=A.$id&&(A=new DBRef(A.$ref,A.$id,A.$db)),A},isolateEvalWithHash=function(functionCache,hash,functionString,object){var value=null;return null==functionCache[hash]&&(eval("value = "+functionString),functionCache[hash]=value),functionCache[hash].bind(object)},isolateEval=function(functionString){var value=null;return eval("value = "+functionString),value},BSON={},functionCache=BSON.functionCache={};BSON.BSON_DATA_NUMBER=1,BSON.BSON_DATA_STRING=2,BSON.BSON_DATA_OBJECT=3,BSON.BSON_DATA_ARRAY=4,BSON.BSON_DATA_BINARY=5,BSON.BSON_DATA_UNDEFINED=7,BSON.BSON_DATA_OID=7,BSON.BSON_DATA_BOOLEAN=8,BSON.BSON_DATA_DATE=9,BSON.BSON_DATA_NULL=10,BSON.BSON_DATA_REGEXP=11,BSON.BSON_DATA_CODE=13,BSON.BSON_DATA_SYMBOL=14,BSON.BSON_DATA_CODE_W_SCOPE=15,BSON.BSON_DATA_INT=16,BSON.BSON_DATA_TIMESTAMP=17,BSON.BSON_DATA_LONG=18,BSON.BSON_DATA_MIN_KEY=255,BSON.BSON_DATA_MAX_KEY=127,BSON.BSON_BINARY_SUBTYPE_DEFAULT=0,BSON.BSON_BINARY_SUBTYPE_FUNCTION=1,BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2,BSON.BSON_BINARY_SUBTYPE_UUID=3,BSON.BSON_BINARY_SUBTYPE_MD5=4,BSON.BSON_BINARY_SUBTYPE_USER_DEFINED=128,BSON.BSON_INT32_MAX=2147483647,BSON.BSON_INT32_MIN=-2147483648,BSON.BSON_INT64_MAX=Math.pow(2,63)-1,BSON.BSON_INT64_MIN=-Math.pow(2,63),BSON.JS_INT_MAX=9007199254740992,BSON.JS_INT_MIN=-9007199254740992;var JS_INT_MAX_LONG=Long.fromNumber(9007199254740992),JS_INT_MIN_LONG=Long.fromNumber(-9007199254740992);module.exports=deserialize;